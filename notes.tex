\documentclass[10pt]{amsart}
\usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\usepackage{amsmath,amsthm,amssymb,stmaryrd,color,graphicx}
\usepackage{setspace}
\usepackage{bussproofs}
\usepackage{array}
\usepackage{comment}
\usepackage[protrusion=true,expansion=true]{microtype}
\usepackage{hyperref}

\usepackage{tikz}
\usetikzlibrary{calc,shapes.callouts,shapes.arrows}
\newcommand{\hcancel}[5]{%
    \tikz[baseline=(tocancel.base)]{
        \node[inner sep=0pt,outer sep=0pt] (tocancel) {#1};
        \draw[red, line width=0.5mm] ($(tocancel.south west)+(#2,#3)$) -- ($(tocancel.north east)+(#4,#5)$);
    }%
}

\theoremstyle{definition}
\newtheorem{defn}{Definition}[section]
\newtheorem{ex}[defn]{Example}

\theoremstyle{plain}

\newtheorem{prop}[defn]{Proposition}
\newtheorem{cor}[defn]{Corollary}
\newtheorem{lemma}[defn]{Lemma}
\newtheorem{thm}[defn]{Theorem}

\theoremstyle{remark}
\newtheorem{rem}[defn]{Remark}

\newcommand{\ZZ}{\mathbb{Z}}
\renewcommand{\AA}{\mathbb{A}}
\newcommand{\A}{\mathcal{A}}
\newcommand{\C}{\mathcal{C}}
\newcommand{\D}{\mathcal{D}}
\newcommand{\E}{\mathcal{E}}
\newcommand{\F}{\mathcal{F}}
\newcommand{\G}{\mathcal{G}}
\renewcommand{\O}{\mathcal{O}}
\newcommand{\K}{\mathcal{K}}
\renewcommand{\P}{\mathcal{P}}
\newcommand{\NN}{\mathbb{N}}
\newcommand{\RR}{\mathbb{R}}
\newcommand{\GG}{\mathbb{G}}
\newcommand{\Hom}{\mathrm{Hom}}
\newcommand{\id}{\mathrm{id}}
\newcommand{\Aut}[1]{\operatorname{Aut}(#1)}
\newcommand{\GL}{\mathrm{GL}}
\newcommand{\freist}{\_{}\_{}}
\newcommand{\ul}[1]{\underline{#1}}
\newcommand{\Set}{\mathrm{Set}}
\newcommand{\Grp}{\mathrm{Grp}}
\newcommand{\Vect}{\mathrm{Vect}}
\newcommand{\Sh}{\mathrm{Sh}}
\newcommand{\Zar}{\mathrm{Zar}}
\newcommand{\Sch}{\mathrm{Sch}}
\DeclareMathOperator{\Spec}{Spec}
\DeclareMathOperator{\colim}{colim}
\DeclareMathOperator{\rank}{rank}
\newcommand{\?}{\,{:}\,}
\renewcommand{\_}{\mathpunct{.}\,}
\newcommand{\speak}[1]{\ulcorner\text{\textnormal{#1}}\urcorner}
\newcommand{\Ll}{:\Longleftrightarrow}

\title{Using the internal language of toposes in algebraic geometry}
\author{Ingo Blechschmidt}
\email{iblech@web.de}

\begin{document}
\maketitle

\begin{abstract}
  There are several important topoi associated to a scheme, for instance the
  petit and gros Zariski topoi. These come with an internal mathematical language
  which closely resembles the usual formal language of mathematics, but is ``local
  on the base scheme'':

  For example, from the internal perspective, the structure sheaf looks like an
  ordinary local ring (instead of a sheaf of rings with local stalks) and vector
  bundles look like ordinary free modules (instead of sheaves of modules
  satisfying a certain condition). The translation of internal statements and
  proofs is facilitated by an easy mechanical procedure.

  These expository notes give an introduction to this topic and show how the internal
  point of view can be exploited to give simpler definitions and more conceptual
  proofs of the basic notions and observations in algebraic geometry. No prior
  knowledge about topos theory and formal logic is assumed.
\end{abstract}

\tableofcontents

\section{Introduction}

\section{Kripke--Joyal semantics}

Let~$X$ be a topological space. Later, $X$ will be the underlying space of a
scheme.

\begin{defn}[Kripke--Joyal semantics of a sheaf topos]The meaning of 
\[ U \models \varphi \quad\text{(``$\varphi$ holds on $U$'')} \]
for open subsets~$U \subseteq X$ and formulas~$\varphi$ is given by
the following rules, recursively in the structure of~$\varphi$:
\[ \renewcommand{\arraystretch}{1.3}\begin{array}{@{}lcl@{}}
  U \models f = g \? \F &\Ll& f|_U = g|_U \in \Gamma(U, \F) \\
  U \models \varphi \wedge \psi &\Ll&
    \text{$U \models \varphi$ and $U \models \psi$} \\
  U \models \varphi \vee \psi &\Ll&
    \hcancel{\text{$U \models \varphi$ or $U \models \psi$}}{0pt}{3pt}{0pt}{-2pt} \\
  && \text{there exists a covering $U = \bigcup_i U_i$ s.\,th. for all~$i$:} \\
  && \quad\quad \text{$U_i \models \varphi$ or $U_i \models \psi$} \\
  U \models \varphi \Rightarrow \psi &\Ll&
    \text{for all open~$V \subseteq U$: } 
  \text{$V \models \varphi$ implies $V \models \psi$} \\
  U \models \forall f \? \F\_ \varphi(f) &\Ll&
    \text{for all sections~$f \in \Gamma(V, \F), V \subseteq U$: $V \models
    \varphi(f)$} \\
  U \models \exists f \? \F\_ \varphi(f) &\Ll&
    \hcancel{\text{there exists a section~$f \in \Gamma(U,\F)$ s.\,th. $U
    \models \varphi(f)$}}{0pt}{3pt}{0pt}{-2pt} \\
  &&
    \text{there exists a covering $U = \bigcup_i U_i$ s.\,th. for all~$i$:} \\
  && \quad\quad \text{there exists~$f_i \in \Gamma(U_i, \F)$ s.\,th.
  $U_i \models \varphi(f_i)$} \\
  U \models \forall \F\_ \varphi(\F) &\Ll&
    \text{for all sheaves $\F$ on $V$, $V \subseteq U$: $V \models \varphi(\F)$} \\
  U \models \exists \F\_ \varphi(\F) &\Ll&
    \text{there exists a covering $U = \bigcup_i U_i$ s.\,th. for all~$i$:} \\
  && \quad\quad \text{there exists a sheaf~$\F_i$ on~$U_i$ s.\,th.
  $U_i \models \varphi(\F_i)$}
\end{array} \]
\end{defn}

\begin{rem}The last two rules, concerning \emph{unbounded quantification}, are
not part of the classical Kripke--Joyal semantics, but instead of Mike
Shulman's stack semantics~\cite{shulman:stack}, a slight extension. They are
needed so that we can formulate universal properties in the internal
language.
\end{rem}

The rules are not all arbitrary. They are finely concerted to make the
following propositions true, which are crucial for a proper appreciation of the
internal language.

\begin{prop}[Locality of the internal language]
Let~$U = \bigcup_i U_i$ be covered by open subsets. Let~$\varphi$
be a formula. Then
\[ U \models \varphi \qquad\text{iff}\qquad
  \text{$U_i \models \varphi$ for each $i$}. \]
\end{prop}
\begin{proof}Induction on the structure of~$\varphi$. Note that the canceled
rules would make this proposition false.\end{proof}

\begin{prop}[Soundness of the internal language]
If a formula~$\varphi$ implies a further formula~$\psi$ in intuitionistic logic, then
\[ U \models \varphi \qquad\text{implies}\qquad
  U \models \psi. \]
\end{prop}
\begin{proof}
Proof by induction on the structure of formal intuitionistic proofs; we are to
show that any inference rule of intuitionistic logic is satisfied by the
Kripke--Joyal semantics. For instance, there is the following rule governing
disjunction:
\begin{quote}
If~$\varphi \vee \psi$ holds, and both $\varphi$ and $\psi$ imply a further
formula~$\chi$, then~$\chi$ holds.
\end{quote}
So we are to prove that if~$U \models \varphi \vee \psi$, $U \models (\varphi
\Rightarrow \chi)$, and $U \models (\psi \Rightarrow \chi)$, then $U \models \chi$.
This is done as follows: By assumption, there exists a covering~$U = \bigcup_i
U_i$ such that on each~$U_i$, $U_i \models \varphi$ or $U_i \models \psi$.
Again by assumption, we may conclude that~$U_i \models \chi$ for each~$i$. The statement
follows because of the locality of the internal language.

A complete list of which rules are to prove is
in~\cite[D1.3.1]{johnstone:elephant}.
\end{proof}

\begin{itemize}
\item geometric formulas
\item geometric constructions
\item simplification rules
\item notation: $\Sh(X) \models \varphi$ means~$X \models \varphi$
\item remark: do not confuse $\Sh(X) \models \neg\varphi$ with $\Sh(X)
\not\models \varphi$
\item first steps: invertibility, nilpotency (needed later)
\end{itemize}


\section{Sheaves of rings}

\subsection{Reducedness} Recall that a scheme~$X$ is \emph{reduced} if and only
if all stalks~$\O_{X,x}$ are reduced rings. Since the condition on a ring~$R$
to be reduced is a geometric implication,
\[ \forall s\?R\_ s^2 = 0 \Longrightarrow s = 0, \]
we immediately obtain the following characterization of reducedness in the
internal language:
\begin{prop}A scheme~$X$ is reduced iff, from the internal point of view, the
ring~$\O_X$ is reduced.\end{prop}


\subsection{Locality} Recall the usual definition of a local ring: a ring
possessing exactly one maximal ideal. This is a higher-order condition and in
particular not of a geometric form. Therefore, for our purposes, it's better to
adopt the following elementary definition of a local ring.
\begin{defn}A \emph{local ring} is a ring~$R$ such that~$1 \neq 0$ in~$R$ and
for all~$x,y \in R$
\[ \text{$x+y$ invertible} \quad\Longrightarrow\quad
  \text{$x$ invertible}\ \vee\ \text{$y$ invertible}. \]
\end{defn}
In classical logic, it's an easy exercise to show that this definition is
equivalent to the usual one. In intuitionistic logic, we would need to be
more precise in order to even state the question of equivalence, since
intuitionistically, the notion of a maximal ideal bifurcates into several
non-equivalent notions.

\begin{prop}In the internal language of a scheme~$X$ (or a locally ringed
space), the ring~$\O_X$ is a local ring.\end{prop}
\begin{proof}The stated locality condition is a conjunction of two geometric
implications (the first one being~$1 = 0 \Rightarrow \bot$, the second being
the displayed one) and holds on each stalk.\end{proof}


\subsection{Field properties} From the internal point of view, the structure
sheaf~$\O_X$ of a scheme~$X$ is \emph{almost} a field, in the sense that any
element which is not invertible is nilpotent. This is a genuine property of
schemes, not shared with general locally ringed spaces.

\begin{prop}Let~$X$ be a scheme. Then
\[ \Sh(X) \models \forall s\?\O_X\_ \neg(\speak{$s$ invertible}) \Rightarrow
\speak{$s$ nilpotent}. \]
\end{prop}
\begin{proof}By the locality of the internal language and since~$X$ can be
covered by open affine subsets, it's enough to show that for any affine
scheme~$X = \Spec A$ and global function~$s \in \Gamma(X,\O_X) = A$ it holds
that
\[ X \models \neg(\speak{$s$ invertible}) \quad\text{implies}\quad
  X \models \speak{$s$ nilpotent}. \]
The meaning of the antecedent is that any open subset on which~$s$ is
invertible is empty. So in particular, the standard open subset~$D(s)$ is
empty. Therefore~$s$ is an element of any prime ideal of~$A$ and thus
nilpotent. This implies the a priori weaker statement~$X \models \speak{$s$
nilpotent}$ (which would allow~$s$ to have different indices of nilpotency on
an open covering).
\end{proof}

\begin{cor}Let~$X$ be a scheme. If~$X$ is reduced, the ring~$\O_X$ is a field
from the internal point of view, in the sense that
\[ \Sh(X) \models \forall s\?\O_X\_ \neg(\speak{$s$ invertible}) \Rightarrow
s=0. \]
The converse holds as well.\end{cor}
\begin{proof}We can prove this purely in the internal language: It suffices to
give an intuitionistic proof of the fact that a local ring which satisfies the
condition of the previous proposition fulfills the stated field condition if
and only if it is reduced. This is straightforward.
\end{proof}

This field property is very useful. We will put it to good use when giving a
simple proof of the fact that~$\O_X$-modules of finite type on a reduced scheme
are locally free on a dense open subset (proposition~\ref{modules:densefree}).

\begin{itemize}
\item Remark that intuitionistically, the notion of a field bifurcates into
several inequivalent notions
\item discreteness
\end{itemize}

\section{Sheaves of modules}
\begin{itemize}
\item of finite type, of finite presentation, coherent
\item basic lemmas
\item flatness
\item important hard exercise
\item torsion (check Liu p. 174)
\item quasicoherence: give presentation condition and affine condition in
internal language; discuss equivalence with~$M[f^{-1}]$ being an~$f$-sheaf for
any~$f:\O$; discuss easy condition for a submodule to be quasicoherent; give
examples (nilradical and annihilator ideal)
\end{itemize}


\section{Upper semicontinuous functions}

\subsection{Interlude on natural numbers}
In classical logic, the natural numbers are complete in the sense that any
inhabited set of natural numbers possesses a minimal element. This statement
can not be proven intuitionistically -- intuitively, this is because one cannot
explicitly pinpoint the (classically existing) minimal element of an arbitrary
inhabited set. In intuitionistic logic, this principle can be salvaged in two
essentially different ways: either be strengthening the premise, or by
weakening the conclusion.

\begin{lemma}Let~$U \subseteq \NN$ be an inhabited subset of the natural
numbers.
\begin{enumerate}
\item Assume~$U$ to be \emph{detachable}, i.\,e. assume that for any natural
number~$n$, either~$n \in U$ or~$n \not\in U$. Then~$U$ possesses a minimal
element.
\item In any case,~$U$ does \emph{not not} possess a minimal element.
\end{enumerate}
\end{lemma}
\begin{proof}
\begin{enumerate}
\item By induction on the witness of inhabitation, i.\,e. the given number~$n$ such
that~$n \in U$. Details omitted, since we will not need this statement.
\item We give a careful proof since logical subtleties matter. To simplify the
exposition, we assume that~$U$ is upward-closed, i.\,e. that any number
larger than some element of~$U$ lies in~$U$ as well. Any subset can be closed
in this way (by considering~$\{ n \in \NN \,|\, \exists m \in U\_ n \geq m \}$)
and a minimal element of the closure will be a minimal element for~$U$ as well.

We induct on the number~$n \in U$ given by the assumption that~$U$ is
inhabited. In the case~$n = 0$ we are done since~$0$ is a minimal element
of~$U$. For the induction step~$n \to n+1$, the weak law of excluded middle
gives
\[ \neg\neg(n \in U \vee n \not\in U). \]
If we can show that~$n \in U \vee n \not\in U$ implies the conclusion, we're
done by XXX. So assume~$n \in U \vee n \not\in U$.
If~$n \in U$, then~$U$ does not not possess a minimal element by the induction
hypothesis. If~$n \not\in U$, then~$n+1$ is a minimal element (and so, in
particular,~$U$ does not not possess a minimal element): For if~$m$ is
any element of~$U$, we have~$m \geq n+1$ or~$m \leq n$. In the first case,
we're done. In the second case, it follows that~$n \in U$ because~$U$ is
upward-closed and so we obtain a contradiction. From this contradiction we can
deduce~$m \geq n+1$. \qedhere
\end{enumerate}
\end{proof}

If we want to work with a complete set of natural numbers in intuitionistic
logic, we have to construction a completion.
\begin{defn}The partially ordered set of \emph{completed natural numbers} is
the set~$\widehat{\NN}$ of all inhabited upward-closed subsets of~$\NN$, ordered by
reverse inclusion.\end{defn}
\begin{lemma}The poset of completed natural numbers is the least partially
ordered set containing~$\NN$ and possessing minima
of arbitrary inhabited subsets.\end{lemma}
\begin{proof}
The embedding $\NN \hookrightarrow \widehat\NN$ is given by
\[ n \in \NN \longmapsto {\uparrow}(n) := \{ m \in \NN \,|\, m \geq n \}. \]
If~$M \subseteq \widehat\NN$ is an inhabited subset, its minimum is
\[ \min M = \bigcup M \in \widehat\NN. \]
The proof of the universal property is left to the reader.
\end{proof}

\begin{rem}In classical logic, the map~$\widehat\NN \to \NN,\ U \mapsto \min U$
is a well-defined isomorphism of partially ordered sets.\end{rem}


\subsection{A geometric interpretation}
We are interested in the completed natural numbers for the following reason: A
completed natural number of the topos of sheaves on a topological space~$X$ is
the same as an upper semicontinuous function~$X \to \NN$.

\begin{lemma}Let~$X$ be a topological space. The sheaf~$\widehat\NN$ of
completed natural numbers on~$X$ is canonically isomorphic to the sheaf of upper
semicontinuous~$\NN$-valued functions on~$X$.\end{lemma}
\begin{proof}
When referring to the natural numbers in the internal language, we actually
refer to the constant sheaf~$\ul{\NN}$ on~$X$. (This is because the
sheaf~$\ul{\NN}$ fulfills the axioms of a natural numbers object,
cf.~\cite[XXX]{johnstone:elephant/moerdijk}.) Recall that its sections on an
open subset~$U \subseteq X$ are continuous functions~$U \to \NN$, where~$\NN$
is equipped with the discrete topology.

Therefore, a section of~$\widehat\NN$ on an open subset~$U \subseteq X$ is
given by a subsheaf~$\A \hookrightarrow \ul{\NN}|_U$ such that
\[ U \models \exists n\?\ul{\NN}\_ n \in \A
  \quad\text{and}\quad
  U \models \forall n,m\?\ul{\NN}\_ n \geq m \wedge n \in \A \Rightarrow m \in
  \A. \]
Since these conditions are geometric, they are satisfied if and only if any
stalk~$\A_x$ is an inhabited upward-closed subset of~$\ul{\NN}_x \cong \NN$.
The association
\[ x \in X \longrightarrow \min\{ n \in \NN \,|\, n \in \A_x \} \]
thus defines a map~$X \to \NN$. This map is indeed upper semicontinuous, since
if~$n \in \A_x$, there exists a neighbourhood~$V$ of~$x$ such that the constant
function with value~$n$ is an element of~$\Gamma(V,\A)$ and therefore~$n \in
\A_y$ for all~$y \in V$.

Conversely, let~$\alpha : U \to \NN$ be a upper semi-continous function. Then
\[ V \subseteq X \longmapsto \{ f : V \to \NN \,|\, \text{$f$
continuous,\ $f \geq \alpha$ on~$V$} \} \]
is a subobject of~$\ul{\NN}|_U$ which internally is inhabited and upward-closed.
Further details are left to the reader.
\end{proof}

Under the correspondence given by the lemma, locally \emph{constant}
functions map exactly to the (image of the) \emph{ordinary} internal natural numbers
(in the completed natural numbers).

\begin{rem}In a similar vein, the sheaf given by the internal construction of
the set of \emph{all} upward-closed subsets of the natural numbers (not
necessarily only the inhabited ones) is canonically isomorphic to the sheaf of
upper semicontinuous functions with values in~$\NN \cup \{ +\infty
\}$.\end{rem}


\subsection{The upper semicontinuous rank function}
Recall that the rank of an~$\O_X$-module~$\F$ on a scheme~$X$ (or
locally ringed space) at a point~$x \in X$ is defined as the~$k(x)$-dimension
of the vector space~$\F_x \otimes_{\O_{X,x}} k(x)$. If we assume that~$\F$ is
of finite type around~$x$, this dimension is finite and equals the minimal
number of elements needed to generate~$\F_x$ as an~$\O_{X,x}$-module (by
Nakayama's lemma).

In the internal language, we can define an element of~$\widehat\NN$ by
\[ \rank\F := \min\{ n \in \NN \,|\, \speak{there is a gen. family
for~$\F$ consisting of~$n$ elements} \} \in \widehat\NN. \]
If~$\F$ is locally finitely free, it will be a finitely free module from the
internal point of view and the rank defined in this way will be an
actual natural number; but in general, the rank is really an element of the
completion.

\begin{prop}
Let~$\F$ be an~$\O_X$-module of finite type on a scheme~$X$ (or locally ringed
space). Under the correspondence given by the previous lemma, the internally
defined rank maps to the rank function of~$\F$.
\end{prop}
\begin{proof}
We have to show that for any point~$x \in X$ and natural number~$n$, there
exists a generating family for~$\F_x$ consisting of~$n$
elements if and only if there exists a neighbourhood~$U$ of~$x$ such that
\[ U \models \speak{there exists a generating family
for~$\F$ consisting of~$n$ elements}. \]
The ``if'' direction is obvious. For the ``only if'' direction, consider
(liftings to local sections of a)
generating family~$s_1,\ldots,s_n$ of~$\F_x$. Since~$\F$ is of finite type,
there also exist sections~$t_1,\ldots,t_m$ on some neighbourhood~$V$ of~$x$ which
generate any stalk~$\F_y$, $y \in V$. Since the~$t_i$ can be expressed as a
linear combination of the~$s_j$ in~$\F_x$, the same is true on some open
neighbourhood~$U \subseteq V$ of~$x$. On this neighbourhood, the~$s_j$ generate
any stalk~$\F_y$, $y \in U$, so we have
\[ U \models \speak{$s_1,\ldots,s_n$ generate~$\F$}. \qedhere \]
\end{proof}
\begin{rem}Once we understand when properties holding at a stalk spread to a
neighbourhood, we will be able to give a simpler proof of the proposition (see
XXX).\end{rem}


\section{Rational functions and Cartier divisors}

\subsection{The sheaf of rational functions} Recall that the sheaf~$\K_X$ of rational
functions on a scheme~$X$ (or ringed space) can be defined as the sheaf
associated to the presheaf
\[ U \subseteq X \longmapsto \Gamma(U,\O_X)[S(U)^{-1}], \]
where~$S(U)$ is the multiplicative set of those sections of~$\O_X$ on~$U$,
which are regular in each stalk~$\O_{X,x}$, $x \in U$. Recall also there are
some wrong definitions in the literature~\cite{kleiman:misconceptions}.

\begin{itemize}
\item internal definition of $\K_X$
\item discuss stalks of~$\K_X$; discuss that on a locally Noetherian scheme,
regularity spreads from stalk to neighbourhood
\item show~$\K_X = j_*(\O_X)$?
\item internal definition of Cartier divisors
\item correspondence between Cartier divisors and sub-$\O_X$-modules of $\K_X$
\end{itemize}


\section{Relative spectrum}
\begin{itemize}
\item ...
\end{itemize}

\section{Modalities}
\begin{itemize}
\item negneg
\item spreading of properties from stalk to neighbourhood
\item internal sheafification
\end{itemize}

\section{Unsorted}
\begin{itemize}
\item ``functoriality''
\item Kähler differentials
\item closed and open subschemes
\item reduced closed subscheme
\item Koszul resolution
\item meta properties, uses (e.g. nilpotent on stalks iff globally nilpotent,
some lemmas about limits of modules)
\item locally small categories
\item big Zariski topos
\item open/closed immersions
\item morphisms of schemes...
\item proper maps...
\item limits and colimits...
\item related work: Mulvey/Burden, Wraith, Vickers, the Bohr topos crew, Awodey, ...
\end{itemize}

\end{document}

XXX: ``completed natural number'' is a misnomer.
