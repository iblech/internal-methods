\documentclass[10pt]{amsart}
\usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\usepackage{amsmath,amsthm,amssymb,stmaryrd,color,graphicx}
\usepackage{setspace}
\usepackage{bussproofs}
\usepackage{array}
\usepackage{comment}
\usepackage[protrusion=true,expansion=true]{microtype}
\usepackage{hyperref}
\usepackage[all]{xy}

\usepackage{tikz}
\usetikzlibrary{calc,shapes.callouts,shapes.arrows}
\newcommand{\hcancel}[5]{%
    \tikz[baseline=(tocancel.base)]{
        \node[inner sep=0pt,outer sep=0pt] (tocancel) {#1};
        \draw[red, line width=0.5mm] ($(tocancel.south west)+(#2,#3)$) -- ($(tocancel.north east)+(#4,#5)$);
    }%
}

\theoremstyle{definition}
\newtheorem{defn}{Definition}[section]
\newtheorem{ex}[defn]{Example}

\theoremstyle{plain}

\newtheorem{prop}[defn]{Proposition}
\newtheorem{cor}[defn]{Corollary}
\newtheorem{lemma}[defn]{Lemma}
\newtheorem{thm}[defn]{Theorem}

\theoremstyle{remark}
\newtheorem{rem}[defn]{Remark}

\newcommand{\ZZ}{\mathbb{Z}}
\renewcommand{\AA}{\mathbb{A}}
\newcommand{\A}{\mathcal{A}}
\newcommand{\C}{\mathcal{C}}
\newcommand{\D}{\mathcal{D}}
\newcommand{\E}{\mathcal{E}}
\newcommand{\F}{\mathcal{F}}
\newcommand{\G}{\mathcal{G}}
\renewcommand{\H}{\mathcal{H}}
\renewcommand{\O}{\mathcal{O}}
\newcommand{\K}{\mathcal{K}}
\renewcommand{\P}{\mathcal{P}}
\newcommand{\R}{\mathcal{R}}
\renewcommand{\S}{\mathcal{S}}
\newcommand{\NN}{\mathbb{N}}
\newcommand{\RR}{\mathbb{R}}
\newcommand{\GG}{\mathbb{G}}
\newcommand{\ppp}{\mathfrak{p}}
\newcommand{\Hom}{\mathrm{Hom}}
\newcommand{\id}{\mathrm{id}}
\newcommand{\Aut}[1]{\operatorname{Aut}(#1)}
\newcommand{\GL}{\mathrm{GL}}
\newcommand{\placeholder}{\underline{\quad}}
\newcommand{\ul}[1]{\underline{#1}}
\newcommand{\Set}{\mathrm{Set}}
\newcommand{\Grp}{\mathrm{Grp}}
\newcommand{\Vect}{\mathrm{Vect}}
\newcommand{\Sh}{\mathrm{Sh}}
\newcommand{\Zar}{\mathrm{Zar}}
\newcommand{\Sch}{\mathrm{Sch}}
\DeclareMathOperator{\Spec}{Spec}
\DeclareMathOperator{\colim}{colim}
\DeclareMathOperator{\rank}{rank}
\DeclareMathOperator{\Ann}{Ann}
\newcommand{\?}{\,{:}\,}
\renewcommand{\_}{\mathpunct{.}\,}
\newcommand{\speak}[1]{\ulcorner\text{\textnormal{#1}}\urcorner}
\newcommand{\Ll}{:\Longleftrightarrow}

\title{Using the internal language of toposes in algebraic geometry}
\author{Ingo Blechschmidt}
\email{iblech@web.de}

\begin{document}
\maketitle

\begin{abstract}
  There are several important topoi associated to a scheme, for instance the
  petit and gros Zariski topoi. These come with an internal mathematical language
  which closely resembles the usual formal language of mathematics, but is ``local
  on the base scheme'':

  For example, from the internal perspective, the structure sheaf looks like an
  ordinary local ring (instead of a sheaf of rings with local stalks) and vector
  bundles look like ordinary free modules (instead of sheaves of modules
  satisfying a certain condition). The translation of internal statements and
  proofs is facilitated by an easy mechanical procedure.

  These expository notes give an introduction to this topic and show how the internal
  point of view can be exploited to give simpler definitions and more conceptual
  proofs of the basic notions and observations in algebraic geometry. No prior
  knowledge about topos theory and formal logic is assumed.
\end{abstract}

\tableofcontents

\section{Introduction}

\section{Kripke--Joyal semantics}

Let~$X$ be a topological space. Later, $X$ will be the underlying space of a
scheme.

\begin{defn}The meaning of 
\[ U \models \varphi \quad\text{(``$\varphi$ holds on $U$'')} \]
for open subsets~$U \subseteq X$ and formulas~$\varphi$ is given by
the following rules, recursively in the structure of~$\varphi$:
% XXX: introduce term "Kripke--Joyal semantic"
\[ \renewcommand{\arraystretch}{1.3}\begin{array}{@{}lcl@{}}
  U \models f = g \? \F &\Ll& f|_U = g|_U \in \Gamma(U, \F) \\
  U \models \top &\Ll& U = U \text{ (always fulfilled)} \\
  U \models \bot &\Ll& U = \emptyset \\
  U \models \varphi \wedge \psi &\Ll&
    \text{$U \models \varphi$ and $U \models \psi$} \\
  U \models \varphi \vee \psi &\Ll&
    \hcancel{\text{$U \models \varphi$ or $U \models \psi$}}{0pt}{3pt}{0pt}{-2pt} \\
  && \text{there exists a covering $U = \bigcup_i U_i$ s.\,th. for all~$i$:} \\
  && \quad\quad \text{$U_i \models \varphi$ or $U_i \models \psi$} \\
  U \models \varphi \Rightarrow \psi &\Ll&
    \text{for all open~$V \subseteq U$: } 
  \text{$V \models \varphi$ implies $V \models \psi$} \\
  U \models \forall f \? \F\_ \varphi(f) &\Ll&
    \text{for all sections~$f \in \Gamma(V, \F)$, open $V \subseteq U$: $V \models
    \varphi(f)$} \\
  U \models \exists f \? \F\_ \varphi(f) &\Ll&
    \hcancel{\text{there exists a section~$f \in \Gamma(U,\F)$ s.\,th. $U
    \models \varphi(f)$}}{0pt}{3pt}{0pt}{-2pt} \\
  &&
    \text{there exists an open covering $U = \bigcup_i U_i$ s.\,th. for all~$i$:} \\
  && \quad\quad \text{there exists~$f_i \in \Gamma(U_i, \F)$ s.\,th.
  $U_i \models \varphi(f_i)$} \\
  U \models \forall \F\_ \varphi(\F) &\Ll&
    \text{for all sheaves $\F$ on $V$, open $V \subseteq U$: $V \models \varphi(\F)$} \\
  U \models \exists \F\_ \varphi(\F) &\Ll&
    \text{there exists an open covering $U = \bigcup_i U_i$ s.\,th. for all~$i$:} \\
  && \quad\quad \text{there exists a sheaf~$\F_i$ on~$U_i$ s.\,th.
  $U_i \models \varphi(\F_i)$}
\end{array} \]
The translation of~$U \models \neg\varphi$ does not have to be defined, since
negation can be expressed using other symbols: $\neg\varphi :\equiv (\varphi
\Rightarrow \bot)$. Analogously to the rules for~$\wedge$ and~$\vee$, we can
define rules for arbitrary set-indexed conjuctions~($\bigwedge_{j \in J}$) and
disjunctions~($\bigvee_{j \in J}$). If we want to emphasize the particular topos, we write
\[ \Sh(X) \models \varphi \quad\Ll\quad X \models \varphi. \]
\end{defn}
% XXX: Explanation of \top and \bot.
% XXX: Rule for \in.

\begin{rem}The last two rules, concerning \emph{unbounded quantification}, are
not part of the classical Kripke--Joyal semantics, but instead of Mike
Shulman's stack semantics~\cite{shulman:stack}, a slight extension. They are
needed so that we can formulate universal properties in the internal
language.
\end{rem}

\begin{ex}Let~$\alpha : \F \to \G$ be a morphism of sheaves on~$X$. Then
$\alpha$ is a monomorphism of sheaves if and only if, from the internal
perspective,~$\alpha$ is simply an injective map:
\begin{align*}
  & X \models \speak{$\alpha$ is injective} \\[0.5em]
  \Longleftrightarrow\
  & X \models \forall s,t\?\F\_ \alpha(s) = \alpha(t) \Rightarrow s = t \\[0.5em]
  \Longleftrightarrow\ &
    \text{for all open~$U \subseteq X$, sections $s, t \in \Gamma(U, \F)$:} \\
  &\qquad\qquad
      U \models \alpha(s) = \alpha(t) \Rightarrow s = t \\[0.5em]
  \Longleftrightarrow\ &
    \text{for all open~$U \subseteq X$, sections $s, t \in \Gamma(U, \F)$:} \\
  &\qquad\qquad
      \text{for all open~$V \subseteq U$:} \\
  &\qquad\qquad\qquad\qquad
        \text{$\alpha_V(s|_V) = \alpha_V(t|_V)$ implies $s|_V = t|_V$} \\[0.5em]
  \Longleftrightarrow\ &
    \text{for all open~$U \subseteq X$, sections $s, t \in \Gamma(U, \F)$:} \\
  &\qquad\qquad
        \text{$\alpha_U(s|_U) = \alpha_U(t|_U)$ implies $s|_U = t|_U$} \\[0.5em]
  \Longleftrightarrow\ &
    \text{$\alpha$ is a monomorphism of sheaves}
\end{align*}
The corner quotes ``$\speak{\ldots}$'' indicate that translation into formal
language is left to the reader. Similarly,~$\alpha$ is an epimorphism of
sheaves if and only if, from the internal perspective,~$\alpha$ is a
surjective map.
\end{ex}

The rules are not all arbitrary. They are finely concerted to make the
following propositions true, which are crucial for a proper appreciation of the
internal language.

\begin{prop}[Locality of the internal language]
Let~$U = \bigcup_i U_i$ be covered by open subsets. Let~$\varphi$
be a formula. Then
\[ U \models \varphi \qquad\text{iff}\qquad
  \text{$U_i \models \varphi$ for each $i$}. \]
\end{prop}
\begin{proof}Induction on the structure of~$\varphi$. Note that the canceled
rules would make this proposition false.\end{proof}

\begin{prop}[Soundness of the internal language]
If a formula~$\varphi$ implies a further formula~$\psi$ in intuitionistic logic, then
$U \models \varphi$ implies $U \models \psi$.
\end{prop}
\begin{proof}
Proof by induction on the structure of formal intuitionistic proofs; we are to
show that any inference rule of intuitionistic logic is satisfied by the
Kripke--Joyal semantics. For instance, there is the following rule governing
disjunction:
\begin{quote}
If~$\varphi \vee \psi$ holds, and both $\varphi$ and $\psi$ imply a further
formula~$\chi$, then~$\chi$ holds.
\end{quote}
So we are to prove that if~$U \models \varphi \vee \psi$, $U \models (\varphi
\Rightarrow \chi)$, and $U \models (\psi \Rightarrow \chi)$, then $U \models \chi$.
This is done as follows: By assumption, there exists a covering~$U = \bigcup_i
U_i$ such that on each~$U_i$, $U_i \models \varphi$ or $U_i \models \psi$.
Again by assumption, we may conclude that~$U_i \models \chi$ for each~$i$. The statement
follows because of the locality of the internal language.

A complete list of which rules are to prove is
in~\cite[D1.3.1]{johnstone:elephant}.
\end{proof}
% XXX: Put rules into an appendix and give some explanation regarding contexts
% etc. Don't forget the rules for \in, \bigwedge, \bigvee.

Because of the multitude of quantifiers, literal translations of internal statements
can sometimes get slightly unwieldy. There are simplification rules for certain
often-occuring special cases:
\begin{prop}
    \[ \renewcommand{\arraystretch}{1.3}\begin{array}{@{}lcl@{}}
      U \models \forall s\?\F\_ \forall t\?\G\_ \varphi(s,t)
      &\Longleftrightarrow&
      \text{for all open~$V \subseteq U$,} \\
      && \text{sections~$s \in \Gamma(V,\F)$, $t \in \Gamma(V,\G)$:
      $V \models \varphi(s,t)$} \\[0.3em]
      U \models \forall s\?\F\_ \varphi(s) \Rightarrow \psi(s)
      &\Longleftrightarrow&
      \text{for all open~$V \subseteq U$, sections~$s \in \Gamma(V,\F)$:} \\
      &&\qquad\qquad \text{$V \models \varphi(s)$ implies $V \models \psi(s)$}
      \\[0.3em]
      U \models \exists!s\?\F\_ \varphi(s)
      &\Longleftrightarrow&
      \text{for all open~$V \subseteq U$,} \\
      &&
      \text{there is exactly one section~$s \in \Gamma(V,\F)$ with:} \\
      &&\qquad\qquad V \models \varphi(s)
    \end{array} \]
\end{prop}
\begin{proof}Straightforward. By way of example, we prove the existence claim
in the ``only if'' direction of the last rule. (Note that this rule formalizes
the saying ``unique existence is global existence''.) By definition of~$\exists!$, it
holds that
\[ U \models \exists s\?\F\_ \varphi(s) \]
and
\[ U \models \forall s,t\?\F\_ \varphi(s) \wedge \varphi(t) \Rightarrow s = t.  \]
Let~$V \subseteq U$ be an arbitrary open subset. Then there exist local
section~$s_i \in \Gamma(V_i,\F)$ such that~$V_i \models \varphi(s_i)$, where~$V
= \bigcup_i V_i$ is an open covering. By the locality of the internal language,
on intersections it holds that~$V_i \cap V_j \models \varphi(s_i)$, so by the
uniqueness assumption, it follows that the local sections agree on intersections.
They therefore glue to a section~$s \in \Gamma(V,\F)$. Since~$V_i \models
\varphi(s)$ for any~$i$, the locality of the internal language allows us to
conclude that~$V \models \varphi(s)$.
\end{proof}

\begin{rem}Note that~$\Sh(X) \models \neg\varphi$ is in general a much stronger
statement that merely supposing that~$\Sh(X) \models \varphi$ does not hold:
The former always implies the latter (unless~$X = \emptyset$, in which case
\emph{any} internal statement is true), but the converse does not hold: The
former statement means that~$U = \emptyset$ is the \emph{only} open subset on
which~$\varphi$ holds.\end{rem}
% XXX: Find appropriate place for this remark.


\subsection{Geometric formulas and constructions} In categorical logic,
so-called geometric formulas play a special role, because their meaning is
preserved under pullback with geometric morphisms. % XXX gibberish!
\begin{defn}A formula is \emph{geometric} if and only if it consists only of
\[ {=} \quad {\top} \quad {\bot} \quad {\wedge} \quad {\vee} \quad
{\bigvee} \quad {\exists}, \]
% XXX: \in
but not~``$\bigwedge$'' nor ``$\Rightarrow$'' nor~``$\forall$'' (and thus
not~``$\neg$'' either, since this is defined using~``$\Rightarrow$'').
A \emph{geometric implication} is a formula of the form
\[ \forall \cdots \forall\_ (\cdots) \Rightarrow (\cdots) \]
with the bracketed subformulas being geometric.
\end{defn}
We say that a formula~$\varphi$ holds \emph{at a point~$x \in X$} if and only
if the formula obtained by substituting all parameters in~$\varphi$ (e.\,g.
sheaves being quantified over) with their stalks at~$x$ holds in the usual
mathematical sense.
% XXX: "e.g." list is not complete

\begin{lemma}Let~$x \in X$ be a point. Let~$\varphi$ be a geometric formula.
Then~$\varphi$ holds at~$x$ if and only if there exists a neighbourhood~$U
\subseteq X$ of~$x$ such that~$\varphi$ holds on~$U$.
\end{lemma}
% XXX: Need to reformulate this for the relative case of \varphi
% being a formula with parameters defined only over some open subset U.
\begin{proof}This is a very general instance of the phenomenom that sometimes,
truth at a point spreads to truth on a neighbourhood. It can be proven by
induction on the structure of~$\varphi$, but we will give a more conceptual
proof later (lemma~XXX).
\end{proof}

\begin{cor}A geometric implication holds on~$X$ if and only if it holds at
every point of~$X$.\end{cor}
\begin{proof}For notational simplicity, we consider a geometric implication of
the form
\[ \forall s\?\F\_ \varphi(s) \Rightarrow \psi(s). \]
For the ``only if'' direction, assume that this formula holds on~$X$ and let~$x
\in X$ be an arbitrary point. Let~$s_x \in \F_x$ be the germ of an arbitrary
local section~$s$ of~$\F$ and assume that~$\varphi(s)$ holds at~$x$. Then by
the lemma, it follows that~$\varphi(s)$ holds on some open neighbourhood of~$x$. By
assumption,~$\psi(s)$ holds on this neighbourhood as well. Again by the
lemma,~$\psi(s)$ holds at~$x$.

For the ``if'' direction, assume that the geometric implication holds at every
point. Let~$U \subseteq X$ be an arbitrary open subset and let~$s \in
\Gamma(U,\F)$ be a local section such that~$\varphi(s)$ holds on~$U$. By the
lemma and the locality of the internal language, to show that~$\psi(s)$ holds
on~$U$, it suffices to show that~$\psi(s)$
holds at every point of~$U$. This is clear, since again by the
lemma,~$\varphi(s)$ holds at every point of~$U$.
\end{proof}

\begin{itemize}
\item remark on how, even though injectivity and surjectivity are notions of an
element-based language, the Kripke--Joyal semantics manages to incorporate
\emph{all} elements, not only global ones
\item remark that since injectivity and surjectivity are geometric
implications, monos/epis are stalkwise injective/surjective (and vice versa)
\item geometric constructions
\item crash course on intuitionistic logic
\item first steps: invertibility, nilpotency (needed later)
\item somewhere, the external interpretation of power sets has to be explained
(needed for instance for completed natural numbers and~$\Box$-sheaves)
\end{itemize}


\section{Sheaves of rings}

\subsection{Reducedness} Recall that a scheme~$X$ is \emph{reduced} if and only
if all stalks~$\O_{X,x}$ are reduced rings. Since the condition on a ring~$R$
to be reduced is a geometric implication,
\[ \forall s\?R\_ s^2 = 0 \Longrightarrow s = 0, \]
we immediately obtain the following characterization of reducedness in the
internal language:
\begin{prop}A scheme~$X$ is reduced iff, from the internal point of view, the
ring~$\O_X$ is reduced.\end{prop}


\subsection{Locality} Recall the usual definition of a local ring: a ring
possessing exactly one maximal ideal. This is a higher-order condition and in
particular not of a geometric form. Therefore, for our purposes, it's better to
adopt the following elementary definition of a local ring.
\begin{defn}A \emph{local ring} is a ring~$R$ such that~$1 \neq 0$ in~$R$ and
for all~$x,y \in R$
\[ \text{$x+y$ invertible} \quad\Longrightarrow\quad
  \text{$x$ invertible}\ \vee\ \text{$y$ invertible}. \]
\end{defn}
In classical logic, it's an easy exercise to show that this definition is
equivalent to the usual one. In intuitionistic logic, we would need to be
more precise in order to even state the question of equivalence, since
intuitionistically, the notion of a maximal ideal bifurcates into several
non-equivalent notions.

\begin{prop}In the internal language of a scheme~$X$ (or a locally ringed
space), the ring~$\O_X$ is a local ring.\end{prop}
\begin{proof}The stated locality condition is a conjunction of two geometric
implications (the first one being~$1 = 0 \Rightarrow \bot$, the second being
the displayed one) and holds on each stalk.\end{proof}


\subsection{Field properties} From the internal point of view, the structure
sheaf~$\O_X$ of a scheme~$X$ is \emph{almost} a field, in the sense that any
element which is not invertible is nilpotent. This is a genuine property of
schemes, not shared with general locally ringed spaces.

\begin{prop}Let~$X$ be a scheme. Then
\[ \Sh(X) \models \forall s\?\O_X\_ \neg(\speak{$s$ invertible}) \Rightarrow
\speak{$s$ nilpotent}. \]
\end{prop}
\begin{proof}By the locality of the internal language and since~$X$ can be
covered by open affine subsets, it's enough to show that for any affine
scheme~$X = \Spec A$ and global function~$s \in \Gamma(X,\O_X) = A$ it holds
that
\[ X \models \neg(\speak{$s$ invertible}) \quad\text{implies}\quad
  X \models \speak{$s$ nilpotent}. \]
The meaning of the antecedent is that any open subset on which~$s$ is
invertible is empty. So in particular, the standard open subset~$D(s)$ is
empty. Therefore~$s$ is an element of any prime ideal of~$A$ and thus
nilpotent. This implies the a priori weaker statement~$X \models \speak{$s$
nilpotent}$ (which would allow~$s$ to have different indices of nilpotency on
an open covering).
\end{proof}

\begin{cor}Let~$X$ be a scheme. If~$X$ is reduced, the ring~$\O_X$ is a field
from the internal point of view, in the sense that
\[ \Sh(X) \models \forall s\?\O_X\_ \neg(\speak{$s$ invertible}) \Rightarrow
s=0. \]
The converse holds as well.\end{cor}
\begin{proof}We can prove this purely in the internal language: It suffices to
give an intuitionistic proof of the fact that a local ring which satisfies the
condition of the previous proposition fulfills the stated field condition if
and only if it is reduced. This is straightforward.
\end{proof}

This field property is very useful. We will put it to good use when giving a
simple proof of the fact that~$\O_X$-modules of finite type on a reduced scheme
are locally free on a dense open subset (proposition~\ref{modules:densefree}).

\begin{itemize}
\item Remark that intuitionistically, the notion of a field bifurcates into
several inequivalent notions
\item discreteness
\end{itemize}

\section{Sheaves of modules}

\subsection{Finite type, finite presentation, coherence}
Recall the conditions of an~$\O_X$-module~$\F$ on a scheme~$X$ (or ringed
space) to be of finite type, of finite presentation and to be coherent:
\begin{itemize}
\item $\F$ is \emph{of finite type} if and only if there exists a covering of~$X$ by
open subsets~$U$ such that on each such~$U$, there exists an exact sequence
\[ (\O_X|_U)^n \longrightarrow \F|_U \longrightarrow 0 \]
of~$\O_X|_U$-modules.
\item $\F$ is \emph{of finite presentation} if and only if there exists a covering of~$X$ by
open subsets~$U$ such that on each such~$U$, there exists an exact sequence
\[ (\O_X|_U)^m \longrightarrow (\O_X|_U)^n \longrightarrow \F|_U \longrightarrow 0. \]
\item $\F$ is \emph{coherent} if and only if~$\F$ is of finite type and the
kernel of any~$\O_X|_U$-linear morphism~$(\O_X|_U)^n \to \F|_U$, $U \subseteq
X$ any open subset, is of finite type.
\end{itemize}

The following proposition gives translations of these definitions into the
internal language.
\begin{prop}Let~$X$ be a scheme (or ringed locale). Let~$\F$ be
an~$\O_X$-module. Then:
\begin{enumerate}
\item $\F$ is of finite type if and only if~$\F$, considered as an ordinary
module from the internal perspective, is finitely generated, i.\,e. if
\[ \Sh(X) \models
  \bigvee_{n \geq 0}
  \exists x_1,\ldots,x_n\?\F\_
  \forall x\?\F\_
  \exists a_1,\ldots,a_n\?\F\_
  x = \textstyle\sum\limits_i a_i x_i. \]
\item $\F$ is of finite presentation if and only if~$\F$ is a finitely
presented module from the internal perspective, i.\,e. if \ldots
\item $\F$ is coherent if and only if \ldots
\end{enumerate}
\end{prop}


\subsection{Tensor product} Recall that the tensor product
of~$\O_X$-modules~$\F$ and~$\G$ on a scheme~$X$ (or ringed space) is usually
constructed as the sheafification of the presheaf
\[ \text{$U \subseteq X$ open} \longmapsto \Gamma(U,\F) \otimes_{\Gamma(U,\O_X)}
\Gamma(U,\G). \]
From the internal point of view,~$\F$ and~$\G$ look like ordinary modules, so
that we can consider their tensor product as usually constructed in
commutative algebra, as a certain quotient of a free module on the elements
of~$\F \times \G$:
\[ \O_X\langle x \otimes y \,|\, x\?\F, y\?\G \rangle / R, \]
where~$R$ is the submodule generated by
\begin{gather*}
  (x+x') \otimes y - x \otimes y - x' \otimes y, \\
  x \otimes (y+y') - x \otimes y - x \otimes y', \\
  (sx) \otimes y - s(x \otimes y), \\
  x \otimes (sy) - s(x \otimes y)
\end{gather*}
with~$x,x'\?\F$, $y,y'\?\G$, $s\?\O_X$.
This internal construction will give rise to the same sheaf
of modules as the externally defined tensor product:

\begin{prop}Let~$X$ be scheme (or a ringed space). Let~$\F$ and~$\G$
be~$\O_X$-modules. Then the internally constructed tensor product~$\F
\otimes_{\O_X} \G$ coincides with the external one.
\end{prop}
\begin{proof}
Since the proof of the corresponding fact of commutative algebra is
intuitionistic, the internally defined tensor product~$\F \otimes_{\O_X} \G$
fulfills the following universal property: For any~$\O_X$-module~$\H$,
any~$\O_X$-bilinear map~$\F \times \G \to \H$ uniquely factors over the
canonical morphism~$\F \times \G \to \F \otimes_{\O_X} \G$.

Interpreting this property with the Kripke--Joyal semantics, we see that the
internally constructed tensor product fulfills the following external property:
For any open subset~$U \subseteq X$ and any~$\O_X|_U$-module~$\H$ on~$U$,
any~$\O_X|_U$-bilinear map~$\F|_U \times \G|_U \to \H$ uniquely factors over the
canonical morphism~$\F \times \G \to (\F \otimes_{\O_X} \G)|_U$.

In particular, for~$U = X$, this property is well-known to be the universal
property satisfied by the externally constructed tensor product. Therefore the
claim follows.
\end{proof}

By the internal construction, a description of the stalks of the tensor product
follows purely by considering the logical form of the construction:
\begin{cor}Let~$X$ be scheme (or a ringed space). Let~$\F$ and~$\G$
be~$\O_X$-modules. Then the stalks of the tensor product coincide with the
tensor products of the stalks: $(\F \otimes_{\O_X} \G)_x \cong \F_x
\otimes_{\O_{X,x}} \G_x$.\end{cor}
\begin{proof}
We constructed the tensor product using the following operations: product of
two sets, free module on a set, quotient module with respect to a submodule;
submodule generated by a set of elements given by a geometric formula.
All of these operations are geometric, so the tensor product construction is
geometric as well. Hence taking stalks commutes with performing the
construction.
\end{proof}

Recall that an~$\O_X$-module~$\F$ is \emph{flat} if and only if all
stalks~$\F_x$ are flat~$\O_{X,x}$-modules. We can characterize flatness in the
internal language.
\begin{prop}Let~$X$ be a scheme (or ringed space). Let~$\F$ be
an~$\O_X$-module. Then~$\F$ is flat if and only if, from the internal
perspective,~$\F$ is a flat~$\O_X$-module.
\end{prop}
\begin{proof}
Recall that flatness of an~$A$-module~$M$ can be characterized without
reference to tensor products by the following condition (using
suggestive vector notation): For any natural number~$p$,
any $p$-tuple~$m \? M^p$ of elements of~$M$ and
any~$p$-tuple $a \? A^p$ of elements of~$A$,
\[
  a^T m = 0 \ \Longrightarrow\ 
  \bigvee\limits_{q \geq 0} \exists n\?M^q, B\?A^{p \times q}\_
  Bn = m \wedge a^T B = 0. \]
% XXX: Is this really constructively equivalent to tensoring being exact?
% Check the details!
This formulation of flatness has the advantage that it is the conjunction of
geometric implications; therefore it holds internally if and only if it holds at
any stalk.
\end{proof}

\begin{itemize}
\item of finite type, of finite presentation, coherent
\item basic lemmas: finite type in exact sequences, filtered colimits,
flatness, \ldots
\item important hard exercise
\item torsion (check Liu p. 174)
\end{itemize}


\section{Upper semicontinuous functions}

\subsection{Interlude on natural numbers}
In classical logic, the natural numbers are complete in the sense that any
inhabited set of natural numbers possesses a minimal element. This statement
can not be proven intuitionistically -- intuitively, this is because one cannot
explicitly pinpoint the (classically existing) minimal element of an arbitrary
inhabited set. In intuitionistic logic, this principle can be salvaged in two
essentially different ways: either be strengthening the premise, or by
weakening the conclusion.
% XXX: Give sheaf-theoretic interpretation of the failure.

\begin{lemma}Let~$U \subseteq \NN$ be an inhabited subset of the natural
numbers.
\begin{enumerate}
\item Assume~$U$ to be \emph{detachable}, i.\,e. assume that for any natural
number~$n$, either~$n \in U$ or~$n \not\in U$. Then~$U$ possesses a minimal
element.
% XXX: Give sheaf-theoretic interpretation of detachability. With this
% interpretation, it should be totally clear that $U$ possesses a minimal
% element.
\item In any case,~$U$ does \emph{not not} possess a minimal element.
\end{enumerate}
\end{lemma}
\begin{proof}
\begin{enumerate}
\item By induction on the witness of inhabitation, i.\,e. the given number~$n$ such
that~$n \in U$. Details omitted, since we will not need this statement.
\item We give a careful proof since logical subtleties matter. To simplify the
exposition, we assume that~$U$ is upward-closed, i.\,e. that any number
larger than some element of~$U$ lies in~$U$ as well. Any subset can be closed
in this way (by considering~$\{ n \in \NN \,|\, \exists m \in U\_ n \geq m \}$)
and a minimal element of the closure will be a minimal element for~$U$ as well.

We induct on the number~$n \in U$ given by the assumption that~$U$ is
inhabited. In the case~$n = 0$ we are done since~$0$ is a minimal element
of~$U$. For the induction step~$n \to n+1$, the weak law of excluded middle
gives
\[ \neg\neg(n \in U \vee n \not\in U). \]
If we can show that~$n \in U \vee n \not\in U$ implies the conclusion, we're
done by XXX. So assume~$n \in U \vee n \not\in U$.
If~$n \in U$, then~$U$ does not not possess a minimal element by the induction
hypothesis. If~$n \not\in U$, then~$n+1$ is a minimal element (and so, in
particular,~$U$ does not not possess a minimal element): For if~$m$ is
any element of~$U$, we have~$m \geq n+1$ or~$m \leq n$. In the first case,
we're done. In the second case, it follows that~$n \in U$ because~$U$ is
upward-closed and so we obtain a contradiction. From this contradiction we can
deduce~$m \geq n+1$. \qedhere
\end{enumerate}
\end{proof}

If we want to work with a complete set of natural numbers in intuitionistic
logic, we have to construction a completion.
\begin{defn}The partially ordered set of \emph{completed natural numbers} is
the set~$\widehat{\NN}$ of all inhabited upward-closed subsets of~$\NN$, ordered by
reverse inclusion.\end{defn}
\begin{lemma}The poset of completed natural numbers is the least partially
ordered set containing~$\NN$ and possessing minima
of arbitrary inhabited subsets.\end{lemma}
\begin{proof}
The embedding $\NN \hookrightarrow \widehat\NN$ is given by
\[ n \in \NN \longmapsto {\uparrow}(n) := \{ m \in \NN \,|\, m \geq n \}. \]
If~$M \subseteq \widehat\NN$ is an inhabited subset, its minimum is
\[ \min M = \bigcup M \in \widehat\NN. \]
The proof of the universal property is left to the reader.
\end{proof}

\begin{rem}In classical logic, the map~$\widehat\NN \to \NN,\ U \mapsto \min U$
is a well-defined isomorphism of partially ordered sets.\end{rem}


\subsection{A geometric interpretation}
We are interested in the completed natural numbers for the following reason: A
completed natural number of the topos of sheaves on a topological space~$X$ is
the same as an upper semicontinuous function~$X \to \NN$.

\begin{lemma}Let~$X$ be a topological space. The sheaf~$\widehat\NN$ of
completed natural numbers on~$X$ is canonically isomorphic to the sheaf of upper
semicontinuous~$\NN$-valued functions on~$X$.\end{lemma}
\begin{proof}
When referring to the natural numbers in the internal language, we actually
refer to the constant sheaf~$\ul{\NN}$ on~$X$. (This is because the
sheaf~$\ul{\NN}$ fulfills the axioms of a natural numbers object,
cf.~\cite[XXX]{johnstone:elephant/moerdijk}.) Recall that its sections on an
open subset~$U \subseteq X$ are continuous functions~$U \to \NN$, where~$\NN$
is equipped with the discrete topology.

Therefore, a section of~$\widehat\NN$ on an open subset~$U \subseteq X$ is
given by a subsheaf~$\A \hookrightarrow \ul{\NN}|_U$ such that
\[ U \models \exists n\?\ul{\NN}\_ n \in \A
  \quad\text{and}\quad
  U \models \forall n,m\?\ul{\NN}\_ n \geq m \wedge n \in \A \Rightarrow m \in
  \A. \]
Since these conditions are geometric, they are satisfied if and only if any
stalk~$\A_x$ is an inhabited upward-closed subset of~$\ul{\NN}_x \cong \NN$.
The association
\[ x \in X \longmapsto \min\{ n \in \NN \,|\, n \in \A_x \} \]
thus defines a map~$X \to \NN$. This map is indeed upper semicontinuous, since
if~$n \in \A_x$, there exists a neighbourhood~$V$ of~$x$ such that the constant
function with value~$n$ is an element of~$\Gamma(V,\A)$ and therefore~$n \in
\A_y$ for all~$y \in V$.

Conversely, let~$\alpha : U \to \NN$ be a upper semi-continous function. Then
\[ \text{$V \subseteq X$ open} \longmapsto \{ f : V \to \NN \,|\, \text{$f$
continuous,\ $f \geq \alpha$ on~$V$} \} \]
is a subobject of~$\ul{\NN}|_U$ which internally is inhabited and upward-closed.
Further details are left to the reader.
\end{proof}

Under the correspondence given by the lemma, locally \emph{constant}
functions map exactly to the (image of the) \emph{ordinary} internal natural numbers
(in the completed natural numbers).

\begin{rem}In a similar vein, the sheaf given by the internal construction of
the set of \emph{all} upward-closed subsets of the natural numbers (not
only the inhabited ones) is canonically isomorphic to the sheaf of
upper semicontinuous functions with values in~$\NN \cup \{ +\infty
\}$.\end{rem}


\subsection{The upper semicontinuous rank function}
Recall that the rank of an~$\O_X$-module~$\F$ on a scheme~$X$ (or
locally ringed space) at a point~$x \in X$ is defined as the~$k(x)$-dimension
of the vector space~$\F_x \otimes_{\O_{X,x}} k(x)$. If we assume that~$\F$ is
of finite type around~$x$, this dimension is finite and equals the minimal
number of elements needed to generate~$\F_x$ as an~$\O_{X,x}$-module (by
Nakayama's lemma).

In the internal language, we can define an element of~$\widehat\NN$ by
\[ \rank\F := \min\{ n \in \NN \,|\, \speak{there is a gen. family
for~$\F$ consisting of~$n$ elements} \} \in \widehat\NN. \]
If~$\F$ is locally finitely free, it will be a finitely free module from the
internal point of view and the rank defined in this way will be an
actual natural number; but in general, the rank is really an element of the
completion.

\begin{prop}
Let~$\F$ be an~$\O_X$-module of finite type on a scheme~$X$ (or locally ringed
space). Under the correspondence given by the previous lemma, the internally
defined rank maps to the rank function of~$\F$.
\end{prop}
\begin{proof}
We have to show that for any point~$x \in X$ and natural number~$n$, there
exists a generating family for~$\F_x$ consisting of~$n$
elements if and only if there exists a neighbourhood~$U$ of~$x$ such that
\[ U \models \speak{there exists a generating family
for~$\F$ consisting of~$n$ elements}. \]
The ``if'' direction is obvious. For the ``only if'' direction, consider
(liftings to local sections of a)
generating family~$s_1,\ldots,s_n$ of~$\F_x$. Since~$\F$ is of finite type,
there also exist sections~$t_1,\ldots,t_m$ on some neighbourhood~$V$ of~$x$ which
generate any stalk~$\F_y$, $y \in V$. Since the~$t_i$ can be expressed as a
linear combination of the~$s_j$ in~$\F_x$, the same is true on some open
neighbourhood~$U \subseteq V$ of~$x$. On this neighbourhood, the~$s_j$ generate
any stalk~$\F_y$, $y \in U$, so we have
\[ U \models \speak{$s_1,\ldots,s_n$ generate~$\F$}. \qedhere \]
\end{proof}
\begin{rem}Once we understand when properties holding at a stalk spread to a
neighbourhood, we will be able to give a simpler proof of the proposition (see
XXX).\end{rem}


\section{Rational functions and Cartier divisors}

\subsection{The sheaf of rational functions} Recall that the sheaf~$\K_X$ of rational
functions on a scheme~$X$ (or ringed space) can be defined as the sheaf
associated to the presheaf
\[ \text{$U \subseteq X$ open} \longmapsto \Gamma(U,\O_X)[\Gamma(U,\S)^{-1}], \]
where~$\Gamma(U,\S)$ is the multiplicative set of those sections of~$\O_X$ on~$U$,
which are regular in each stalk~$\O_{X,x}$, $x \in U$. Recall also there are
some wrong definitions in the literature~\cite{kleiman:misconceptions}.

Using the internal language, we can give a simpler definition of~$\K_X$.
Recall that we can associate to any ring~$R$ its total quotient ring, i.\,e.
its localization at the multiplicative subset of regular elements. Since from
the internal perspective~$\O_X$ is an ordinary ring, we can associate to it its
total quotient ring $\O_X[\S^{-1}]$,
where~$\S$ is internally defined by the formula
\[ \S := \{ s\?\O_X \,|\, \speak{$s$ is regular} \} \subseteq \O_X. \]
Externally, this ring is the sheaf~$\K_X$.
\begin{prop}Let~$X$ be a scheme (or a ringed space). The sheaf of rings defined
in the internal language by localizing~$\O_X$ at its set of regular elements is
(canonically isomorphic to) the sheaf~$\K_X$ of rational functions.
\end{prop}
\begin{proof}Internally, the ring~$\O_X[\S^{-1}]$ fulfills the following
universal property: For any ring~$R$ and any homomorphism~$\O_X \to R$ which
maps the elements of~$\S$ to units, there exists exactly one
homomorphism~$\O_X[\S^{-1}] \to R$ which makes the evident diagram commute.
\[ \xymatrix{
  \O_X \ar[rr] \ar[dr] && R \\
  & \O_X[\S^{-1}] \ar@{-->}[ru]
} \]
The translation using the Kripke--Joyal semantics gives the following universal
property: For any open subset~$U \subseteq X$, any sheaf of rings~$\R$ on~$U$ and any
homomorphism~$\O_X|_U \to \R$ which maps all elements of~$\Gamma(V,\S)$, $V
\subseteq U$ to units, there exists exactly one homomorphism~$\O_X[\S^{-1}]|_U \to
\R$ which makes the evident diagram commute.
It is well-known~\cite{???} that the sheaf~$\K_X$ as usually defined satisfies
this universal property as well.
\end{proof}

\begin{prop}Let~$X$ be a scheme (or ringed space). Then the stalks of~$\K_X$
are given by
\[ \K_{X,x} = \O_{X,x}[\S_x^{-1}]. \]
The elements of~$\S_x$ are exactly the germs of those local sections which are
regular not only in~$\O_{X,x}$, but in all rings~$\O_{X,y}$ where~$y$
ranges over some neighbourhood of~$x$ (depending on the section).\end{prop}
\begin{proof}
Since localization is a geometric construction, the first statement is entirely
trivial. The second statement follows since
\[ \Gamma(U,\S) = \{ s\in\Gamma(U,\O_X) \,|\, U \models \speak{$s$ is regular}
\} \]
and regularity is a geometric implication, so that
$U \models \speak{$s$ is regular}$ if and only iff the germ~$s_y$ is regular
in~$\O_{X,y}$ for all~$y \in U$.
\end{proof}


\subsection{Regularity of local functions}
It is well known that on a locally Noetherian scheme, regularity spreads from
stalks to neighbourhoods, i.\,e. a section of~$\O_X$ is regular
in~$\O_{X,x}$ if and only if it is regular on some neighbourhood on~$x$.
This fact has a simple proof in the internal language:
\begin{prop}Let~$X$ be a locally Noetherian scheme. Let~$s \in \Gamma(U,\O_X)$
be a local function on~$X$. Let~$x \in U$. Then the following statements are
equivalent:
\begin{enumerate}
\item The section~$s$ is regular in~$\O_{X,x}$.
\item The section~$s$ is regular in all local rings~$\O_{X,y}$ where~$y$ ranges
over some neighbourhood of~$x$.
\end{enumerate}
\end{prop}
\begin{proof}
Let~$\Box$ be the modal operator defined by~$\Box(\varphi) :\equiv ((\varphi
\Rightarrow {!x}) \Rightarrow {!x})$. By XXX, we are to show that the following
statements of the internal language
are equivalent:
\begin{enumerate}
\item $(\speak{$s$ is regular})^\Box$, i.\,e.
$\forall t\?\O_X\_ st = 0 \Rightarrow \Box(t = 0)$.
\item $\Box(\speak{$s$ is regular})$, i.\,e.
$\Box(\forall t\?\O_X\_ st = 0 \Rightarrow t = 0)$.
\end{enumerate}
It is clear that the second statement implies the first -- in fact, this is true
without any assumptions on~$X$: Let~$t\?\O_X$ be such that~$st = 0$. Since we want to
prove the boxed statement~$\Box(t=0)$, we may assume that~$s$ is regular and
prove~$t = 0$. This follows by definition.

For the converse direction, consider the annihilator of~$s$, i.\,e. the ideal
\[ I := \Ann_{\O_X}(s) = \{ t\?\O_X \,|\, st = 0 \} \subseteq \O_X. \]
This ideal satisfies the quasicoherence condition (proposition~XXX):
Let~$f:\O_X$ be arbitrary and assume~$\speak{$f$ inv.} \Rightarrow t \in I$.
By~XXX (here the assumption that~$X$ is a scheme enters) it follows that~$f^n
st = 0$ for some~$n\?\NN$, i.\,e. that~$f^n t \in I$.
% XXX: refer to example in the section on quasicoherence

Thus~$I$ is a quasicoherent submodule of a finitely generated module. Since~$X$ is
locally Noetherian, it follows that~$I$ is finitely generated as well. By
assumption, each generator~$x_i \in I$ fulfills~$\Box(x_i = 0)$. Since we want
to prove a boxed statement, we may in fact assume~$x_i = 0$. Thus~$I = (0)$ and
the assertion, that~$s$ is regular, follows.
\end{proof}

\begin{cor}Let~$X$ be a locally Noetherian scheme. Then the stalks~$\K_{X,x}$
of the sheaf of rational functions are given by the total quotient rings of the
local rings~$\O_{X,x}$.\end{cor}


\subsection{Geometric interpretation of the sheaf of rational functions}

\begin{itemize}
\item on reduced schemes, $\K_X$ is the sheaf of meromorphic functions
\item show~$\K_X = j_*(\O_X)$?
\item internal definition of Cartier divisors
\item correspondence between Cartier divisors and sub-$\O_X$-modules of $\K_X$
\end{itemize}


\section{Relative spectrum}
\begin{itemize}
\item ...
\end{itemize}

\section{Modalities}

\subsection{Basics on truth values and modal operators}

\begin{defn}The \emph{set of truth values~$\Omega$} is the powerset of the
singleton set~$1 := \{\star\}$, where~$\star$ is a formal symbol.\end{defn}

In classical logic, any subset of~$\{\star\}$ is either empty or inhabited, so
that~$\Omega$ contains exactly two elements, the empty set (``false'')
and~$\{\star\}$ (``true''). But
in intuitionistic logic, this can not be shown; indeed, if we interpret the
definition in the topos of sheaves on a space~$X$, we obtain a sheaf~$\Omega$
with
\[ \text{$U \subseteq X$ open} \longmapsto \Gamma(V,\Omega) = \{ V \subseteq U \,|\, \text{$V$
open} \}. \]
(This is because sections of~$\Omega$ on an open subset~$U$ correspond to
subsheaves~$\F \hookrightarrow 1|_U$ of the restriction of the terminal sheaf
to~$U$, and those are given by the greatest open subset~$V \subseteq U$ such
that~$\Gamma(V,\F)$ is inhabited.)

The \emph{truth value} of a formula~$\varphi$ is by definition the subset
$\{ x \in 1 \,|\, \varphi \} \in \Omega$, where~``$x$'' is a fresh variable not
appearing in~$\varphi$. This subset is inhabited if and only
if~$\varphi$ holds and is empty if and only if~$\neg\varphi$ holds.
Conversely, we can associate to a subset~$F \subseteq 1$ the
formula~$\speak{$F$ is inhabited}$.

Under this correspondence of formulas with truth values, logical operations
like~$\wedge$ and~$\vee$ map to set-theoretic operations like~$\cap$ and~$\cup$
-- for instance, we have
\[ \{ x \in 1 \,|\, \varphi \} \cap \{ x \in 1 \,|\, \psi \} =
  \{ x \in 1 \,|\, \varphi \wedge \psi \}. \]
This justifies a certain abuse of notation: We will sometimes treat elements
of~$\Omega$ as propositions and use logical instead of set-theoretic
connectives. In particular, if~$\varphi$ and~$\psi$ are elements of~$\Omega$,
we will write~``$\varphi \Rightarrow \psi$'' to mean~$\varphi \subseteq \psi$;
``$\bot$'' to mean~$\emptyset$; and~``$\top$'' to mean~$1$.

\begin{defn}A \emph{modal operator} is a map~$\Box : \Omega \to \Omega$ such
that for all~$\varphi, \psi \in \Omega$,
\begin{enumerate}
\item $\varphi \Longrightarrow \Box\varphi$,
\item $\Box\Box\varphi \Longrightarrow \varphi$,
\item $\Box(\varphi \wedge \psi) \Longleftrightarrow \Box\varphi \wedge \Box\psi$.
\end{enumerate}
\end{defn}

The intuition is that~$\Box\varphi$ is a certain weakening of~$\varphi$, where
the precise meaning of ``weaker'' depends on the modal operator.

In classical logic, where~$\Omega = \{ \bot, \top \}$, there are only two modal
operators: the identity function and the constant function with value~$\top$.
Both of these are not very interesting: The identity operator does not weaken
propositions at all, while the constant operator weakens every proposition to
the trivial statement~$\top$.

In intuitionistic logic, there can potentially exist further modal operators.
For applications to algebraic geometry, the following four operators will have
a clear geometric meaning and be of particular importance:
\begin{enumerate}
\item $\Box\varphi :\equiv (\alpha \Rightarrow \varphi)$, where~$\alpha$ is a
fixed proposition.
\item $\Box\varphi :\equiv (\varphi \vee \alpha)$, where~$\alpha$ is a
fixed proposition.
\item $\Box\varphi :\equiv \neg\neg\varphi$ (the \emph{double negation
modality}).
\item $\Box\varphi :\equiv ((\varphi \Rightarrow \alpha) \Rightarrow \alpha)$,
where~$\alpha$ is a fixed proposition.
\end{enumerate}

\begin{lemma}Any modal operator~$\Box$ is monotonic, i.\,e. if~$\varphi
\Rightarrow \psi$, then~$\Box\varphi \Rightarrow \Box\psi$. Furthermore, there
holds a modus ponens rule: If~$\Box\varphi$ holds, and~$\varphi$
implies~$\Box\psi$, then~$\Box\psi$ holds as well.\end{lemma}
\begin{proof}Assume~$\varphi \Rightarrow \psi$. This is equivalent to
supposing~$\varphi \wedge \psi \Leftrightarrow \varphi$. We are to show
that~$\Box\varphi \Rightarrow \Box\psi$, i.\,e. that~$\Box\varphi \wedge
\Box\psi \Leftrightarrow \Box\varphi$. The statement follows since by the third
axiom on a modal operator, we have~$\Box\varphi \wedge \Box\psi \Leftrightarrow
\Box(\varphi \wedge \psi)$.

For the second statement, consider that if~$\varphi \Rightarrow \Box\psi$, by
monotonicity and the second axiom on a modal operator it follows
that~$\Box\varphi \Rightarrow \Box\Box\psi \Rightarrow \Box\psi$.
\end{proof}

The modus ponens rule justifies the following proof scheme: In showing
that a boxed statement~$\Box\psi$ holds given that a further boxed
statement~$\Box\varphi$ holds, we may assume that indeed~$\varphi$ holds.

\begin{itemize}
\item general explanation of modalities (as for instance in philosophy)
\item define modal operators as certain maps~$\Omega \to \Omega$;
explain that classically, there are only two such operators (both not
interesting), but that internal to a sheaf topos, there are many interesting
such operators
\item introduce the notation~$X_\Box$; explain the relationship
between~$\Sh(X_\Box)$ and~$\Sh(X)$ (given by pushforward/pullback resp.
forget/sheafify from the internal perspective)
\item explain the meaning of $U \models \Box\varphi$
\item introduce the~$\Box$-translation; give basic lemmas
\item explain that~$\Sh(X) \models \varphi^\Box$ iff~$\Sh(X_\Box) \models
\varphi$; specialize to the four most important modal operators~($\neg\neg$, $U
\Rightarrow \placeholder$, $\placeholder \vee A^c$, $(\placeholder \Rightarrow
!x) \Rightarrow !x$)
\item spreading of properties from stalk to neighbourhood: give general
metatheorem for geometric statements; give many examples
\item internal sheafification? To what extent is a description necessary?
Contemplate what I want to say about the geometric meaning of~$\K_X$
\end{itemize}


\section{Quasicoherent sheaves of modules}

Recall that an~$\O_X$-module~$\F$ on a ringed space~$X$ is \emph{quasicoherent}
if and only if there exists a covering of~$X$ by open subsets~$U$ such that on
each such~$U$, there exists an exact sequence
\[ (\O_X|_U)^J \longrightarrow (\O_X|_U)^I \longrightarrow \F|_U \longrightarrow 0 \]
of~$\O_X|_U$-modules, where~$I$ and~$J$ are arbitrary sets (which may depend
on~$U$).

If~$X$ is indeed a scheme, quasicoherence can also be characterized in
terms of inclusions of distinguished open subsets of affines:
An~$\O_X$-module~$\F$ is quasicoherent if and only if for any open affine
subscheme~$U = \Spec A$ of~$X$ and any function~$f \in A$, the canonical map
\[ \Gamma(U,\F)[f^{-1}] \longrightarrow \Gamma(D(f),\F),\ 
  \tfrac{s}{f^n} \longmapsto f^{-n} s|_{D(f)} \]
is an isomorphism of~$A[f^{-1}]$-modules. Here~$D(f) \subseteq U$ denotes the
standard open subset~$\{ \ppp \in \Spec A \,|\, f \not\in \ppp \}$. Both
conditions can be internalized.

\begin{prop}Let~$X$ be a ringed space. Let~$\F$ be an~$\O_X$-module. Then~$\F$
is quasicoherent if and only if
\[ \Sh(X) \models \exists I,J\ \mathrm{lc}\_ \speak{there exists an
  exact sequence~$\O_X^J \to \O_X^I \to \F \to 0$}. \]
The ``\textnormal{lc}'' indicates that when interpreting this internal statement with the
Kripke--Joyal semantics,~$I$ and~$J$ should only be instantiated with
\emph{locally constant} sheaves.
\end{prop}
\begin{proof} We only sketch the proof.
The translation of the internal statement is that there exists a covering
of~$X$ by open subsets~$U$ such that for each such~$U$, there exist sets~$I,J$
and an exact sequence
\[ (\O_X|_U)^{\ul{J}} \longrightarrow (\O_X|_U)^{\ul{I}} \longrightarrow \F|_U
\longrightarrow 0 \]
where~$\ul{I}$ and~$\ul{J}$ are the constant sheaves associated to~$I$
respectively~$J$. The term~``$(\O_X|_U)^{\ul{I}}$'' refers to the internally
defined free~$\O_X$-module with basis the elements of~$\ul{I}$. By exploiting
that~$\ul{I}$ is a discrete set from the internal point of view (i.\,e. any two
elements are either equal or not), one can show that this is the same
as~$(\O_X|_U)^I$; similarly for~$J$. With this observation, the statement
follows.
\end{proof}

In practice, the internal condition given by the proposition is not very
useful, since at the moment, we do not know of any internal characterization of
locally constant sheaves. The internal condition given by the following
proposition does not have this defect.

\begin{prop}\label{qcoh:sheafchar}
Let~$X$ be scheme. Let~$\F$ be an~$\O_X$-module. Then~$\F$ is
quasicoherent if and only if, from the internal perspective, the localized
module~$\F[f^{-1}]$ is a sheaf for the modal operator~$(\speak{$f$ inv.}
\Rightarrow \placeholder)$ for any~$f\?\O_X$.
\end{prop}

In detail, the internal condition is that for any~$f\?\O_X$, it holds that
\[ \forall s\?\F[f^{-1}]\_
  (\speak{$f$ inv.} \Rightarrow s = 0) \Longrightarrow s = 0 \]
and for any subsingleton~$S \subseteq \F[f^{-1}]$ it holds that
\[ (\speak{$f$ inv.} \Rightarrow \speak{$S$ inhabited}) \Longrightarrow
  \exists s\?\F[f^{-1}]\_
  (\speak{$f$ inv.} \Rightarrow s \in S). \]
Unlike with the internalizations of finite type, finite presentation and
coherence, this condition is \emph{not} a standard condition of commutative
algebra. In fact, in classical logic, this condition is always satisfied --
for trivial logical reasons if~$f$ is invertible and because~$\F[f^{-1}]$ is
the zero module if~$f$ is not invertible (since then, it's nilpotent). This is
to be expected: \emph{Any} module~$M$ in commutative algebra is quasicoherent in
the sense that the associated sheaf of modules~$M^\sim$ is quasicoherent.
% XXX: More to the point, commutative algebra does not deal with
% quasicoherence, since quasicoherence is an interesting condition only on on
% arbitrary schemes, not on affine schemes.

The proof will explain the origin of this condition.

\begin{proof}[Proof of proposition~\ref{qcoh:sheafchar}]\ldots\end{proof}

\begin{cor}Let~$X$ be a scheme. Let~$\F$ be a quasicoherent~$\O_X$-module.
Let~$\G \subseteq \F$ be a submodule. Then~$\G$ is quasicoherent if and only
if
\[ \Sh(X) \models \forall f\?\O_X\_
  \forall s\?\F\_
  (\speak{$f$ inv.} \Rightarrow s \in \G) \Longrightarrow
  \bigvee_{n \geq 0} f^n s \in \G. \]
\end{cor}
\begin{proof}We can give a purely internal proof. Let~$f\?\O_X$.
Since subpresheaves of separated sheaves are separated, the module~$\G[f^{-1}]$
is in any case separated with respect to the modal operator~$(\speak{$f$ inv.}
\Rightarrow \placeholder)$.

Now suppose that~$\G$ is quasicoherent. Let~$f\?\O_X$. Let $s\?\F$ and assume that
if~$f$ were invertible,~$s$ would be an element of~$\G$. Define the
subsingleton~$S := \{ t\?\G[f^{-1}] \,|\, \speak{$f$ inv.} \wedge t=s/1 \}$.
Then~$S$ would be inhabited by~$s/1$ if~$f$ were invertible. Since~$\G[f^{-1}]$
is a sheaf, it follows that there exists an element~$u/f^n$ of~$\G[f^{-1}]$
such that, if~$f$ were invertible, it would be the case that~$u/f^n = s/1 \in
\G[f^{-1}] \subseteq \F[f^{-1}]$.
Since~$\F[f^{-1}]$ is separated, it follows that it actually holds that~$u/f^n
= s/1 \in \F[f^{-1}]$. Therefore there exists~$m\?\NN$ such that $f^m f^n s =
f^m u \in \F$. Thus~$f^{m+n} s$ is an element of~$\G$.

For the converse direction, assume that~$\G$ fulfills the stated condition.
Let$f\?\O_X$. Let~$S \subseteq \G[f^{-1}]$ be a subsingleton which would be
inhabited if~$f$ were invertible. By regarding~$S$ as a subset of~$\F[f^{-1}]$,
it follows that there exists an element~$u/f^n \in \F[f^{-1}]$ such that,
if~$f$ were invertible, $u/f^n$ would be an element of~$S$. In particular,~$u$
would be an element of~$\G$. By assumption
it follows that there exists~$m\?\NN$ such that~$f^m u \in G$. Thus~$(f^m u) /
(f^m f^n)$ is an element of~$\G[f^{-1}]$ such that, if~$f$ were invertible, it
would be an element of~$S$.
\end{proof}

\begin{ex}Let~$X$ be a scheme and~$s$ be a global section of~$\O_X$. Then the
annihilator of~$s$, i.\,e. the sheaf of ideals internally defined by the
formula
\[ I := \Ann_{\O_X}(s) = \{ t\?\O_X \,|\, st = 0 \} \subseteq \O_X \]
is quasicoherent. To prove this in the internal language, it suffices to
verify the condition of the proposition.
So let~$f:\O_X$ be arbitrary and assume~$\speak{$f$ inv.} \Rightarrow t \in I$,
i.\,e. assume that if~$f$ were invertible,~$st$ would be zero. By~XXX it
follows that~$f^n st = 0$ for some~$n\?\NN$, i.\,e. that~$f^n t \in I$.
\end{ex}

\begin{itemize}
\item is the condition good enough to show that modules of finite type are
quasicoherent? To show that cokernels are quasicoherent?
\item discussion meaning of the sheaf condition in external language
\item give more examples: $\sqrt{(0)}$, $(h)$, \ldots
\item Noetherian hypotheses: for example, that any quasicoherent submodule of a
module of finite type is of finite type as well
\end{itemize}


\section{Unsorted}
\begin{itemize}
\item ``functoriality''
\item Khler differentials
\item closed and open subschemes
\item reduced closed subscheme
\item Koszul resolution
\item meta properties, uses (e.g. nilpotent on stalks iff globally nilpotent,
some lemmas about limits of modules)
\item locally small categories
\item big Zariski topos
\item open/closed immersions
\item morphisms of schemes...
\item proper maps...
\item limits and colimits...
\item related work: Mulvey/Burden, Wraith, Vickers, the Bohr topos crew, Awodey, ...
\end{itemize}

\end{document}

XXX: ``completed natural number'' is a misnomer.

XXX: standardize level of generality: ringed locales, where possible?
