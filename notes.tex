\documentclass[10pt]{amsart}
\usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\usepackage{amsmath,amsthm,amssymb,stmaryrd,color,graphicx,multirow}
\usepackage{setspace}
\usepackage{bussproofs}
\usepackage{array}
\usepackage{comment}
\usepackage[protrusion=true,expansion=true]{microtype}
\usepackage{hyperref}
\usepackage[all]{xy}

\usepackage{tikz}
\usetikzlibrary{calc,shapes.callouts,shapes.arrows}
\newcommand{\hcancel}[5]{%
    \tikz[baseline=(tocancel.base)]{
        \node[inner sep=0pt,outer sep=0pt] (tocancel) {#1};
        \draw[red, line width=0.3mm] ($(tocancel.south west)+(#2,#3)$) -- ($(tocancel.north east)+(#4,#5)$);
    }%
}

\theoremstyle{definition}
\newtheorem{defn}{Definition}[section]
\newtheorem{ex}[defn]{Example}

\theoremstyle{plain}

\newtheorem{prop}[defn]{Proposition}
\newtheorem{cor}[defn]{Corollary}
\newtheorem{lemma}[defn]{Lemma}
\newtheorem{thm}[defn]{Theorem}

\theoremstyle{remark}
\newtheorem{rem}[defn]{Remark}

\newcommand{\ZZ}{\mathbb{Z}}
\newcommand{\FF}{\mathbb{F}}
\renewcommand{\AA}{\mathbb{A}}
\newcommand{\A}{\mathcal{A}}
\newcommand{\C}{\mathcal{C}}
\newcommand{\D}{\mathcal{D}}
\newcommand{\E}{\mathcal{E}}
\newcommand{\F}{\mathcal{F}}
\newcommand{\G}{\mathcal{G}}
\renewcommand{\H}{\mathcal{H}}
\renewcommand{\O}{\mathcal{O}}
\newcommand{\K}{\mathcal{K}}
\renewcommand{\P}{\mathcal{P}}
\newcommand{\R}{\mathcal{R}}
\renewcommand{\S}{\mathcal{S}}
\newcommand{\NN}{\mathbb{N}}
\newcommand{\RR}{\mathbb{R}}
\newcommand{\QQ}{\mathbb{Q}}
\newcommand{\GG}{\mathbb{G}}
\newcommand{\ppp}{\mathfrak{p}}
\newcommand{\Hom}{\mathrm{Hom}}
\newcommand{\HOM}{\mathcal{H}\mathrm{om}}
\newcommand{\id}{\mathrm{id}}
\newcommand{\Aut}[1]{\operatorname{Aut}(#1)}
\newcommand{\GL}{\mathrm{GL}}
\newcommand{\placeholder}{\underline{\quad}}
\newcommand{\ul}[1]{\underline{#1}}
\newcommand{\Set}{\mathrm{Set}}
\newcommand{\Grp}{\mathrm{Grp}}
\newcommand{\Vect}{\mathrm{Vect}}
\newcommand{\Sh}{\mathrm{Sh}}
\newcommand{\PSh}{\mathrm{PSh}}
\newcommand{\Zar}{\mathrm{Zar}}
\newcommand{\Sch}{\mathrm{Sch}}
\DeclareMathOperator{\Spec}{Spec}
\DeclareMathOperator{\colim}{colim}
\DeclareMathOperator{\rank}{rank}
\DeclareMathOperator{\Ann}{Ann}
\DeclareMathOperator{\Int}{int}
\DeclareMathOperator{\Clos}{cl}
\DeclareMathOperator{\Kernel}{ker}
\newcommand{\Open}{\mathrm{Op}}
\newcommand{\?}{\,{:}\,}
\renewcommand{\_}{\mathpunct{.}\,}
\newcommand{\speak}[1]{\ulcorner\text{\textnormal{#1}}\urcorner}
\newcommand{\Ll}{:\Longleftrightarrow}
\newcommand{\notat}[1]{{!#1}}
\newcommand{\lra}{\longrightarrow}
\newcommand{\brak}[1]{{\llbracket{#1}\rrbracket}}

\definecolor{gray}{rgb}{0.7,0.7,0.7}

\title{Using the internal language of toposes in algebraic geometry}
\author{Ingo Blechschmidt}
\email{iblech@web.de}

\begin{document}

\begin{abstract}
  There are several important topoi associated to a scheme, for instance the
  petit and gros Zariski topoi. These support an internal mathematical language
  which closely resembles the usual formal language of mathematics, but is ``local
  on the base scheme'':

  For example, from the internal perspective, the structure sheaf looks like an
  ordinary local ring (instead of a sheaf of rings with local stalks) and vector
  bundles look like ordinary free modules (instead of sheaves of modules
  satisfying a certain condition). The translation of internal statements and
  proofs is facilitated by an easy mechanical procedure.

  These expository notes give an introduction to this topic and show how the internal
  point of view can be exploited to give simpler definitions and more conceptual
  proofs of the basic notions and observations in algebraic geometry. No prior
  knowledge about topos theory and formal logic is assumed.
\end{abstract}

\maketitle

\tableofcontents

\section{Introduction}

A \emph{topos} is a category which shares certain categorical properties with
the category of sets; the archetypical example is the the category of sets, and
the most important example for the purposes of these notes is the category of
set-valued sheaves on a topological space.

Any topos~$\E$ supports an \emph{internal language}. This is a device which
allows one to \emph{pretend} that the objects of~$\E$ are plain sets and that
the morphisms are plain maps between sets, even if in fact they are not. For
instance, consider a morphism~$\alpha : X \to Y$ in~$\E$. From the \emph{internal
point of view}, this looks like a map between sets, and we can formulate the
condition that this map is surjective; we write this as
\[ \E \models \forall y\?Y\_ \exists x\?X\_ \alpha(x) = y. \]
The appearance of the colons instead of the usual element signs remind us that
this expression is not to be taken literally --~$X$ and~$Y$ are objects of~$\E$
and thus not necessarily sets. The definition of the internal language is made
in such a way so that the meaning of this internal statement is that~$\alpha$
is an epimorphism. Similarly, the translation of the internal statement
that~$\alpha$ is injective is that~$\alpha$ is a monomorphism.

Furthermore, we can \emph{reason} with the internal language. There is a
metatheorem to the effect that if some statement~$\varphi$ holds from the
internal point of view of a topos~$\E$ and if~$\varphi$ logically implies some
further statement~$\psi$, then~$\psi$ holds in~$\E$ as well. As a simple
example, consider the elementary fact that the composition of surjective maps
is surjective. Interpreting this statement in the internal language of~$\E$, we
obtain the more abstract result that the composition of epimorphisms in~$\E$ is
epic.

There is, however, a slight caveat to this metatheorem. Namely, the internal
language of a topos is in general only \emph{intuitionistic}, not
\emph{classical}. This means that internally, one can not use the law of
excluded middle~($\varphi \vee \neg\varphi$), nor the law of double negation
elimination~($\neg\neg\varphi \Rightarrow \varphi$), nor the axiom of choice.
For instance, one rendition of the axiom of choice is that any surjection
splits. But it need not be the case that an epimorphism in a general topos
splits.
% XXX: the translation of splitting would be that locally (!), there is a right
% inverse.

We apply this internal language to algebraic geometry as follows. If~$X$ is a
scheme, the structure sheaf~$\O_X$ is a sheaf of rings, i.\,e. the sets of
local sections carry ring structures and these ring strictures are compatible
with restriction. From the internal point of view of the topos of set-valued
sheaves on~$X$,~$\O_X$ looks much simpler: It looks just like a plain ring (and
not a sheaf of rings). Similarly, a sheaf of~$\O_X$-modules looks just like a
plain module over that ring.

This allows to import notions and facts from basic linear and commutative
algebra into the sheaf setting. For instance, it turns out that a sheaf
of~$\O_X$-modules is of finite type if and only if, from the internal
perspective, it is finitely generated as an~$\O_X$-module. Now consider the
following fact of linear algebra: If in a short exact sequence of modules the two
outer ones are finitely generated, then the middle one is too. The usual proof of
this fact is intuitionistically acceptable and can thus be interpreted in the
internal language. It then \emph{automatically} yields the following more advanced
proposition: If in a short exact sequence of sheaves of~$\O_X$-modules the
two outer ones are of finite type, then the middle one is too.

The internal language machinery thus allows us to understand the basic notions
and statements of scheme theory as notions and statements of linear and
commutative algebra, interpreted in a suitable sheaf topos. This brings
conceptual clarity and reduces technical overhead.

In these notes, we explain how the internal language works and then develop a
\emph{dictionary} between common notions of scheme theory and corresponding
notions of algebra. Once built, this dictionary can be used arbitrarily often.

Two highlights of our approach are the following. Let~$X$ be a reduced scheme
and~$\F$ a sheaf of~$\O_X$-modules of finite type. Then it is well-known
that~$\F$ is locally free on some dense open subset of~$X$; for instance, this
is stated in Vakil's lecture notes as an ``important hard
exercise''~\cite[exercise~13.7.K]{vakil}. In fact, this fact is just the
interpretation of the following statement of intuitionistic linear algebra in
the sheaf topos: Any finitely generated vector space is \emph{not not} free.
The proof of this statement is entirely straightforward.\footnote{Intuitionistically,
the statement that any finitely generated vector space is free is stronger than
the doubly negated version and can not be shown. It would imply that any sheaf
of finite type is not only locally free on some dense open subset, but locally
free on the whole space.}

The second highlight is that we can shed light on the phenomenon that
sometimes, truth of a property at a point~$x$ spreads to some open
neighbourhood of~$x$; and in particular that sometimes, truth of a property at
the generic point spreads to some dense open subset. For instance, if the stalk
of a sheaf of finite type is zero at some point, the sheaf is even zero on some
open neighbourhood; but this spreading does not occur for general sheaves which
may fail to be of finite type.

We formalize this by introducing a \emph{modal operator}~$\Box$ into the
internal language, such that the internal statement~$\Box\varphi$ means
that~$\varphi$ holds on some open neighbourhood of~$x$. Furthermore, we
introduce a simple operation on formulas, the~\emph{$\Box$-translation}
$\varphi \mapsto \varphi^\Box$, such that~$\varphi^\Box$ means that~$\varphi$
holds at the point~$x$. The question whether truth at~$x$ spreads to truth on a
neighbourhood can thus be formulated in the following way: Does~$\varphi^\Box$
intuitionistically imply~$\Box\varphi$?

This allows to deal with the question in a simpler, more logical way, with the
technicalities of sheaves blinded out. We can also give a metatheorem which
covers a wide range of cases. Namely, spreading occurs for all those properties
which can be formulated in the internal language without
using~``$\Rightarrow$'',~``$\forall$'', and~``$\neg$''.

To illustrate the example above, consider that the property of a module~$\F$ being
the zero module is formulated as~$(\forall x\?\F\_ x = 0)$ in the internal
language. Because of the appearance of~``$\forall$'', the metatheorem is not
applicable to this statement. But if~$\F$ is of finite type, there are
generators~$x_1,\ldots,x_n\?\F$ from the internal point of view, and the
condition can be reformulated as~$x_1 = 0 \wedge \cdots \wedge x_n = 0$; the
metatheorem is applicable to this statement.

%Of particular importance is the
%case~$\Box\varphi :\equiv ((\varphi \Rightarrow \notat{x}) \Rightarrow
%\notat{x})$ where~$x \in X$ is a point, since for this modal operator, the
%proposition specializes to
%\[ \Sh(X) \models \varphi^\Box \quad\text{iff}\quad
%  \text{$\varphi$ holds at~$x$}. \]
%Thus the question whether truth of a proposition~$\varphi$ at a point~$x$ spreads
%to a neighbourhood of~$x$ can be formulated in the following way:
%\emph{Does~$\varphi^\Box$ imply~$\Box\varphi$?} We can give a general
%answer to this question.

\begin{itemize}
\item explain concept of an internal language; mottos: notions of scheme theory
are notions of linear algebra, interpreted in a suitable topos; (some) statements of
scheme theory are statements of linear algebra, interpreted in a suitable
topos; dictionary; intuitionistic logic; microscope/telescope into another
universe; types instead of sets; (dependent types to encompass almost all
mathematics)
\item explain highlights: hard exercise, spreading of truth
\item explain that with the internal language business, it becomes more
transparent where scheme condition enters
\item discuss limitations (here or somewhere else)
\item give pointers to introductory literature
\end{itemize}


\section{The internal language of a sheaf topos}

\subsection{Internal statements}
Let~$X$ be a topological space. Later, $X$ will be the underlying space of a
scheme. The meaning of internal statements is given by a set of rules, the
\emph{Kripke--Joyal semantics} of the topos of sheaves on~$X$.

\begin{defn}The meaning of 
\[ U \models \varphi \quad\text{(``$\varphi$ holds on $U$'')} \]
for open subsets~$U \subseteq X$ and formulas~$\varphi$ over~$U$ is given by
the rules listed in table~\ref{table:kripke-joyal}, recursively in the structure of~$\varphi$.
In a \emph{formula over~$U$} there may appear sheaves defined on~$U$ as domains
of quantifications,~$U$-sections of sheaves as terms and morphisms of sheaves
on~$U$ as function symbols. The symbols~``$\top$'' and~``$\bot$'' denote truth
and falsehold, respectively. The universal and existential quantifiers come in
two flavors: for bounded and unbounded quantification.
The translation of~$U \models \neg\varphi$ does not have to be defined, since
negation can be expressed using other symbols: $\neg\varphi :\equiv (\varphi
\Rightarrow \bot)$. If we want to emphasize the particular topos, we write
\[ \Sh(X) \models \varphi \quad\Ll\quad X \models \varphi. \]
\end{defn}

\begin{table}
  \centering
  \[ \renewcommand{\arraystretch}{1.3}\begin{array}{@{}lcl@{}}
    U \models s = t \? \F &\Ll& s|_U = t|_U \in \Gamma(U, \F) \\
    U \models s \in \G &\Ll& s|_U \in \Gamma(U,\G) \quad\quad\text{($\G$ a
    subsheaf of~$\F$, $s$ a section of~$\F$)} \\
    U \models \top &\Ll& U = U \text{ (always fulfilled)} \\
    U \models \bot &\Ll& U = \emptyset \\
    U \models \varphi \wedge \psi &\Ll&
      \text{$U \models \varphi$ and $U \models \psi$} \\
    U \models \bigwedge_{j \in J} \varphi_j &\Ll&
      \text{for all~$j \in J$: $U \models \varphi_j$} \quad\quad\text{($J$ an
      index set)} \\
    U \models \varphi \vee \psi &\Ll&
      \hcancel{\text{$U \models \varphi$ or $U \models \psi$}}{0pt}{3pt}{0pt}{-2pt} \\
    && \text{there exists a covering $U = \bigcup_i U_i$ such that for all~$i$:} \\
    && \quad\quad \text{$U_i \models \varphi$ or $U_i \models \psi$} \\
    U \models \bigvee_{j \in J} \varphi_j &\Ll&
      \hcancel{\text{$U \models \varphi_j$ for some~$j \in J$}}{0pt}{3pt}{0pt}{-2pt}
      \quad\quad\text{($J$ an index set)} \\
    && \text{there exists a covering $U = \bigcup_i U_i$ such that for all~$i$:} \\
    && \quad\quad \text{$U_i \models \varphi_j$ for some~$j \in J$} \\
    U \models \varphi \Rightarrow \psi &\Ll&
      \text{for all open~$V \subseteq U$:
      $V \models \varphi$ implies $V \models \psi$} \\
    U \models \forall s \? \F\_ \varphi(s) &\Ll&
      \text{for all sections~$s \in \Gamma(V, \F)$, open $V \subseteq U$: $V \models
      \varphi(s)$} \\
    U \models \exists s \? \F\_ \varphi(s) &\Ll&
      \hcancel{\text{there exists a section~$s \in \Gamma(U,\F)$ such that $U
      \models \varphi(s)$}}{0pt}{3pt}{0pt}{-2pt} \\
    &&
      \text{there exists an open covering $U = \bigcup_i U_i$ such that for all~$i$:} \\
    && \quad\quad \text{there exists~$s_i \in \Gamma(U_i, \F)$ such that
    $U_i \models \varphi(s_i)$} \\
    U \models \forall \F\_ \varphi(\F) &\Ll&
      \text{for all sheaves $\F$ on $V$, open $V \subseteq U$: $V \models \varphi(\F)$} \\
    U \models \exists \F\_ \varphi(\F) &\Ll&
      \text{there exists an open covering $U = \bigcup_i U_i$ such that for all~$i$:} \\
    && \quad\quad \text{there exists a sheaf~$\F_i$ on~$U_i$ such that
    $U_i \models \varphi(\F_i)$}
  \end{array} \]
  \caption{\label{table:kripke-joyal}The Kripke--Joyal semantics of a sheaf
  topos.}
\end{table}

\begin{rem}The last two rules in table~\ref{table:kripke-joyal}, concerning
\emph{unbounded quantification}, and are not part of the classical Kripke--Joyal
semantics, but instead of Mike Shulman's stack semantics~\cite{shulman:stack},
a slight extension. They are needed so that we can formulate universal
properties in the internal language.
\end{rem}

\begin{ex}Let~$\alpha : \F \to \G$ be a morphism of sheaves on~$X$. Then
$\alpha$ is a monomorphism of sheaves if and only if, from the internal
perspective,~$\alpha$ is simply an injective map:
\begin{align*}
  & X \models \speak{$\alpha$ is injective} \\[0.5em]
  \Longleftrightarrow\
  & X \models \forall s\?\F\_ \forall t\?\F\_ \alpha(s) = \alpha(t) \Rightarrow s = t \\[0.5em]
  \Longleftrightarrow\ &
    \text{for all open~$U \subseteq X$, sections $s \in \Gamma(U, \F)$:} \\
  & \text{for all open~$V \subseteq U$, sections $t \in \Gamma(V, \F)$:} \\
  &\qquad\qquad
      V \models \alpha(s) = \alpha(t) \Rightarrow s = t \\[0.5em]
  \Longleftrightarrow\ &
    \text{for all open~$U \subseteq X$, sections $s, t \in \Gamma(U, \F)$:} \\
  &\qquad\qquad
      U \models \alpha(s) = \alpha(t) \Rightarrow s = t \\[0.5em]
  \Longleftrightarrow\ &
    \text{for all open~$U \subseteq X$, sections $s, t \in \Gamma(U, \F)$:} \\
  &\qquad\qquad
      \text{for all open~$W \subseteq U$:} \\
  &\qquad\qquad\qquad\qquad
        \text{$\alpha_W(s|_W) = \alpha_W(t|_W)$ implies $s|_W = t|_W$} \\[0.5em]
  \Longleftrightarrow\ &
    \text{for all open~$U \subseteq X$, sections $s, t \in \Gamma(U, \F)$:} \\
  &\qquad\qquad
        \text{$\alpha_U(s|_U) = \alpha_U(t|_U)$ implies $s|_U = t|_U$} \\[0.5em]
  \Longleftrightarrow\ &
    \text{$\alpha$ is a monomorphism of sheaves}
\end{align*}
The corner quotes ``$\speak{\ldots}$'' indicate that translation into formal
language is left to the reader. Similarly,~$\alpha$ is an epimorphism of
sheaves if and only if, from the internal perspective,~$\alpha$ is a
surjective map. Notice that injectivity and surjectivity are
notions of a simple element-based language, and the Kripke--Joyal semantics
takes care to properly handle \emph{all} sections, not only global ones.
\end{ex}

The rules are not all arbitrary. They are finely concerted to make the
following propositions true, which are crucial for a proper appreciation of the
internal language.

\begin{prop}[Locality of the internal language]
Let~$U = \bigcup_i U_i$ be covered by open subsets. Let~$\varphi$
be a formula over~$U$. Then
\[ U \models \varphi \qquad\text{iff}\qquad
  \text{$U_i \models \varphi$ for each $i$}. \]
\end{prop}
\begin{proof}Induction on the structure of~$\varphi$. Note that the canceled
rules would make this proposition false.\end{proof}

\begin{prop}[Soundness of the internal language]
If a formula~$\varphi$ implies a further formula~$\psi$ in intuitionistic logic, then
$U \models \varphi$ implies $U \models \psi$.
\end{prop}
\begin{proof}
Proof by induction on the structure of formal intuitionistic proofs; we are to
show that any inference rule of intuitionistic logic is satisfied by the
Kripke--Joyal semantics. For instance, there is the following rule governing
disjunction:
\begin{quote}
If~$\varphi \vee \psi$ holds, and both $\varphi$ and $\psi$ imply a further
formula~$\chi$, then~$\chi$ holds.
\end{quote}
So we are to prove that if~$U \models \varphi \vee \psi$, $U \models (\varphi
\Rightarrow \chi)$, and $U \models (\psi \Rightarrow \chi)$, then $U \models \chi$.
This is done as follows: By assumption, there exists a covering~$U = \bigcup_i
U_i$ such that on each~$U_i$, $U_i \models \varphi$ or $U_i \models \psi$.
Again by assumption, we may conclude that~$U_i \models \chi$ for each~$i$. The statement
follows because of the locality of the internal language.

A complete list of which rules are to prove is
in~\cite[D1.3.1]{johnstone:elephant}.
\end{proof}
% XXX: Put rules into an appendix and give some explanation regarding contexts
% etc. Don't forget the rules for \in, \bigwedge, \bigvee.

% XXX: Is it clear that any constructively valid statement yields a valid sheaf
% statement?

Because of the multitude of quantifiers, literal translations of internal statements
can sometimes get slightly unwieldy. There are simplification rules for certain
often-occuring special cases:
\begin{prop}\label{prop:simplification}
    \[ \renewcommand{\arraystretch}{1.3}\begin{array}{@{}lcl@{}}
      U \models \forall s\?\F\_ \forall t\?\G\_ \varphi(s,t)
      &\Longleftrightarrow&
      \text{for all open~$V \subseteq U$,} \\
      && \text{sections~$s \in \Gamma(V,\F)$, $t \in \Gamma(V,\G)$:
      $V \models \varphi(s,t)$} \\[0.3em]
      U \models \forall s\?\F\_ \varphi(s) \Rightarrow \psi(s)
      &\Longleftrightarrow&
      \text{for all open~$V \subseteq U$, sections~$s \in \Gamma(V,\F)$:} \\
      &&\qquad\qquad \text{$V \models \varphi(s)$ implies $V \models \psi(s)$}
      \\[0.3em]
      U \models \exists!s\?\F\_ \varphi(s)
      &\Longleftrightarrow&
      \text{for all open~$V \subseteq U$,} \\
      &&
      \text{there is exactly one section~$s \in \Gamma(V,\F)$ with:} \\
      &&\qquad\qquad V \models \varphi(s)
    \end{array} \]
\end{prop}
\begin{proof}Straightforward. By way of example, we prove the existence claim
in the ``only if'' direction of the last rule. (Note that this rule formalizes
the saying ``unique existence is global existence''.) By definition of~$\exists!$, it
holds that
\[ U \models \exists s\?\F\_ \varphi(s) \]
and
\[ U \models \forall s,t\?\F\_ \varphi(s) \wedge \varphi(t) \Rightarrow s = t.  \]
Let~$V \subseteq U$ be an arbitrary open subset. Then there exist local
section~$s_i \in \Gamma(V_i,\F)$ such that~$V_i \models \varphi(s_i)$, where~$V
= \bigcup_i V_i$ is an open covering. By the locality of the internal language,
on intersections it holds that~$V_i \cap V_j \models \varphi(s_i)$, so by the
uniqueness assumption, it follows that the local sections agree on intersections.
They therefore glue to a section~$s \in \Gamma(V,\F)$. Since~$V_i \models
\varphi(s)$ for any~$i$, the locality of the internal language allows us to
conclude that~$V \models \varphi(s)$.
\end{proof}

\begin{rem}Note that~$\Sh(X) \models \neg\varphi$ is in general a much stronger
statement that merely supposing that~$\Sh(X) \models \varphi$ does not hold:
The former always implies the latter (unless~$X = \emptyset$, in which case
\emph{any} internal statement is true), but the converse does not hold: The
former statement means that~$U = \emptyset$ is the \emph{only} open subset on
which~$\varphi$ holds.\end{rem}
% XXX: Find appropriate place for this remark.


\subsection{Internal constructions} The Kripke--Joyal semantics defines the
interpretation of internal statements. The interpretation of internal
constructions is given by the following definition.

\begin{defn}The interpretation of an internal construction~$T$
is denoted by~$\brak{T} \in \Sh(X)$ and given by the following rules.
\begin{itemize}\item If~$\F$ and~$\G$ are sheaves, $\brak{\F \times \G}$ is the
categorical product of~$\F$ and~$\G$ (i.\,e. their product as presheaves).
\item If~$\F$ and~$\G$ are sheaves, $\brak{\F \amalg \G}$ is the categorical
coproduct of~$\F$ and~$\G$, i.\,e. the sheafification of the presheaf
$U \mapsto \Gamma(U,\F) \amalg \Gamma(U,\G)$.
\item If~$\F$ is a sheaf, the interpretation~$\brak{\P(\F)}$ of the power set
construction is the sheaf given by
\[ \text{$U \subseteq X$ open} \longmapsto \{ \G \hookrightarrow \F|_U \}, \]
i.\,e. sections on an open set~$U$ are subsheaves of~$\F|_U$ (either literally
or isomorphism classes of general monomorphisms into~$\F|_U$).
\item If~$\F$ is a sheaf and~$\varphi(s)$ is a formula containing a free
variable~$s\?\F$, the interpretation~$\brak{\{s\?\F\,|\,\varphi(s)\}}$ is given
by the subsheaf of~$\F$ defined by
\[ \text{$U \subseteq X$ open} \longmapsto \{ s \in \Gamma(U,\F) \ |\ 
  U \models \varphi(s) \}. \]
\end{itemize}
\end{defn}

The definition is made in such a way that, from the internal perspective, the
constructions enjoy their expected properties. For instance, it holds that
\[ \Sh(X) \models
  \bigl[\forall x\?\brak{\{s\?\F \,|\, \varphi(s)\}}\_ \psi(x)\bigr]
  \Longleftrightarrow
  \bigl[\forall x\?\F\_ \varphi(x) \Rightarrow \psi(x)\bigr]. \]
We gloss over several details here. See~\cite[???]{johnstone:elephant} for
a proper treatment.

% XXX: remark that dependent types are necessary for a full support of ordinary
% mathematics; cite Awodey/Bauer for how to interpret those.


\subsection{Geometric formulas and constructions} In categorical logic,
so-called geometric formulas play a special role, because their meaning is
preserved under pullback with geometric morphisms. % XXX gibberish!
\begin{defn}A formula is \emph{geometric} if and only if it consists only of
\[ {=} \quad {\in} \quad {\top} \quad {\bot} \quad {\wedge} \quad {\vee} \quad
{\bigvee} \quad {\exists}, \]
but not~``$\bigwedge$'' nor ``$\Rightarrow$'' nor~``$\forall$'' (and thus
not~``$\neg$'' either, since this is defined using~``$\Rightarrow$'').
A \emph{geometric implication} is a formula of the form
\[ \forall \cdots \forall\_ (\cdots) \Rightarrow (\cdots) \]
with the bracketed subformulas being geometric.
\end{defn}
We say that a formula~$\varphi$ holds \emph{at a point~$x \in X$} if and only
if the formula obtained by substituting all parameters in~$\varphi$ (sheaves
being quantified over, sections of sheaves appearing as terms and morphisms of
sheaves appearing as function symbols) with their stalks at~$x$ holds in the usual
mathematical sense.

\begin{lemma}\label{lemma:geometric-stalk-neighbourhood}
Let~$x \in X$ be a point. Let~$\varphi$ be a geometric formula (over some open
neighbourhood of~$x$).
Then~$\varphi$ holds at~$x$ if and only if there exists a neighbourhood~$U
\subseteq X$ of~$x$ such that~$\varphi$ holds on~$U$.
\end{lemma}
\begin{proof}This is a very general instance of the phenomenom that sometimes,
truth at a point spreads to truth on a neighbourhood. It can be proven by
induction on the structure of~$\varphi$, but we will give a more conceptual
proof later (corollary~\ref{cor:geometric-spreading}).
\end{proof}

This lemma is in fact a very useful metatheorem. We will properly discuss its
significance in section~\ref{sect:spreading}. For now, we just use it to prove a
simple criterion for the internal truth of a geometric implication; we will
apply this criterion many times.

\begin{cor}A geometric implication holds on~$X$ if and only if it holds at
every point of~$X$.\end{cor}
\begin{proof}For notational simplicity, we consider a geometric implication of
the form
\[ \forall s\?\F\_ \varphi(s) \Rightarrow \psi(s). \]
For the ``only if'' direction, assume that this formula holds on~$X$ and let~$x
\in X$ be an arbitrary point. Let~$s_x \in \F_x$ be the germ of an arbitrary
local section~$s$ of~$\F$ and assume that~$\varphi(s)$ holds at~$x$. Then by
the lemma, it follows that~$\varphi(s)$ holds on some open neighbourhood of~$x$. By
assumption,~$\psi(s)$ holds on this neighbourhood as well. Again by the
lemma,~$\psi(s)$ holds at~$x$.

For the ``if'' direction, assume that the geometric implication holds at every
point. Let~$U \subseteq X$ be an arbitrary open subset and let~$s \in
\Gamma(U,\F)$ be a local section such that~$\varphi(s)$ holds on~$U$. By the
lemma and the locality of the internal language, to show that~$\psi(s)$ holds
on~$U$, it suffices to show that~$\psi(s)$
holds at every point of~$U$. This is clear, since again by the
lemma,~$\varphi(s)$ holds at every point of~$U$.
\end{proof}

\begin{ex}Injectivity and surjectivity are geometric implications (surjectivity
can be spelled~$\forall y\?\G\_ \top \Rightarrow \exists x\?\F\_ \alpha(x) =
y$). Thus the corollary gives a deeper reason for the well-known fact that a
morphism of sheaves is a monomorphism resp. an epimorphism if and only if it is
stalkwise injective resp. surjective.\end{ex}

A construction is \emph{geometric} if and only if it commutes with pullback
under arbitrary geometric morphisms. We do not want to discuss the notion of
geometric morphisms here; suffice it to say that calculating the stalk at a
point~$x \in X$ is an instance of such a pullback. Among others, the following
constructions are geometric:
\begin{itemize}
\item finite product: $(\F \times \G)_x \cong \F_x \times \G_x$
\item finite coproduct: $(\F \amalg \G)_x \cong \F_x \amalg \G_x$
\item arbitrary coproduct: $(\coprod_i \F_i)_x \cong \coprod_i (\F_i)_x$
\item set comprehension with respect to a \emph{geometric} formula~$\varphi$:
\[ \brak{\{ s\?\F \,|\, \varphi(s) \}}_x \cong \{ [s]\in\F_x \,|\,
\text{$\varphi(s)$ holds at $x$} \} \]
\item free module: $(\R\langle \F \rangle)_x \cong \R_x\langle \F_x
\rangle$ ($\R$ a sheaf of rings, $\F$ a sheaf of sets)
\end{itemize}

The following constructions are not in general geometric:
\begin{itemize}
\item arbitrary product
\item set comprehension with respect to a non-geometric formula
\item powerset
\item internal Hom: $\HOM(\F,\G)_x \not\cong \HOM(\F_x,\G_x)$
\end{itemize}

\begin{itemize}
\item crash course on intuitionistic logic
\end{itemize}


\section{Sheaves of rings}

Recall that a \emph{sheaf of rings} can be categorically described as a
sheaf of sets~$\R$ together with maps of sheaves $+, \cdot : \R \times \R \to
\R$ and global elements~$0, 1$ such that certain axioms hold. For instance, the
axiom on the commutativity of addition is rendered in diagrammatic form as
follows:
\[ \xymatrix{
  \R \times \R \ar[rr]^{\mathrm{swap}} \ar[rd]_{+} && \R \times \R \ar[ld]^{+} \\
  & \R
} \]

From the internal perspective, a sheaf of rings looks just like a plain ring.
This is the content of the following proposition:

\begin{prop}\label{prop:rings-internally}
Let~$X$ be a topological space. Let~$\R$ be a sheaf of sets on~$X$.
Let~$+, \cdot : \R \times \R \to \R$ be maps of sheaves and let~$0, 1$ be
global elements of~$\R$. Then these data define a sheaf of rings if and only
if, from the internal perspective, these data fulfill the usual equational ring
axioms.\end{prop}
\begin{proof}We only discuss the commutativity axiom. The internal statement
\[ \Sh(X) \models \forall x,y\?\R\_ x + y = y + x \]
means that for any open subset~$U \subseteq X$ and any local sections~$x,y \in
\Gamma(U,\R)$, it holds that~$x + y = y + x \in \Gamma(U,\R)$. This is
precisely the external commutativity condition.
\end{proof}

\begin{lemma}Let~~$X$ be a topological space. Let~$\R$ be a sheaf of rings
on~$X$. Let~$f$ be a global section of~$\R$. Then the following statements are
equivalent:
\begin{enumerate}
\item $f$ is invertible from the internal point of view, i.\,e. $\Sh(X) \models
\exists g\?\R\_ fg = 1$.
\item $f$ is is invertible in all stalks~$\R_x$.
\item $f$ is in invertible in~$\Gamma(X,\R)$.
\end{enumerate}
\end{lemma}
\begin{proof}Since invertibility is a geometric implication, the equivalence of
the first two statements is clear. Also, it's obvious that the third statement
implies the other two. For the remaining direction, note that the
uniqueness of inverses in rings can be proven intuitionistically. Therefore, if~$f$ is invertible
from the internal point of view, it actually holds that
\[ \Sh(X) \models \exists! g\?\R\_ fg = 1. \]
Since unique internal existence implies global existence
(proposition~\ref{prop:simplification}), this shows that the first statement
implies the third.
\end{proof}


\subsection{Reducedness} Recall that a scheme~$X$ is \emph{reduced} if and only
if all stalks~$\O_{X,x}$ are reduced rings. Since the condition on a ring~$R$
to be reduced is a geometric implication,
\[ \forall s\?R\_ s^2 = 0 \Longrightarrow s = 0, \]
we immediately obtain the following characterization of reducedness in the
internal language:
\begin{prop}A scheme~$X$ is reduced iff, from the internal point of view, the
ring~$\O_X$ is reduced.\end{prop}


\subsection{Locality} Recall the usual definition of a local ring: a ring
possessing exactly one maximal ideal. This is a higher-order condition and in
particular not of a geometric form. Therefore, for our purposes, it's better to
adopt the following elementary definition of a local ring.
\begin{defn}A \emph{local ring} is a ring~$R$ such that~$1 \neq 0$ in~$R$ and
for all~$x,y \in R$
\[ \text{$x+y$ invertible} \quad\Longrightarrow\quad
  \text{$x$ invertible}\ \vee\ \text{$y$ invertible}. \]
\end{defn}
In classical logic, it's an easy exercise to show that this definition is
equivalent to the usual one. In intuitionistic logic, we would need to be
more precise in order to even state the question of equivalence, since
intuitionistically, the notion of a maximal ideal bifurcates into several
non-equivalent notions.

\begin{prop}In the internal language of a scheme~$X$ (or a locally ringed
space), the ring~$\O_X$ is a local ring.\end{prop}
\begin{proof}The stated locality condition is a conjunction of two geometric
implications (the first one being~$1 = 0 \Rightarrow \bot$, the second being
the displayed one) and holds on each stalk.\end{proof}


\subsection{Field properties} From the internal point of view, the structure
sheaf~$\O_X$ of a scheme~$X$ is \emph{almost} a field, in the sense that any
element which is not invertible is nilpotent. This is a genuine property of
schemes, not shared with general locally ringed spaces.

\begin{prop}Let~$X$ be a scheme. Then
\[ \Sh(X) \models \forall s\?\O_X\_ \neg(\speak{$s$ invertible}) \Rightarrow
\speak{$s$ nilpotent}. \]
\end{prop}
\begin{proof}By the locality of the internal language and since~$X$ can be
covered by open affine subsets, it's enough to show that for any affine
scheme~$X = \Spec A$ and global function~$s \in \Gamma(X,\O_X) = A$ it holds
that
\[ X \models \neg(\speak{$s$ invertible}) \quad\text{implies}\quad
  X \models \speak{$s$ nilpotent}. \]
The meaning of the antecedent is that any open subset on which~$s$ is
invertible is empty. So in particular, the standard open subset~$D(s)$ is
% XXX: missing: "Let's assume the antecedent to be true"
empty. Therefore~$s$ is an element of any prime ideal of~$A$ and thus
nilpotent. This implies the a priori weaker statement~$X \models \speak{$s$
nilpotent}$ (which would allow~$s$ to have different indices of nilpotency on
an open covering).
\end{proof}

\begin{cor}Let~$X$ be a scheme. If~$X$ is reduced, the ring~$\O_X$ is a field
from the internal point of view, in the sense that
\[ \Sh(X) \models \forall s\?\O_X\_ \neg(\speak{$s$ invertible}) \Rightarrow
s=0. \]
The converse holds as well.\end{cor}
\begin{proof}We can prove this purely in the internal language: It suffices to
give an intuitionistic proof of the fact that a local ring which satisfies the
condition of the previous proposition fulfills the stated field condition if
and only if it is reduced. This is straightforward.
\end{proof}

This field property is very useful. We will put it to good use when giving a
simple proof of the fact that~$\O_X$-modules of finite type on a reduced scheme
are locally free on a dense open subset (proposition~\ref{modules:densefree}).

The following proposition says that one can deduce a certain unconditional
statement from the premise that an element~$s\?\O_X$ is zero under the
assumption that some further element~$f\?\O_X$ is invertible.

\begin{prop}\label{prop:cond-zero}
Let~$X$ be a scheme. Then
\[ \Sh(X) \models
  \forall f\?\O_X\_
  \forall s\?\O_X\_
  (\speak{$f$ inv.} \Rightarrow s = 0) \Longrightarrow
  \textstyle
  \bigvee_{n \geq 0} f^n s = 0. \]
\end{prop}
\begin{proof}It's enough to show that for any affine scheme~$X = \Spec A$ and
global functions~$f, s \in A$ such that
\[ X \models (\speak{$f$ inv.} \Rightarrow s = 0), \]
it holds that $X \models \textstyle \bigvee_{n \geq 0} f^n s = 0$. This is
obvious, since by assumption such a function~$s$ is zero on~$D(f)$, i.\,e. $s$
is zero as an element of~$A[f^{-1}]$.
\end{proof}

\begin{itemize}
\item Remark that intuitionistically, the notion of a field bifurcates into
several inequivalent notions
\item normal rings, principal ideal domains, \ldots
\item discreteness
\end{itemize}


\section{Sheaves of modules}

From the internal perspective, a sheaf of~$\R$-modules, where~$\R$ is a sheaf
of rings, looks just like a plain module over the plain ring~$\R$. This is
proven just as the correspondence between sheaf of rings and internal rings
(proposition~\ref{prop:rings-internally}).


\subsection{Local finite freeness}

Recall that an~$\O_X$-module~$\F$ is \emph{locally finitely free} if and only
if there exists a covering of~$X$ by open subsets~$U$ such that on each
such~$U$, the restricted module~$\F|_U$ is isomorphic as an~$\O_X|_U$-module
to~$(\O_X|_U)^n$ for some natural number~$n$ (which may depend on~$U$).

\begin{prop}Let~$X$ be a scheme (or ringed space). Let~$\F$ be
an~$\O_X$-module. Then~$\F$ is locally finitely free if and only if, from the
internal perspective,~$\F$ is a finitely free module, i.\,e.
\[ \Sh(X) \models \bigvee_{n \geq 0} \speak{$\F \cong (\O_X)^n$} \]
or more elementary
\[ \Sh(X) \models \bigvee_{n \geq 0}
  \exists x_1,\ldots,x_n\?\F\_
  \forall x\?\F\_
  \exists! a_1,\ldots,a_n\?\O_X\_
  x = \textstyle\sum\limits_i a_i x_i. \]
\end{prop}
\begin{proof}By the expression~``$(\O_X)^n$'' in the internal language we mean
the internally constructed object~$\O_X \times \cdots \times \O_X$ with its
pointwise~$\O_X$-module structure. This coincides with the sheaf~$(\O_X)^n$ as
usually understood.

It is clear that the two stated internal conditions are equivalent, since the
corresponding proof in linear algebra is intuitionistic. The equivalence with
the external notion of locally finite freeness is obvious, since the
interpretation of the first condition with the Kripke--Joyal semantics is the
following: There exists a covering of~$X$ by open subsets~$U$ such that for
each such~$U$, there exists a natural number~$n$ and a morphism of
sheaves~$\varphi : \F|_U \to (\O_X|_U)^n$ such that
\[ U \models \speak{$\varphi$ is~$\O_X$-linear} \quad\text{and}\quad
  U \models \speak{$\varphi$ is bijective}. \]
The first subcondition means that~$\varphi$ is a morphism of sheaves
of~$\O_X$-modules and the second one means that~$\varphi$ is an isomorphism of
sheaves.
\end{proof}


\subsection{Finite type, finite presentation, coherence}
Recall the conditions of an~$\O_X$-module~$\F$ on a scheme~$X$ (or ringed
space) to be of finite type, of finite presentation and to be coherent:
\begin{itemize}
\item $\F$ is \emph{of finite type} if and only if there exists a covering of~$X$ by
open subsets~$U$ such that on each such~$U$, there exists an exact sequence
\[ (\O_X|_U)^n \longrightarrow \F|_U \longrightarrow 0 \]
of~$\O_X|_U$-modules.
\item $\F$ is \emph{of finite presentation} if and only if there exists a covering of~$X$ by
open subsets~$U$ such that on each such~$U$, there exists an exact sequence
\[ (\O_X|_U)^m \longrightarrow (\O_X|_U)^n \longrightarrow \F|_U \longrightarrow 0. \]
\item $\F$ is \emph{coherent} if and only if~$\F$ is of finite type and the
kernel of any~$\O_X|_U$-linear morphism~$(\O_X|_U)^n \to \F|_U$, $U \subseteq
X$ any open subset, is of finite type.
\end{itemize}

The following proposition gives translations of these definitions into the
internal language.
\begin{prop}Let~$X$ be a scheme (or ringed space). Let~$\F$ be
an~$\O_X$-module. Then:
\begin{itemize}
\item $\F$ is of finite type if and only if~$\F$, considered as an ordinary
module from the internal perspective, is finitely generated, i.\,e. if
\[ {\qquad\qquad} \Sh(X) \models
  \bigvee_{n \geq 0}
  \exists x_1,\ldots,x_n\?\F\_
  \forall x\?\F\_
  \exists a_1,\ldots,a_n\?\F\_
  x = \textstyle\sum\limits_i a_i x_i. \]
\item $\F$ is of finite presentation if and only if~$\F$ is a finitely
presented module from the internal perspective, i.\,e. if
\[ {\qquad\qquad} \Sh(X) \models \bigvee_{n,m \geq 0}
  \speak{there is a short exact sequence $\O_X^m \to \O_X^n \to \F \to 0$}.
  \]
\item $\F$ is coherent if and only if
\begin{multline*}
{\qquad\qquad\qquad}
  \Sh(X) \models \speak{$\F$ is finitely generated} \mathop{\wedge} \\
  \bigwedge_{n \geq 0} \forall \varphi \? \HOM(\O_X^n,\F)\_
  \speak{$\Kernel \varphi$ is finitely generated}.
\end{multline*}
\end{itemize}
\end{prop}
\begin{proof}Straightforward: The translations of the internal statements using
the Kripke--Joyal semantics are precisely the corresponding external
statements.
\end{proof}


\subsection{Tensor product} Recall that the tensor product
of~$\O_X$-modules~$\F$ and~$\G$ on a scheme~$X$ (or ringed space) is usually
constructed as the sheafification of the presheaf
\[ \text{$U \subseteq X$ open} \longmapsto \Gamma(U,\F) \otimes_{\Gamma(U,\O_X)}
\Gamma(U,\G). \]
From the internal point of view,~$\F$ and~$\G$ look like ordinary modules, so
that we can consider their tensor product as usually constructed in
commutative algebra, as a certain quotient of a free module on the elements
of~$\F \times \G$:
\[ \O_X\langle x \otimes y \,|\, x\?\F, y\?\G \rangle / R, \]
where~$R$ is the submodule generated by
\begin{gather*}
  (x+x') \otimes y - x \otimes y - x' \otimes y, \\
  x \otimes (y+y') - x \otimes y - x \otimes y', \\
  (sx) \otimes y - s(x \otimes y), \\
  x \otimes (sy) - s(x \otimes y)
\end{gather*}
with~$x,x'\?\F$, $y,y'\?\G$, $s\?\O_X$.
This internal construction will give rise to the same sheaf
of modules as the externally defined tensor product:

\begin{prop}Let~$X$ be scheme (or a ringed space). Let~$\F$ and~$\G$
be~$\O_X$-modules. Then the internally constructed tensor product~$\F
\otimes_{\O_X} \G$ coincides with the external one.
\end{prop}
\begin{proof}
Since the proof of the corresponding fact of commutative algebra is
intuitionistic, the internally defined tensor product~$\F \otimes_{\O_X} \G$
fulfills the following universal property: For any~$\O_X$-module~$\H$,
any~$\O_X$-bilinear map~$\F \times \G \to \H$ uniquely factors over the
canonical morphism~$\F \times \G \to \F \otimes_{\O_X} \G$.

Interpreting this property with the Kripke--Joyal semantics, we see that the
internally constructed tensor product fulfills the following external property:
For any open subset~$U \subseteq X$ and any~$\O_X|_U$-module~$\H$ on~$U$,
any~$\O_X|_U$-bilinear map~$\F|_U \times \G|_U \to \H$ uniquely factors over the
canonical morphism~$\F \times \G \to (\F \otimes_{\O_X} \G)|_U$.

In particular, for~$U = X$, this property is well-known to be the universal
property satisfied by the externally constructed tensor product. Therefore the
claim follows.
\end{proof}

By the internal construction, a description of the stalks of the tensor product
follows purely by considering the logical form of the construction:
\begin{cor}Let~$X$ be scheme (or a ringed space). Let~$\F$ and~$\G$
be~$\O_X$-modules. Then the stalks of the tensor product coincide with the
tensor products of the stalks: $(\F \otimes_{\O_X} \G)_x \cong \F_x
\otimes_{\O_{X,x}} \G_x$.\end{cor}
\begin{proof}
We constructed the tensor product using the following operations: product of
two sets, free module on a set, quotient module with respect to a submodule;
submodule generated by a set of elements given by a geometric formula.
All of these operations are geometric, so the tensor product construction is
geometric as well. Hence taking stalks commutes with performing the
construction.
\end{proof}

Recall that an~$\O_X$-module~$\F$ is \emph{flat} if and only if all
stalks~$\F_x$ are flat~$\O_{X,x}$-modules. We can characterize flatness in the
internal language.
\begin{prop}Let~$X$ be a scheme (or ringed space). Let~$\F$ be
an~$\O_X$-module. Then~$\F$ is flat if and only if, from the internal
perspective,~$\F$ is a flat~$\O_X$-module.
\end{prop}
\begin{proof}
Recall that flatness of an~$A$-module~$M$ can be characterized without
reference to tensor products by the following condition (using
suggestive vector notation): For any natural number~$p$,
any $p$-tuple~$m \? M^p$ of elements of~$M$ and
any~$p$-tuple $a \? A^p$ of elements of~$A$,
\[
  a^T m = 0 \ \Longrightarrow\ 
  \bigvee\limits_{q \geq 0} \exists n\?M^q, B\?A^{p \times q}\_
  Bn = m \wedge a^T B = 0. \]
% This really is constructively equivalent to tensoring being exact.
% See Mines/Richman/Ruitenburg, page 94.
This formulation of flatness has the advantage that it is the conjunction of
geometric implications; therefore it holds internally if and only if it holds at
any stalk.
\end{proof}


\subsection{Internal proofs of common lemmas}

\begin{lemma}Let~$X$ be a scheme (or ringed space). Let
\[ 0 \lra \F \lra \G \lra \H \to 0 \]
be a short exact sequence of~$\O_X$-modules. If~$\F$ and~$\H$ are of finite
type, so is~$\G$; similarly, if~$\F$ and~$\H$ are locally finitely free, so
ist~$\G$.
\end{lemma}
\begin{proof}From the internal perspective, we are given a short exact sequence
of modules with the outer ones being finitely generated (resp. finitely free)
and we have to show that the middle one is finitely generated (resp. finitely
free) as well. It is well-known that this follows; and since the usual proof of
this fact is intuitionistic, we are done.
\end{proof}

\begin{lemma}Let~$X$ be a scheme (or locally ringed space). Let~$\alpha : \G
\to \H$ be an epimorphism of locally finitely free~$\O_X$-modules. Then the
kernel of~$\alpha$ is locally finitely free as well.\end{lemma}
\begin{proof}It suffices to give an intuitionistic proof of the following
statement: The kernel of a matrix over a local ring, which as a linear map is
surjective, is finitely free.

Let~$M \in R^{n \times m}$ be such a matrix. Since by the surjectivity
assumption some linear combination of the columns is~$e_1$ (the first canonical
basis vector), some linear combination of the entries of the first row of~$M$
is~$1$. By locality of~$R$, at least one entry of the first row is invertible.
By applying appropriate column and row transformations, we may assume that~$M$
is of the form
\[ \left(
  \begin{array}{c|ccc}
    1 & 0 & \cdots & 0 \\ \hline
    0 & \multicolumn{3}{c}{\multirow{3}{*}{\raisebox{-5mm}{\scalebox{1.5}{$\widetilde M$}}}} \\
    \raisebox{2pt}{\vdots} & & & \\
    0 & & &
  \end{array}
\right) \]
with the submatrix~$\widetilde M$ fulfilling the same condition as~$M$.
Continuing in this way, it follows that~$m \geq n$ and that we may assume
that~$M$ is of the form
\[ \left(
  \begin{array}{ccc|c}
    1 & & & \multirow{3}{*}{\raisebox{-3mm}{\scalebox{1.5}{\ 0}}} \\
    & \ddots && \\
    && 1
  \end{array}
\right)\!. \]
The kernel of such a matrix is obviously freely generated by the canonical
basis vectors corresponding to the zero columns. In particular, the rank of the
kernel is~$m-n$.
\end{proof}

\begin{rem}The internal language machinery gives no reason to believe that the
dual statement is true, i.\,e. that the cokernel of a monomorphism of locally
finitely free~$\O_X$-modules is locally finitely free: This would follow from
an intuitionistic proof of the statement that the cokernel of an injective map
between finitely free modules over a local ring is finitely free. But this
statement is false, as the following example shows.
\[ 0 \lra \ZZ_{(2)} \stackrel{\cdot 2}{\lra} \ZZ_{(2)} \lra \FF_2 \lra 0 \]
\end{rem}

\begin{lemma}Let~$X$ be a scheme (or locally ringed space). Let~$\alpha : \G
\to \H$ be an epimorphism of locally finitely free~$\O_X$-modules of the same
rank. Then~$\alpha$ is an isomorphism.\end{lemma}
\begin{proof}It suffices to give an intuitionistic proof of the following
statement: A square matrix over a local ring, which as a linear map is
surjective, is invertible.

This follows from the proof of the previous lemma, since it shows that the
kernel of such a matrix is finitely free of rank zero.
\end{proof}


\begin{itemize}
\item basic lemmas: finite type in exact sequences, filtered colimits,
flatness, surjective implies iso, \ldots
\item important hard exercise
\item torsion (check Liu p. 174)
\end{itemize}


\section{Upper semicontinuous functions}

\subsection{Interlude on natural numbers}
In classical logic, the natural numbers are complete in the sense that any
inhabited set of natural numbers possesses a minimal element. This statement
can not be proven intuitionistically -- intuitively, this is because one cannot
explicitly pinpoint the (classically existing) minimal element of an arbitrary
inhabited set. In intuitionistic logic, this principle can be salvaged in two
essentially different ways: either be strengthening the premise, or by
weakening the conclusion.
% XXX: Give sheaf-theoretic interpretation of the failure.

\begin{lemma}Let~$U \subseteq \NN$ be an inhabited subset of the natural
numbers.
\begin{enumerate}
\item Assume~$U$ to be \emph{detachable}, i.\,e. assume that for any natural
number~$n$, either~$n \in U$ or~$n \not\in U$. Then~$U$ possesses a minimal
element.
% XXX: Give sheaf-theoretic interpretation of detachability. With this
% interpretation, it should be totally clear that $U$ possesses a minimal
% element.
\item In any case,~$U$ does \emph{not not} possess a minimal element.
\end{enumerate}
\end{lemma}
\begin{proof}
\begin{enumerate}
\item By induction on the witness of inhabitation, i.\,e. the given number~$n$ such
that~$n \in U$. Details omitted, since we will not need this statement.
\item We give a careful proof since logical subtleties matter. To simplify the
exposition, we assume that~$U$ is upward-closed, i.\,e. that any number
larger than some element of~$U$ lies in~$U$ as well. Any subset can be closed
in this way (by considering~$\{ n \in \NN \,|\, \exists m \in U\_ n \geq m \}$)
and a minimal element of the closure will be a minimal element for~$U$ as well.

We induct on the number~$n \in U$ given by the assumption that~$U$ is
inhabited. In the case~$n = 0$ we are done since~$0$ is a minimal element
of~$U$. For the induction step~$n \to n+1$, the weak law of excluded middle
gives
\[ \neg\neg(n \in U \vee n \not\in U). \]
If we can show that~$n \in U \vee n \not\in U$ implies the conclusion, we're
done by XXX. So assume~$n \in U \vee n \not\in U$.
If~$n \in U$, then~$U$ does not not possess a minimal element by the induction
hypothesis. If~$n \not\in U$, then~$n+1$ is a minimal element (and so, in
particular,~$U$ does not not possess a minimal element): For if~$m$ is
any element of~$U$, we have~$m \geq n+1$ or~$m \leq n$. In the first case,
we're done. In the second case, it follows that~$n \in U$ because~$U$ is
upward-closed and so we obtain a contradiction. From this contradiction we can
deduce~$m \geq n+1$. \qedhere
\end{enumerate}
\end{proof}

If we want to work with a complete set of natural numbers in intuitionistic
logic, we have to construction a completion.
\begin{defn}The partially ordered set of \emph{completed natural numbers} is
the set~$\widehat{\NN}$ of all inhabited upward-closed subsets of~$\NN$, ordered by
reverse inclusion.\end{defn}
\begin{lemma}The poset of completed natural numbers is the least partially
ordered set containing~$\NN$ and possessing minima
of arbitrary inhabited subsets.\end{lemma}
\begin{proof}
The embedding $\NN \hookrightarrow \widehat\NN$ is given by
\[ n \in \NN \longmapsto {\uparrow}(n) := \{ m \in \NN \,|\, m \geq n \}. \]
If~$M \subseteq \widehat\NN$ is an inhabited subset, its minimum is
\[ \min M = \bigcup M \in \widehat\NN. \]
The proof of the universal property is left to the reader.
\end{proof}

\begin{rem}In classical logic, the map~$\widehat\NN \to \NN,\ U \mapsto \min U$
is a well-defined isomorphism of partially ordered sets.\end{rem}


\subsection{A geometric interpretation}
We are interested in the completed natural numbers for the following reason: A
completed natural number of the topos of sheaves on a topological space~$X$ is
the same as an upper semicontinuous function~$X \to \NN$.

\begin{lemma}Let~$X$ be a topological space. The sheaf~$\widehat\NN$ of
completed natural numbers on~$X$ is canonically isomorphic to the sheaf of upper
semicontinuous~$\NN$-valued functions on~$X$.\end{lemma}
\begin{proof}
When referring to the natural numbers in the internal language, we actually
refer to the constant sheaf~$\ul{\NN}$ on~$X$. (This is because the
sheaf~$\ul{\NN}$ fulfills the axioms of a natural numbers object,
cf.~\cite[XXX]{johnstone:elephant/moerdijk}.) Recall that its sections on an
open subset~$U \subseteq X$ are continuous functions~$U \to \NN$, where~$\NN$
is equipped with the discrete topology.

Therefore, a section of~$\widehat\NN$ on an open subset~$U \subseteq X$ is
given by a subsheaf~$\A \hookrightarrow \ul{\NN}|_U$ such that
\[ U \models \exists n\?\ul{\NN}\_ n \in \A
  \quad\text{and}\quad
  U \models \forall n,m\?\ul{\NN}\_ n \geq m \wedge n \in \A \Rightarrow m \in
  \A. \]
Since these conditions are geometric, they are satisfied if and only if any
stalk~$\A_x$ is an inhabited upward-closed subset of~$\ul{\NN}_x \cong \NN$.
The association
\[ x \in X \longmapsto \min\{ n \in \NN \,|\, n \in \A_x \} \]
thus defines a map~$X \to \NN$. This map is indeed upper semicontinuous, since
if~$n \in \A_x$, there exists a neighbourhood~$V$ of~$x$ such that the constant
function with value~$n$ is an element of~$\Gamma(V,\A)$ and therefore~$n \in
\A_y$ for all~$y \in V$.

Conversely, let~$\alpha : U \to \NN$ be a upper semi-continous function. Then
\[ \text{$V \subseteq X$ open} \longmapsto \{ f : V \to \NN \,|\, \text{$f$
continuous,\ $f \geq \alpha$ on~$V$} \} \]
is a subobject of~$\ul{\NN}|_U$ which internally is inhabited and upward-closed.
Further details are left to the reader.
\end{proof}

Under the correspondence given by the lemma, locally \emph{constant}
functions map exactly to the (image of the) \emph{ordinary} internal natural numbers
(in the completed natural numbers).

\begin{rem}In a similar vein, the sheaf given by the internal construction of
the set of \emph{all} upward-closed subsets of the natural numbers (not
only the inhabited ones) is canonically isomorphic to the sheaf of
upper semicontinuous functions with values in~$\NN \cup \{ +\infty
\}$.\end{rem}


\subsection{The upper semicontinuous rank function}
Recall that the rank of an~$\O_X$-module~$\F$ on a scheme~$X$ (or
locally ringed space) at a point~$x \in X$ is defined as the~$k(x)$-dimension
of the vector space~$\F_x \otimes_{\O_{X,x}} k(x)$. If we assume that~$\F$ is
of finite type around~$x$, this dimension is finite and equals the minimal
number of elements needed to generate~$\F_x$ as an~$\O_{X,x}$-module (by
Nakayama's lemma).

In the internal language, we can define an element of~$\widehat\NN$ by
\[ \rank\F := \min\{ n \in \NN \,|\, \speak{there is a gen. family
for~$\F$ consisting of~$n$ elements} \} \in \widehat\NN. \]
If~$\F$ is locally finitely free, it will be a finitely free module from the
internal point of view and the rank defined in this way will be an
actual natural number; but in general, the rank is really an element of the
completion.

\begin{prop}
Let~$\F$ be an~$\O_X$-module of finite type on a scheme~$X$ (or locally ringed
space). Under the correspondence given by the previous lemma, the internally
defined rank maps to the rank function of~$\F$.
\end{prop}
\begin{proof}
We have to show that for any point~$x \in X$ and natural number~$n$, there
exists a generating family for~$\F_x$ consisting of~$n$
elements if and only if there exists a neighbourhood~$U$ of~$x$ such that
\[ U \models \speak{there exists a generating family
for~$\F$ consisting of~$n$ elements}. \]
The ``if'' direction is obvious. For the ``only if'' direction, consider
(liftings to local sections of a)
generating family~$s_1,\ldots,s_n$ of~$\F_x$. Since~$\F$ is of finite type,
there also exist sections~$t_1,\ldots,t_m$ on some neighbourhood~$V$ of~$x$ which
generate any stalk~$\F_y$, $y \in V$. Since the~$t_i$ can be expressed as a
linear combination of the~$s_j$ in~$\F_x$, the same is true on some open
neighbourhood~$U \subseteq V$ of~$x$. On this neighbourhood, the~$s_j$ generate
any stalk~$\F_y$, $y \in U$, so we have
\[ U \models \speak{$s_1,\ldots,s_n$ generate~$\F$}. \qedhere \]
\end{proof}
\begin{rem}Once we understand when properties holding at a stalk spread to a
neighbourhood, we will be able to give a simpler proof of the proposition (see
XXX).\end{rem}


\section{Rational functions and Cartier divisors}

\subsection{The sheaf of rational functions} Recall that the sheaf~$\K_X$ of rational
functions on a scheme~$X$ (or ringed space) can be defined as the sheaf
associated to the presheaf
\[ \text{$U \subseteq X$ open} \longmapsto \Gamma(U,\O_X)[\Gamma(U,\S)^{-1}], \]
where~$\Gamma(U,\S)$ is the multiplicative set of those sections of~$\O_X$ on~$U$,
which are regular in each stalk~$\O_{X,x}$, $x \in U$. Recall also there are
some wrong definitions in the literature~\cite{kleiman:misconceptions}.

Using the internal language, we can give a simpler definition of~$\K_X$.
Recall that we can associate to any ring~$R$ its total quotient ring, i.\,e.
its localization at the multiplicative subset of regular elements. Since from
the internal perspective~$\O_X$ is an ordinary ring, we can associate to it its
total quotient ring $\O_X[\S^{-1}]$,
where~$\S$ is internally defined by the formula
\[ \S := \{ s\?\O_X \,|\, \speak{$s$ is regular} \} \subseteq \O_X. \]
Externally, this ring is the sheaf~$\K_X$.
\begin{prop}Let~$X$ be a scheme (or a ringed space). The sheaf of rings defined
in the internal language by localizing~$\O_X$ at its set of regular elements is
(canonically isomorphic to) the sheaf~$\K_X$ of rational functions.
\end{prop}
\begin{proof}Internally, the ring~$\O_X[\S^{-1}]$ fulfills the following
universal property: For any ring~$R$ and any homomorphism~$\O_X \to R$ which
maps the elements of~$\S$ to units, there exists exactly one
homomorphism~$\O_X[\S^{-1}] \to R$ which makes the evident diagram commute.
\[ \xymatrix{
  \O_X \ar[rr] \ar[dr] && R \\
  & \O_X[\S^{-1}] \ar@{-->}[ru]
} \]
The translation using the Kripke--Joyal semantics gives the following universal
property: For any open subset~$U \subseteq X$, any sheaf of rings~$\R$ on~$U$ and any
homomorphism~$\O_X|_U \to \R$ which maps all elements of~$\Gamma(V,\S)$, $V
\subseteq U$ to units, there exists exactly one homomorphism~$\O_X[\S^{-1}]|_U \to
\R$ which makes the evident diagram commute.
It is well-known~\cite{???} that the sheaf~$\K_X$ as usually defined satisfies
this universal property as well.
\end{proof}

\begin{prop}Let~$X$ be a scheme (or ringed space). Then the stalks of~$\K_X$
are given by
\[ \K_{X,x} = \O_{X,x}[\S_x^{-1}]. \]
The elements of~$\S_x$ are exactly the germs of those local sections which are
regular not only in~$\O_{X,x}$, but in all rings~$\O_{X,y}$ where~$y$
ranges over some neighbourhood of~$x$ (depending on the section).\end{prop}
\begin{proof}
Since localization is a geometric construction, the first statement is entirely
trivial. The second statement follows since
\[ \Gamma(U,\S) = \{ s\in\Gamma(U,\O_X) \,|\, U \models \speak{$s$ is regular}
\} \]
and regularity is a geometric implication, so that
$U \models \speak{$s$ is regular}$ if and only iff the germ~$s_y$ is regular
in~$\O_{X,y}$ for all~$y \in U$.
\end{proof}


\subsection{Regularity of local functions}
It is well known that on a locally Noetherian scheme, regularity spreads from
stalks to neighbourhoods, i.\,e. a section of~$\O_X$ is regular
in~$\O_{X,x}$ if and only if it is regular on some neighbourhood on~$x$.
This fact has a simple proof in the internal language:
\begin{prop}Let~$X$ be a locally Noetherian scheme. Let~$s \in \Gamma(U,\O_X)$
be a local function on~$X$. Let~$x \in U$. Then the following statements are
equivalent:
\begin{enumerate}
\item The section~$s$ is regular in~$\O_{X,x}$.
\item The section~$s$ is regular in all local rings~$\O_{X,y}$ where~$y$ ranges
over some neighbourhood of~$x$.
\end{enumerate}
\end{prop}
\begin{proof}
Let~$\Box$ be the modal operator defined by~$\Box(\varphi) :\equiv ((\varphi
\Rightarrow {!x}) \Rightarrow {!x})$. By XXX, we are to show that the following
statements of the internal language
are equivalent:
\begin{enumerate}
\item $(\speak{$s$ is regular})^\Box$, i.\,e.
$\forall t\?\O_X\_ st = 0 \Rightarrow \Box(t = 0)$.
\item $\Box(\speak{$s$ is regular})$, i.\,e.
$\Box(\forall t\?\O_X\_ st = 0 \Rightarrow t = 0)$.
\end{enumerate}
It is clear that the second statement implies the first -- in fact, this is true
without any assumptions on~$X$: Let~$t\?\O_X$ be such that~$st = 0$. Since we want to
prove the boxed statement~$\Box(t=0)$, we may assume that~$s$ is regular and
prove~$t = 0$. This follows by definition.

For the converse direction, consider the annihilator of~$s$, i.\,e. the ideal
\[ I := \Ann_{\O_X}(s) = \{ t\?\O_X \,|\, st = 0 \} \subseteq \O_X. \]
This ideal satisfies the quasicoherence condition (example~\ref{ex:annihilator-qcoh}),
thus~$I$ is a quasicoherent submodule of a finitely generated module. Since~$X$ is
locally Noetherian, it follows that~$I$ is finitely generated as well. By
assumption, each generator~$x_i \in I$ fulfills~$\Box(x_i = 0)$. Since we want
to prove a boxed statement, we may in fact assume~$x_i = 0$. Thus~$I = (0)$ and
the assertion, that~$s$ is regular, follows.
\end{proof}

\begin{cor}Let~$X$ be a locally Noetherian scheme. Then the stalks~$\K_{X,x}$
of the sheaf of rational functions are given by the total quotient rings of the
local rings~$\O_{X,x}$.\end{cor}


\subsection{Geometric interpretation of the sheaf of rational functions}

\begin{itemize}
\item on reduced schemes, $\K_X$ is the sheaf of meromorphic functions
\item show~$\K_X = j_*(\O_X)$?
\item internal definition of Cartier divisors
\item correspondence between Cartier divisors and sub-$\O_X$-modules of $\K_X$
\end{itemize}


\section{Relative spectrum}
\begin{itemize}
\item ...
\end{itemize}

\section{Modalities}

\subsection{Basics on truth values and modal operators}

\begin{defn}The \emph{set of truth values~$\Omega$} is the powerset of the
singleton set~$1 := \{\star\}$, where~$\star$ is a formal symbol.\end{defn}

In classical logic, any subset of~$\{\star\}$ is either empty or inhabited, so
that~$\Omega$ contains exactly two elements, the empty set (``false'')
and~$\{\star\}$ (``true''). But
in intuitionistic logic, this can not be shown; indeed, if we interpret the
definition in the topos of sheaves on a space~$X$, we obtain a sheaf~$\Omega$
with
\[ \text{$U \subseteq X$ open} \longmapsto \Gamma(U,\Omega) = \{ V \subseteq U \,|\, \text{$V$
open} \}. \]
(This is because by definition of~$\Omega$ as the power object of the terminal
sheaf~$1$, sections of~$\Omega$ on an open subset~$U$ correspond to
subsheaves~$\F \hookrightarrow 1|_U$, and those are given by the greatest open
subset~$V \subseteq U$ such that~$\Gamma(V,\F)$ is inhabited.)

The \emph{truth value} of a formula~$\varphi$ is by definition the subset
$\{ x \in 1 \,|\, \varphi \} \in \Omega$, where~``$x$'' is a fresh variable not
appearing in~$\varphi$. This subset is inhabited if and only
if~$\varphi$ holds and is empty if and only if~$\neg\varphi$ holds.
Conversely, we can associate to a subset~$F \subseteq 1$ the
formula~$\speak{$F$ is inhabited}$.
% XXX: "formula" is not the correct term here.

Under this correspondence of formulas with truth values, logical operations
like~$\wedge$ and~$\vee$ map to set-theoretic operations like~$\cap$ and~$\cup$
-- for instance, we have
\[ \{ x \in 1 \,|\, \varphi \} \cap \{ x \in 1 \,|\, \psi \} =
  \{ x \in 1 \,|\, \varphi \wedge \psi \}. \]
This justifies a certain abuse of notation: We will sometimes treat elements
of~$\Omega$ as propositions and use logical instead of set-theoretic
connectives. In particular, if~$\varphi$ and~$\psi$ are elements of~$\Omega$,
we will write~``$\varphi \Rightarrow \psi$'' to mean~$\varphi \subseteq \psi$;
``$\bot$'' to mean~$\emptyset$; and~``$\top$'' to mean~$1$.

\begin{defn}A \emph{modal operator} is a map~$\Box : \Omega \to \Omega$ such
that for all~$\varphi, \psi \in \Omega$,
\begin{enumerate}
\item $\varphi \Longrightarrow \Box\varphi$,
\item $\Box\Box\varphi \Longrightarrow \Box\varphi$,
\item $\Box(\varphi \wedge \psi) \Longleftrightarrow \Box\varphi \wedge \Box\psi$.
\end{enumerate}
\end{defn}

The intuition is that~$\Box\varphi$ is a certain weakening of~$\varphi$, where
the precise meaning of ``weaker'' depends on the modal operator. By the second
axiom, weakening twice is the same as weakening once.

In classical logic, where~$\Omega = \{ \bot, \top \}$, there are only two modal
operators: the identity function and the constant function with value~$\top$.
Both of these are not very interesting: The identity operator does not weaken
propositions at all, while the constant operator weakens every proposition to
the trivial statement~$\top$.

In intuitionistic logic, there can potentially exist further modal operators.
For applications to algebraic geometry, the following four operators will have
a clear geometric meaning and be of particular importance:
\begin{enumerate}
\item $\Box\varphi :\equiv (\alpha \Rightarrow \varphi)$, where~$\alpha$ is a
fixed proposition.
\item $\Box\varphi :\equiv (\varphi \vee \alpha)$, where~$\alpha$ is a
fixed proposition.
\item $\Box\varphi :\equiv \neg\neg\varphi$ (the \emph{double negation
modality}).
\item $\Box\varphi :\equiv ((\varphi \Rightarrow \alpha) \Rightarrow \alpha)$,
where~$\alpha$ is a fixed proposition.
\end{enumerate}

\begin{lemma}Any modal operator~$\Box$ is monotonic, i.\,e. if~$\varphi
\Rightarrow \psi$, then~$\Box\varphi \Rightarrow \Box\psi$. Furthermore, there
holds a modus ponens rule: If~$\Box\varphi$ holds, and~$\varphi$
implies~$\Box\psi$, then~$\Box\psi$ holds as well.\end{lemma}
\begin{proof}Assume~$\varphi \Rightarrow \psi$. This is equivalent to
supposing~$\varphi \wedge \psi \Leftrightarrow \varphi$. We are to show
that~$\Box\varphi \Rightarrow \Box\psi$, i.\,e. that~$\Box\varphi \wedge
\Box\psi \Leftrightarrow \Box\varphi$. The statement follows since by the third
axiom on a modal operator, we have~$\Box\varphi \wedge \Box\psi \Leftrightarrow
\Box(\varphi \wedge \psi)$.

For the second statement, consider that if~$\varphi \Rightarrow \Box\psi$, by
monotonicity and the second axiom on a modal operator it follows
that~$\Box\varphi \Rightarrow \Box\Box\psi \Rightarrow \Box\psi$.
\end{proof}

The modus ponens rule justifies the following proof scheme: When showing
that a boxed statement~$\Box\psi$ holds given that a further boxed
statement~$\Box\varphi$ holds, we may assume that indeed~$\varphi$ holds.


\subsection{Geometric meaning} Let~$X$ be a topological space. As discussed
above, an open subset~$U \subseteq X$ defines an internal truth value (a global
section of the sheaf~$\Omega$) also
denoted by~``$U$'' such that
\[ V \models U \quad\Longleftrightarrow\quad V \subseteq U \]
for any open subset~$V \subseteq X$. (Shortcutting the various intermediate
steps, this can also be taken as a definition of~``$V \models U$''.)
If~$A \subseteq X$ is a closed subset, there is thus an internal truth
value~$A^c$ corresponding to the open subset~$A^c = X \setminus A$. If~$x \in
X$ is a point, we define~``$\notat{x}$'' to denote the truth value
corresponding to~$\Int(X \setminus \{x\})$, such that
\[ V \models \notat{x} \quad\Longleftrightarrow\quad V \subseteq \Int(X
\setminus \{ x \}) \quad\Longleftrightarrow\quad x \not\in V. \]

\begin{prop}\label{prop:modops-kripke}
Let~$U \subseteq X$ be a fixed open and~$A \subseteq X$ be a fixed
closed subset. Let~$x \in X$. Then, for any open subset~$V \subseteq X$, it
holds that:
\[ \renewcommand{\arraystretch}{1.3}\begin{array}{@{}lcl@{}}
  V \models (U \Rightarrow \varphi) &\Longleftrightarrow&
    V \cap U \models \varphi. \\[0.3em]
  V \models (\varphi \vee A^c) &\Longleftrightarrow&
    \textnormal{there is an open subset~$W \subseteq V$} \\
  && \quad\quad \textnormal{containing~$A \cap V$ s.\,th. $W \models \varphi$.} \\[0.3em]
  V \models \neg\neg\varphi &\Longleftrightarrow&
    \textnormal{there is a dense open subset~$W \subseteq V$ s.\,th. $W \models
    \varphi$.} \\[0.3em]
  V \models ((\varphi \Rightarrow \notat{x}) \Rightarrow \notat{x}) &\Longleftrightarrow&
    \textnormal{$x \not\in V$ or there is an open neighbourhood~$W \subseteq V$} \\
  && \quad\quad \textnormal{of~$x$ s.\,th. $W \models \varphi$.}
\end{array} \]
\end{prop}
\begin{proof}
\begin{enumerate}
\item Omitted.

\item Let~$V \models \varphi \vee A^c$. Then there exists an open covering~$V =
\bigcup_i V_i$ such that for each~$i$, $V_i \models \varphi$ or $V_i \subseteq
A^c$. Let~$W \subseteq V$ be the union of those~$V_i$ such that~$V_i \models \varphi$.
Then~$W \models \varphi$ by the locality of the internal language and~$A \cap V
\subseteq W$.

Conversely, let~$W \subseteq V$ be an open subset containing~$A \cap V$ such
that~$W \models \varphi$. Then~$V = W \cup (V \cap A^c)$ is an open covering
attesting~$V \models \varphi \vee A^c$.

\item For the ``only if'' direction, let~$W \subseteq V$ be the largest
open subset on which~$\varphi$ holds, i.\,e. the union of all open subsets
of~$V$ on which~$\varphi$ holds. For the ``if'' direction, we may assume that
the given~$W$ is also the largest open subset on which~$\varphi$ holds (by
enlarging~$W$ if necessary). The claim then follows by the following chain of
equivalences:
\begin{align*}
  &\ V \models \neg\neg\varphi \\
  \Longleftrightarrow&\ \forall \text{$Y \subseteq V$ open}\_
    \left[\forall \text{$Z \subseteq Y$ open}\_ Z \models \varphi \Rightarrow Z
    = \emptyset\right] \Longrightarrow Y = \emptyset \\
  \Longleftrightarrow&\ \forall \text{$Y \subseteq V$ open}\_
    \left[\forall \text{$Z \subseteq Y$ open}\_ Z \subseteq W \Rightarrow Z
    = \emptyset\right] \Longrightarrow Y = \emptyset \\
  \Longleftrightarrow&\ \forall \text{$Y \subseteq V$ open}\_
    Y \cap W = \emptyset \Longrightarrow Y = \emptyset \\
  \Longleftrightarrow&\ \text{$W$ is dense in~$V$.}
\end{align*}

\item Straightforward, since the interpretation of the internal statement with
the Kripke--Joyal semantics is
\[ \forall \text{$Y \subseteq V$ open}\_
  \left[\forall \text{$Z \subseteq Y$ open}\_
    Z \models \varphi \Rightarrow x \not\in Z\right] \Longrightarrow x \not\in
    Y. \qedhere \]
\end{enumerate}
\end{proof}


\subsection{The subspace associated to a modal operator}
Any modal operator~$\Box : \Omega \to \Omega$ in the sheaf topos of~$X$ induces
on global sections a map
\[ j : \Open(X) \to \Open(X), \]
where~$\Open(X) = \Gamma(X,\Omega)$ is the set of open subsets of~$X$. By the
axioms on a modal operator, the map~$j$ fulfills similar axioms: For any open
subsets~$U, V \subseteq X$,
\begin{enumerate}
\item $U \subseteq j(U)$,
\item $j(j(U)) \subseteq j(U)$,
\item $j(U \cap V) = j(U) \cap j(V)$.
\end{enumerate}
Such a map is called a \emph{nucleus} on~$\Open(X)$. Table~\ref{table:nuclei}
lists the nuclei associated to the four modal operators
of proposition~\ref{prop:modops-kripke}.

\begin{table}
  \centering
  \setlength{\extrarowheight}{0.4em}
  \begin{tabular}{llll}
    Modal operator & associated nucleus &
      $j(V) = X$ iff \ldots &
      subspace \\\hline
    $\Box\varphi :\equiv (U \Rightarrow \varphi)$ &
      $j(V) = \Int(U^c \cup V)$ & $U \subseteq V$ & $U$ \\
    $\Box\varphi :\equiv (\varphi \vee A^c)$ &
      $j(V) = V \cup A^c$ & $A \subseteq V$ & $A$ \\
    $\Box\varphi :\equiv \neg\neg\varphi$ &
      $j(V) = \Int(\Clos(V))$ & $V$ is dense in $X$ & (see text) \\
    $\Box\varphi :\equiv ((\varphi \Rightarrow \notat{x}) \Rightarrow \notat{x})$ &
%      $\Int(\Clos(V \cap \Clos\{x\}) \cup (X \setminus \Clos\{x\}))$ &
      $j(V) = \begin{cases}
        X \setminus \Clos\{x\}, & \text{if $x \not\in V$} \\
        X, & \text{if $x \in V$}
      \end{cases}$ &
      $x \in V$ & $\{x\}$
  \end{tabular}

  \caption{\label{table:nuclei}List of important modal operators and their
  associated nuclei (notation as in proposition~\ref{prop:modops-kripke}).}
\end{table}

Any nucleus~$j$ defines a subspace~$X_j$ of~$X$, with a small caveat: In
general, the subspace~$X_j$ can not be realized as a topological subspace, but
only as a so-called \emph{sublocale}; the notion of a locale is a slight
generalization of the notion of a topological space, in which an underlying set
of points is not part of the definition. Instead, a locale is simply given by a
lattice of general \emph{opens} -- these may, but do not necessarily have to,
be sets of points. Sheaf theory carries over to locales essentially unchanged,
since the notions of presheaves and sheaves only need opens and coverings.
% XXX: give introductory reference

\begin{defn}\label{defn:subspace-by-nucleus}Let~$j$ be a nucleus on~$\Open(X)$.
Then a sublocale~$X_j$ of~$X$ is given by the lattice of opens
$\Open(X_j) := \{ U \in \Open(X) \,|\, j(U) = U \}$.
\end{defn}
If~$j$ is induced by a modal operator~$\Box$, we also write~``$X_\Box$''
for~$X_j$. In three of the four cases listed in table~\ref{table:nuclei}, the
sublocale~$X_\Box$ can indeed be realized as a topological subspace. The only
exception is the sublocale~$X_{\neg\neg}$ associated to the double negation
modality. It can be also be described as the \emph{smallest dense sublocale}
of~$X$; this is obviously a true locale-theoretic notion, since a topological
space does not have (in general) a smallest dense topological subspace
(consider~$\RR$ and its dense subsets~$\QQ$ and~$\RR \setminus \QQ$).
% XXX: word "true"

The inclusion~$i : X_j \hookrightarrow X$ can not in general be described on the
level of points, since~$X_j$ might not be realizable as a topological subspace.
But for sheaf-theoretic purposes, it suffices to describe~$i$ on the level of
opens. This is done as follows:
\[ i^{-1} : \Open(X) \lra \Open(X_j), \quad U \longmapsto j(U). \]
Thus we can relate the toposes of sheaves on~$X_j$ and~$X$ by the usual
pullback and pushforward functors.
\begin{align*}
  i^{-1} \F &= \text{sheafification of $(U \mapsto \colim_{U \preceq i^{-1}V} \Gamma(V,\F))$} \\
  i_* \G &= (U \mapsto \Gamma(i^{-1}U, \G) = \Gamma(j(U), \G))
\end{align*}
As familiar from honest topological subspace inclusions, the pushforward
functor~$i_* : \Sh(X_j) \to \Sh(X)$ is fully faithful and the composition~$i^{-1}
\circ i_* : \Sh(X_j) \to \Sh(X_j)$ is (isomorphic to) the identity.


\subsection{Internal sheaves and sheafification} It turns out that the image of
the pushforward functor~$i_* : \Sh(X_\Box) \to \Sh(X)$, where~$\Box$ is a modal
operator in~$\Sh(X)$, can be explicitly described: Namely, it consists exactly
of those sheaves which from the internal point of view
are so-called~\emph{$\Box$-sheaves}, a notion explained below.

Furthermore, if we identify~$\Sh(X_\Box)$ with its image in~$\Sh(X)$, the
pullback functor is given by an internal sheafification process with respect to
the modality~$\Box$. Thus the external situation of pushforward/pullback
translates to forget/sheafify. This broadens the scope of the internal
language: It can not only be used to talk about sheaves on~$X$ in a simple,
element-based language, but also to talk about sheaves on arbitrary subspaces
of~$X$.

To describe the notion of~$\Box$-sheaves and related ones, we switch to the internal
perspective and thus forget~$X$; we are simply given a model operator~$\Box :
\Omega \to \Omega$ and have to take care that our proofs are intuitionistic.

\begin{defn}A set~$F$ is \emph{$\Box$-separated} if and only if
\[ \forall x,y\?F\_ \Box(x = y) \Longrightarrow x = y. \]
A set~$F$ is a \emph{$\Box$-sheaf} if and only if it is~$\Box$-separated and
\[ \forall S \subseteq F\_
  \Box(\speak{$S$ is a singleton}) \Longrightarrow
  \exists x\?F\_ \Box(x \in S). \]
\end{defn}

The two conditions can be combined: A set~$F$ is a~$\Box$-sheaf if and only if
\[ \forall S \subseteq F\_
  \Box(\speak{$S$ is a singleton}) \Longrightarrow
  \exists! x\?F\_ \Box(x \in S). \]

\begin{defn}The \emph{plus construction} of a set~$F$ with respect to~$\Box$ is the set
\[ F^+ := \{ S \subseteq F \,|\, \Box(\speak{$S$ is a singleton}) \}/{\sim},
\]
where the equivalence relation is defined by~$S \sim T :\Leftrightarrow
\Box(S = T)$. There is a canonical map~$F \to F^+$ given by~$x \mapsto
[\{x\}]$. The \emph{$\Box$-sheafi\-fi\-ca\-tion} of a set~$F$ is the
set~$F^{++}$.
\end{defn}

\begin{rem}The topos of \emph{pre}sheaves on a topological space~$X$ admits an
internal language as well~\cite[???]{moerdijk}. In it, there
exists a modal operator~$\Box$ reflecting the topology of~$X$. A presheaf is separated
in the usual sense if, from the internal perspective of~$\PSh(X)$, it
is~$\Box$-separated; and it is a sheaf if, from the internal perspective, it
is a~$\Box$-sheaf. Furthermore, the~$\Box$-sheafification of a presheaf
(considered as a set from the internal perspective) coincides with the usual
sheafification.\end{rem}

\begin{lemma}For any set~$F$, it holds that: \begin{enumerate}
\item $F^+$ is~$\Box$-separated.
\item The canonical map~$F \to F^+$ is injective if and only if~$F$
is~$\Box$-separated.
\item If~$F$ is~$\Box$-separated, $F^+$ is a~$\Box$-sheaf.
\item If~$F$ is a~$\Box$-sheaf, the canonical map~$F \to F^+$ is bijective.
\end{enumerate}
Let``$\Sh_\Box(\Set)$'' denote the full subcategory of~$\Set$ consisting of
the~$\Box$-sheaves. Then it holds that:
\begin{enumerate}
\addtocounter{enumi}{4}
\item The functor~$(\placeholder)^+ : \Set \to \Set$ is left exact.
\item The functor~$(\placeholder)^{++} : \Set \to \Sh_\Box(\Set)$ is left exact and left
adjoint to the forgetful functor~$\Sh_\Box(\Set) \to \Set,\ F \mapsto F$.
\end{enumerate}\end{lemma}
\begin{proof}These are all straightforward, and it fact simpler than their
classical counterparts, since there are no colimit constructions which would have to
be dealt with.
\end{proof}

% XXX: introduce notion of Box-stability


\subsection{The~$\Box$-translation} There is certain well-known transformation~$\varphi
\mapsto \varphi^{\neg\neg}$ on formulas, the \emph{double negation
translation}, with the following curious property: A formula~$\varphi$ is
derivable in classical logic if and only if its
translation~$\varphi^{\neg\neg}$ is derivable in intuitionistic logic. The
translation~$\varphi^{\neg\neg}$ is obtained from~$\varphi$ by putting
``$\neg\neg$'' before any subformula, i.\,e. before any~``$\exists$''
and~``$\forall$'', around any logical connective and around any atomic
statement (``$x=y$'', ``$x \in A$'').

We will describe a slight generalization of the double negation translation,
the~$\Box$-translation for any modal operator~$\Box$.
% check http://arxiv.org/pdf/1101.5442.pdf for references to cite

\begin{defn}The~\emph{$\Box$-translation} is recursively defined as follows.
\newcommand{\optBox}{\textcolor{gray}{\Box}}
\begin{align*}
  (f = g)^\Box &:\equiv \Box(f = g) \\
  (x \in A)^\Box &:\equiv \Box(x \in A) \\
  \top^\Box &:\equiv \Box\top \quad \text{($\Leftrightarrow \top$)} \\
  \bot^\Box &:\equiv \Box\bot \\
  (\varphi \wedge \psi)^\Box &:\equiv \optBox(\varphi^\Box \wedge \psi^\Box) &
  \textstyle (\bigwedge_i \varphi_i)^\Box &:\equiv \textstyle \optBox(\bigwedge_i \varphi_i^\Box) \\
  (\varphi \vee \psi)^\Box &:\equiv \Box(\varphi^\Box \vee \psi^\Box) &
  \textstyle (\bigvee_i \varphi_i)^\Box &:\equiv \textstyle \Box(\bigvee_i \varphi_i^\Box) \\
  (\varphi \Rightarrow \psi)^\Box &:\equiv \optBox(\varphi^\Box \Rightarrow \psi^\Box) \\
  (\forall x\?X\_ \varphi)^\Box &:\equiv \optBox(\forall x\?X\_ \varphi^\Box) &
  (\forall X\_ \varphi)^\Box &:\equiv \optBox(\forall X\_ \varphi^\Box) \\
  (\exists x\?X\_ \varphi)^\Box &:\equiv \Box(\exists x\?X\_ \varphi^\Box) &
  (\exists X\_ \varphi)^\Box &:\equiv \Box(\exists X\_ \varphi^\Box)
\end{align*}
\end{defn}

\begin{lemma}\begin{enumerate}
\item Formulas in the image of the $\Box$-translation are~$\Box$-stable,
i.\,e. for any formula~$\varphi$ it holds that
$\Box(\varphi^\Box) \Longrightarrow \varphi^\Box$.
\item In the definition of the~$\Box$-translation, one may omit the boxes
printed in gray.
\end{enumerate}\end{lemma}
\begin{proof}The first statement is obvious, since one of the axioms on a modal
operator demands that~$\Box\Box\varphi \Rightarrow \varphi$ for any
formula~$\varphi$. The second statement follows by an induction on the
formula structure. By way of example, we prove the case for~``$\Rightarrow$'':
\newcommand{\withgray}{\text{$\Box$ with the gray parts}}
\newcommand{\withoutgray}{\text{$\Box$ without the gray parts}}
\begin{align*}
  &\ (\varphi \Rightarrow \psi)^\withgray \\
  \Longleftrightarrow &\ \Box(\varphi^\withgray \Rightarrow \psi^\withgray) \\
  \Longleftrightarrow &\ (\varphi^\withgray \Rightarrow \psi^\withgray) \\
  \Longleftrightarrow &\ (\varphi^\withoutgray \Rightarrow \psi^\withoutgray) \\
  \Longleftrightarrow &\ (\varphi \Rightarrow \psi)^\withoutgray
\end{align*}
The first step is by definition; the second by~$\Box$-stability
of~$\psi^\withgray$; the third by the induction hypothesis; the fourth by
definition.
\end{proof}

\begin{lemma}Let~$\varphi$ be a formula such that for any subformulas~$\psi$
appearing as antecedents of implications, it holds that~$\psi^\Box \Rightarrow
\Box\psi$. (In particular, this condition is satisfied if there is
no~``$\Rightarrow$'' in~$\varphi$.) Then $\Box\varphi \Rightarrow
\varphi^\Box$.\end{lemma}
\begin{proof}We prove this by an induction on the formula structure. All cases
except for~``$\Rightarrow$'' are obvious. For this case, assume~$\Box(\varphi
\Rightarrow \psi)$; we are to show that~$(\varphi^\Box \Rightarrow \psi^\Box)$.
Since this is a~$\Box$-stable statement, we can in fact assume that~$(\varphi
\Rightarrow \psi)$. We thus have
\[ \varphi^\Box \Longrightarrow \Box\varphi \Longrightarrow \Box\psi
\Longrightarrow \psi^\Box, \]
with the first step being by the requirement on antecedents, the second by the
monotonicity of~$\Box$, and the third by the induction hypothesis.
\end{proof}

\begin{lemma}Let~$\varphi$ be a geometric formula.
Then $\varphi^\Box \Rightarrow \Box\varphi$.\end{lemma}
\begin{proof}By induction on the formula structure. By way of example, we prove
the case for~``$\bigvee$''. So assume~$\Box(\bigvee_i \varphi_i^\Box)$; we are
to show that~$\Box(\bigvee_i \varphi_i)$. Since this is a boxed statement, we
may in fact assume~$\bigvee_i \varphi_i^\Box$, so for some index~$j$, it holds
that~$\varphi_j^\Box$. By the induction hypothesis, it follows
that~$\Box\varphi_j$. By~$\varphi_j \Rightarrow \bigvee_i \varphi_i$ and the
monotonicity of~$\Box$, it follows that that~$\Box(\bigvee_i \varphi_i)$.
\end{proof}

%\begin{ex}The failure of~$(\bigwedge_i \varphi_i)^\Box \equiv \bigwedge_i
%\varphi_i^\Box \Rightarrow \Box(\bigwedge_i \varphi_i)$ can be nicely
%illustrated with the internal language of a sheaf topos~$\Sh(X)$.
%\end{ex}

\begin{rem}In the special case that~$\Box$ is the double negation modality, the
lemma holds with slightly weaker hypotheses: Namely, implications may occur
in~$\varphi$, provided that for their antecedents~$\psi$ it holds that~$\psi
\Rightarrow \psi^\Box$.\end{rem}
% is this remark useful?

\begin{lemma}For the modality~$\Box$ defined by~$\Box\varphi :\equiv ((\varphi
\Rightarrow \alpha) \Rightarrow \alpha)$, where~$\alpha$ is a fixed
proposition, the~$\Box$-translation of the law of excluded middle holds.
In particular, this is for the~$\Box = \neg\neg$, where~$\alpha =
\bot$.\end{lemma}
\begin{proof}We are to show that~$(\varphi \vee \neg\varphi)^\Box$, i.\,e. that
\[ (((\varphi^\Box \vee (\varphi^\Box \Rightarrow \alpha)) \Longrightarrow
\alpha) \Longrightarrow \alpha. \]
So assume that the antecedent holds. If~$\varphi^\Box$ would hold, then in
particular~$\varphi^\Box \vee (\varphi^\Box \Rightarrow \alpha)$ and thus~$\alpha$
would hold. Therefore it follows that~$(\varphi^\Box \Rightarrow \alpha)$. This
implies~$\varphi^\Box \vee (\varphi^\Box \Rightarrow \alpha)$ and
thus~$\alpha$.
\end{proof}


\subsection{Truth at stalks vs. truth on neighbourhoods}\label{sect:spreading}
We now state the crucial property of the~$\Box$-translation. Recall
that~``$X_\Box$'' denotes the sublocale of~$X$ induced by~$\Box$
(definition~\ref{defn:subspace-by-nucleus}).
\begin{thm}\label{thm:box-translation-semantically}
Let~$X$ be a topological space. Let~$\Box$ be a modal operator
in~$\Sh(X)$. Let~$\varphi$ be a formula. Then
\[ \Sh(X) \models \varphi^\Box \quad\text{iff}\quad
  \Sh(X_\Box) \models \varphi. \]
\end{thm}

\begin{cor}Let~$X$ be a topological space.
\begin{enumerate}
\item Let~$U \subseteq X$ be an open subset and let~$\Box\varphi :\equiv (U
\Rightarrow \varphi)$. Then
\[ \Sh(X) \models \varphi^\Box \quad\text{iff}\quad \Sh(U) \models \varphi. \]
\item Let~$A \subseteq X$ be a closed subset and let~$\Box\varphi :\equiv
(\varphi \vee A^c)$. Then
\[ \Sh(X) \models \varphi^\Box \quad\text{iff}\quad \Sh(A) \models \varphi. \]
\item Let~$x \in X$ be a point and let~$\Box\varphi :\equiv ((\varphi
\Rightarrow \notat{x}) \Rightarrow \notat{x})$. Then
\[ \Sh(X) \models \varphi^\Box \quad\text{iff}\quad \text{$\varphi$ holds
at~$x$}. \]
% change text below ("discuss the third case") if numbering of the items changes
\end{enumerate}
\end{cor}
\begin{proof}Combine theorem~\ref{thm:box-translation-semantically} and
table~\ref{table:nuclei}.\end{proof}

We want to discuss the third case of the corollary in more detail. Let~$x$ be a
point of a topological space~$X$ and let~$\varphi$ be a formula. Let~$\Box$ be
the modal operator given in the corollary. Then~$\varphi$ \emph{holds at~$x$}
if and only if, from the internal perspective of~$\Sh(X)$, the translated
formula~$\varphi^\Box$ holds; and~$\varphi$ \emph{holds on some open
neighbourhood of~$x$} if and only if, from the internal perspective, the
formula~$\Box\varphi$ holds.

Thus the question whether the truth of~$\varphi$ at the point~$x$ spreads to
some open neighbourhood can be formulated in the following way:
\emph{Does~$\varphi^\Box$ imply~$\Box\varphi$ in the internal language
of~$\Sh(X)$?}

\begin{cor}\label{cor:geometric-spreading}
Let~$X$ be a topological space. Let~$\varphi$ be a formula.
If~$\varphi$ is geometric, truth of~$\varphi$ at a point~$x \in X$ implies
truth of~$\varphi$ on some open neighbourhood of~$x$, and vice versa.\end{cor}
\begin{proof}By the purely logical lemmas of the previous section, it holds
that~$\varphi^\Box \Leftrightarrow \Box\varphi$.
\end{proof}

% discuss the case x = generic point, and discuss that for us, absence of a
% generic point is no problem

\begin{proof}[Proof of theorem~\ref{thm:box-translation-semantically}]
\ldots
\end{proof}

\begin{ex}Let~$X$ be a scheme (or a ringed space). Since the condition for a
function~$f\?\O_X$ to be nilpotent is geometric (it is~$\bigvee_{n \geq 0} f^n
= 0$), nilpotency of~$f$ at a point is equivalent to nilpotency on some open
neighbourhood.\end{ex}

\begin{itemize}
\item general explanation of modalities (as for instance in philosophy)
\item explain that for some modal operators, the~$\Box$-translation of the law
of excluded middle is valid; explain consequences
\item spreading of properties from stalk to neighbourhood: give many examples
% $\G \to \F$ surjective at~$x$, $\F$ of finite type ==> surjective on neighbourhood
% $\G \to \F$ injective at~$x$, $\F$ coherent, $\G$ of finite type ==> injective on neighbourhood
% F_x = 0, F of finite type ==> F = 0 on neighbourhood
% i closed immersion, then i_*(F) of finite type iff F of finite type
\item give proof of the expressions for the nuclei listed in the table
\item baby version of Barr's theorem
\end{itemize}


\section{Quasicoherent sheaves of modules}

Recall that an~$\O_X$-module~$\F$ on a ringed space~$X$ is \emph{quasicoherent}
if and only if there exists a covering of~$X$ by open subsets~$U$ such that on
each such~$U$, there exists an exact sequence
\[ (\O_X|_U)^J \longrightarrow (\O_X|_U)^I \longrightarrow \F|_U \longrightarrow 0 \]
of~$\O_X|_U$-modules, where~$I$ and~$J$ are arbitrary sets (which may depend
on~$U$).

If~$X$ is indeed a scheme, quasicoherence can also be characterized in
terms of inclusions of distinguished open subsets of affines:
An~$\O_X$-module~$\F$ is quasicoherent if and only if for any open affine
subscheme~$U = \Spec A$ of~$X$ and any function~$f \in A$, the canonical map
\[ \Gamma(U,\F)[f^{-1}] \longrightarrow \Gamma(D(f),\F),\ 
  \tfrac{s}{f^n} \longmapsto f^{-n} s|_{D(f)} \]
is an isomorphism of~$A[f^{-1}]$-modules. Here~$D(f) \subseteq U$ denotes the
standard open subset~$\{ \ppp \in \Spec A \,|\, f \not\in \ppp \}$. Both
conditions can be internalized.

\begin{prop}Let~$X$ be a ringed space. Let~$\F$ be an~$\O_X$-module. Then~$\F$
is quasicoherent if and only if
\[ \Sh(X) \models \exists I,J\ \mathrm{lc}\_ \speak{there exists an
  exact sequence~$\O_X^J \to \O_X^I \to \F \to 0$}. \]
The ``\textnormal{lc}'' indicates that when interpreting this internal statement with the
Kripke--Joyal semantics,~$I$ and~$J$ should only be instantiated with
\emph{locally constant} sheaves.
\end{prop}
\begin{proof} We only sketch the proof.
The translation of the internal statement is that there exists a covering
of~$X$ by open subsets~$U$ such that for each such~$U$, there exist sets~$I,J$
and an exact sequence
\[ (\O_X|_U)^{\ul{J}} \longrightarrow (\O_X|_U)^{\ul{I}} \longrightarrow \F|_U
\longrightarrow 0 \]
where~$\ul{I}$ and~$\ul{J}$ are the constant sheaves associated to~$I$
respectively~$J$. The term~``$(\O_X|_U)^{\ul{I}}$'' refers to the internally
defined free~$\O_X$-module with basis the elements of~$\ul{I}$. By exploiting
that~$\ul{I}$ is a discrete set from the internal point of view (i.\,e. any two
elements are either equal or not), one can show that this is the same
as~$(\O_X|_U)^I$; similarly for~$J$. With this observation, the statement
follows.
\end{proof}

In practice, the internal condition given by the proposition is not very
useful, since at the moment, we do not know of any internal characterization of
locally constant sheaves. The internal condition given by the following
proposition does not have this defect.

\begin{prop}\label{qcoh:sheafchar}
Let~$X$ be scheme. Let~$\F$ be an~$\O_X$-module. Then~$\F$ is
quasicoherent if and only if, from the internal perspective, the localized
module~$\F[f^{-1}]$ is a sheaf for the modal operator~$(\speak{$f$ inv.}
\Rightarrow \placeholder)$ for any~$f\?\O_X$.
\end{prop}

In detail, the internal condition is that for any~$f\?\O_X$, it holds that
\[ \forall s\?\F[f^{-1}]\_
  (\speak{$f$ inv.} \Rightarrow s = 0) \Longrightarrow s = 0 \]
and for any subsingleton~$S \subseteq \F[f^{-1}]$ it holds that
\[ (\speak{$f$ inv.} \Rightarrow \speak{$S$ inhabited}) \Longrightarrow
  \exists s\?\F[f^{-1}]\_
  (\speak{$f$ inv.} \Rightarrow s \in S). \]
Unlike with the internalizations of finite type, finite presentation and
coherence, this condition is \emph{not} a standard condition of commutative
algebra. In fact, in classical logic, this condition is always satisfied --
for trivial logical reasons if~$f$ is invertible and because~$\F[f^{-1}]$ is
the zero module if~$f$ is not invertible (since then, it's nilpotent). This is
to be expected: \emph{Any} module~$M$ in commutative algebra is quasicoherent in
the sense that the associated sheaf of modules~$M^\sim$ is quasicoherent.
% XXX: More to the point, commutative algebra does not deal with
% quasicoherence, since quasicoherence is an interesting condition only on on
% arbitrary schemes, not on affine schemes.

The proof will explain the origin of this condition.

\begin{proof}[Proof of proposition~\ref{qcoh:sheafchar}]\ldots\end{proof}

\begin{cor}Let~$X$ be a scheme. Let~$\F$ be a quasicoherent~$\O_X$-module.
Let~$\G \subseteq \F$ be a submodule. Then~$\G$ is quasicoherent if and only
if
\[ \Sh(X) \models \forall f\?\O_X\_
  \forall s\?\F\_
  (\speak{$f$ inv.} \Rightarrow s \in \G) \Longrightarrow
  \bigvee_{n \geq 0} f^n s \in \G. \]
\end{cor}
\begin{proof}We can give a purely internal proof. Let~$f\?\O_X$.
Since subpresheaves of separated sheaves are separated, the module~$\G[f^{-1}]$
is in any case separated with respect to the modal operator~$(\speak{$f$ inv.}
\Rightarrow \placeholder)$.

Now suppose that~$\G$ is quasicoherent. Let~$f\?\O_X$. Let $s\?\F$ and assume that
if~$f$ were invertible,~$s$ would be an element of~$\G$. Define the
subsingleton~$S := \{ t\?\G[f^{-1}] \,|\, \speak{$f$ inv.} \wedge t=s/1 \}$.
Then~$S$ would be inhabited by~$s/1$ if~$f$ were invertible. Since~$\G[f^{-1}]$
is a sheaf, it follows that there exists an element~$u/f^n$ of~$\G[f^{-1}]$
such that, if~$f$ were invertible, it would be the case that~$u/f^n = s/1 \in
\G[f^{-1}] \subseteq \F[f^{-1}]$.
Since~$\F[f^{-1}]$ is separated, it follows that it actually holds that~$u/f^n
= s/1 \in \F[f^{-1}]$. Therefore there exists~$m\?\NN$ such that $f^m f^n s =
f^m u \in \F$. Thus~$f^{m+n} s$ is an element of~$\G$.

For the converse direction, assume that~$\G$ fulfills the stated condition.
Let$f\?\O_X$. Let~$S \subseteq \G[f^{-1}]$ be a subsingleton which would be
inhabited if~$f$ were invertible. By regarding~$S$ as a subset of~$\F[f^{-1}]$,
it follows that there exists an element~$u/f^n \in \F[f^{-1}]$ such that,
if~$f$ were invertible, $u/f^n$ would be an element of~$S$. In particular,~$u$
would be an element of~$\G$. By assumption
it follows that there exists~$m\?\NN$ such that~$f^m u \in G$. Thus~$(f^m u) /
(f^m f^n)$ is an element of~$\G[f^{-1}]$ such that, if~$f$ were invertible, it
would be an element of~$S$.
\end{proof}

\begin{ex}\label{ex:annihilator-qcoh}
Let~$X$ be a scheme and~$s$ be a global section of~$\O_X$. Then the
annihilator of~$s$, i.\,e. the sheaf of ideals internally defined by the
formula
\[ I := \Ann_{\O_X}(s) = \{ t\?\O_X \,|\, st = 0 \} \subseteq \O_X \]
is quasicoherent. To prove this in the internal language, it suffices to
verify the condition of the proposition.
So let~$f:\O_X$ be arbitrary and assume~$\speak{$f$ inv.} \Rightarrow t \in I$,
i.\,e. assume that if~$f$ were invertible,~$st$ would be zero. By
proposition~\ref{prop:cond-zero} it follows that~$f^n st = 0$ for
some~$n\?\NN$, i.\,e. that~$f^n t \in I$.
\end{ex}

\begin{itemize}
\item is the condition good enough to show that modules of finite type are
quasicoherent? To show that cokernels are quasicoherent?
\item discussion meaning of the sheaf condition in external language
\item give more examples: $\sqrt{(0)}$, $(h)$, \ldots
\item Noetherian hypotheses: for example, that any quasicoherent submodule of a
module of finite type is of finite type as well
\end{itemize}


\section{Unsorted}
\begin{itemize}
\item ``functoriality''
\item Kähler differentials
\item closed and open subschemes
\item reduced closed subscheme
\item Koszul resolution
\item meta properties, uses (e.g. nilpotent on stalks iff globally nilpotent,
some lemmas about limits of modules)
\item compactness principle for ``$f$ inv.''
\item locally small categories
\item big Zariski topos
\item open/closed immersions
\item morphisms of schemes...
\item proper maps...
\item limits and colimits...
\item related work: Mulvey/Burden, Wraith, Vickers, the Bohr topos crew, Awodey, ...
\end{itemize}

\end{document}

XXX: ``completed natural number'' is a misnomer.

XXX: standardize level of generality: ringed locales, where possible?

XXX: remark that for simplicity, we work in a classical metatheory

XXX: replace []'s with ()'s where appropriate

XXX: word "intuitionistic"

XXX: check whether the negneg translation ``finitely generated ==> free''
implies the hard but important exercise
