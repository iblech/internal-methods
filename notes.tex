\documentclass[10pt]{amsart}
\usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\usepackage{amsmath,amsthm,amssymb,stmaryrd,color,graphicx,multirow}
\usepackage{setspace}
\usepackage{bussproofs}
\usepackage{xspace}
\usepackage{longtable}
\usepackage{booktabs}
\usepackage{array}
\usepackage[protrusion=true,expansion=true]{microtype}
\usepackage[bookmarksdepth=2,pdfencoding=auto]{hyperref}
\usepackage[all]{xy}

\usepackage{tikz}
\usetikzlibrary{calc,shapes.callouts,shapes.arrows}
\newcommand{\hcancel}[5]{%
    \tikz[baseline=(tocancel.base)]{
        \node[inner sep=0pt,outer sep=0pt] (tocancel) {#1};
        \draw[red, line width=0.3mm] ($(tocancel.south west)+(#2,#3)$) -- ($(tocancel.north east)+(#4,#5)$);
    }%
}

\usepackage[natbib=true,style=numeric]{biblatex}
\usepackage[babel]{csquotes}
\bibliography{bibliography}

\theoremstyle{definition}
\newtheorem{defn}{Definition}[section]
\newtheorem{ex}[defn]{Example}

\theoremstyle{plain}

\newtheorem{prop}[defn]{Proposition}
\newtheorem{cor}[defn]{Corollary}
\newtheorem{lemma}[defn]{Lemma}
\newtheorem{thm}[defn]{Theorem}

\theoremstyle{remark}
\newtheorem{rem}[defn]{Remark}

\newcommand{\ZZ}{\mathbb{Z}}
\newcommand{\FF}{\mathbb{F}}
\renewcommand{\AA}{\mathbb{A}}
\newcommand{\A}{\mathcal{A}}
\renewcommand{\C}{\mathcal{C}}
\newcommand{\D}{\mathcal{D}}
\newcommand{\E}{\mathcal{E}}
\newcommand{\F}{\mathcal{F}}
\renewcommand{\G}{\mathcal{G}}
\renewcommand{\H}{\mathcal{H}}
\renewcommand{\O}{\mathcal{O}}
\newcommand{\K}{\mathcal{K}}
\newcommand{\N}{\mathcal{N}}
\newcommand{\M}{\mathcal{M}}
\renewcommand{\L}{\mathcal{L}}
\renewcommand{\P}{\mathcal{P}}
\newcommand{\R}{\mathcal{R}}
\newcommand{\I}{\mathcal{I}}
\renewcommand{\S}{\mathcal{S}}
\newcommand{\NN}{\mathbb{N}}
\newcommand{\RR}{\mathbb{R}}
\newcommand{\QQ}{\mathbb{Q}}
\newcommand{\GG}{\mathbb{G}}
\newcommand{\aaa}{\mathfrak{a}}
\newcommand{\ppp}{\mathfrak{p}}
\newcommand{\mmm}{\mathfrak{m}}
\newcommand{\nnn}{\mathfrak{n}}
\newcommand{\Hom}{\mathrm{Hom}}
\newcommand{\HOM}{\mathcal{H}\mathrm{om}}
\newcommand{\id}{\mathrm{id}}
\newcommand{\GL}{\mathrm{GL}}
\newcommand{\placeholder}{\underline{\quad}}
\newcommand{\ul}[1]{\underline{#1}}
\newcommand{\Set}{\mathrm{Set}}
\newcommand{\Grp}{\mathrm{Grp}}
\newcommand{\Vect}{\mathrm{Vect}}
\newcommand{\Sh}{\mathrm{Sh}}
\newcommand{\PSh}{\mathrm{PSh}}
\newcommand{\Zar}{\mathrm{Zar}}
\newcommand{\Sch}{\mathrm{Sch}}
\newcommand{\Mod}{\mathrm{Mod}}
\newcommand{\Alg}{\mathrm{Alg}}
\newcommand{\Ring}{\mathrm{Ring}}
\newcommand{\LRL}{\mathrm{LRL}}
\newcommand{\pt}{\mathrm{pt}}
\newcommand{\tors}{\mathrm{tors}}
\DeclareMathOperator{\Spec}{Spec}
\newcommand{\QcohSpec}[2]{\mathrm{Spec}^{\mathrm{qcoh}}_{#1}{#2}}
\newcommand{\RelSpec}[2]{\mathrm{RelSpec}_{#1}{#2}}
\newcommand{\op}{\mathrm{op}}
\DeclareMathOperator{\colim}{colim}
\DeclareMathOperator{\rank}{rank}
\DeclareMathOperator{\Ann}{Ann}
\DeclareMathOperator{\Int}{int}
\DeclareMathOperator{\Clos}{cl}
\DeclareMathOperator{\Kernel}{ker}
\DeclareMathOperator{\supp}{supp}
\newcommand{\Ass}{\mathrm{Ass}}
\newcommand{\Open}{\mathrm{Op}}
\newcommand{\?}{\,{:}\,}
\renewcommand{\_}{\mathpunct{.}\,}
\newcommand{\speak}[1]{\ulcorner\text{\textnormal{#1}}\urcorner}
\newcommand{\Ll}{:\Longleftrightarrow}
\newcommand{\notat}[1]{{!#1}}
\newcommand{\lra}{\longrightarrow}
\newcommand{\lhra}{\ensuremath{\lhook\joinrel\relbar\joinrel\rightarrow}}
\newcommand{\hra}{\hookrightarrow}
\newcommand{\brak}[1]{{\llbracket{#1}\rrbracket}}
\newcommand{\ie}{i.\,e.\@\xspace}
\newcommand{\eg}{e.\,g.\@\xspace}
\newcommand{\vs}{vs.\@\xspace}
\newcommand{\resp}{resp.\@\xspace}
\newcommand{\inv}{inv.\@\xspace}
\newcommand{\notnot}{\emph{not not}\xspace}

\newcommand{\XXX}[1]{\textbf{XXX: #1}}

\definecolor{gray}{rgb}{0.7,0.7,0.7}

\title{Using the internal language of toposes in algebraic geometry}
\author{Ingo Blechschmidt}
\email{iblech@web.de}

\begin{document}

\begin{abstract}
  There are several important toposes associated to a scheme, for instance the
  petit and gros Zariski toposes. These support an internal mathematical language
  which closely resembles the usual formal language of mathematics, but is ``local
  on the base scheme'':
  For example, from the internal perspective, the structure sheaf looks like an
  ordinary local ring (instead of a sheaf of rings with local stalks) and vector
  bundles look like ordinary free modules (instead of sheaves of modules
  satisfying a certain condition). The translation of internal statements and
  proofs is facilitated by an easy mechanical procedure.

  These expository notes give an introduction to this topic and show how the internal
  point of view can be exploited to give simpler definitions and more conceptual
  proofs of the basic notions and observations in algebraic geometry.
  % For instance, any theorem about modules yields a corresponding theorem about
  % sheaves of modules (with a small caveat).
  We also employ this framework to study the phenomenon that some properties
  spread from points to open neighbourhoods. We give a general sufficient
  condition for this spreading to occur, depending only on the logical
  form of the property in question.

  No prior knowledge about topos theory or formal logic is assumed.
\end{abstract}

\maketitle

\begin{center}Rough draft in progress, missing explanations, references,
proofs, and a proper copyediting. I am happy about comments of any
kind; please direct them to \texttt{iblech@web.de}.\end{center}

%\setcounter{tocdepth}{1}
\tableofcontents

\section{Introduction}

\subsection*{Internal language of toposes}
A \emph{topos} is a category which shares certain categorical properties with
the category of sets; the archetypical example is the category of sets, and
the most important example for the purposes of these notes is the category of
set-valued sheaves on a topological space.

Any topos~$\E$ supports an \emph{internal language}. This is a device which
allows one to \emph{pretend} that the objects of~$\E$ are plain sets and that
the morphisms are plain maps between sets, even if in fact they are not. For
instance, consider a morphism~$\alpha : X \to Y$ in~$\E$. From the \emph{internal
point of view}, this looks like a map between sets, and we can formulate the
condition that this map is surjective; we write this as
\[ \E \models \forall y\?Y\_ \exists x\?X\_ \alpha(x) = y. \]
The appearance of the colons instead of the usual element signs reminds us that
this expression is not to be taken literally --~$X$ and~$Y$ are objects of~$\E$
and thus not necessarily sets. The definition of the internal language is made
in such a way so that the meaning of this internal statement is that~$\alpha$
is an epimorphism. Similarly, the translation of the internal statement
that~$\alpha$ is injective is that~$\alpha$ is a monomorphism.

Furthermore, we can \emph{reason} with the internal language. There is a
metatheorem to the effect that if some statement~$\varphi$ holds from the
internal point of view of a topos~$\E$ and if~$\varphi$ logically implies some
further statement~$\psi$, then~$\psi$ holds in~$\E$ as well. As a simple
example, consider the elementary fact that the composition of surjective maps
is surjective. Interpreting this statement in the internal language of~$\E$, we
obtain the more abstract result that the composition of epimorphisms in~$\E$ is
epic.

There is, however, a slight caveat to this metatheorem. Namely, the internal
language of a topos is in general only \emph{intuitionistic}, not
\emph{classical}. This means that internally, one can not use the law of
excluded middle~($\varphi \vee \neg\varphi$), the law of double negation
elimination~($\neg\neg\varphi \Rightarrow \varphi$), or the axiom of choice.
For instance, one rendition of the axiom of choice is that any vector space is
free. But it need not be the case that a vector space internal to a topos
is free as seen from the internal perspective: By the technique explained in
these notes, this would imply the absurd statement that any sheaf of modules on
a reduced scheme is locally free.

The restriction to intuitionistic reasoning is not as confining as it might first
appear. We will discuss its practical consequences below (on
page~\pageref{sect:appreciating-intuitionistic-logic}).


\subsection*{Algebraic geometry}
We apply the internal language of toposes to algebraic geometry as follows. If~$X$ is a
scheme, the structure sheaf~$\O_X$ is a sheaf of rings, \ie the sets of
local sections carry ring structures and these ring structures are compatible
with restriction. From the internal point of view of the topos of set-valued
sheaves on~$X$, denoted~``$\Sh(X)$'' in the following, the structure
sheaf~$\O_X$ looks much simpler: It looks just like a plain ring (and
not a sheaf of rings). Similarly, a sheaf of~$\O_X$-modules looks just like a
plain module over that ring.

This allows to import notions and facts from basic linear and commutative
algebra into the sheaf setting. For instance, it turns out that a sheaf
of~$\O_X$-modules is of finite type if and only if, from the internal
perspective, it is finitely generated as an~$\O_X$-module. Now consider the
following fact of linear algebra: If in a short exact sequence of modules the two
outer ones are finitely generated, then the middle one is too. The usual proof of
this fact is intuitionistically acceptable and can thus be interpreted in the
internal language. It then \emph{automatically} yields the following more advanced
proposition: If in a short exact sequence of sheaves of~$\O_X$-modules the
two outer ones are of finite type, then the middle one is too.

This example was not special: \emph{Any (intuitionistically valid) theorem
about modules yields a corresponding theorem about sheaves of modules.}

The internal language machinery thus allows us to understand the basic notions
and statements of scheme theory as notions and statements of linear and
commutative algebra, interpreted in a suitable sheaf topos. This brings
conceptual clarity and reduces technical overhead.

In these notes, we explain how the internal language machinery works and then develop a
\emph{dictionary} between common notions of scheme theory and corresponding
notions of algebra. Once built, this dictionary can be used arbitrarily often.
We stress that no in-depth knowledge of topos theory or categorical logic is
necessary to apply this apparatus.

Two highlights of our approach are the following. Let~$X$ be a reduced scheme
and~$\F$ be a sheaf of~$\O_X$-modules of finite type. Then it is well-known
that~$\F$ is locally free on some dense open subset of~$X$; for instance, this
is stated in Ravi Vakil's lecture notes as an ``important hard
exercise''~\cite[exercise~13.7.K]{vakil:foag}. In fact, this proposition is just the
interpretation of the following statement of intuitionistic linear algebra in
the sheaf topos: Any finitely generated vector space is \emph{not not} free.
The proof of this statement is entirely straightforward.\footnote{Intuitionistically,
the statement that any finitely generated vector space is \emph{free} is stronger than
the doubly negated version and can not be shown. It would imply that any sheaf
of finite type is not only locally free on some dense open subset, but locally
free on the whole space. We discuss this example in more detail in
section~\ref{sect:upper-semicontinuous-functions} and in particular in
lemma~\ref{lemma:locally-free-dense}.)}

The second highlight is that we can shed light on the phenomenon that
sometimes, truth of a property at a point~$x$ spreads to some open
neighbourhood of~$x$; and in particular that sometimes, truth of a property at
the generic point spreads to some dense open subset. For instance, if the stalk
of a sheaf of finite type is zero at some point, the sheaf is even zero on some
open neighbourhood; but this spreading does not occur for general sheaves which
may fail to be of finite type.

We formalize this by introducing a \emph{modal operator}~$\Box$ into the
internal language, such that the internal statement~$\Box\varphi$ means
that~$\varphi$ holds on some open neighbourhood of~$x$. Furthermore, we
introduce a simple operation on formulas, the~\emph{$\Box$-translation}
$\varphi \mapsto \varphi^\Box$, such that~$\varphi^\Box$ means that~$\varphi$
holds at the point~$x$. This translation is defined on a purely syntactical
level. The question whether truth at~$x$ spreads to truth on a
neighbourhood can then be formulated in the following way: Does~$\varphi^\Box$
intuitionistically imply~$\Box\varphi$?

This allows to deal with the question in a simpler, more logical way, with the
technicalities of sheaves blinded out. We also give a metatheorem which
covers a wide range of cases. Namely, spreading occurs for all those properties
which can be formulated in the internal language without
using~``$\Rightarrow$'',~``$\forall$'', and~``$\neg$''.

To illustrate the example above, consider the property of a module~$\F$ being
the zero module. In the internal language, it can be formulated as~$(\forall x\?\F\_ x = 0)$.
Because of the appearance of~``$\forall$'', the metatheorem is not
applicable to this statement. But if~$\F$ is of finite type, there are
generators~$x_1,\ldots,x_n\?\F$ from the internal point of view, and the
condition can be reformulated as~$x_1 = 0 \wedge \cdots \wedge x_n = 0$; the
metatheorem is applicable to this statement.


\subsection*{Limitations} The internal language is \emph{local}, in the sense
that if~$X = \bigcup_i U_i$ is an open covering and an internal statement
holds in the sheaf toposes~$\Sh(U_i)$, it holds in~$\Sh(X)$ as well. On the one
hand, this property is very useful. But on the other hand, it gives an inherent
limitation of the internal language:
Global properties of sheaves of modules like ``being generated by global
sections'', ``being ample'', or ``having vanishing sheaf cohomology'' and global properties of schemes like ``being
quasicompact'' can \emph{not} be
expressed in the internal language.

Thus for global considerations, the internal language of~$\Sh(X)$ is only
useful in that local subparts can be simplified. Also, some global features
reflect themselves in certain meta properties of the internal language. For
instance, a scheme is quasicompact if and only if the internal language
has a weak version of the so-called disjunction property of mathematical
logic (section~\ref{sect:compactness}).


\subsection*{Introductory literature} These notes are intended
to be self-contained, requiring only basic knowledge of scheme theory. In
particular, we assume no prior familiarity with topos theory or formal logic.
But if the interested reader is so inclined, she will find a gentle
introduction to topos theory in an article by Tom
Leinster~\cite{leinster:introduction}. Standard references for the internal
language of a topos include the book of Saunders Mac~Lane and
Ieke Moerdijk~\cite[chapter~VI]{moerdijk-maclane:sheaves-logic}, the book of
Francis Borceux~\cite[chapter~6]{borceux:handbook3}, and part~D of
Peter Johnstone's Elephant~\cite{johnstone:elephant}. In the 1970s, there was a
flurry of activity on applications of the internal language. An article by
Christopher Mulvey~\cite{mulvey:repr} of this time gives a very accessible
introduction to the topic, culminating in an internal proof of the Serre--Swan
theorem (with just one external ingredient needed).

\subsection*{Related work} The internal language of toposes was applied to algebraic geometry before. For
instance, Gavin Wraith used it to construct (and verify the universal property
of) the big étale topos of a scheme by internally developing the theory of
strict henselization~\cite{wraith:generic-galois-theory}. However, to the best
of my knowledge, systematically building a dictionary between external and
internal notions has not been attempted before, and the use of modal operators
to study the spreading of properties from points to neighbourhoods seems to be
new as well.

In other branches of mathematics, the internal language is used as well. For
instance, there is an ongoing effort in mathematical physics to understand
quantum mechanical systems from an internal point of view: To any quantum
mechanical system, one can associate a so-called Bohr topos containing an
internal mirror image of the system. This mirror image looks like a
system of classical mechanics from the internal perspective, and therefore
tools like Gelfand duality can be used to construct an internal
phase space for the system~\cite{bohr1,bohr2}.

In stochastics, the usefulness of an internal language was recently stressed by
Tao~\cite{tao:analysis-rel-measure-space}. Such a language makes the
common notational practice of dropping the explicit dependence of the
value~$X(\omega)$ of a random variable on the sample~$\omega$ completely
rigorous and simplifies the basic theory. Tao also highlighted how a suitable
language can be used to simplify ``$\varepsilon$/$\delta$ management'' in
analysis~\cite{tao:cheap-nsa}. Furthermore, there is a topos-theoretic approach to
measure theory, in which the sheaf of measurable real functions on
a~$\sigma$-algebra looks like the ordinary set of real numbers from an internal point
of view~\cite{jackson:sheaf-theoretic-measure-theory}; this has applications in
noncommutative geometry~\cite{henry:measure-theory-boolean-toposes}.

In constructive mathamatics, the internal language of toposes is routinely used
to obtain models of intuitionistic theories fulfilling certain anti-classical
axioms. For instance, there are toposes in which the axiom ``any map~$\RR \to
\RR$ is continuous'' (appropriately formulated) holds~\cite{kock:sdg,moerdijk:reyes:models}
and toposes in which the Church--Turing thesis holds (realizability toposes).
The internal language can also be used to extract computational content
out of classical constructions. To cite just one recent example, Mannaa and
Coquand used it to implement algorithms which work with the algebraic closure
of an arbitrary field~\cite{mannaa:coquand:alg-closure}.

More specifically, our contribution is related to the program of constructive
mathematics in that intuitionistic mathematics gains new areas of application.
For instance, the constructive account of the theory of Krull dimension was
originally developed to simplify proofs, extract computational meaning, and
generalize classical theorems to non-Noetherian
contexts~\cite{dyn:krull-integral,dyn:char-krull}. It can now also be used to
reason about the dimension of schemes, since the topological dimension of a
scheme~$X$ coincides with the Krull dimension of the structure sheaf~$\O_X$
(regarded as an ordinary ring from the internal perspective of~$\Sh(X)$,
section~\ref{sect:krull-dimension}).

\XXX{mention and explain: Mulvey/Burden, Vickers, Awodey, Coquand, Caramello,
...}

\XXX{cite and explain relation to
\url{http://www.andrew.cmu.edu/user/awodey/preprints/FoS4.phil.pdf}, maybe in
section on modal operators}

\XXX{uses of the big Zariski topos, étale versions, further work, ...}


\subsection*{Notational convention} Occasionally, when quantifying, we use
colons instead of element signs not only in internal statements, but also in
external ones; particularly if we want to stress that a discussion takes place
in an intuitionistic context.


%Of particular importance is the
%case~$\Box\varphi :\equiv ((\varphi \Rightarrow \notat{x}) \Rightarrow
%\notat{x})$ where~$x \in X$ is a point, since for this modal operator, the
%proposition specializes to
%\[ \Sh(X) \models \varphi^\Box \quad\text{iff}\quad
%  \text{$\varphi$ holds at~$x$}. \]
%Thus the question whether truth of a proposition~$\varphi$ at a point~$x$ spreads
%to a neighbourhood of~$x$ can be formulated in the following way:
%\emph{Does~$\varphi^\Box$ imply~$\Box\varphi$?} We can give a general
%answer to this question.

\begin{itemize}
\item dictionary; microscope/telescope into another
universe; types instead of sets; (dependent types to encompass almost all
mathematics)
\item explain that with the internal language business, it becomes more
transparent where scheme condition enters
\end{itemize}


\section{The internal language of a sheaf topos}

\subsection{Internal statements}
Let~$X$ be a topological space. Later, $X$ will be the underlying space of a
scheme. The meaning of internal statements is given by a set of rules, the
\emph{Kripke--Joyal semantics} of the topos of sheaves on~$X$.

\begin{defn}The meaning of 
\[ U \models \varphi \quad\text{(``$\varphi$ holds on $U$'')} \]
for open subsets~$U \subseteq X$ and formulas~$\varphi$ over~$U$ is given by
the rules listed in table~\ref{table:kripke-joyal}, recursively in the structure of~$\varphi$.
In a \emph{formula over~$U$} there may appear sheaves defined on~$U$ as domains
of quantifications,~$U$-sections of sheaves as terms and morphisms of sheaves
on~$U$ as function symbols. The symbols~``$\top$'' and~``$\bot$'' denote truth
and falsehold, respectively. The universal and existential quantifiers come in
two flavors: for bounded and unbounded quantification.
The translation of~$U \models \neg\varphi$ does not have to be separately defined, since
negation can be expressed using other symbols: $\neg\varphi :\equiv (\varphi
\Rightarrow \bot)$. If we want to emphasize the particular topos, we write
\[ \Sh(X) \models \varphi \quad\Ll\quad X \models \varphi. \]
\end{defn}

\begin{table}
  \centering
  \[ \renewcommand{\arraystretch}{1.3}\begin{array}{@{}lcl@{}}
    U \models s = t \? \F &\Ll& s|_U = t|_U \in \Gamma(U, \F) \\
    U \models s \in \G &\Ll& s|_U \in \Gamma(U,\G) \quad\quad\text{($\G$ a
    subsheaf of~$\F$, $s$ a section of~$\F$)} \\
    U \models \top &\Ll& U = U \text{ (always fulfilled)} \\
    U \models \bot &\Ll& U = \emptyset \\
    U \models \varphi \wedge \psi &\Ll&
      \text{$U \models \varphi$ and $U \models \psi$} \\
    U \models \bigwedge_{j \in J} \varphi_j &\Ll&
      \text{for all~$j \in J$: $U \models \varphi_j$} \quad\quad\text{($J$ an
      index set)} \\
    U \models \varphi \vee \psi &\Ll&
      \hcancel{\text{$U \models \varphi$ or $U \models \psi$}}{0pt}{3pt}{0pt}{-2pt} \\
    && \text{there exists a covering $U = \bigcup_i U_i$ such that for all~$i$:} \\
    && \quad\quad \text{$U_i \models \varphi$ or $U_i \models \psi$} \\
    U \models \bigvee_{j \in J} \varphi_j &\Ll&
      \hcancel{\text{$U \models \varphi_j$ for some~$j \in J$}}{0pt}{3pt}{0pt}{-2pt}
      \quad\quad\text{($J$ an index set)} \\
    && \text{there exists a covering $U = \bigcup_i U_i$ such that for all~$i$:} \\
    && \quad\quad \text{$U_i \models \varphi_j$ for some~$j \in J$} \\
    U \models \varphi \Rightarrow \psi &\Ll&
      \text{for all open~$V \subseteq U$:
      $V \models \varphi$ implies $V \models \psi$} \\
    U \models \forall s \? \F\_ \varphi(s) &\Ll&
      \text{for all sections~$s \in \Gamma(V, \F)$, open $V \subseteq U$: $V \models
      \varphi(s)$} \\
    U \models \exists s \? \F\_ \varphi(s) &\Ll&
      \hcancel{\text{there exists a section~$s \in \Gamma(U,\F)$ such that $U
      \models \varphi(s)$}}{0pt}{3pt}{0pt}{-2pt} \\
    &&
      \text{there exists an open covering $U = \bigcup_i U_i$ such that for all~$i$:} \\
    && \quad\quad \text{there exists~$s_i \in \Gamma(U_i, \F)$ such that
    $U_i \models \varphi(s_i)$} \\
    U \models \forall \F\_ \varphi(\F) &\Ll&
      \text{for all sheaves $\F$ on $V$, open $V \subseteq U$: $V \models \varphi(\F)$} \\
    U \models \exists \F\_ \varphi(\F) &\Ll&
      \text{there exists an open covering $U = \bigcup_i U_i$ such that for all~$i$:} \\
    && \quad\quad \text{there exists a sheaf~$\F_i$ on~$U_i$ such that
    $U_i \models \varphi(\F_i)$}
  \end{array} \]
  \caption{\label{table:kripke-joyal}The Kripke--Joyal semantics of a sheaf
  topos.}
\end{table}

\begin{rem}The last two rules in table~\ref{table:kripke-joyal}, concerning
\emph{unbounded quantification}, and are not part of the classical Kripke--Joyal
semantics. They are part of Mike Shulman's stack semantics~\cite{shulman:stack},
a slight extension. They are needed so that we can formulate universal
properties in the internal language.
\end{rem}

\begin{ex}\label{ex:injective-surjective}
Let~$\alpha : \F \to \G$ be a morphism of sheaves on~$X$. Then
$\alpha$ is a monomorphism of sheaves if and only if, from the internal
perspective,~$\alpha$ is simply an injective map:
\allowdisplaybreaks
\begin{align*}
  & X \models \speak{$\alpha$ is injective} \\[0.5em]
  \Longleftrightarrow\
  & X \models \forall s\?\F\_ \forall t\?\F\_ \alpha(s) = \alpha(t) \Rightarrow s = t \\[0.5em]
  \Longleftrightarrow\ &
    \text{for all open~$U \subseteq X$, sections $s \in \Gamma(U, \F)$:} \\
  & \text{for all open~$V \subseteq U$, sections $t \in \Gamma(V, \F)$:} \\
  &\qquad\qquad
      V \models \alpha(s) = \alpha(t) \Rightarrow s = t \\[0.5em]
  \Longleftrightarrow\ &
    \text{for all open~$U \subseteq X$, sections $s, t \in \Gamma(U, \F)$:} \\
  &\qquad\qquad
      U \models \alpha(s) = \alpha(t) \Rightarrow s = t \\[0.5em]
  \Longleftrightarrow\ &
    \text{for all open~$U \subseteq X$, sections $s, t \in \Gamma(U, \F)$:} \\
  &\qquad\qquad
      \text{for all open~$W \subseteq U$:} \\
  &\qquad\qquad\qquad\qquad
        \text{$\alpha_W(s|_W) = \alpha_W(t|_W)$ implies $s|_W = t|_W$} \\[0.5em]
  \Longleftrightarrow\ &
    \text{for all open~$U \subseteq X$, sections $s, t \in \Gamma(U, \F)$:} \\
  &\qquad\qquad
        \text{$\alpha_U(s|_U) = \alpha_U(t|_U)$ implies $s|_U = t|_U$} \\[0.5em]
  \Longleftrightarrow\ &
    \text{$\alpha$ is a monomorphism of sheaves}
\end{align*}
The corner quotes ``$\speak{\ldots}$'' indicate that translation into formal
language is left to the reader. Similarly,~$\alpha$ is an epimorphism of
sheaves if and only if, from the internal perspective,~$\alpha$ is a
surjective map. Notice that injectivity and surjectivity are
notions of a simple element-based language, and the Kripke--Joyal semantics
takes care to properly handle \emph{all} sections, not only global ones.
\end{ex}

The rules are not all arbitrary. They are finely concerted to make the
following propositions true, which are crucial for a proper appreciation of the
internal language.

\begin{prop}[Locality of the internal language]
Let~$U = \bigcup_i U_i$ be covered by open subsets. Let~$\varphi$
be a formula over~$U$. Then
\[ U \models \varphi \qquad\text{iff}\qquad
  \text{$U_i \models \varphi$ for each $i$}. \]
\end{prop}
\begin{proof}Induction on the structure of~$\varphi$. Note that the canceled
rules would make this proposition false.\end{proof}

As a corollary, one may restrict the open coverings and universal
quantifications in the the definition of the Kripke--Joyal semantics
(table~\ref{table:kripke-joyal}) to open subsets of some basis of the topology.
For instance, if~$X$ is a scheme, one may restrict to affine open subsets.

Furthermore, the proposition shows that the internal language is monotone in
the following sense: If~$U \models \varphi$, and~$V$ is an open subset of~$U$,
then~$V \models \varphi$. (This follows by applying the proposition to the
trivial covering~$U = V \cup U$.)

\begin{prop}[Soundness of the internal language]
If a formula~$\varphi$ implies a further formula~$\psi$ in intuitionistic logic, then
$U \models \varphi$ implies $U \models \psi$.
\end{prop}
\begin{proof}
Proof by induction on the structure of formal intuitionistic proofs; we are to
show that any inference rule of intuitionistic logic is satisfied by the
Kripke--Joyal semantics. For instance, there is the following rule governing
disjunction:
\begin{quote}
If~$\varphi \vee \psi$ holds, and both $\varphi$ and $\psi$ imply a further
formula~$\chi$, then~$\chi$ holds.
\end{quote}
So we are to prove that if~$U \models \varphi \vee \psi$, $U \models (\varphi
\Rightarrow \chi)$, and $U \models (\psi \Rightarrow \chi)$, then $U \models \chi$.
This is done as follows: By assumption, there exists a covering~$U = \bigcup_i
U_i$ such that on each~$U_i$, $U_i \models \varphi$ or $U_i \models \psi$.
Again by assumption, we may conclude that~$U_i \models \chi$ for each~$i$. The statement
follows because of the locality of the internal language.

A complete list of which rules are to prove is
in~\cite[section~D1.3.1]{johnstone:elephant}.
\end{proof}

In particular, if a formula~$\psi$ has an unconditional intuitionistic proof,
then~$U \models \psi$.

The restriction to intuitionistic logic is really necessary at this point. We
will encounter many examples of classically equivalent internal statements whose
translation using the Kripke--Joyal semantics are wildly different. In
particular, our treatment of modal operators to understand spreading of
properties from points to neighbourhoods depends on having the ability to make
finer distinctions -- distinctions which are not visible in classical logic.
At the end of this section there are some notes on what the restriction to
intuitionistic logic amounts to in practice.

\XXX{Put rules into an appendix and give some explanation regarding contexts
etc. Don't forget the rules for $\in$, $\bigwedge$, $\bigvee$.}

Because of the multitude of quantifiers, literal translations of internal statements
can sometimes get slightly unwieldy. There are simplification rules for certain
often-occuring special cases:
\begin{prop}\label{prop:simplification}
    \[ \renewcommand{\arraystretch}{1.3}\begin{array}{@{}lcl@{}}
      U \models \forall s\?\F\_ \forall t\?\G\_ \varphi(s,t)
      &\Longleftrightarrow&
      \text{for all open~$V \subseteq U$,} \\
      && \text{sections~$s \in \Gamma(V,\F)$, $t \in \Gamma(V,\G)$:
      $V \models \varphi(s,t)$} \\[0.3em]
      U \models \forall s\?\F\_ \varphi(s) \Rightarrow \psi(s)
      &\Longleftrightarrow&
      \text{for all open~$V \subseteq U$, sections~$s \in \Gamma(V,\F)$:} \\
      &&\qquad\qquad \text{$V \models \varphi(s)$ implies $V \models \psi(s)$}
      \\[0.3em]
      U \models \exists!s\?\F\_ \varphi(s)
      &\Longleftrightarrow&
      \text{for all open~$V \subseteq U$,} \\
      &&
      \text{there is exactly one section~$s \in \Gamma(V,\F)$ with:} \\
      &&\qquad\qquad V \models \varphi(s)
    \end{array} \]
\end{prop}
\begin{proof}Straightforward. By way of example, we prove the existence claim
in the ``only if'' direction of the last rule. (Note that this rule formalizes
the saying ``unique existence implies global existence''.) By definition of~$\exists!$, it
holds that
\[ U \models \exists s\?\F\_ \varphi(s) \]
and
\[ U \models \forall s,t\?\F\_ \varphi(s) \wedge \varphi(t) \Rightarrow s = t.  \]
Let~$V \subseteq U$ be an arbitrary open subset. Then there exist local
sections~$s_i \in \Gamma(V_i,\F)$ such that~$V_i \models \varphi(s_i)$, where~$V
= \bigcup_i V_i$ is an open covering. By the locality of the internal language,
on intersections it holds that~$V_i \cap V_j \models \varphi(s_i)$, so by the
uniqueness assumption, it follows that the local sections agree on intersections.
They therefore glue to a section~$s \in \Gamma(V,\F)$. Since~$V_i \models
\varphi(s)$ for all~$i$, the locality of the internal language allows us to
conclude that~$V \models \varphi(s)$.
\end{proof}

\begin{rem}Note that~$\Sh(X) \models \neg\varphi$ is in general a much stronger
statement than merely supposing that~$\Sh(X) \models \varphi$ does not hold:
The former always implies the latter (unless~$X = \emptyset$, in which case
\emph{any} internal statement is true), but the converse does not hold: The
former statement means that~$U = \emptyset$ is the \emph{only} open subset on
which~$\varphi$ holds.\end{rem}


\subsection{Internal constructions}
\label{sect:internal-constructions}
The Kripke--Joyal semantics defines the
interpretation of internal \emph{statements}. The interpretation of internal
\emph{constructions} is given by the following definition.

\begin{defn}The interpretation of an internal construction~$T$
is denoted by~$\brak{T} \in \Sh(X)$ and given by the following rules.
\begin{itemize}\item If~$\F$ and~$\G$ are sheaves, $\brak{\F \times \G}$ is the
categorical product of~$\F$ and~$\G$ (\ie their product as presheaves).
\item If~$\F$ and~$\G$ are sheaves, $\brak{\F \amalg \G}$ is the categorical
coproduct of~$\F$ and~$\G$, \ie the sheafification of the presheaf
$U \mapsto \Gamma(U,\F) \amalg \Gamma(U,\G)$.
\item If~$\F$ is a sheaf, the interpretation~$\brak{\P(\F)}$ of the power set
construction is the sheaf given by
\[ \text{$U \subseteq X$ open} \quad\longmapsto\quad \{ \G \hookrightarrow \F|_U \}, \]
\ie sections on an open set~$U$ are subsheaves of~$\F|_U$ (either literally
or isomorphism classes of arbitrary monomorphisms into~$\F|_U$).
\item If~$\F$ is a sheaf and~$\varphi(s)$ is a formula containing a free
variable~$s\?\F$, the interpretation~$\brak{\{s\?\F\,|\,\varphi(s)\}}$ is given
by the subpresheaf of~$\F$ defined by
\[ \text{$U \subseteq X$ open} \quad\longmapsto\quad \{ s \in \Gamma(U,\F) \ |\
  U \models \varphi(s) \}. \]
Note that by the locality of the internal language, this presheaf is in fact a
sheaf.
\end{itemize}
\end{defn}

The definition is made in such a way that, from the internal perspective, the
constructions enjoy their expected properties. For instance, it holds that
\[ \Sh(X) \models
  \bigl(\forall x\?\brak{\{s\?\F \,|\, \varphi(s)\}}\_ \psi(x)\bigr)
  \Longleftrightarrow
  \bigl(\forall x\?\F\_ \varphi(x) \Rightarrow \psi(x)\bigr). \]
We gloss over several details here. See~\cite[section~D4.1]{johnstone:elephant} for
a proper treatment.

Morphisms can internally be constructed by appealing to the \emph{principle of
unique choice}: Let~$\varphi(s,t)$ be a formula with free variables of
type~$s\?\F$, $t\?\G$. Assume
\[ \Sh(X) \models \forall s\?\F\_ \exists!t\?\G\_ \varphi(s,t). \]
Then there is one and only one morphism~$\alpha : \F \to \G$ of sheaves such
that for any local section~$s \in \Gamma(U,\F)$, $\Sh(X) \models
\varphi(s,\alpha(s))$. This follows from the meaning of unique existence with
the Kripke--Joyal semantics (proposition~\ref{prop:simplification}).

An important application is showing that two sheaves~$\F$ and~$\G$ are
isomorphic (usually as objects with more structure, for instance sheaves of
modules). To this end, it suffices to give a formula~$\varphi(s,t)$ satisfying,
in addition to the condition above, the condition
$\Sh(X) \models \forall t\?\G\_ \exists! s\?\F\_ \varphi(s,t)$,
expressing that the induced morphism~$\alpha$ is a bijective map from the
internal perspective. Note that this implies the statement
\[ \Sh(X) \models \exists \alpha\?\HOM(\F,\G)\_ \speak{$\alpha$ is bijective},
\]
but this statement is strictly weaker: Its interpretation with the
Kripke--Joyal semantics is that the sheaves~$\F$ and~$\G$ are \emph{locally}
isomorphic.


\subsection{Geometric formulas and constructions} In formal and categorical logic,
and more specifically for our purposes, so-called geometric formulas play a
special role. They are named that way because, in a sense which can be made
precise, their meaning is preserved under pullback with geometric morphisms.
\begin{defn}A formula is \emph{geometric} if and only if it consists only of
\[ {=} \quad {\in} \quad {\top} \quad {\bot} \quad {\wedge} \quad {\vee} \quad
{\bigvee} \quad {\exists}, \]
but not~``$\bigwedge$'' nor ``$\Rightarrow$'' nor~``$\forall$'' (and thus
not~``$\neg$'' either, since this is defined using~``$\Rightarrow$'').
A \emph{geometric implication} is a formula of the form
\[ \forall \cdots \forall\_ (\cdots) \Rightarrow (\cdots) \]
with the bracketed subformulas being geometric.
\end{defn}
The \emph{parameters} of a formula~$\varphi$ are the sheaves
being quantified over, sections of sheaves appearing as terms, and morphisms of
sheaves appearing as function symbols in~$\varphi$.
We say that a formula~$\varphi$ holds \emph{at a point~$x \in X$} if and only
if the formula obtained by substituting all parameters in~$\varphi$ with their
stalks at~$x$ holds in the usual mathematical sense.

\begin{lemma}\label{lemma:geometric-stalk-neighbourhood}
Let~$x \in X$ be a point. Let~$\varphi$ be a geometric formula (over some open
neighbourhood~V of~$x$).
Then~$\varphi$ holds at~$x$ if and only if there exists an open neighbourhood~$U
\subseteq X$ of~$x$ (contained in~V) such that~$\varphi$ holds on~$U$.
\end{lemma}
\begin{proof}This is a very general instance of the phenomenom that sometimes,
truth at a point spreads to truth on a neighbourhood. It can be proven by
induction on the structure of~$\varphi$, but we will give a more conceptual
proof later (corollary~\ref{cor:geometric-spreading}).
\end{proof}

This lemma is in fact a very useful metatheorem. We will properly discuss its
significance in section~\ref{sect:spreading}. For now, we just use it to prove a
simple criterion for the internal truth of a geometric implication; we will
apply this criterion many times.

\begin{cor}\label{cor:geometric-implication}
A geometric implication holds on~$X$ if and only if it holds at
every point of~$X$.\end{cor}
\begin{proof}For notational simplicity, we consider a geometric implication of
the form
\[ \forall s\?\F\_ \varphi(s) \Rightarrow \psi(s). \]
For the ``only if'' direction, assume that this formula holds on~$X$ and let~$x
\in X$ be an arbitrary point. Let~$s_x \in \F_x$ be the germ of an arbitrary
local section~$s$ of~$\F$ and assume that~$\varphi(s)$ holds at~$x$. Then by
the lemma, it follows that~$\varphi(s)$ holds on some open neighbourhood of~$x$. By
assumption,~$\psi(s)$ holds on this neighbourhood as well. Again by the
lemma,~$\psi(s)$ holds at~$x$.

For the ``if'' direction, assume that the geometric implication holds at every
point. Let~$U \subseteq X$ be an arbitrary open subset and let~$s \in
\Gamma(U,\F)$ be a local section such that~$\varphi(s)$ holds on~$U$. By the
lemma and the locality of the internal language, to show that~$\psi(s)$ holds
on~$U$, it suffices to show that~$\psi(s)$
holds at every point of~$U$. This is clear, since again by the
lemma,~$\varphi(s)$ holds at every point of~$U$.
\end{proof}

\begin{ex}Injectivity and surjectivity are geometric implications (surjectivity
can be spelled~$\forall y\?\G\_ (\top \Rightarrow \exists x\?\F\_ \alpha(x) =
y)$). Thus the corollary gives a deeper reason for the well-known fact that a
morphism of sheaves is a monomorphism \resp an epimorphism if and only if it is
stalkwise injective \resp surjective.\end{ex}

A construction is \emph{geometric} if and only if it commutes with pullback
under arbitrary geometric morphisms. We do not want to discuss the notion of
geometric morphisms here; suffice it to say that calculating the stalk at a
point~$x \in X$ is an instance of such a pullback. Among others, the following
constructions are geometric:
\begin{itemize}
\item finite product: $(\F \times \G)_x \cong \F_x \times \G_x$
\item finite coproduct: $(\F \amalg \G)_x \cong \F_x \amalg \G_x$
\item arbitrary coproduct: $(\coprod_i \F_i)_x \cong \coprod_i (\F_i)_x$
\item set comprehension with respect to a \emph{geometric} formula~$\varphi$:
\[ \brak{\{ s\?\F \,|\, \varphi(s) \}}_x \cong \{ [s]\in\F_x \,|\,
\text{$\varphi(s)$ holds at $x$} \} \]
\item free module: $(\R\langle \F \rangle)_x \cong \R_x\langle \F_x
\rangle$ ($\R$ a sheaf of rings, $\F$ a sheaf of sets)
\item localization of a module: $\F[\S^{-1}]_x \cong \F_x[\S_x^{-1}]$
\end{itemize}
Note that compatibility with taking stalks is not sufficient for geometricity.
It is just the most easily visualized requirement.
The following constructions are not in general geometric:
\begin{itemize}
\item arbitrary product
\item set comprehension with respect to a non-geometric formula
\item powerset
\item internal Hom: $\HOM(\F,\G)_x \not\cong \Hom(\F_x,\G_x)$
\end{itemize}


\subsection{Appreciating intuitionistic logic}
\label{sect:appreciating-intuitionistic-logic}
The principal (and only) difference between classical and intuitionistic logic
is that in classical logic, the axioms schemes of \emph{excluded middle} and
\emph{double negation elimination} are added.
\[ \varphi \vee \neg\varphi \qquad\qquad \neg\neg\varphi \Rightarrow \varphi \]
A classically trained mathematician might legitimately wonder why one should
drop these axioms: Are they not obviously true? The pragmatic answer to this
question is that the translations of these axioms with the Kripke--Joyal
semantics are, except for uninteresting special cases of the base space~$X$,
plainly false -- irrespective of one's philosophical convictions. Therefore the
internal language is in general only sound with respect to intuitionistic logic and
not with respect to classical logic. Concretely, the internal language of
a~$\mathrm{T}_1$-space~$X$ is \emph{Boolean}, \ie it verifies the classical
axiom schemes displayed above, if and only if~$X$ is discrete;
and the internal language of a scheme~$X$ is Boolean if and only if~$X$ has
dimension~$\leq 0$.

However, there is also a more satisfying answer, which furthermore
illuminates how to intuitively picture intuitionistic mathematics.
Namely, when doing intuitionistic mathematics, we use the same formal symbols as classically, but with
\emph{a different intended meaning}. For instance, the classical reading of an
existential statement like~$\exists x\?A\_ \varphi(x)$ is that there exists
some element~$x \? A$ with the property~$\varphi(x)$. In contrast, its
intuitionistic reading is that such an element can actually be
\emph{constructed}, \ie explicitly given in some form. This is a much stronger
statement. Classically, a proof that it is \emph{not} the case that such an
element does \emph{not} exist -- formally $\neg\neg \exists x\?A\_ \varphi(x)$
(or, equivalently even in intuitionistic mathematics, $\neg\forall x\? A\_
\neg\varphi(x)$) suffices to demonstrate the existential statement; this is not
so in intuitionistic mathematics.

Similarly, the intuitionistic meaning of a disjunction~$\varphi \vee \psi$ is
not only that one of the disjuncts is true, but that one can explicitly state
which case holds. It is in general not enough to show that it is impossible
that both~$\varphi$ and~$\psi$ fail.

In this picture, it is obvious that one should not adopt the law of excluded
middle or the principle of double negation elimination as axioms. Note that we
do not \emph{reject} those axioms in the sense of postulating their
converses either, we simply don't use them. Therefore any intuitionistically
true result is also true classically. In fact, for some special instances,
these two classical axioms do hold intuitionistically. For example, any natural
number is zero or is not zero -- this is not a triviality, but can be proven by
induction.\footnote{The analogous statement about real numbers cannot be
shown. Intuitively, for a number given by a decimal expansion starting
with~$0.0000\ldots$ one cannot decide whether the string of zeros will continue
indefinitely or whether eventually a non-zero digit will occur. This argument
can be made rigorous. The analogous statement about algebraic numbers
\emph{can} be proven; the information contained in a witness of algebraicity (a
normed polynomial which the given number is a zero of) suffices to make the
case distiction~\cite[chapter~VI.1, page~140]{mines-richman-ruitenburg:constructive-algebra}.}

A consequence of not adopting these axioms is that proofs by contradiction are
not generally justified; they are intuitionistically acceptable only for those
statements which can be proven to be true or false. Note that a proof of a
\emph{negated formula} is not the same as a proof by contradiction. For
instance, the usual proof that~$\sqrt{2}$ is not rational is
intuitionistically perfectly fine: From the assumption that~$\sqrt{2}$ is
rational one deduces a contradiction~($\bot$). This is exactly the definition
of~$\neg(\speak{$\sqrt{2}$ is rational})$.

A more positive consequence of not adopting the law of excluded middle and the
principle of double negation elimination is that intuitionistically, we can
make \emph{finer distinctions}. For instance, for a formula~$\varphi$, the doubly
negated formula~$\neg\neg\varphi$ is a certain kind of weakening of~$\varphi$:
If~$\varphi$ holds, then~$\neg\neg\varphi$ does as well, while the converse can
not be shown in general.\footnote{A detailed proof of the correct implication
goes as follows: Assume~$\varphi$. We are to show~$\neg\neg\varphi$, \ie
$(\neg\varphi \Rightarrow \bot)$. So assume~$\neg\varphi$, we are to
show~$\bot$. Since~$\varphi$ and~$\varphi \Rightarrow \bot$,~$\bot$ indeed
follows.} An example from everday life runs as follows: If in the morning you
can't find the key for your appartment, but you know that it must hide
somewhere since you used it to open the door in the evening before, you
intuitionistically know~$(\neg\neg\exists x\_ \speak{the key is at position
$x$})$, but you cannot claim the unnegated proposition. One cannot model this
distinction with pure classical logic.

Double negation also has a concrete geometric meaning with the
Kripke--Joyal semantics. Namely,~$X \models \neg\neg\varphi$ holds if and
only if there is a dense open subset~$U$ of~$X$ such that~$U \models \varphi$.
In section~\ref{sect:modalities}, we will discuss this fact and other
\emph{modal operators} in more detail. For instance, there is a similarly defined modal
operator~$\Box$ such that~$X \models \Box\varphi$ if and only if there is an
open neighbourhood~$U$ of a given point~$x$ such that~$U \models \varphi$.

For future reference, note that if~$\varphi \Rightarrow \psi$,
then also~$\neg\neg\varphi \Rightarrow \neg\neg\psi$; and note that weakening
twice has no further effect, \ie~$\neg\neg\neg\neg\varphi \Leftrightarrow
\neg\neg\varphi$.\footnote{In fact, negating thrice is the same as negating
once: Assume~$\neg\neg\neg\varphi$. We are to show~$\neg\varphi$. So
assume~$\varphi$, we are to show~$\bot$. Since~$\varphi$,~$\neg\neg\varphi$.
By~$\neg\neg\neg\varphi$,~$\bot$ follows.}

A classical mathematician might then ask which classical results are valid
intuitionistically. The answer is that in linear and commutative algebra, most
of the basic theorems stay valid, provided one exercises some caution in
formulating them (for instance, one should not arbitrarily weaken assumptions
by introducing double negations). This is because the proofs of these
statements are usually direct; if intuitionistically unacceptable case
distictions do occur, they can often be eliminated by streamlining the proof.

Consider as a simple example the proposition that the kernel of a linear map is
a linear subspace. The case distiction ``either the kernel consists just of the
zero vector, in which case the claim is trivial, or otherwise \ldots'' is not
intuitionistically acceptable, but it can be entirely dispensed with: The proof
for the general case works in the special case just as well.

Finally, we should clarify the status of the axiom of choice. This axiom, which
is strictly speaking not part of classical logic, but of a classical set
theory, is not accepted in an intuitionistic context: By \emph{Diaconescu's
theorem}, it implies the law of excluded middle in presence of the other axioms
of set theory.

The standard reference for intuitionistic algebra is a textbook by Ray Mines,
Fred Richman and Wim
Ruitenburg~\cite{mines-richman-ruitenburg:constructive-algebra}, the standard
reference for intuitionistic analysis is a book by Erret Bishop and Douglas
Bridges~\cite{bishop-bridges:constructive-analysis}. Further explanations and
pointers to relevant literature can be found in an expository article and a
recorded lecture by Andrej Bauer~\cite{bauer:int-mathematics,bauer:video}.

\begin{rem}For ease of exposition, we work in a classical metatheory. This
means that we allow ourselves to occasionally use the law of excluded middle
and the axiom of choice when reasoning \emph{about} the internal language. In
particular, we have the theory of schemes as commonly presented at our
disposal. But we should note that this concession is really a cop out, and that
it would be better to develop an intuitionistic theory of schemes. If this were
done, one could extend our approach to understand morphisms of schemes from an
internal point of view -- a morphism~$Y \to X$ would internally look like a
morphism~$Y \to \pt$. See section~\ref{sect:relative-spectrum} for details.\end{rem}


\section{Sheaves of rings}

Recall that a \emph{sheaf of rings} can be categorically described as a
sheaf of sets~$\R$ together with maps of sheaves $+, \cdot : \R \times \R \to
\R$ and global elements~$0, 1$ such that certain axioms hold. For instance, the
axiom on the commutativity of addition is rendered in diagrammatic form as
follows:
\[ \xymatrix{
  \R \times \R \ar[rr]^{\mathrm{swap}} \ar[rd]_{+} && \R \times \R \ar[ld]^{+} \\
  & \R
} \]

From the internal perspective, a sheaf of rings looks just like a plain ring.
This is the content of the following proposition.

\begin{prop}\label{prop:rings-internally}
Let~$X$ be a topological space. Let~$\R$ be a sheaf of sets on~$X$.
Let~$+, \cdot : \R \times \R \to \R$ be maps of sheaves and let~$0, 1$ be
global elements of~$\R$. Then these data define a sheaf of rings if and only
if, from the internal perspective, these data fulfill the usual equational ring
axioms.\end{prop}
\begin{proof}We only discuss the commutativity axiom. The internal statement
\[ \Sh(X) \models \forall x,y\?\R\_ x + y = y + x \]
means that for any open subset~$U \subseteq X$ and any local sections~$x,y \in
\Gamma(U,\R)$, it holds that~$x + y = y + x \in \Gamma(U,\R)$. This is
precisely the external commutativity condition.
\end{proof}

\begin{lemma}Let~$X$ be a topological space. Let~$\R$ be a sheaf of rings
on~$X$. Let~$f$ be a global section of~$\R$. Then the following statements are
equivalent:
\begin{enumerate}
\item $f$ is invertible from the internal point of view, \ie $\Sh(X) \models
\exists g\?\R\_ fg = 1$.
\item $f$ is invertible in all stalks~$\R_x$.
\item $f$ is invertible in~$\Gamma(X,\R)$.
\end{enumerate}
\end{lemma}
\begin{proof}Since invertibility is a geometric implication, the equivalence of
the first two statements is clear. Also, it is obvious that the third statement
implies the other two. For the remaining direction, note that the
uniqueness of inverses in rings can be proven intuitionistically. Therefore, if~$f$ is invertible
from the internal point of view, it actually holds that
\[ \Sh(X) \models \exists! g\?\R\_ fg = 1. \]
Since unique internal existence implies global existence
(proposition~\ref{prop:simplification}), this shows that the first statement
implies the third.
\end{proof}


\subsection{Reducedness} Recall that a scheme~$X$ is \emph{reduced} if and only
if all stalks~$\O_{X,x}$ are reduced rings. Since the condition on a ring~$R$
to be reduced is a geometric implication,
\[ \forall s\?R\_ \Bigl(\bigvee_{n \geq 0} s^n = 0\Bigr) \Longrightarrow s = 0, \]
we immediately obtain the following characterization of reducedness in the
internal language:
\begin{prop}\label{prop:reduced-ring}
A scheme~$X$ is reduced iff, from the internal point of view, the
ring~$\O_X$ is reduced.\end{prop}


\subsection{Locality} Recall the usual definition of a local ring: a ring
possessing exactly one maximal ideal. This is a so-called \emph{higher-order
condition} since it involves quantification over subsets. It is also not of a
geometric form. Therefore, for our purposes, it is better to
adopt the following elementary definition of a local ring.
\begin{defn}A \emph{local ring} is a ring~$R$ such that~$1 \neq 0$ in~$R$ and
for all~$x,y \? R$
\[ \text{$x+y$ invertible} \quad\Longrightarrow\quad
  \text{$x$ invertible}\ \vee\ \text{$y$ invertible}. \]
\end{defn}
In classical logic, it is an easy exercise to show that this definition is
equivalent to the usual one. In intuitionistic logic, we would need to be
more precise in order to even state the question of equivalence, since
intuitionistically, the notion of a maximal ideal bifurcates into several
non-equivalent notions.\footnote{For instance, should a maximal ideal~$\mmm$ be
such that if~$\nnn$ is any ideal with~$\mmm \subseteq \nnn \subsetneq (1)$,
then~$\mmm = \nnn$? Or should the condition be that if~$\nnn$ is any ideal
with~$\mmm \subseteq \nnn$, then~$\mmm = \nnn$ or~$\nnn = (1)$?
Intuitionistically, the latter condition is stronger than the former.}

\begin{prop}\label{prop:local-ring}
In the internal language of a scheme~$X$ (or a locally ringed
space), the ring~$\O_X$ is a local ring.\end{prop}
\begin{proof}The stated locality condition is a conjunction of two geometric
implications (the first one being~$1 = 0 \Rightarrow \bot$, the second being
the displayed one) and holds on each stalk.\end{proof}


\subsection{Field properties} From the internal point of view, the structure
sheaf~$\O_X$ of a scheme~$X$ is \emph{almost} a field, in the sense that any
element which is not invertible is nilpotent. This is a genuine property of
schemes, not shared with arbitrary locally ringed spaces. It is also a specific
feature of the internal universe: Neither the local rings~$\O_{X,x}$ nor the
rings of local sections~$\Gamma(U,\O_X)$ have this property in general.

\begin{prop}\label{prop:neginvnilpotent}Let~$X$ be a scheme. Then
\[ \Sh(X) \models \forall s\?\O_X\_ \neg(\speak{$s$ invertible}) \Rightarrow
\speak{$s$ nilpotent}. \]
\end{prop}
\begin{proof}By the locality of the internal language and since~$X$ can be
covered by open affine subsets, it is enough to show that for any affine
scheme~$X = \Spec A$ and any global function~$s \in \Gamma(X,\O_X) = A$ it holds
that
\[ X \models \neg(\speak{$s$ invertible}) \quad\text{implies}\quad
  X \models \speak{$s$ nilpotent}. \]
The meaning of the antecedent is that any open subset on which~$s$ is
invertible is empty. This implies in particular that the standard open subset~$D(s)$ is
empty. This means that~$s$ is an element of any prime ideal of~$A$, thus
nilpotent, and therefore implies the a priori weaker statement~$X \models \speak{$s$
nilpotent}$ (which would allow~$s$ to have different indices of nilpotency on
an open covering).
\end{proof}

\begin{rem}In classical logic, the statement ``not invertible implies
nilpotent'' is equivalent to ``any element is invertible or nilpotent''.
However, in intuitionistic logic, the latter is strictly stronger than the
former. We will see in the next section
(corollary~\ref{cor:scheme-dimension-zero}) that the structure sheaf of a
scheme fulfills the latter condition if and only if the scheme is
zero-dimensional (or empty).\end{rem}

\begin{cor}\label{cor:field-reduced}
Let~$X$ be a scheme. If~$X$ is reduced, the ring~$\O_X$ is a field
from the internal point of view, in the sense that
\[ \Sh(X) \models \forall s\?\O_X\_ \neg(\speak{$s$ invertible}) \Rightarrow
s=0. \]
The converse holds as well.\end{cor}
\begin{proof}We can prove this purely in the internal language: It suffices to
give an intuitionistic proof of the fact that a local ring which satisfies the
condition of the previous proposition fulfills the stated field condition if
and only if it is reduced. This is straightforward.
\end{proof}

This field property is very useful. We will put it to good use when giving a
simple proof of the fact that~$\O_X$-modules of finite type on a reduced scheme
are locally free on a dense open subset (lemma~\ref{lemma:locally-free-dense}).
Note that the field property only holds precisely as stated in the corollary;
the classically equivalent condition that any element is invertible or zero is
intuitionistically stronger. This is a common phenomenom in intuitionistic
mathematics: Classically equivalent notions may bifurcate into related but
inequivalent notions intuitionistically.

The following proposition says that we can deduce a certain unconditional
statement from the premise that, under the assumption that some element~$f\?\O_X$ is invertible, an element~$s\?\O_X$ is zero. This is
interesting on its own, but will be of particular importance in understanding
quasicoherence from the internal point of view (section~\ref{sect:qcoh}).

\begin{prop}\label{prop:cond-zero}
Let~$X$ be a scheme. Then
\[ \Sh(X) \models
  \forall f\?\O_X\_
  \forall s\?\O_X\_
  (\speak{$f$ \inv} \Rightarrow s = 0) \Longrightarrow
  \textstyle
  \bigvee_{n \geq 0} f^n s = 0. \]
\end{prop}
\begin{proof}It is enough to show that for any affine scheme~$X = \Spec A$ and
any global functions~$f, s \in A$ such that
\[ X \models (\speak{$f$ \inv} \Rightarrow s = 0), \]
it holds that $X \models \textstyle \bigvee_{n \geq 0} f^n s = 0$. This
indeed follows, since by assumption such a function~$s$ is zero on~$D(f)$, \ie $s$
is zero as an element of~$A[f^{-1}]$.
\end{proof}


\subsection{Krull dimension}\label{sect:krull-dimension}
Recall that the \emph{Krull dimension} of a
ring is usually defined as the supremum of the lengths of strictly
ascending chains of prime ideals. As with the classical definition of a local ring,
this definition does not lead to a well-behaved notion in an intuitionistic
context. Furthermore, it is a higher-order condition, so interpreting it
with the Kripke--Joyal semantics is a bit unwieldy.

Luckily, there is an elementary definition of the Krull dimension which works
intuitionistically and which is classically equivalent to the usual notion. It
was found by Thierry Coquand and Henri Lombardi, building upon work by André
Joyal and Luis Español~\cite{dyn:krull-integral,dyn:char-krull}.

\begin{defn}Let~$R$ be a ring. A \emph{complementary sequence} for a
sequence~$(a_0,\ldots,a_n)$ of elements of~$R$ is a sequence~$(b_0,\ldots,b_n)$
such that the following inclusions of radical ideals hold:
\[ \renewcommand{\arraystretch}{1.3}
\left\{\begin{array}{@{}rcl@{}}
  \sqrt{(1)} &\subseteq& \sqrt{(a_0,b_0)} \\
  \sqrt{(a_0 b_0)} &\subseteq& \sqrt{(a_1,b_1)} \\
  \sqrt{(a_1 b_1)} &\subseteq& \sqrt{(a_2,b_2)} \\
  &\vdots \\
  \sqrt{(a_{n-1} b_{n-1})} &\subseteq& \sqrt{(a_n,b_n)} \\
  \sqrt{(a_n b_n)} &\subseteq& \sqrt{(0)}
\end{array}\right. \]
The ring~$R$ is \emph{of Krull dimension~$\leq n$} if
and only if for any sequence~$(a_0,\ldots,a_n)$ there exists a
complementary sequence. (The ring~$R$ is trivial if and only if it is
of Krull dimension~$\leq (-1)$.)
\end{defn}
Note that unlike the usual definition, this definition posits only a condition
on elements and not on ideals. It is thus of a simpler logical form.
(The radical ideals appear only for convenience. We will dispose of them in the
proof of proposition~\ref{prop:dimension-scheme-ox}.)
Also note that we do not define the Krull dimension of a ring as some natural
number (this is intuitionistically not possible for general rings). Instead, we
only define what it means for the Krull dimension to be less than or equal to
a given natural number.

For the following, no intuition on the definition is needed; however, we
feel that some motivation might be of use. Recall that we can picture inclusions of
radical ideals geometrically by considering standard open subsets~$D(f) = \{
\ppp \in \Spec R \,|\, f \not\in \ppp \}$: The inclusion~$\sqrt{(f)} \subseteq
\sqrt{(g,h)}$ holds if and only if~$D(f) \subseteq D(g) \cup D(h)$, and
intersections are calculated by products, \ie~$D(f) \cap D(g) = D(fg)$.

The condition that~$(b_0,\ldots,b_n)$ is complementary to~$(a_0,\ldots,a_n)$
thus means that~$D(a_0)$ and~$D(b_0)$ cover the whole of~$\Spec R$; that their
intersection is covered by~$D(a_1)$ and~$D(b_1)$; that in turn their
intersection is covered by~$D(a_2)$ and~$D(b_2)$; \ldots; and that finally, the
intersection of~$D(a_n)$ and~$D(b_n)$ is empty.

For the special case~$n = 0$, the condition that~$R$ is of Krull
dimension~$\leq 0$ means that for any element~$a_0$ there exists an
element~$b_0$ such that~$D(a_0)$ and~$D(b_0)$ cover~$\Spec R$ and are disjoint.
This implies that~$\Spec R$ is zero-dimensional in an intuitive sense.
\XXX{continue explanation}

\begin{thm}Let~$R$ be a ring.
\begin{enumerate}
\item In classical logic, the ring~$R$ is
of Krull dimension~$\leq n$ if and only if its Krull dimension
as usually defined using chains of prime ideals is less than or equal to~$n$.
\item If the ring~$R$ is
of Krull dimension~$\leq n$, the radical of any finitely generated ideal is
equal to the radical of some ideal which can be generated by~$n+1$ elements.
This holds intuitionistically, and there is an explicit algorithm for computing
the reduced set of generators from the given ones.
\end{enumerate}
\end{thm}
\begin{proof}See~\cite[theorem~1.2]{dyn:krull-integral}.\end{proof}

We can apply the constructive theory of Krull dimension to the structure
sheaf~$\O_X$ of a scheme~$X$ as follows. Note that the condition that a
scheme~$X$ has dimension exactly~$n$ is not local -- the dimension may vary on
an open cover; therefore it is not possible to characterize this condition in
the internal language. However, the condition that the dimension of~$X$ is less
than or equal to~$n$ \emph{is} local, thus there is hope that it can be
internalized. And indeed, this is the case.

\begin{prop}\label{prop:dimension-scheme-ox}
Let~$X$ be a scheme. Then:
\[ \dim X \leq n \quad\Longleftrightarrow\quad
  \Sh(X) \models \speak{$\O_X$ is of Krull dimension~$\leq n$}
  \]
\end{prop}
\begin{proof}
% Recall that the topological dimension of~$X$ is defined as the
% supremum of the lengths of strictly ascending chains of irreducible closed
% subsets. It can be calculated as the supremum of the local dimensions~$\dim_x X
% := \inf\{\dim U \,|\, \text{$U$ open neighbourhood of~$x$} \}$, where~$x$
% ranges over all points of~$X$. The local dimension can be characterized
% algebraically: $\dim_x X = \dim \O_{X,x}$.

A condition of the form~``$\sqrt{(f)} \subseteq \sqrt{(g,h)}$''
like in the constructive definition of the Krull dimension is not a geometric
formula when taken on face value. However, it is equivalent to a geometric
condition, namely to
\begin{multline*}
  \exists a,b\?\O_X\_ \bigvee_{m \geq 0} f^m = ag + bh \quad\wedge\quad \\
  \exists u\?\O_X\_ \bigvee_{p \geq 0} g^p = uf \quad\wedge\quad
  \exists v\?\O_X\_ \bigvee_{q \geq 0} h^q = vf.\end{multline*}
Therefore the condition~$\speak{$\O_X$ is of Krull
dimension~$\leq n$}$ is (equivalent to) a geometric implication and thus holds
internally if and only if it holds at every point~$x \in X$. This in turn means that the
Krull dimension of any stalk~$\O_{X,x}$ is less than or equal to~$n$. This is
equivalent to the (Krull) dimension of~$X$ being less than or equal to~$n$.
\end{proof}

For the following corollary, note that if a scheme~$X$ is not empty, $\dim X
\leq 0$ is equivalent to~$\dim X = 0$.
\begin{cor}\label{cor:scheme-dimension-zero}
Let~$X$ be a scheme. Then:
\[ \dim X \leq 0 \quad\Longleftrightarrow\quad
  \Sh(X) \models \forall s\?\O_X\_ \speak{$s$ \inv} \vee \speak{$s$ nilpotent}.
  \]
If furthermore~$X$ is reduced, this is further equivalent to~$\O_X$ being a
field in the strong sense that any element of~$\O_X$ is invertible or zero.
\end{cor}
\begin{proof}By the proposition and the fact that~$\O_X$ is a local ring from
the internal perspective, this is an immediate consequence of
interpreting the following standard fact of ring theory in the internal
language of~$\Sh(X)$: A local ring~$R$ is of Krull
dimension~$\leq 0$ if and only if any element of~$R$ is invertible or
nilpotent.

It is well-known that this holds classically; to make sure that it
holds intuitionistically as well (so that it can be used in the internal
universe), we give a proof of the ``only if'' direction. Let~$a \? R$ be
arbitrary. By assumption on the Krull dimension, there exists an element~$b \?
R$ such that~$\sqrt{(1)} \subseteq \sqrt{(a,b)}$ and~$\sqrt{(ab)} =
\sqrt{(0)}$. The latter means that~$ab$ is nilpotent. Since~$R$ is local, the
former implies that~$a$ is invertible or that~$b$ is invertible. In the first
case, we are done. In the second case, it follows that~$a$ is nilpotent, so we
are done as well.
\end{proof}

As a further corollary note the curious fact that the classicality of the
internal language of~$\Sh(X)$, where~$X$ is a scheme, is tightly coupled with
the properties of the ring~$\O_X$: Internally, the law of excluded middle and
the principle of double negation elimination hold if and only if~$\O_X$ is of
Krull dimension~$\leq 0$.


\subsection{Integrality} In intuitionistic logic, the notion of an integral
domain bifurcates into several inequivalent notions. The following two are
important for our purposes:
\begin{defn}A ring~$R$ is an \emph{integral domain in the weak sense} if and
only if~$1 \neq 0$ in~$R$ and
\[ \forall x,y\?R\_ xy = 0 \Longrightarrow (x = 0) \vee (y = 0). \]
A ring~$R$ is an \emph{integral domain in the strong sense} if and only if~$1
\neq 0$ in~$R$ and
\[ \forall x\?R\_ x = 0 \vee \speak{$x$ is regular}, \]
where~$\speak{$x$ is regular}$ means that~$xy = 0$ implies~$y = 0$ for any~$y \?
R$.\end{defn}

For the following result, recall that a scheme~$X$ (or ringed space) is
\emph{integral at a point~$x \in X$} if and only if~$\O_{X,x}$ is an integral
domain (in either sense, since we have adopted a classical metatheory).

\begin{prop}\label{prop:internal-integrality}
Let~$X$ be a ringed space. Then:
\begin{enumerate}
\item $X$ is integral at all points if and only if, internally,~$\O_X$ is an
integral domain in the weak sense.
\item If~$X$ is even a locally Noetherian scheme, then~$\O_X$ is an integral
domain in the weak sense iff it is an integral domain in the strong sense from
the internal point of view.
\end{enumerate}
\end{prop}
\begin{proof}The condition on a ring to be an integral domain in the weak sense
is a conjunction of two geometric implications,~``$1 = 0 \Rightarrow \bot$''
and the implication displayed in the definition. Therefore the first statement
is obvious.

For the second statement, note that the condition on a function~$f \in
\Gamma(U,\O_X)$ to be regular from the internal perspective is open: It holds
at a point~$x \in U$ if and only if it holds on some open neighbourhood of~$x$.
We will give a proof of this specific feature of locally Noetherian schemes
later on, when we have developed appropriate machinery to do so easily
(proposition~\ref{prop:regularity-spreading}). In any case, this openness
property was the essential ingredient for the equivalence between ``holding
internally'' and ``holding at every point''
(corollary~\ref{cor:geometric-implication}). Therefore~$\O_X$ is an integral
domain in the strong sense from the internal point of view if and only if all
local rings~$\O_{X,x}$ are integral domains. By the first statement, this is
equivalent to~$\O_X$ being an integral domain in the weak sense from the
internal point of view.
\end{proof}

\begin{lemma}\label{lemma:regular-affine}
Let~$X = \Spec A$ be an affine scheme. Let~$f \in A$. Then~$f$ is
a regular element of~$A$ if and only if~$f$ is a regular element of~$\O_X$ from
the internal perspective.\end{lemma}
\begin{proof}The Kripke--Joyal translation of internal regularity is:
\begin{quote}For any open subset~$U \subseteq X$ and any function~$g \in
\Gamma(U,\O_X)$, $fg = 0$ in~$\Gamma(U,\O_X)$ implies~$g = 0$
in~$\Gamma(U,\O_X)$.\end{quote}
So the ``only if'' direction is clear (use~$U := X$). For the ``if'' direction,
note that~$\Gamma(U,\O_X)$ is a localization of~$A$ and that regular elements
remain regular in localizations.
\end{proof}


\subsection{Bézout property} Recall that a \emph{Bézout ring} is a ring in
which any finitely generated ideal is a principal ideal. In intuitionistic
mathematics, this is a better notion than that of a principal ideal ring: The
requirement that \emph{any} ideal is a principal ideal is far too strong.
Intuitively, this is because without any given generators to begin with, one
cannot hope to explicitly pinpoint a principal generator.
One can (provably) not even verify this property for the ring~$\ZZ$.\footnote{Assume
that any ideal of~$\ZZ$ is finitely generated. Let~$\varphi$ be an arbitrary
proposition; we want to intuitionistically deduce~$\varphi \vee \neg\varphi$.
Consider the ideal~$\aaa := \{ x \in \ZZ \,|\, (x = 0) \vee \varphi \}
\subseteq \ZZ$. The definition is such that~$\varphi$ holds if and only
if~$\aaa$ contains an element other than zero; and that~$\neg\varphi$ holds if
and only if zero is the only element of~$\aaa$.
By assumption,~$\aaa$ is finitely generated. Since~$\ZZ$ is a
Bézout ring, it is therefore even principal:~$\aaa = (x_0)$ for some~$x_0 \in
\ZZ$. Even intuitionistically we have~$(x_0 = 0) \vee (x_0 \neq 0)$ (for the
natural numbers, this can be proven by induction). In the first case, it
follows that~$\aaa$ contains only zero; in the second case, it follows
that~$\aaa$ contains an element other than zero. Thus~$\neg\varphi \vee
\varphi$.

This kind of reasoning is called \emph{exhibiting a Brouwerian
counterexample}. The definition of~$\aaa$ may look slightly dubious,
considering that~$\varphi$ does not depend on~$x$; but we will see that such
definitions actually have a clear geometric meaning -- they can be used to
define extensions of sheaves by zero in the internal language
(lemma~\ref{lemma:extension-by-zero}).}

\begin{prop}Let~$X$ be a scheme (or ringed space).
\begin{enumerate}
\item $\O_X$ is a Bézout ring from the internal perspective if and only if all
rings~$\O_{X,x}$ are Bézout rings.
\item $\O_X$ is such that, from the internal perspective, of any two elements,
one divides the other, if and only if all rings~$\O_{X,x}$ are such.
\end{enumerate}
\end{prop}
\begin{proof}Both properties can be formulated as geometric implications:
\begin{multline*}
  \text{(1)}\quad
  \forall f,g\?\O_X\_
  \top \Rightarrow
  \exists d\?\O_X\_
  (\exists a,b\?\O_X\_ d = af + bg) \wedge {} \\
  (\exists u\?\O_X\_ f = ud) \wedge
  (\exists v\?\O_X\_ g = vd)
\end{multline*}
\[
  \text{(2)}\quad
  \forall f,g\?\O_X\_
  \top \Rightarrow
  (\exists u\?\O_X\_ f = ug) \,\vee\,
  (\exists u\?\O_X\_ g = uf) \qquad\qquad\qquad\quad \qedhere
\]
\end{proof}

\begin{cor}\label{cor:dedekind-smith}
Let~$X$ be a Dedekind scheme, \ie a locally Noetherian normal scheme
of dimension~$\leq 1$. Then, from the internal perspective, any matrix
over~$\O_X$ can be put into Smith canonical form, \ie is equivalent to a
(rectangular) diagonal matrix with diagonal entries~$a_1|a_2|\cdots|a_n$
successively dividing each other.
\end{cor}
\begin{proof}It is well-known that such a scheme has principal ideal domains as
local rings~$\O_{X,x}$. For local domains, the Bézout condition is equivalent to the
property that of any two elements, one divides the other. Therefore all local
rings have this property, and by the previous proposition, the internal
ring~$\O_X$ has it as well. The statement thus follows from interpreting the
following fact of linear algebra in the internal universe: Let~$R$ be a ring
such that of any two elements, one divides the other. Then any matrix over~$R$
can be put into Smith canonical form.

The usual proof of this fact is indeed intuitionistically acceptable: Let a
matrix over~$R$ be given. By induction, one can show that for any finite family
of ring elements, one divides all the others. So some matrix entry is a factor
of all the others. We can put this entry to the upper left by row and column
transformations and then kill the other entries of the first row and the first
column. After these operations, it is still the case that the entry in the
first row and column is a factor of all other entries. Continuing in this
fashion, we obtain a diagonal matrix. Its diagonal entries already fulfill
the divisibility condition.
\end{proof}

Note that phrases such as ``if by chance the entry in the upper left divides
all the others, we can directly proceed with the next step; otherwise, some
other entry must be a factor of all entries, so \ldots'' may not be included in
a proof which is intended to be intuitionistically acceptable.
Those phrases assume that one may make the case distinction that for
any two ring elements~$x,y$, either~$x$ divides~$y$ or not. Fortunately, those
case distinctions are in fact superfluous.

A consequence of the corollary is that internally to the sheaf topos of a
Dedekind scheme, the usual structure theorem on finitely
presented~$\O_X$-modules is available. We will exploit this in
lemma~\ref{lemma:torsion-stuff}, where we give an internal proof of the
fact that on Dedekind schemes, torsion-free~$\O_X$-modules are locally free.


\subsection{Normality} We will discuss the property of a ring to be
\emph{normal}, \ie to be integrally closed in its total field of
fractions, in section~\ref{sect:normality}, after giving an internal
characterization of the sheaf of rational functions.


\section{Sheaves of modules}

From the internal perspective, a sheaf of~$\R$-modules, where~$\R$ is a sheaf
of rings, looks just like a plain module over the plain ring~$\R$. This is
proven just as the correspondence between sheaf of rings and internal rings
(proposition~\ref{prop:rings-internally}).

% XXX: talk about modules over constant sheaves of rings as well


\subsection{Finite local freeness}

Recall that an~$\O_X$-module~$\F$ is \emph{finite locally free} if and only
if there exists a covering of~$X$ by open subsets~$U$ such that on each
such~$U$, the restricted module~$\F|_U$ is isomorphic as an~$\O_X|_U$-module
to~$(\O_X|_U)^n$ for some natural number~$n$ (which may depend on~$U$).

\begin{prop}\label{prop:locally-free}
Let~$X$ be a scheme (or ringed space). Let~$\F$ be
an~$\O_X$-module. Then~$\F$ is finite locally free if and only if, from the
internal perspective,~$\F$ is a finite free module, \ie
\[ \Sh(X) \models \bigvee_{n \geq 0} \speak{$\F \cong (\O_X)^n$}, \]
or more elementarily
\[ \Sh(X) \models \bigvee_{n \geq 0}
  \exists x_1,\ldots,x_n\?\F\_
  \forall x\?\F\_
  \exists! a_1,\ldots,a_n\?\O_X\_
  x = \textstyle\sum\limits_i a_i x_i. \]
\end{prop}
\begin{proof}By the expression~``$(\O_X)^n$'' in the internal language we mean
the internally constructed object~$\O_X \times \cdots \times \O_X$ with its
componentwise~$\O_X$-module structure. This coincides with the sheaf~$(\O_X)^n$ as
usually understood.

It is clear that the two stated internal conditions are equivalent, since the
corresponding proof in linear algebra is intuitionistically acceptable. The equivalence with
the external notion of finite local freeness follows because the
interpretation of the first condition with the Kripke--Joyal semantics is the
following: There exists a covering of~$X$ by open subsets~$U$ such that for
each such~$U$, there exists a natural number~$n$ and a morphism of
sheaves~$\varphi : \F|_U \to (\O_X|_U)^n$ such that
\[ U \models \speak{$\varphi$ is~$\O_X$-linear} \quad\text{and}\quad
  U \models \speak{$\varphi$ is bijective}. \]
The first subcondition means that~$\varphi$ is a morphism of sheaves
of~$\O_X|_U$-modules and the second one means that~$\varphi$ is an isomorphism of
sheaves.
\end{proof}


\subsection{Finite type, finite presentation, coherence}
Recall the conditions of an~$\O_X$-module~$\F$ on a scheme~$X$ (or ringed
space) to be of finite type, of finite presentation, and to be coherent:
\begin{itemize}
\item $\F$ is \emph{of finite type} if and only if there exists a covering of~$X$ by
open subsets~$U$ such that for each such~$U$, there exists an exact sequence
\[ (\O_X|_U)^n \longrightarrow \F|_U \longrightarrow 0 \]
of~$\O_X|_U$-modules.
\item $\F$ is \emph{of finite presentation} if and only if there exists a covering of~$X$ by
open subsets~$U$ such that for each such~$U$, there exists an exact sequence
\[ (\O_X|_U)^m \longrightarrow (\O_X|_U)^n \longrightarrow \F|_U \longrightarrow 0. \]
\item $\F$ is \emph{coherent} if and only if~$\F$ is of finite type and the
kernel of any~$\O_X|_U$-linear morphism~$(\O_X|_U)^n \to \F|_U$, where~$U \subseteq
X$ is any open subset, is of finite type.
\end{itemize}

The following proposition gives translations of these definitions into the
internal language.
\begin{prop}\label{prop:finite-type-and-co}
Let~$X$ be a scheme (or ringed space). Let~$\F$ be
an~$\O_X$-module. Then:
\begin{itemize}
\item $\F$ is of finite type if and only if~$\F$, considered as an ordinary
module from the internal perspective, is finitely generated, \ie if
\[ {\qquad\qquad} \Sh(X) \models
  \bigvee_{n \geq 0}
  \exists x_1,\ldots,x_n\?\F\_
  \forall x\?\F\_
  \exists a_1,\ldots,a_n\?\F\_
  x = \textstyle\sum\limits_i a_i x_i. \]
\item $\F$ is of finite presentation if and only if~$\F$ is a finitely
presented module from the internal perspective, \ie if
\[ {\qquad\qquad} \Sh(X) \models \bigvee_{n,m \geq 0}
  \speak{there is a short exact sequence $\O_X^m \to \O_X^n \to \F \to 0$}.
  \]
\item $\F$ is coherent if and only if~$\F$ is a coherent module from the
internal perspective, \ie if
\begin{multline*}
{\qquad\qquad\qquad}
  \Sh(X) \models \speak{$\F$ is finitely generated} \mathop{\wedge} \\
  \bigwedge_{n \geq 0} \forall \varphi \? \HOM_{\O_X}(\O_X^n,\F)\_
  \speak{$\Kernel \varphi$ is finitely generated}.
\end{multline*}
\end{itemize}
\end{prop}
\begin{proof}Straightforward -- the translations of the internal statements using
the Kripke--Joyal semantics are precisely the corresponding external
statements.
\end{proof}

Recall that an~$\O_X$-module~$\F$ is \emph{generated by global sections} if and
only if there exist global sections~$s_i \in \Gamma(X,\F)$ such that for any~$x
\in X$, the stalk~$\F_x$ is generated by the germs of the~$s_i$.
This condition is of course not local on the base. Therefore there cannot
exist a formula~$\varphi$ such that for any space~$X$ and
any~$\O_X$-module~$\F$ it holds that~$\F$ is generated by global sections if
and only if~$\Sh(X) \models \varphi(\F)$. But still, global generation can be
characterized by a mixed internal/external statement:

\begin{prop}Let~$X$ be a scheme (or ringed space). Let~$\F$ be
an~$\O_X$-module. Then~$\F$ is generated by global sections if and only if
there exist global sections~$s_i \in \Gamma(X,\F)$, $i \in I$ such that
\[ \Sh(X) \models \forall x\?\F\_ \bigvee\nolimits_{\textnormal{$J=\{i_1,\ldots,i_n\} \subseteq I$ finite}}
  \exists a_1,\ldots,a_n\?\O_X\_
  x = \sum_j a_j x_{i_j}. \]
Furthermore,~$\F$ is generated by finitely many global sections if and only if
there exist global sections~$s_1,\ldots,s_n \in \Gamma(X,\F)$ such that
\[ \Sh(X) \models \forall x\?\F\_ \exists a_1,\ldots,a_n\?\O_X\_ x = \sum_j a_j
x_j. \]
\end{prop}
\begin{proof}The given internal statements are geometric implications, their
validity can thus be checked stalkwise.\end{proof}


\subsection{Tensor product and flatness} Recall that the tensor product
of~$\O_X$-modules~$\F$ and~$\G$ on a scheme~$X$ (or ringed space) is usually
constructed as the sheafification of the presheaf
\[ \text{$U \subseteq X$ open} \quad\longmapsto\quad \Gamma(U,\F) \otimes_{\Gamma(U,\O_X)}
\Gamma(U,\G). \]
From the internal point of view,~$\F$ and~$\G$ look like ordinary modules, so
that we can consider their tensor product as usually constructed in
commutative algebra, as a certain quotient of the free module on the elements
of~$\F \times \G$:
\[ \O_X\langle x \otimes y \,|\, x\?\F, y\?\G \rangle / R, \]
where~$R$ is the submodule generated by
\begin{gather*}
  (x+x') \otimes y - x \otimes y - x' \otimes y, \\
  x \otimes (y+y') - x \otimes y - x \otimes y', \\
  (sx) \otimes y - s(x \otimes y), \\
  x \otimes (sy) - s(x \otimes y)
\end{gather*}
with~$x,x'\?\F$, $y,y'\?\G$, $s\?\O_X$.
This internal construction will give rise to the same sheaf
of modules as the externally defined tensor product:

\begin{prop}\label{prop:internal-tensor-product}
Let~$X$ be scheme (or a ringed space). Let~$\F$ and~$\G$
be~$\O_X$-modules. Then the internally constructed tensor product~$\F
\otimes_{\O_X} \G$ coincides with the external one.
\end{prop}
\begin{proof}
Since the proof of the corresponding fact of commutative algebra is
intuitionistically acceptable, the internally defined tensor product~$\F \otimes_{\O_X} \G$
has the following universal property: For any~$\O_X$-module~$H$,
any~$\O_X$-bilinear map~$\F \times \G \to H$ uniquely factors over the
canonical map~$\F \times \G \to \F \otimes_{\O_X} \G$.

Interpreting this property with the Kripke--Joyal semantics, we see that the
internally constructed tensor product has the following external property:
For any open subset~$U \subseteq X$ and any~$\O_X|_U$-module~$\H$ on~$U$,
any~$\O_X|_U$-bilinear morphism~$\F|_U \times \G|_U \to \H$ uniquely factors over the
canonical morphism~$\F|_U \times \G|_U \to (\F \otimes_{\O_X} \G)|_U$.

In particular, for~$U = X$, this property is well-known to be the universal
property of the externally constructed tensor product. Therefore the
claim follows.
\end{proof}

A description of the stalks of the tensor product
follows purely by considering the logical form of the construction:
\begin{cor}Let~$X$ be scheme (or a ringed space). Let~$\F$ and~$\G$
be~$\O_X$-modules. Then the stalks of the tensor product coincide with the
tensor products of the stalks: $(\F \otimes_{\O_X} \G)_x \cong \F_x
\otimes_{\O_{X,x}} \G_x$.\end{cor}
\begin{proof}
We constructed the tensor product using the following operations: product of
two sets, free module on a set, quotient module with respect to a submodule;
submodule generated by a set of elements given by a geometric formula.
All of these operations are geometric, so the tensor product construction is
geometric as well. Hence taking stalks commutes with performing the
construction.
\end{proof}

Recall that an~$\O_X$-module~$\F$ is \emph{flat} if and only if all
stalks~$\F_x$ are flat~$\O_{X,x}$-modules. We can characterize flatness in the
internal language.
\begin{prop}\label{prop:flatness}
Let~$X$ be a scheme (or ringed space). Let~$\F$ be
an~$\O_X$-module. Then~$\F$ is flat if and only if, from the internal
perspective,~$\F$ is a flat~$\O_X$-module.
\end{prop}
\begin{proof}
Recall that flatness of an~$A$-module~$M$ can be characterized without
reference to tensor products by the following condition (using
suggestive vector notation): For any natural number~$p$,
any $p$-tuple~$m \? M^p$ of elements of~$M$ and
any~$p$-tuple $a \? A^p$ of elements of~$A$, it should hold that
\[
  a^T m = 0 \ \Longrightarrow\
  \bigvee\limits_{q \geq 0} \exists n\?M^q, B\?A^{p \times q}\_
  Bn = m \wedge a^T B = 0. \]
The equivalence of this condition with tensoring being exact holds
intuitionistically as
well~\cite[theorem~III.5.3]{mines-richman-ruitenburg:constructive-algebra}.
This formulation of flatness has the advantage that it is the conjunction of
geometric implications (one for each~$p \geq 0$); therefore it holds internally
if and only if it holds at any point.
\end{proof}


\subsection{Support} Recall that the \emph{support} of an~$\O_X$-module~$\F$ is
the subset~$\supp\F := \{ x \in X \,|\, \F_x \neq 0 \} \subseteq X$. If~$\F$ is
of finite type, this set is closed, since its complement is then open by a
standard lemma. (We will give an internal proof of this fact in
lemma~\ref{lemma:module-zero-point-neighbourhood}.)

\begin{prop}\label{prop:characterization-support}
Let~$X$ be a scheme (or ringed space). Let~$\F$ be
an~$\O_X$-module. Then the interior of the complement of the support of~$\F$
can be characterized as the largest open subset of~$X$ on which the internal
statement~$\F = 0$ holds.
\end{prop}
\begin{proof}
For any open subset~$U \subseteq X$, it holds that:
\begin{align*}
  &\ U \subseteq \Int(X \setminus \supp \F) \\
  \Longleftrightarrow&\ U \subseteq X \setminus \supp \F \\
  \Longleftrightarrow&\ U \subseteq \{ x \in X \,|\, \forall s \in \F_x\_ s = 0 \} \\
  \Longleftrightarrow&\ U \models \forall s\?\F\_ s = 0 \\
  \Longleftrightarrow&\ U \models \speak{$\F = 0$}
\end{align*}
The second to last equivalence is because~``$\forall s\?\F\_ s = 0$'' is a
geometric implication and can thus be checked stalkwise.
\end{proof}

\begin{rem}\label{rem:support-sheaf-of-sets}
The support of a sheaf of \emph{sets}~$\F$ is defined as the subset~$\{ x \in X \,|\,
\text{$\F_x$ is not a singleton} \}$. A similar proof shows that the interior
of its complement can be characterized as the largest open subset of~$X$ where
the internal statement~$\speak{$\F$ is a singleton}$ holds.\end{rem}


\subsection{Torsion} Let~$R$ be a ring. Recall that the
\emph{torsion submodule}~$M_\tors$ of an~$R$-module~$M$ is defined as
\[ M_\tors := \{ x\?M \,|\, \exists a\?R\_ \speak{$a$ regular} \wedge ax = 0 \}
\subseteq M. \]
This definition is meaningful even if~$R$ is not an integral domain.
An~$R$-module~$M$ is \emph{torsion-free} if and only if~$M_\tors$ is
the zero submodule; an~$R$-module~$M$ is a \emph{torsion module} if and only
if~$M_\tors = M$.

Recall also that if~$\F$ is a sheaf of~$\O_X$-modules on an integral
scheme~$X$, there is a unique subsheaf~$\F_\tors \subseteq \F$ with the
property that~$\Gamma(U,\F_\tors) = \Gamma(U,\F)_\tors$ for all affine open
subsets~$U \subseteq X$. The content of the following proposition is that
internally constructing the torsion submodule of~$\F$, regarded as a plain
module from the internal perspective, gives exactly that subsheaf. There is
therefore no harm in using the same notation~``$\F_\tors$'' for the result of
the internal construction.

\begin{prop}Let~$X$ be an integral scheme. Let~$\F$ be an~$\O_X$-module. Let~$U
= \Spec A \subseteq X$ be an affine open subset. Let~$s \in \Gamma(U,\F)$ be a local
section. Then
\[ s \in \Gamma(U,\F)_\tors \quad\text{if and only if}\quad
  U \models s \in \F_\tors. \]
\end{prop}
\begin{proof}
The ``only if'' direction is trivial in light of
lemma~\ref{lemma:regular-affine}: If~$s$ is a torsion element
of~$\Gamma(U,\F)$, there exists a regular element~$a \in \Gamma(U,\O_X)$ such
that~$as = 0$. By the lemma, this element is regular from the internal
perspective as well, so~$U \models \speak{$a$ regular} \wedge as = 0$.

For the ``if'' direction, we may assume that there exists an open covering~$X =
\bigcup_i U_i$ be standard open subsets~$U_i = D(f_i)$ such that there are
sections~$a_i \in \Gamma(U_i,\O_X) = A[f_i^{-1}]$ with~$U_i \models \speak{$a_i$ regular}
\wedge a_i s = 0$. Without loss of generality, we may assume that the
denominators of the~$a_i$'s are ones, that the $f_i$ are
finite in number, and that the~$f_i$ are regular (\ie nonzero, since~$A$ is an
integral domain). By lemma~\ref{lemma:regular-affine}, the~$a_i$ are
regular in~$A[f_i^{-1}]$ and by regularity of the~$f_i$ also regular in~$A$.
Therefore their product~$\prod_i a_i \in A$ is regular in~$A$ as well and
annihilates~$s$.
\end{proof}

\begin{prop}\label{prop:torsion-submodule-stalks}
Let~$X$ be a locally Noetherian scheme. Let~$\F$ be
an~$\O_X$-module. Let~$x \in X$ be a point. Then~$(\F_\tors)_x =
(\F_x)_\tors$.\end{prop}
\begin{proof}This would be obvious if the condition on an element~$s\?\F$ to
belong to~$\F_\tors$ were a geometric formula. Because of the universal
quantifier, it is not:
\[ s \in \F_\tors \quad\Longleftrightarrow\quad
  \exists a\?\O_X\_ (\forall b\?\O_X\_ ab = 0 \Rightarrow b = 0) \wedge as = 0. \]
But since~$X$ is assumed to be locally Noetherian, regularity is an open
property nonetheless (see proposition~\ref{prop:regularity-spreading} for an
internal proof of this fact). Thus the claim still follows, just like in the
proof of proposition~\ref{prop:internal-integrality}.
\end{proof}


\subsection{Internal proofs of common lemmas}

\begin{lemma}Let~$X$ be a scheme (or ringed space). Let
\[ 0 \lra \F \lra \G \lra \H \lra 0 \]
be a short exact sequence of~$\O_X$-modules. If~$\F$ and~$\H$ are of finite
type, so is~$\G$; similarly, if~$\F$ and~$\H$ are finite locally free, so
is~$\G$.
\end{lemma}
\begin{proof}From the internal perspective, we are given a short exact sequence
of modules with the outer ones being finitely generated (\resp finite free)
and we have to show that the middle one is finitely generated (\resp finite
free) as well. It is well-known that this follows; and since the usual proof of
this fact is intuitionistically acceptable, we are done.
\end{proof}

Note that the proof works very generally, in the context of arbitrary ringed
spaces, and is still very simple. This is common to proofs using the internal
language. Particular features of schemes enter only at clearly recognizable
points, for instance when an internal property specific to the structure sheaf
of schemes is used (such as in proposition~\ref{prop:neginvnilpotent}).

\begin{lemma}\label{lemma:coherent-stuff}
Let~$X$ be a scheme (or ringed space).
\begin{itemize}
\item Let~$0 \to \F \to \G \to \H \to 0$ be an exact sequence
of~$\O_X$-modules. If two of the three modules are coherent, so is the third.
\item Let~$\F \to \G$ be a morphism of~$\O_X$-modules such that~$\F$ is
of finite type and~$\G$ is coherent. Then its kernel is of finite type as well.
\item If~$\F$ is a finitely presented~$\O_X$-module and~$\G$ is a
coherent~$\O_X$-module, the~$\O_X$-modules~$\HOM(\F,\G)$ and~$\F \otimes \G$
are coherent as well.
\end{itemize}
\end{lemma}
\begin{proof}These statements follow directly from interpreting the
corresponding standard proofs of commutative algebra in the internal language.
For those standard proofs, see for instance the lecture notes of Ravi
Vakil~\cite[section~13.8]{vakil:foag}, where they are given as a series of
exercises.
\end{proof}

\begin{lemma}\label{lemma:kernel-of-epi-fingen}
Let~$X$ be a scheme (or locally ringed space). Let~$\alpha : \G
\to \H$ be an epimorphism of finite locally free~$\O_X$-modules. Then the
kernel of~$\alpha$ is locally finite locally as well.\end{lemma}
\begin{proof}It suffices to give an intuitionistic proof of the following
statement: The kernel of a matrix over a local ring, which as a linear map is
surjective, is finite free.

Let~$M \? R^{n \times m}$ be such a matrix. Since by the surjectivity
assumption some linear combination of the columns is~$e_1$ (the first canonical
basis vector), some linear combination of the entries of the first row of~$M$
is~$1$. By locality of~$R$, at least one entry of the first row is invertible.
By applying appropriate column and row transformations, we may therefore assume that~$M$
is of the form
\[ \left(
  \begin{array}{c|ccc}
    1 & 0 & \cdots & 0 \\ \hline
    0 & \multicolumn{3}{c}{\multirow{3}{*}{\raisebox{-5mm}{\scalebox{1.2}{$\widetilde M$}}}} \\
    \raisebox{2pt}{\vdots} & & & \\
    0 & & &
  \end{array}
\right) \]
with the submatrix~$\widetilde M$ fulfilling the same condition as~$M$.
Continuing in this way, it follows that~$m \geq n$ and that we may assume
that~$M$ is of the form
\[ \left(
  \begin{array}{ccc|c}
    1 & & & \multirow{3}{*}{\raisebox{-3mm}{\scalebox{1.2}{\ 0}}} \\
    & \ddots && \\
    && 1
  \end{array}
\right)\!. \]
The kernel of such a matrix is obviously freely generated by the canonical
basis vectors corresponding to the zero columns. In particular, the rank of the
kernel is~$m-n$.
\end{proof}

\begin{rem}The internal language machinery gives no reason to believe that the
dual statement is true, \ie that the cokernel of a monomorphism of finite
locally free~$\O_X$-modules is finite locally free. This would follow from
an intuitionistic proof of the statement that the cokernel of an injective map
between finite free modules over a local ring is finite free. But this
statement is of course false (consider the exact sequence
$0 \lra \ZZ_{(2)} \stackrel{\cdot 2}{\lra} \ZZ_{(2)} \lra \FF_2 \lra 0$
of~$\ZZ_{(2)}$-modules).
\end{rem}

\begin{lemma}Let~$X$ be a scheme (or locally ringed space). Let~$\alpha : \G
\to \H$ be an epimorphism of finite locally free~$\O_X$-modules of the same
rank. Then~$\alpha$ is an isomorphism.\end{lemma}
\begin{proof}It suffices to give an intuitionistic proof of the following
statement: A square matrix over a local ring, which as a linear map is
surjective, is invertible.

This follows from the proof of the previous lemma, since it shows that the
kernel of such a matrix is finite free of rank zero.
\end{proof}

\begin{lemma}Let~$X$ be a scheme (or ringed space). Let
$0 \to \F \to \G \to \H \to 0$ be a short exact sequence of~$\O_X$-modules.
Then for the closures of the supports holds the equation
$\Clos \supp \G = \Clos \supp \F \cup \Clos \supp \H$.
\end{lemma}
\begin{proof}Switching to complements, we have to prove that
\[ \Int(X \setminus \supp\G) = \Int(X \setminus \supp\F) \cap \Int(X \setminus
\supp\H). \]
By proposition~\ref{prop:characterization-support}, it suffices to prove
\[ \Sh(X) \models (\G = 0\ \Longleftrightarrow\ \F = 0 \wedge \H = 0); \]
this is a basic observation in linear algebra, valid intuitionistically.
\end{proof}
\XXX{This is kind of a lame example.}

\begin{lemma}Let~$X$ be a scheme (or locally ringed space). Let~$\L$ be a line
bundle on~$X$, \ie an~$\O_X$-module locally free of rank~1.
Let~$s_1,\ldots,s_n \in \Gamma(X,\L)$ be global sections. Then these sections
globally generate~$\F$ if and only if
\[ \Sh(X) \models \bigvee_i \speak{$\alpha(s_i)$ is invertible for some
isomorphism~$\alpha : \L \to \O_X$}. \]
\end{lemma}
\begin{proof}It suffices to give an intuitionistic proof of the following fact:
Let~$R$ be a local ring. Let~$L$ be a free~$R$-module of rank~1.
Let~$s_1,\ldots,s_n\?L$ be given elements. Then~$L$ is generated as
an~$R$-module by these elements if and only if for some~$i$, the image of~$s_i$
under some isomorphism~$L \to R$ is invertible.

Note that the choice of such an isomorphism does not matter, since any two such
isomorphisms~$\alpha, \beta : L \to R$ differ by a unit of~$R$: $\alpha(x) =
\alpha(\beta^{-1}(1)) \cdot \beta(x)$ for any~$x\?L$,
and~$\alpha(\beta^{-1}(1)) \cdot \beta(\alpha^{-1}(1)) = 1$ in~$R$.

For the ``if'' direction, we have that some~$\alpha(s_i)$ is a generator
of~$R$. Since~$\alpha$ is an isomorphism, it follows that~$s_i$ generates~$L$,
and thus that in particular, the family~$s_1,\ldots,s_n$ generates~$L$.

For the ``only if'' direction, we have that the unit of~$R$ can be expressed as
a linear combination of the~$\alpha(s_i)$, where~$\alpha : L \to R$ is some
isomorphism (whose existence is assured by the assumption on the rank of~$L$).
Since~$R$ is a local ring, it follows that one of the summands and thus one of
the~$\alpha(s_i)$ is invertible.
\end{proof}

\begin{rem}Note that the canonical ring homomorphism~$\O_{X,x}
\twoheadrightarrow k(x)$ is local. Therefore a germ in~$\O_{X,x}$ is invertible
if and only if its image in~$k(x)$ is not zero. From this one can follow that
global sections~$s_1,\ldots,s_n \in \Gamma(X,\F)$ generate~$\F$ if and only if,
for any point~$x \in X$, the images~$s_i \in \F|_x$ in the fibers do not vanish
simultaneously.
\end{rem}

\begin{lemma}Let~$X$ be a scheme (or ringed space). Let~$\L$ be a locally
free~$\O_X$-module of rank~1. Then~$\L^\vee \otimes_{\O_X} \L \cong \O_X$.\end{lemma}
\begin{proof}Recall that the dual is defined by~$\L^\vee :=
\HOM_{\O_X}(\L,\O_X)$. Since~``$\HOM$'' looks like~``$\Hom$'' from the internal
point of view, the dual sheaf~$\L^\vee$ looks just like the ordinary dual
module. However, to prove the claim, it does \emph{not} suffice to give an
intuitionistic proof of the following fact of linear algebra: ``Let~$L$ be a
free~$R$-module of rank~1. Then there exists an isomorphism~$L^\vee \otimes_R L
\to R$.'' Since the interpretation of ``$\exists$'' using the Kripke--Joyal
semantics is local existence, this would only show that~$\L^\vee \otimes_{\O_X}
\L$ is \emph{locally} isomorphic to~$\O_X$.

Instead, we have to actually \emph{write down} (\ie explicitly give) a
linear map in the internal language -- not using the assumption that~$L$ is
free of rank~1, as this would introduce an existential quantifier again (see
section~\ref{sect:internal-constructions}).
So we have to prove the following fact: Let~$L$ be an~$R$-module. Then there
explicitly exists a linear map~$L^\vee \otimes_R L \to R$ such that this map is
an isomorphism if~$L$ is free of rank~1.

This is done as usual: Define~$\alpha : L^\vee \otimes_R L \to R$ by~$\lambda
\otimes x \mapsto \lambda(x)$. Since~$L$ is free of rank~1, there is an
isomorphism~$L \cong R$. Precomposing~$\alpha$
with the induced isomorphism~$R^\vee \otimes_R R \to L^\vee \otimes_R L$,
we obtain the linear map~$R^\vee \otimes_R R \to R$ given by the same
term: $\lambda \otimes x \mapsto \lambda(x)$. One can check that an inverse is given
by~$x \mapsto \id_R \otimes x$.
\end{proof}

\begin{lemma}\label{lemma:torsion-stuff}
Let~$X$ be a scheme (or ringed space). Let~$\F$ be
an~$\O_X$-module. Then:
\begin{enumerate}
\item Assume~$X$ to be a locally Noetherian scheme. Then $\F$ is torsion-free
(meaning~$\F_\tors = 0$) if and only if all stalks~$\F_x$ are torsion-free.
\item The quotient sheaf~$\F/\F_\tors$ is torsion-free and the torsion
submodule~$\F_\tors$ is a torsion module.
\item The dual sheaf $\F^\vee$ is torsion-free.
\item If~$\F$ is reflexive (meaning that the canonical morphism~$\F \to
\F^{\vee\vee}$ is an isomorphism), it is torsion-free.
\item If~$\F$ is locally finitely free, it is reflexive.
\item Assume~$X$ to be a Dedekind scheme and~$\F$ to be of finite presentation.
If~$\F$ is torsion-free, then it is locally finitely free.
% change references below if numbering changes
\end{enumerate}
\end{lemma}
\begin{proof}The first statement follows from the observation that~$(\F_\tors)_x
= (\F_x)_\tors$ (proposition~\ref{prop:torsion-submodule-stalks}). All the
others follow simply by interpreting the corresponding facts of linear algebra
in the internal universe. For concreteness, we give intuitionistic proofs of
the last three statements.

So let~$M$ be an reflexive~$R$-module. We have to show that~$M$ is
torsion-free. To this end, let an element~$x \? M$ and a regular element~$a \?
R$ such that~$ax = 0$ be given. For any~$\vartheta \? M^\vee$, it follows
that~$\vartheta(x) = 0$, since~$a \vartheta(x) = \vartheta(ax) = \vartheta(0) =
0$ and~$a$ is regular. Thus the image of~$x$ under the canonical map~$M \to
M^{\vee\vee}$ is zero. By reflexivity, this implies that~$x$ is zero.

For statement~(5), we have to prove that~$R$-modules of the form~$R^n$ are
reflexive. This is obvious, the required inverse map is~$(R^n)^{\vee\vee} \to
R^n,\ \lambda \mapsto \sum_i \lambda(\vartheta_i)$ where~$\vartheta_i : R^n \to
R,\ (x_j)_j \mapsto x_i$.

In light of corollary~\ref{cor:dedekind-smith} we can put matrices over~$\O_X$
into Smith canonical form if~$X$ is a Dedekind scheme. Therefore it suffices
to give an intuitionistic proof of the following fact: Let~$R$ be an integral
domain in the strong sense such that matrices over~$R$ can be put into
Smith canonical form. Let~$M$ be a finitely presented torsion-free~$R$-module.
Then~$M$ is finite free.

This goes as follows: Since~$M$ is finitely presented, it is the cokernel of
some matrix. Without loss of generality, we may assume that it is a diagonal
matrix, so~$M$ is isomorphic to some (finite) direct sum~$\bigoplus_i R/(a_i)$.
Since~$M$ is torsion-free, all the summands~$R/(a_i)$ are torsion-free as well.
Since~$R$ is an integral domain in the strong sense, this holds if and only if
the~$a_i$ are either zero or invertible. Thus~$R/(a_i)$ is isomorphic to~$R$ or
to the zero module. In any case,~$R/(a_i)$ is finite free and therefore~$M$
is finite free as well.
\end{proof}


\section{Upper semicontinuous functions}
\label{sect:upper-semicontinuous-functions}

\subsection{Interlude on natural numbers}
In classical logic, the natural numbers are complete in the sense that any
inhabited set of natural numbers possesses a minimal element. This statement
can not be proven intuitionistically -- intuitively, this is because one cannot
explicitly pinpoint the (classically existing) minimal element of an arbitrary
inhabited set;\footnote{Let~$\varphi$ be an arbitrary formula. Assuming that
any inhabited subset of the natural numbers possesses a minimal element, we
want to show that~$\varphi \vee \neg\varphi$. Define the subset $U := \{ n \in
\NN \,|\, (n = 1) \vee \varphi \} \subseteq \NN$, which surely is inhabited by~$1
\in U$. So by assumption, there exists a number~$z \in \NN$ which is the
minimum of~$U$. We have $z = 0$ or $z > 0$. If~$z = 0$, we have~$0 \in U$,
so~$(0 = 1) \vee \varphi$, so~$\varphi$ holds.  If~$z > 0$, then~$\neg\varphi$
holds: If~$\varphi$ were true, zero would be an element of~$U$, contradicting
the minimality of~$z$.} see below for a sheaf-theoretic interpretation.

In intuitionistic logic, the completeness principle can be salvaged in two
essentially different ways: either by strengthening the premise, or by
weakening the conclusion.

\begin{lemma}\label{lemma:minimum-subset-naturals}
Let~$U \subseteq \NN$ be an inhabited subset of the natural
numbers.
\begin{enumerate}
\item Assume~$U$ to be \emph{detachable}, \ie assume that for any natural
number~$n$, either~$n \in U$ or~$n \not\in U$. Then~$U$ possesses a minimal
element.
\item In any case,~$U$ does \emph{not not} possess a minimal element.
\end{enumerate}
\end{lemma}
\begin{proof}
The first statement can be proven by induction on the witness of inhabitation,
\ie the given number~$n$ such that~$n \in U$. We omit further details, since we will
not need this statement in our applications.

For the second statement, we give a careful proof since logical subtleties matter. To simplify the
exposition, we assume that~$U$ is upward-closed, \ie that any number
larger than some element of~$U$ lies in~$U$ as well. Any subset can be closed
in this way (by considering~$\{ n \in \NN \,|\, \exists m \in U\_ n \geq m \}$)
and a minimal element of the closure will be a minimal element for~$U$ as well.

We induct on the number~$n \in U$ given by the assumption that~$U$ is
inhabited. In the case~$n = 0$ we are done since~$0$ is a minimal element
of~$U$. For the induction step~$n \to n+1$, the intuitionistically valid double
negation of the law of excluded middle
gives
\[ \neg\neg(n \in U \vee n \not\in U). \]
Because of the tautologies $(\varphi \Rightarrow \psi) \Rightarrow
(\neg\neg\varphi \Rightarrow \neg\neg\psi)$ and~$\neg\neg\neg\neg\varphi \Rightarrow
\neg\neg\varphi$ (see section~\ref{sect:appreciating-intuitionistic-logic}), it
suffices to show that~$n \in U \vee n \not\in U$ implies the conclusion.
So assume~$n \in U \vee n \not\in U$.
If~$n \in U$, then~$U$ does \notnot possess a minimal element by the induction
hypothesis. If~$n \not\in U$, then~$n+1$ is a minimal element (and so, in
particular,~$U$ does \notnot possess a minimal element): If~$m$ is
any element of~$U$, we have~$m \geq n+1$ or~$m \leq n$. In the first case,
we're done. In the second case, it follows that~$n \in U$ because~$U$ is
upward-closed and so we obtain a contradiction. From this contradiction we
can trivially deduce~$m \geq n+1$ as well. \qedhere
\end{proof}

If we want to work with a complete set of natural numbers in intuitionistic
logic, we have to construct a suitable completion. The idea of the following
definition is to encode numbers as the (not necessarily existing) minimum of
inhabited upward-closed subsets.
\begin{defn}The partially ordered set of \emph{completed natural numbers} is
the set~$\widehat{\NN}$ of all inhabited upward-closed subsets of~$\NN$, ordered by
reverse inclusion.\end{defn}
\begin{lemma}The poset of completed natural numbers is the least partially
ordered set containing~$\NN$ and possessing minima
of arbitrary inhabited subsets.\end{lemma}
\begin{proof}
The embedding $\NN \hookrightarrow \widehat\NN$ is given by
\[ n \in \NN \quad\longmapsto\quad {\uparrow}(n) := \{ m \in \NN \,|\, m \geq n \}. \]
If~$M \subseteq \widehat\NN$ is an inhabited subset, its minimum is
\[ \min M = \bigcup M \in \widehat\NN. \]
The proof of the universal property is left to the reader.
\end{proof}

\begin{rem}\label{rem:surjectivity-embedding}
In classical logic, the map~$\widehat\NN \to \NN,\ U \mapsto \min U$
is a well-defined isomorphism of partially ordered sets. In fact, it is the
inverse of the canonical embedding~$\NN \hookrightarrow \widehat\NN$. In
intuitionistic logic, this embedding is still injective, but it can not be
shown to be surjective: It is only the case that any element of~$\widehat\NN$
does \notnot possess a preimage (by lemma~\ref{lemma:minimum-subset-naturals}).
\end{rem}


\subsection{A geometric interpretation}
We are interested in the completed natural numbers for the following reason: A
completed natural number in the topos of sheaves on a topological space~$X$ is
the same as an upper semicontinuous function~$X \to \NN$.

\begin{lemma}\label{lemma:upper-semicontinuous-functions}
Let~$X$ be a topological space. The sheaf~$\widehat\NN$ of
completed natural numbers on~$X$ is canonically isomorphic to the sheaf of upper
semicontinuous~$\NN$-valued functions on~$X$.\end{lemma}
\begin{proof}
When referring to the natural numbers in the internal language, we actually
refer to the constant sheaf~$\ul{\NN}$ on~$X$. (This is because the
sheaf~$\ul{\NN}$ fulfills the axioms of a natural numbers object,
cf.\@~\cite[section~VI.1]{moerdijk-maclane:sheaves-logic}.) Recall that its sections on an
open subset~$U \subseteq X$ are continuous functions~$U \to \NN$, where~$\NN$
is equipped with the discrete topology.

Therefore, a section of~$\widehat\NN$ on an open subset~$U \subseteq X$ is
given by a subsheaf~$\A \hookrightarrow \ul{\NN}|_U$ such that
\[ U \models \exists n\?\ul{\NN}\_ n \in \A
  \quad\text{and}\quad
  U \models \forall n,m\?\ul{\NN}\_ n \geq m \wedge n \in \A \Rightarrow m \in
  \A. \]
Since these conditions are geometric implications, they are satisfied if and only if any
stalk~$\A_x$ is an inhabited upward-closed subset of~$\ul{\NN}_x \cong \NN$.
The association
\[ x \in X \quad\longmapsto\quad \min\{ n \in \NN \,|\, n \in \A_x \} \]
thus defines a map~$X \to \NN$. This map is indeed upper semicontinuous, since
if~$n \in \A_x$, there exists an open neighbourhood~$V$ of~$x$ such that the constant
function with value~$n$ is an element of~$\Gamma(V,\A)$ and therefore~$n \in
\A_y$ for all~$y \in V$.

Conversely, let~$\alpha : U \to \NN$ be a upper semi-continous function. Then
\[ \text{$V \subseteq U$ open} \quad\longmapsto\quad \{ f : V \to \NN \,|\, \text{$f$
continuous,\ $f \geq \alpha$ on~$V$} \} \]
is a subobject of~$\ul{\NN}|_U$ which internally is inhabited and upward-closed.
Further details are left to the reader.
\end{proof}

Under the correspondence given by the lemma, locally \emph{constant}
functions map exactly to the (image of the) \emph{ordinary} internal natural numbers
(in the completed natural numbers).
In a similar vein, the sheaf given by the internal construction of
the set of \emph{all} upward-closed subsets of the natural numbers (not
only the inhabited ones) is canonically isomorphic to the sheaf of
upper semicontinuous functions with values in~$\NN \cup \{ +\infty
\}$.

Note that the correspondence can be used to understand classical facts about
upper semicontinuous functions as features of intuitionistic number theory. For
instance, it is well-known that any upper semicontinuous~$\mathbb{N}$-valued
function on an arbitrary topological space is locally constant on a dense open subset.
This can be explained as follows: The completed natural number associated to such a
function is \notnot an ordinary natural number from the internal point of view.
Since ``not not'' translates to ``holding on a dense open subset''
(proposition~\ref{prop:modops-kripke}), it follows that there is a dense open
subset on which the function corresponds to an ordinary internal natural
number, \ie is locally constant.


\subsection{The upper semicontinuous rank function}
Recall that the rank of an~$\O_X$-module~$\F$ on a scheme~$X$ (or
locally ringed space) at a point~$x \in X$ is defined as the~$k(x)$-dimension
of the vector space~$\F_x \otimes_{\O_{X,x}} k(x)$. If we assume that~$\F$ is
of finite type around~$x$, this dimension is finite and equals the minimal
number of elements needed to generate~$\F_x$ as an~$\O_{X,x}$-module (by
Nakayama's lemma).

In the internal language, we can define an element of~$\widehat\NN$ by
\begin{multline*}
  \rank\F := \min\{ n \in \NN \,| \\
  \speak{there is a gen.\@ family for~$\F$ consisting of~$n$ elements} \} \in \widehat\NN.
\end{multline*}
If the module~$\F$ is finite locally free, it will be a finite free module from the
internal point of view and the rank defined in this way will be an
actual natural number (see below); but in general, the rank is really an element of the
completion.

\begin{prop}\label{prop:rank-function-internally}
Let~$\F$ be an~$\O_X$-module of finite type on a scheme~$X$ (or locally ringed
space). Under the correspondence given by the previous lemma, the internally
defined rank maps to the rank function of~$\F$.
\end{prop}
\begin{proof}
We have to show that for any point~$x \in X$ and natural number~$n$, there
exists a generating family for~$\F_x$ consisting of~$n$
elements if and only if there exists an open neighbourhood~$U$ of~$x$ such that
\[ U \models \speak{there exists a generating family
for~$\F$ consisting of~$n$ elements}. \]
The ``if'' direction is obvious. For the ``only if'' direction, consider
(liftings to local sections of a)
generating family~$s_1,\ldots,s_n$ of~$\F_x$. Since~$\F$ is of finite type,
there also exist sections~$t_1,\ldots,t_m$ on some neighbourhood~$V$ of~$x$ which
generate any stalk~$\F_y$, $y \in V$. Since the~$t_i$ can be expressed as a
linear combination of the~$s_j$ in~$\F_x$, the same is true on some open
neighbourhood~$U \subseteq V$ of~$x$. On this neighbourhood, the~$s_j$ generate
any stalk~$\F_y$, $y \in U$, so by geometricity we have
\[ U \models \speak{$s_1,\ldots,s_n$ generate~$\F$}. \qedhere \]
\end{proof}
\begin{rem}Once we understand when properties holding at a point spread to
neighbourhoods, we will be able to give a simpler proof of the proposition (see
lemma~\ref{lemma:gen-family-n}).\end{rem}

\begin{lemma}Let~$X$ be a scheme (or a locally ringed space). Let~$\F$ be an~$\O_X$-module of
finite type. If~$\F$ is finite locally free, its rank function is locally
constant. The converse holds if~$X$ is a reduced scheme.
\end{lemma}
\begin{proof}The rank function is locally constant if and only if internally,
the rank of~$\F$ is an actual natural number. Also recall that the structure
sheaf fulfills a certain field condition if~$X$ is a reduced
scheme (corollary~\ref{cor:field-reduced}). Therefore it suffices to give a
proof of the following fact of intuitionistic linear algebra: Let~$R$ be a
local ring. Let~$M$ be a finitely generated~$R$-module. If~$M$ is finite
free, its rank is an actual natural number. The converse holds if~$R$ fulfills
the field condition that any element which is not invertible is zero.

So assume that such a module~$M$ is finite free. Then it is isomorphic
to~$R^n$ for some actual natural number~$n$; by the internal proof in
lemma~\ref{lemma:kernel-of-epi-fingen}, the rank of~$M$ is therefore this
number~$n$ (for any surjection~$R^m \twoheadrightarrow R^n$ it holds that~$m
\geq n$).

Conversely, assume that the rank of~$M$ is an actual natural number. Then
there exists a minimal generating family~$x_1,\ldots,x_n\?M$. This family is
indeed linearly independent (and thus a basis, demonstrating that~$M$ is finite
free): Let~$\sum_i a_i x_i = 0$ with~$a_i\?R$. If any~$a_i$ were
invertible, the family~$x_1,\ldots,x_{i-1},x_{i+1},\ldots,x_n$ would too
generate~$M$, contradicting the minimality. So each~$a_i$ is not invertible.
By the field property of~$R$, each~$a_i$ is zero.
\end{proof}

\begin{lemma}\label{lemma:locally-free-dense}
Let~$X$ be a reduced scheme. Let~$\F$ be an~$\O_X$-module of
finite type. Then~$\F$ is finite locally free on a dense open subset.\end{lemma}
\begin{proof}Since ``dense open'' translates to ``not not'' in the internal
language (proposition~\ref{prop:modops-kripke}), it suffices to give an
intuitionistic proof of the following fact: Let~$R$ be a local ring which fulfills an
appropriate field condition. Let~$M$ be a finitely generated~$R$-module.
Then~$R$ is \notnot finite free.

By remark~\ref{rem:surjectivity-embedding}, the rank of such a module~$M$ is
\notnot an actual natural number. By the last part of the
previous proof, it thus follows that~$M$ is \notnot finite free.
\end{proof}

\begin{rem}Note that besides basics on natural numbers in an intuitionistic
setting and some dictionary terms (``reduced'', ``finite locally free'',
``finite type``, ``dense open''), this proof does not depend on any further
tools. In particular, Nakayama's lemma and facts about semicontinuous functions
do not enter. For the (more complex) standard proof of this fact, see for
instance~\cite{vakil:foag}, where the claim is dubbed an ``important hard
exercise'' (exercise~13.7.K).\end{rem}


\subsection{The upper semicontinuous dimension function} Recall that the
dimension of a topological space~$X$ at a point~$x \in X$ is defined as the
infimum
\[ \dim_x X := \inf\{ \dim U \,|\, \text{$U$ open neighbourhood of~$x$} \}. \]
One may restrict to open \emph{connected} neighbourhoods of~$X$, since an
arbitrary open neighbourhood of~$x$ contains such a one and the dimension
decreases (weakly) on subsets.

The map~$X \to \NN \cup \{+\infty\},\ x \mapsto \dim_x X$ is upper
semicontinuous and thus corresponds to an internal completed (possibly
unbounded) natural number. The following proposition shows that this number has
an explicit description.

\begin{prop}Let~$X$ be a scheme. Then the upper semicontinuous function
associated to the internal number ``Krull dimension of~$\O_X$'' is the
dimension function~$x \mapsto \dim_x X$.\end{prop}
\begin{proof}Internally, we define the Krull dimension of~$\O_X$ as the infimum
over all natural numbers~$n$ such that~$\O_X$ is of Krull
dimension~$\leq n$. This infimum need not exist in the natural numbers, of
course; so we really mean the upward-closed set~$\A$ of all those numbers. (It
is inhabited if and only if, from the external perspective, the dimension
of~$X$ is locally finite. In this case, it defines a completed natural number.)

We thus have to show for any point~$x \in X$:
\[ \inf\{ n \in \NN \cup \{+\infty\} \,|\, n \in \A_x \} =
  \dim_x X. \]
The condition on~$n$ can be expressed as follows, where we write~``$\ul{n}$''
to denote the constant function with value~$n$:
\begin{align*}
  &\ n \in \A_x \\
  \Longleftrightarrow &\
  \text{for some open neighbourhood~$U$ of~$x$, $\ul{n} \in \Gamma(U,\A)$} \\
  \Longleftrightarrow &\
  \text{for some open connected neighbourhood~$U$ of~$x$, $\ul{n} \in \Gamma(U,\A)$} \\
  \Longleftrightarrow &\
  \text{for some open connected neighbourhood~$U$ of~$x$,} \\
  & \qquad\qquad U \models \speak{$\O_X$ is of Krull dimension~$\leq n$} \\
  \Longleftrightarrow &\
  \text{for some open connected neighbourhood~$U$ of~$x$,} \\
  & \qquad\qquad \dim U \leq n
\end{align*}
We thus have:
\begin{align*}
  \inf\{ n \,|\, n \in \A_x \} &=
    \inf\{ \dim U \,|\, \text{$U$ open connected neighbourhood of~$x$} \} \\
  &= \dim_x X. \qedhere
\end{align*}
\end{proof}


\section{Modalities}
\label{sect:modalities}

Philosophers and logicians do not only study what is \emph{true}, but also what
is \emph{known}, what is \emph{believed}, what is \emph{possible}, and so on.
Such \emph{modalities} are absent from the usual mathematical practice.
However, it turns out that a specific kind of such modalities plays a role in
understanding when properties spread from points to neighbourhoods.

Briefly, this is because for any point~$x$ of a topological space~$X$, there
exists a modal operator~$\Box$ such that for any formula~$\varphi$ of the
internal language of the sheaf topos~$\Sh(X)$, the internal
statement~$\Box\varphi$ means that~$\varphi$ holds on some open neighbourhood
of the given point~$x$. In this way, we can reduce sheaf-theoretic questions to
questions of modal intuitionistic (non-sheafy) mathematics.

The techniques developed in this section also enable us to use the internal
language of~$\Sh(X)$ to talk about sheaves on \emph{subspaces} of~$X$ (and more
general \emph{sublocales} of~$X$).


\subsection{Basics on truth values and modal operators}

\begin{defn}The \emph{set of truth values~$\Omega$} is the powerset of the
singleton set~$1 := \{\star\}$, where~$\star$ is a formal symbol.\end{defn}

In classical logic, any subset of~$\{\star\}$ is either empty or inhabited, so
that~$\Omega$ contains exactly two elements, the empty set (``false'')
and~$\{\star\}$ (``true''). But
in intuitionistic logic, this can not be shown; indeed, if we interpret the
definition in the topos of sheaves on a space~$X$, we obtain a (large) sheaf~$\Omega$
with
\[ \text{$U \subseteq X$ open} \quad\longmapsto\quad \Gamma(U,\Omega) = \{ V \subseteq U \,|\, \text{$V$
open} \}. \]
(This is because by definition of~$\Omega$ as the power object of the terminal
sheaf~$1$, sections of~$\Omega$ on an open subset~$U$ correspond to
subsheaves~$\F \hookrightarrow 1|_U$, and those are given by the greatest open
subset~$V \subseteq U$ such that~$\Gamma(V,\F)$ is inhabited.)
Obviously, in general, this sheaf has many sections, in particular more than
the binary coproduct~$1 \amalg 1$ (unless any open subset of~$X$ is also
closed).

The \emph{truth value} of a formula~$\varphi$ is by definition the subset
$\{ x \in 1 \,|\, \varphi \} \in \Omega$, where~``$x$'' is a fresh variable not
appearing in~$\varphi$. This subset is inhabited if and only
if~$\varphi$ holds and is empty if and only if~$\neg\varphi$ holds.
Conversely, we can associate to a subset~$F \subseteq 1$ the
proposition~$\speak{$F$ is inhabited}$.

By the above description of~$\Omega$ in
a sheaf topos~$\Sh(X)$, the interpretation of the truth value
of a formula~$\varphi$ in the internal language of~$\Sh(X)$ is a certain open
subset of~$X$. Tracing the definitions, we see that this open subset is
precisely the largest open subset on which~$\varphi$ holds, \ie the union of
all open subsets~$U \subseteq X$ such that~$U \models \varphi$.

Under the correspondence of formulas with truth values, logical operations
like~$\wedge$ and~$\vee$ map to set-theoretic operations like~$\cap$ and~$\cup$
-- for instance, we have
\[ \{ x \in 1 \,|\, \varphi \} \cap \{ x \in 1 \,|\, \psi \} =
  \{ x \in 1 \,|\, \varphi \wedge \psi \}. \]
This justifies a certain abuse of notation: We will sometimes treat elements
of~$\Omega$ as propositions and use logical instead of set-theoretic
connectives. In particular, if~$\varphi$ and~$\psi$ are elements of~$\Omega$,
we will write~``$\varphi \Rightarrow \psi$'' to mean~$\varphi \subseteq \psi$;
``$\bot$'' to mean~$\emptyset$; and~``$\top$'' to mean~$1$.

\begin{defn}A \emph{modal operator} is a map~$\Box : \Omega \to \Omega$ such
that for all~$\varphi, \psi \in \Omega$,
\begin{enumerate}
\item $\varphi \Longrightarrow \Box\varphi$,
\item $\Box\Box\varphi \Longrightarrow \Box\varphi$,
\item $\Box(\varphi \wedge \psi) \Longleftrightarrow \Box\varphi \wedge \Box\psi$.
\end{enumerate}
\end{defn}

The intuition is that~$\Box\varphi$ is a certain weakening of~$\varphi$, where
the precise meaning of ``weaker'' depends on the modal operator. By the second
axiom, weakening twice is the same as weakening once.

In classical logic, where~$\Omega = \{ \bot, \top \}$, there are only two modal
operators: the identity map and the constant map with value~$\top$.
Both of these are not very interesting: The identity operator does not weaken
propositions at all, while the constant operator weakens every proposition to
the trivial statement~$\top$.

In intuitionistic logic, there can potentially exist further modal operators.
For applications to algebraic geometry, the following four operators will have
a clear geometric meaning and be of particular importance:
\begin{enumerate}
\item $\Box\varphi :\equiv (\alpha \Rightarrow \varphi)$, where~$\alpha$ is a
fixed proposition.
\item $\Box\varphi :\equiv (\varphi \vee \alpha)$, where~$\alpha$ is a
fixed proposition.
\item $\Box\varphi :\equiv \neg\neg\varphi$ (the \emph{double negation
modality}).
\item $\Box\varphi :\equiv ((\varphi \Rightarrow \alpha) \Rightarrow \alpha)$,
where~$\alpha$ is a fixed proposition.
\end{enumerate}

\begin{lemma}Any modal operator~$\Box$ is monotonic, \ie if~$\varphi
\Rightarrow \psi$, then~$\Box\varphi \Rightarrow \Box\psi$. Furthermore, there
holds a modus ponens rule: If~$\Box\varphi$ holds, and~$\varphi$
implies~$\Box\psi$, then~$\Box\psi$ holds as well.\end{lemma}
\begin{proof}Assume~$\varphi \Rightarrow \psi$. This is equivalent to
supposing~$\varphi \wedge \psi \Leftrightarrow \varphi$. We are to show
that~$\Box\varphi \Rightarrow \Box\psi$, \ie that~$\Box\varphi \wedge
\Box\psi \Leftrightarrow \Box\varphi$. This follows since by the third
axiom on a modal operator, we have~$\Box\varphi \wedge \Box\psi \Leftrightarrow
\Box(\varphi \wedge \psi)$, and~$\Box$ respects equivalence of propositions.

For the second statement, consider that if~$\varphi \Rightarrow \Box\psi$, by
monotonicity and the second axiom on a modal operator it follows
that~$\Box\varphi \Rightarrow \Box\Box\psi \Rightarrow \Box\psi$.
\end{proof}

The modus ponens rule justifies the following proof scheme: When trying to
show, given that some boxed statement~$\Box\varphi$ holds, that some further
boxed statement~$\Box\psi$ holds, we may give a proof of~$\Box\psi$ under the
stronger assumption~$\varphi$. Symbolically:
\[ (\Box\varphi \Rightarrow \Box\psi) \Longleftrightarrow
  (\varphi \Rightarrow \Box\psi). \]


\subsection{Geometric meaning}\label{sect:modalities-geometric-meaning}
Let~$X$ be a topological space. As discussed
above, an open subset~$U \subseteq X$ defines an internal truth value (a global
section of the sheaf~$\Omega$). We also denote it by~``$U$'', such that
\[ V \models U \quad\Longleftrightarrow\quad V \subseteq U \]
for any open subset~$V \subseteq X$. (Shortcutting the various intermediate
steps, this can also be taken as a definition of~``$V \models U$''.)
If~$A \subseteq X$ is a closed subset, there is thus an internal truth
value~$A^c$ corresponding to the open subset~$A^c = X \setminus A$. If~$x \in
X$ is a point, we define~``$\notat{x}$'' to denote the truth value
corresponding to~$\Int(X \setminus \{x\})$, such that
\[ V \models \notat{x} \quad\Longleftrightarrow\quad V \subseteq \Int(X
\setminus \{ x \}) \quad\Longleftrightarrow\quad x \not\in V. \]

\begin{prop}\label{prop:modops-kripke}
Let~$U \subseteq X$ be a fixed open and~$A \subseteq X$ be a fixed
closed subset. Let~$x \in X$. Then, for any open subset~$V \subseteq X$, it
holds that:
\[ \renewcommand{\arraystretch}{1.3}\begin{array}{@{}lcl@{}}
  V \models (U \Rightarrow \varphi) &\Longleftrightarrow&
    V \cap U \models \varphi. \\[0.3em]
  V \models (\varphi \vee A^c) &\Longleftrightarrow&
    \textnormal{there is an open subset~$W \subseteq V$} \\
  && \quad\quad \textnormal{containing~$A \cap V$ such that $W \models \varphi$.} \\[0.3em]
  V \models \neg\neg\varphi &\Longleftrightarrow&
    \textnormal{there is a dense open subset~$W \subseteq V$ s.\,th.\@ $W \models
    \varphi$.} \\[0.3em]
  V \models ((\varphi \Rightarrow \notat{x}) \Rightarrow \notat{x}) &\Longleftrightarrow&
    \textnormal{$x \not\in V$ or there is an open neighbourhood~$W \subseteq V$} \\
  && \quad\quad \textnormal{of~$x$ such that $W \models \varphi$.}
\end{array} \]
\end{prop}
\begin{proof}
\begin{enumerate}
\item Omitted.

\item Let~$V \models \varphi \vee A^c$. Then there exists an open covering~$V =
\bigcup_i V_i$ such that for each~$i$, $V_i \models \varphi$ or $V_i \subseteq
A^c$. Let~$W \subseteq V$ be the union of those~$V_i$ such that~$V_i \models \varphi$.
Then~$W \models \varphi$ by the locality of the internal language and~$A \cap V
\subseteq W$.

Conversely, let~$W \subseteq V$ be an open subset containing~$A \cap V$ such
that~$W \models \varphi$. Then~$V = W \cup (V \cap A^c)$ is an open covering
attesting~$V \models \varphi \vee A^c$.

\item For the ``only if'' direction, let~$W \subseteq V$ be the largest
open subset on which~$\varphi$ holds, \ie the union of all open subsets
of~$V$ on which~$\varphi$ holds. For the ``if'' direction, we may assume that
the given set~$W$ is also the largest open subset on which~$\varphi$ holds (by
enlarging~$W$ if necessary). The claim then follows by the following chain of
equivalences:
\begin{align*}
  &\ V \models \neg\neg\varphi \\
  \Longleftrightarrow&\ \forall \text{$Y \subseteq V$ open}\_
    \Bigl(\forall \text{$Z \subseteq Y$ open}\_ (Z \models \varphi) \Rightarrow Z
    = \emptyset\Bigr) \Longrightarrow Y = \emptyset \\
  \Longleftrightarrow&\ \forall \text{$Y \subseteq V$ open}\_
    \Bigl(\forall \text{$Z \subseteq Y$ open}\_ Z \subseteq W \Rightarrow Z
    = \emptyset\Bigr) \Longrightarrow Y = \emptyset \\
  \Longleftrightarrow&\ \forall \text{$Y \subseteq V$ open}\_
    Y \cap W = \emptyset \Longrightarrow Y = \emptyset \\
  \Longleftrightarrow&\ \text{$W$ is dense in~$V$.}
\end{align*}

\item Straightforward, since the interpretation of the internal statement with
the Kripke--Joyal semantics is
\[ \forall \text{$Y \subseteq V$ open}\_
  \Bigl(\forall \text{$Z \subseteq Y$ open}\_
    Z \models \varphi \Rightarrow x \not\in Z\Bigr) \Longrightarrow x \not\in
    Y. \qedhere \]
\end{enumerate}
\end{proof}


\subsection{The subspace associated to a modal operator}
Any modal operator~$\Box : \Omega \to \Omega$ in the sheaf topos of~$X$ induces
on global sections a map
\[ j : \Open(X) \to \Open(X), \]
where~$\Open(X) = \Gamma(X,\Omega)$ is the set of open subsets of~$X$. By the
axioms on a modal operator, the map~$j$ fulfills similar axioms: For any open
subsets~$U, V \subseteq X$,
\begin{enumerate}
\item $U \subseteq j(U)$,
\item $j(j(U)) \subseteq j(U)$,
\item $j(U \cap V) = j(U) \cap j(V)$.
\end{enumerate}
Such a map is called a \emph{nucleus} on~$\Open(X)$. Table~\ref{table:nuclei}
lists the nuclei associated to the four modal operators
of proposition~\ref{prop:modops-kripke}.

\begin{table}
  \centering
  \renewcommand{\arraystretch}{1.3}
  \begin{tabular}{llll}
    \toprule
    Modal operator & associated nucleus &
      $j(V) = X$ iff \ldots &
      subspace \\\midrule
    $\Box\varphi :\equiv (U \Rightarrow \varphi)$ &
      $j(V) = \Int(U^c \cup V)$ & $U \subseteq V$ & $U$ \\
    $\Box\varphi :\equiv (\varphi \vee A^c)$ &
      $j(V) = V \cup A^c$ & $A \subseteq V$ & $A$ \\
    $\Box\varphi :\equiv \neg\neg\varphi$ &
      $j(V) = \Int(\Clos(V))$ & $V$ is dense in $X$ &
      \multicolumn{1}{p{1cm}}{smallest dense sublocale of~$X$} \\
    $\Box\varphi :\equiv ((\varphi \Rightarrow \notat{x}) \Rightarrow \notat{x})$ &
%      $\Int(\Clos(V \cap \Clos\{x\}) \cup (X \setminus \Clos\{x\}))$ &
      $\begin{array}{@{}ll@{}}
        j(V) = X \setminus \Clos\{x\}, & \text{if $x \not\in V$} \\
        j(V) = X, & \text{if $x \in V$}
      \end{array}$ &
      $x \in V$ & $\{x\}$ \\
    \bottomrule
  \end{tabular}
  \vspace{0.5em}

  \caption{\label{table:nuclei}List of important modal operators and their
  associated nuclei (notation as in proposition~\ref{prop:modops-kripke}).}
\end{table}

Any nucleus~$j$ defines a subspace~$X_j$ of~$X$, to be described below, with a small caveat: In
general, the subspace~$X_j$ can not be realized as a topological subspace, but
only as a so-called \emph{sublocale}; the notion of a locale is a slight
generalization of the notion of a topological space, in which an underlying set
of points is not part of the definition. Instead, a locale is simply given by a
lattice of arbitrary \emph{opens} satisfying some axioms -- these opens may, but do not necessarily have to,
be sets of points. Sheaf theory carries over to locales essentially unchanged,
since the notions of presheaves and sheaves only refer to open sets and coverings,
but not points.
Accessible introductions to the theory of locales include two notes by
Johnstone~\cite{johnstone:art,johnstone:point}.

\begin{defn}\label{defn:subspace-by-nucleus}Let~$j$ be a nucleus on~$\Open(X)$.
Then the sublocale~$X_j$ of~$X$ is given by the lattice of opens
$\Open(X_j) := \{ U \in \Open(X) \,|\, j(U) = U \}$.
\end{defn}
If~$j$ is induced by a modal operator~$\Box$, we also write~``$X_\Box$''
for~$X_j$. In three of the four cases listed in table~\ref{table:nuclei}, the
sublocale~$X_\Box$ can indeed be realized as a topological subspace. The only
exception is the sublocale~$X_{\neg\neg}$ associated to the double negation
modality. It can be also be described as the \emph{smallest dense sublocale}
of~$X$; this is obviously a genuine locale-theoretic notion, since there
is (in general) no smallest dense topological subspace
(consider~$\RR$ and its dense subsets~$\QQ$ and~$\RR \setminus \QQ$).

The inclusion~$i : X_j \hookrightarrow X$ can not in general be described on the
level of points, since~$X_j$ might not be realizable as a topological subspace.
But for sheaf-theoretic purposes, it suffices to describe~$i$ on the level of
opens. This is done as follows:
\[ i^{-1} : \Open(X) \lra \Open(X_j),\ \quad U \longmapsto j(U). \]
Thus we can relate the toposes of sheaves on~$X_j$ and~$X$ by the usual
pullback and pushforward functors.
\begin{align*}
  i^{-1} \F &= \text{sheafification of $(U \mapsto \colim_{U \preceq i^{-1}V} \Gamma(V,\F))$} \\
  i_* \G &= (U \mapsto \Gamma(i^{-1}U, \G)) = (U \mapsto \Gamma(j(U), \G))
\end{align*}
As familiar from honest topological subspace inclusions, the pushforward
functor~$i_* : \Sh(X_j) \to \Sh(X)$ is fully faithful and the composition~$i^{-1}
\circ i_* : \Sh(X_j) \to \Sh(X_j)$ is (canonically isomorphic to) the identity.


\subsection{Internal sheaves and sheafification}\label{sect:internal-sheaves}
It turns out that the image of
the pushforward functor~$i_* : \Sh(X_\Box) \to \Sh(X)$, where~$\Box$ is a modal
operator in~$\Sh(X)$, can be explicitly described. Namely, it consists exactly
of those sheaves which from the internal point of view
are so-called~\emph{$\Box$-sheaves}, a notion explained below.
\XXX{state this as a proposition later as well?}

Furthermore, if we identify~$\Sh(X_\Box)$ with its image in~$\Sh(X)$, the
pullback functor is given by an internal sheafification process with respect to
the modality~$\Box$. Thus the external situation of pushforward/pullback
translates to forget/sheafify. This broadens the scope of the internal
language of~$\Sh(X)$: It can not only be used to talk about sheaves on~$X$ in a simple,
element-based language, but also to talk about sheaves on arbitrary subspaces
of~$X$.

To describe the notion of~$\Box$-sheaves and related ones, we switch to the internal
perspective and thus forget~$X$; we are simply given a modal operator~$\Box :
\Omega \to \Omega$ and have to take care that our proofs are intuitionistically acceptable. A
reference for the material in this subsection is a preprint by Fer-Jan de
Vries~\cite{vries:sheafification}.\footnote{Note that on page~5 of that
preprint, there is a slight typing error: Fact~2.1(i) gives the
characterization of~$j$-closedness, not~$j$-denseness. The correct
characterization of~$j$-denseness in that context is~$\forall b \in B\_ j(b \in
A)$.}

Recall that a set~$S$ is a \emph{subsingleton} if and only if~$\forall x,y\?S\_
x = y$, and that a set~$S$ is a \emph{singleton} if and only if it is a subsingleton and
inhabited (\ie~$\exists x\?S$); this amounts to~$\exists!x\?S$.

\begin{defn}\label{defn:box-sheaves}
A set~$F$ is \emph{$\Box$-separated} if and only if
\[ \forall x,y\?F\_ \Box(x = y) \Longrightarrow x = y. \]
A set~$F$ is a \emph{$\Box$-sheaf} if and only if it is~$\Box$-separated and
\[ \forall S \subseteq F\_
  \Box(\speak{$S$ is a singleton}) \Longrightarrow
  \exists x\?F\_ \Box(x \in S). \]
\end{defn}

The two conditions can be combined: A set~$F$ is a~$\Box$-sheaf if and only if
\[ \forall S \subseteq F\_
  \Box(\speak{$S$ is a singleton}) \Longrightarrow
  \exists! x\?F\_ \Box(x \in S). \]
\XXX{explain how to read these definitions}

\begin{defn}The \emph{plus construction} of a set~$F$ with respect to~$\Box$ is the set
\[ F^+ := \{ S \subseteq F \,|\, \Box(\speak{$S$ is a singleton}) \}/{\sim},
\]
where the equivalence relation is defined by~$S \sim T :\Leftrightarrow
\Box(S = T)$. There is a canonical map~$F \to F^+$ given by~$x \mapsto
[\{x\}]$. The \emph{$\Box$-sheafi\-fi\-ca\-tion} of a set~$F$ is the
set~$F^{++}$.
\end{defn}

If~$F$ is~$\Box$-separated, then for any subset~$S \subseteq F$ it holds
that
\[ \Box(\speak{$S$ is a singleton}) \quad\Longleftrightarrow\quad
  \speak{$S$ is a subsingleton} \wedge \Box(\speak{$S$ is inhabited}). \]

\begin{rem}The topos of \emph{pre}sheaves on a topological space~$X$ admits an
internal language as well~\cite[section~VI.7, discussion after
theorem~1]{moerdijk-maclane:sheaves-logic}. In it, there
exists a modal operator~$\Box$ reflecting the topology of~$X$. A presheaf on~$X$ is separated
in the usual sense if, from the internal perspective of~$\PSh(X)$, it
is~$\Box$-separated; and it is a sheaf if, from the internal perspective, it
is a~$\Box$-sheaf. Furthermore, the~$\Box$-sheafification of a presheaf
(considered as a set from the internal perspective) coincides with the usual
sheafification.\end{rem}

\begin{ex}\label{ex:special-sets-sheaves}
Any singleton set is a~$\Box$-sheaf. The empty set is
always~$\Box$-separated (trivially) and is a~$\Box$-sheaf if and only
if~$\Box\bot \Rightarrow \bot$.\end{ex}

We will see geometric examples of~$\Box$-sheaves in further sections.
For instance, on an integral scheme~$X$, the structure sheaf~$\O_X$
is~$\neg\neg$-separated and its~$\neg\neg$-sheafification is the sheaf~$\K_X$
of rational functions (proposition~\ref{prop:kx-is-negneg-sheafification}).

\begin{lemma}For any set~$F$, it holds that: \begin{enumerate}
\item $F^+$ is~$\Box$-separated.
\item The canonical map~$F \to F^+$ is injective if and only if~$F$
is~$\Box$-separated.
\item If~$F$ is~$\Box$-separated, then $F^+$ is a~$\Box$-sheaf.
\item If~$F$ is a~$\Box$-sheaf, then the canonical map~$F \to F^+$ is bijective.
\end{enumerate}
Let``$\Sh_\Box(\Set)$'' denote the full subcategory of~$\Set$ consisting of
the~$\Box$-sheaves. Then it holds that:
\begin{enumerate}
\addtocounter{enumi}{4}
\item The functor~$(\placeholder)^+ : \Set \to \Set$ is left exact.
\item The functor~$(\placeholder)^{++} : \Set \to \Sh_\Box(\Set)$ is left exact and left
adjoint to the forgetful functor~$\Sh_\Box(\Set) \to \Set,\ F \mapsto F$.
\end{enumerate}\end{lemma}
\begin{proof}These are all straightforward, and it fact simpler than their
classical counterparts, since there are no colimit constructions which would have to
be dealt with.
\end{proof}

\begin{rem}As is to be expected from the familiar inclusion of sheaves in
presheaves on topological spaces, the forgetful functor~$\Sh_\Box(\Set) \to \Set$
does not in general preserve colimits. It is instructive to see why
epimorphisms in~$\Sh_\Box(\Set)$ need not be epimorphisms in~$\Set$: A map~$f:A
\to B$ between~$\Box$-sheaves is an epimorphism in~$\Sh_\Box(\Set)$ if and only
if
\[ \forall y\?B\_ \Box(\exists x\?X\_ f(x) = y), \]
\ie preimages do not need to exist, it suffices for them to~``$\Box$-exist''.
(Using results about the~$\Box$-translation, to be introduced below, this
characterization will be obvious.) This condition is intuitionistically weaker
than the condition that~$f$ is an epimorphism in~$\Set$, \ie that~$f$ is
surjective. Compare this to the failure of the forgetful functor~$\Sh(X)
\to \PSh(X)$ to preserve epimorphisms: A morphism of sheaves does not need to
have preimages for any local section in order to be an epimorphism. Instead, it
suffices for any local section to \emph{locally} have preimages.\end{rem}

\XXX{come back to this after introducing the~$\Box$-translation}


\subsection{Sheaves for the double negation modality}
\label{sect:negneg-sheaves}

Recall that if~$\Box$ is the modal operator associated to a sub\emph{space}~$Y$
of a topological space~$X$, then the sheaves on~$X$ which are~$\Box$-sheaves
are easy to describe: These are precisely the sheaves in the essential image of
the pushforward functor~$\Sh(Y) \to \Sh(X)$. For the double negation modality,
the same is true, only that~$Y$ is then the perhaps unfamiliar \emph{smallest
dense sublocale} of~$X$.

The following proposition gives a characterization of~$\neg\neg$-separated
presheaves and~$\neg\neg$-sheaves in explicit terms.

\begin{prop}\label{prop:negneg-sheaves}
Let~$X$ be a topological space. Let~$\F$ be a sheaf on~$X$. Then:
\begin{enumerate}
\item $\F$ is~$\neg\neg$-separated if and only if any two local sections
of~$\F$, which are defined on a common domain and which agree on a dense open
subset of their domain, are already equal.
\item $\F$ is a~$\neg\neg$-sheaf if and only if it is~$\neg\neg$-separated and
for any open subset~$U \subseteq X$ and any open subset~$V \subseteq U$ dense
in~$U$, any~$V$-section of~$\F$ extends to a~$U$-section of~$\F$.
\item If~$\F$ is~$\neg\neg$-separated, the sections of $\F^+$ on an open
subset~$U \subseteq X$ can be described by pairs~$(V,s)$, where~$V$ is a dense
open subset of~$U$ and~$s$ is a section of~$\F$ on~$V$. Two such pairs~$(V,s),
(V',s')$ determine the same element in~$\Gamma(U,\F^+)$ if and only if~$s$ and~$s'$
agree on~$V \cap V'$.
\end{enumerate}
\end{prop}
\begin{proof}
The first statement is obvious from the definition of~$\neg\neg$-separatedness
(definition~\ref{defn:box-sheaves} for~$\Box = \neg\neg$) and the geometric
interpretation of double negation (proposition~\ref{prop:modops-kripke}).

For the second statement, we need to show that if~$\F$
is~$\neg\neg$-separated,~$\F$ has the extension property if and only if
\begin{multline*}
  \Sh(X) \models \forall \S \? \P(\F)\_
  \speak{$\S$ is a subsingleton} \wedge
  \neg\neg(\speak{$\S$ is inhabited}) \Longrightarrow \\
  \exists x\?\F\_ \neg\neg(x \in \S).
\end{multline*}
Note that a section~$\S \in \Gamma(U,\P(\F))$ which internally is a
subsingleton and \notnot inhabited is precisely a subsheaf~$\S \hookrightarrow
\F|_U$ such that all stalks~$\S_x$, $x \in U$ are subsingletons and such that for
some dense open subset~$V \subseteq U$, the stalks~$\S_x$, $x \in V$ are
inhabited. This is precisely the datum of a section of~$\F$ defined on some
dense open subset of~$U$: Consider the gluing of the unique germs in~$\S_x$ for
those points~$x$ such that~$\S_x$ is inhabited. (Conversely, a section~$s \in
\Gamma(V,\F)$ defines a subsheaf~$\S$ by setting~$\Gamma(W,\S) := \{ s|_W \,|\,
W \subseteq V \}$.)

In view of this explicit description and the observation that the asserted
existence~(``$\exists x\?\F\_ \neg\neg(x \in \S)$'') is actually a question of
unique existence, the second statement follows.

For the third statement, one can check that the presheaf on~$X$ defined by
\[ \text{$U \subseteq X$ open} \quad\longmapsto\quad
  \{ (V,s) \,|\, \text{$V \subseteq U$ dense open},\ s \in \Gamma(V,\F)
  \}/{\sim} \]
is in fact a sheaf (with respect to the topology of~$X$), internally a $\neg\neg$-sheaf,
and that it has the universal property of the~$\neg\neg$-sheafification
of~$\F$.
\end{proof}

\begin{rem}The conditions~(1) and~(2) of the previous proposition can be
summarized as follows: A sheaf~$\F$ on a topological space is
a~$\neg\neg$-sheaf if and only if, for any open subset~$U \subseteq X$, the
restriction map~$\Gamma(\Int\Clos U, \F) \to \Gamma(U,\F)$ is
bijective~\cite[lemma~36]{jackson:sheaf-theoretic-measure-theory}.
\end{rem}


\subsection{\texorpdfstring{The~$\Box$-translation}{The □-translation}}
There is certain well-known transformation~$\varphi
\mapsto \varphi^{\neg\neg}$ on formulas, the \emph{double negation
translation}, with the following curious property: A formula~$\varphi$ is
derivable in classical logic if and only if its
translation~$\varphi^{\neg\neg}$ is derivable in intuitionistic logic. The
translation~$\varphi^{\neg\neg}$ is obtained from~$\varphi$ by putting
``$\neg\neg$'' before any subformula, \ie before any~``$\exists$''
and~``$\forall$'', around any logical connective and around any atomic
statement (``$x=y$'', ``$x \in A$'').

We will describe a slight generalization of the double negation translation,
the~$\Box$-translation for any modal operator~$\Box$. It will be pivotal
for using the internal language of a space~$X$ to express internal statements
about sheaves defined on subspaces of~$X$. The~$\Box$-translation has been studied
in other contexts
before~\cite{aczel:russell-prawitz,escardo:oliva:peirce-shift}. To the best of
my knowledge, this application -- expressing the internal language of
subtoposes in the internal language of the ambient topos -- is new.

\begin{defn}The~\emph{$\Box$-translation} is recursively defined as follows.
\newcommand{\optBox}{\textcolor{gray}{\Box}}
\begin{align*}
  (f = g)^\Box &:\equiv \Box(f = g) \\
  (x \in A)^\Box &:\equiv \Box(x \in A) \\
  \top^\Box &:\equiv \Box\top \quad \text{($\Leftrightarrow \top$)} \\
  \bot^\Box &:\equiv \Box\bot \\
  (\varphi \wedge \psi)^\Box &:\equiv \optBox(\varphi^\Box \wedge \psi^\Box) &
  \textstyle (\bigwedge_i \varphi_i)^\Box &:\equiv \textstyle \optBox(\bigwedge_i \varphi_i^\Box) \\
  (\varphi \vee \psi)^\Box &:\equiv \Box(\varphi^\Box \vee \psi^\Box) &
  \textstyle (\bigvee_i \varphi_i)^\Box &:\equiv \textstyle \Box(\bigvee_i \varphi_i^\Box) \\
  (\varphi \Rightarrow \psi)^\Box &:\equiv \optBox(\varphi^\Box \Rightarrow \psi^\Box) \\
  (\forall x\?X\_ \varphi)^\Box &:\equiv \optBox(\forall x\?X\_ \varphi^\Box) &
  (\forall X\_ \varphi)^\Box &:\equiv \optBox(\forall X\_ \varphi^\Box) \\
  (\exists x\?X\_ \varphi)^\Box &:\equiv \Box(\exists x\?X\_ \varphi^\Box) &
  (\exists X\_ \varphi)^\Box &:\equiv \Box(\exists X\_ \varphi^\Box)
\end{align*}
\end{defn}

\begin{defn}A formula~$\varphi$ is \emph{$\Box$-stable} if and only
if~$\Box\varphi$ implies~$\varphi$.\end{defn}

\begin{lemma}\begin{enumerate}
\item Formulas in the image of the $\Box$-translation are~$\Box$-stable,
\ie for any formula~$\varphi$ it holds that
$\Box(\varphi^\Box) \Longrightarrow \varphi^\Box$.
\item In the definition of the~$\Box$-translation, one may omit the boxes
printed in gray.
\end{enumerate}\end{lemma}
\begin{proof}The first statement is obvious, since one of the axioms on a modal
operator demands that~$\Box\Box\varphi \Rightarrow \Box\varphi$ for any
formula~$\varphi$. The second statement follows by an induction on the
formula structure. By way of example, we prove the case for~``$\Rightarrow$'':
\newcommand{\withgray}{\text{$\Box$ with the gray parts}}
\newcommand{\withoutgray}{\text{$\Box$ without the gray parts}}
\begin{align*}
  &\ (\varphi \Rightarrow \psi)^\withgray \\
  \Longleftrightarrow &\ \Box(\varphi^\withgray \Rightarrow \psi^\withgray) \\
  \Longleftrightarrow &\ (\varphi^\withgray \Rightarrow \psi^\withgray) \\
  \Longleftrightarrow &\ (\varphi^\withoutgray \Rightarrow \psi^\withoutgray) \\
  \Longleftrightarrow &\ (\varphi \Rightarrow \psi)^\withoutgray
\end{align*}
The first step is by definition; the second by~$\Box$-stability
of~$\psi^\withgray$ and the intuitionistic tautology~$\Box(\alpha \Rightarrow
\beta) \Leftrightarrow (\alpha \Rightarrow \beta)$ for~$\Box$-stable
formulas~$\beta$; the third by the induction hypothesis; the fourth by
definition.
\end{proof}

\begin{lemma}\label{lemma:box-translation-sound}
The~$\Box$-translation is sound with respect to intuitionistic logic:
Assume that there exists an intuitionistic proof of an
implication~$\varphi \Rightarrow \psi$. Then there is also an intuitionistic
proof of the translated implication~$\varphi^\Box \Rightarrow \psi^\Box$.
\end{lemma}
\begin{proof}This follows by an induction on the structure of intuitionistic
proofs. We have to verify that we can mirror any inference rule of
intuitionistic logic in the translation. For instance, one of the disjunction
rules justifies the following proof scheme: In order to prove~$\varphi \vee
\psi \Rightarrow \chi$, it suffices to give proofs of~$\varphi \Rightarrow
\chi$ and~$\psi \Rightarrow \chi$. We have to justify the translated proof
scheme: In order to prove~$(\varphi \vee \psi)^\Box \Rightarrow \chi^\Box$, it
suffices to give proofs of~$\varphi^\Box \Rightarrow \chi^\Box$ and~$\psi^\Box
\Rightarrow \chi^\Box$.

So assume that proofs of the two implications are given. Further
assume~$(\varphi \vee \psi)^\Box$, \ie~$\Box(\varphi^\Box \vee \psi^\Box)$.
We want to show~$\chi^\Box$. Since this is a~$\Box$-stable statement, we may
assume that in fact~$\varphi^\Box \vee \psi^\Box$ holds. Then the claim is
obvious by the two given proofs.

The cases for the other rules (see appendix~\ref{appendix:inference-rules} for
a list) are similar and left to the reader.\end{proof}

\begin{rem}The reader well-versed in formal logic will have noticed that we are
mixing syntax and semantics here. The proper way to state the lemma would be
to formally adjoin a box operator to the language of intuitionistic logic,
governed by three inference rules which are modeled on the three axioms on a
modal operator. This formal box operator could then be instantiated by any
concrete modal operator~$\Box : \Omega \to \Omega$.\end{rem}

Soundness of the~$\Box$-translation is important for the following reason
(among others). If~$\varphi$ and~$\varphi'$ are equivalent formulas, we are
accustomed to be able to freely substitute~$\varphi$ by~$\varphi'$ anywhere we
want. Since a modal operator~$\Box$ is semantically defined as a map~$\Omega
\to \Omega$, it is trivially justified that~$\Box\varphi$ and~$\Box\varphi'$
are equivalent: The formulas~$\varphi$ and~$\varphi'$ give rise to the
\emph{same} element~$\{x \in 1 \,|\, \varphi\} = \{x \in 1 \,|\, \varphi'\}$
of~$\Omega$, and therefore their images under~$\Box$ are equal as well.

However, it is \emph{not} clear and in fact wrong in general that the translated formulas~$\varphi^\Box$
and~$(\varphi')^\Box$ are equivalent. This follows only if the soundness
lemma can be applied (two times, once for each direction). We should stress that to apply this
lemma, it is not enough to merely \emph{know} that~$\varphi$ and~$\varphi'$ are
equivalent; instead, there has to be an intuitionistic proof of this
equivalence. This is really a stronger requirement, since an
equivalence~$\varphi \Leftrightarrow \varphi'$ might simply
hold in a particular model, \ie in the internal language of some particular
topos, without possessing an intuitionistic proof, \ie holding in any topos. We
give an explicit example of this situation below
(example~\ref{ex:translation-equivalence}).

\begin{lemma}\label{lemma:open-stalk}
Let~$\varphi$ be a formula such that for any subformulas~$\psi$
appearing as antecedents of implications, it holds that~$\psi^\Box \Rightarrow
\Box\psi$. (In particular, this condition is satisfied if there are
no~``$\Rightarrow$'' signs in~$\varphi$ or if~$\varphi$ is a geometric formula.) Then $\Box\varphi \Rightarrow
\varphi^\Box$.\end{lemma}
\begin{proof}We prove this by an induction on the formula structure. All cases
except for~``$\Rightarrow$'' are obvious. For this case, assume~$\Box(\psi
\Rightarrow \chi)$; we are to show that~$(\psi^\Box \Rightarrow \chi^\Box)$.
Since this is a~$\Box$-stable statement, we can in fact assume that~$(\psi
\Rightarrow \chi)$. We then have
\[ \psi^\Box \Longrightarrow \Box\psi \Longrightarrow \Box\chi
\Longrightarrow \chi^\Box, \]
with the first step being by the requirement on antecedents, the second by the
monotonicity of~$\Box$, and the third by the induction hypothesis.
\end{proof}

\begin{lemma}\label{lemma:stalk-open}
Let~$\varphi$ be a geometric formula.
Then $\varphi^\Box \Rightarrow \Box\varphi$.\end{lemma}
\begin{proof}By induction on the formula structure. By way of example, we verify
the case about~``$\bigvee$''. So assume~$\Box(\bigvee_i \varphi_i^\Box)$; we are
to show that~$\Box(\bigvee_i \varphi_i)$. Since this is a boxed statement, we
may in fact assume~$\bigvee_i \varphi_i^\Box$, so for some index~$j$, it holds
that~$\varphi_j^\Box$. By the induction hypothesis, it follows
that~$\Box\varphi_j$. By~$\varphi_j \Rightarrow \bigvee_i \varphi_i$ and the
monotonicity of~$\Box$, it follows that that~$\Box(\bigvee_i \varphi_i)$.
\end{proof}

Note that an analogous argument for infinite conjuctions is not valid:
Assume~$(\bigwedge_i \varphi_i)^\Box$. So for all~$j$,~$\varphi_j^\Box$ holds.
By the induction hypothesis,~$\Box\varphi_j$ holds for any~$j$. But from this
we may not deduce~$\Box\bigwedge_i \varphi_i$, since the axioms on a modal
operator only require commutativity with finite conjuctions. This failure also
has a geometric interpretation, for instance in the special case~$\Box =
\neg\neg$: Given dense open subsets~$U_i$ on which formulas~$\varphi_i$ hold,
we may not conclude that there exists a single dense open subset~$U$ on which
all the formulas~$\varphi_i$ hold.

\begin{rem}In the special case that~$\Box$ is the double negation modality, the
lemma holds with slightly weaker hypotheses: Namely, implications may occur
in~$\varphi$, provided that for their antecedents~$\psi$ it holds that~$\psi
\Rightarrow \psi^\Box$. This is because for the double negation modality,
the formula~$\Box(\psi \Rightarrow \chi)$ is equivalent to~$\psi \Rightarrow
\Box\chi$. (In general, for an arbitrary modality, only the former implies the latter, but not vice versa.) The case
for~``$\Rightarrow$'' in the inductive proof then goes as follows:
Assume~$(\psi \Rightarrow \chi)^\Box$. Then~$\psi \Rightarrow \psi^\Box
\Rightarrow \chi^\Box \Rightarrow \Box\chi$, so~$\Box(\psi \Rightarrow \chi)$.
\end{rem}

\begin{lemma}\label{lemma:stalk-open-with-hypothesis}
Let~$\varphi, \varphi', \psi$ be formulas. Assume that:
\begin{itemize}
\item The formula $\varphi'$ is geometric. (More generally, it suffices for~$(\varphi')^\Box$
to imply~$\Box\varphi'$.)
\item There is an intuitionistic proof that~$\varphi$
and~$\varphi'$ are equivalent under the (only) hypothesis~$\psi$.
\item Both~$\Box\psi$ and~$\psi^\Box$ hold.
\end{itemize}
Then $\varphi^\Box \Rightarrow \Box\varphi$.
\end{lemma}
\begin{proof}
Assume~$\varphi^\Box$. Since~$\psi^\Box$, $(\varphi \wedge \psi)^\Box$. Because
the~$\Box$-translation is sound with respect to intuitionistic logic
(lemma~\ref{lemma:box-translation-sound})
it follows that~$(\varphi')^\Box$. As~$\varphi'$ is geometric, it follows
that~$\Box\varphi'$. Since~$\Box\psi$ holds, it follows that~$\Box\varphi$.
\end{proof}

\begin{ex}\label{ex:module-zero-geometric}
Let~$M$ be an~$R$-module. Then the statement that~$M$ is zero is not
geometric: $\varphi :\equiv (\forall x\?M\_ x = 0)$. But if~$M$ is generated by some finite
family~$x_1,\ldots,x_n\?M$, then~$\varphi$ is equivalent to the
statement~$\varphi' :\equiv (x_1 = 0
\wedge \cdots \wedge x_n = 0)$ which is geometric; and there is an
intuitionistic proof of this equivalence. Since no implication signs occur
in~$\psi :\equiv \speak{$M$ is generated by~$x_1,\ldots,x_n$}$, the lemma is
applicable and shows that~$\varphi^\Box$ implies~$\Box\varphi$.
This example will gain geometric meaning in
lemma~\ref{lemma:module-zero-point-neighbourhood}.
\end{ex}

\begin{lemma}For the modality~$\Box$ defined by~$\Box\varphi :\equiv ((\varphi
\Rightarrow \alpha) \Rightarrow \alpha)$, where~$\alpha$ is a fixed
proposition, the~$\Box$-translation of the law of excluded middle holds.
In particular, this applies to the double negation modality~$\Box = \neg\neg$, where~$\alpha =
\bot$.\end{lemma}
\begin{proof}We are to show that~$(\varphi \vee \neg\varphi)^\Box$, \ie that
\[ (((\varphi^\Box \vee (\varphi^\Box \Rightarrow \alpha)) \Longrightarrow
\alpha) \Longrightarrow \alpha. \]
So assume that the antecedent holds. If~$\varphi^\Box$ would hold, then in
particular~$\varphi^\Box \vee (\varphi^\Box \Rightarrow \alpha)$ and thus~$\alpha$
would hold. Therefore it follows that~$(\varphi^\Box \Rightarrow \alpha)$. This
implies~$\varphi^\Box \vee (\varphi^\Box \Rightarrow \alpha)$ and
thus~$\alpha$.
\end{proof}


\subsection{Truth at stalks \vs truth on neighbourhoods}\label{sect:spreading}
We now state the crucial property of the~$\Box$-translation. Recall
that~``$X_\Box$'' denotes the sublocale of~$X$ induced by~$\Box$
(definition~\ref{defn:subspace-by-nucleus}).
\begin{thm}\label{thm:box-translation-semantically}
Let~$X$ be a topological space. Let~$\Box$ be a modal operator
in~$\Sh(X)$. Let~$\varphi$ be a formula over~$X$. Then
\[ \Sh(X) \models \varphi^\Box \quad\text{iff}\quad
  \Sh(X_\Box) \models \varphi, \]
where on the right hand side, all parameters occuring in~$\varphi$ were pulled
back to~$X_\Box$ along the inclusion~$X_\Box \hookrightarrow X$.
\end{thm}
\XXX{think about powersets appearing as domains of quantification}

We have not yet explicitly stated the Kripke--Joyal semantics for a sheaf topos
over a locale, which~$X_\Box$ is in general. The definition is exactly the same
as in the case for sheaf toposes over a topological space, only that any
mention of ``open sets'' has to be substituted by the more general ``opens''
and any mention of the union operator~``$\bigcup$'' has to be interpreted by
the supremum operator in the lattice of opens of the locale. For~$X_\Box$, this
is~$\sup U_i = j(\bigcup_i U_i)$. Before giving a proof of the theorem, we want
to discuss some of its consequences.

\begin{cor}\label{cor:spreading}
Let~$X$ be a topological space.
\begin{enumerate}
\item Let~$U \subseteq X$ be an open subset and let~$\Box\varphi :\equiv (U
\Rightarrow \varphi)$. Then
\[ \Sh(X) \models \varphi^\Box \quad\text{iff}\quad \Sh(U) \models \varphi. \]
\item Let~$A \subseteq X$ be a closed subset and let~$\Box\varphi :\equiv
(\varphi \vee A^c)$. Then
\[ \Sh(X) \models \varphi^\Box \quad\text{iff}\quad \Sh(A) \models \varphi. \]
\item Let~$\Box\varphi :\equiv \neg\neg\varphi$. Then
\[ \Sh(X) \models \varphi^\Box \quad\text{iff}\quad \Sh(X_{\neg\neg}) \models \varphi. \]
\item Let~$x \in X$ be a point and let~$\Box\varphi :\equiv ((\varphi
\Rightarrow \notat{x}) \Rightarrow \notat{x})$. Then
\[ \Sh(X) \models \varphi^\Box \quad\text{iff}\quad \text{$\varphi$ holds
at~$x$}. \]
% change text below ("discuss the third case") if numbering of the items changes
\end{enumerate}
\end{cor}
\begin{proof}Combine theorem~\ref{thm:box-translation-semantically} and
table~\ref{table:nuclei}.\end{proof}

We want to discuss the last case of the corollary in more detail. Let~$x$ be a
point of a topological space~$X$ and let~$\varphi$ be a formula. Let~$\Box$ be
the modal operator given in the corollary. Then~$\varphi$ \emph{holds at~$x$}
if and only if, from the internal perspective of~$\Sh(X)$, the translated
formula~$\varphi^\Box$ holds; and~$\varphi$ \emph{holds on some open
neighbourhood of~$x$} if and only if, from the internal perspective, the
formula~$\Box\varphi$ holds.

Thus the question whether the truth of~$\varphi$ at the point~$x$ spreads to
some open neighbourhood can be formulated in the following way:
\begin{quote}
\emph{Does~$\varphi^\Box$ imply~$\Box\varphi$ in the internal language
of~$\Sh(X)$?}
\end{quote}
Phrased this way, technicalities like appropriately shrinking open
neighbourhoods are blinded out. A purposefully trivial example to illustrate
this is the following. Let~$X$ be a scheme (or ringed space). Let~$f,g \in
\Gamma(X,\O_X)$ be global functions. Suppose that the germs of~$f$ and~$g$ are
zero in some stalk~$\O_{X,x}$; we want to show that they are zero on a common
open neighbourhood of~$x$.

\begin{proof}[Usual proof]Since the germ of~$f$ vanishes in~$\O_{X,x}$, there
is an open neighbourhood~$U_1$ of~$x$ such that~$f|_{U_1} = 0$
in~$\Gamma(U_1,\O_X)$. Since furthermore the germ of~$g$ vanishes in the same stalk,
there exists an open neighbourhood~$U_2$ of~$x$ such that~$g|_{U_2} = 0$. The
intersection of both neighbourhoods is still an open neighbourhood of~$x$; on
this it holds that~$f$ and~$g$ both vanish.
\end{proof}

\begin{proof}[Proof in the internal language]We may suppose that~$(f = 0 \wedge
g = 0)^\Box$, \ie $\Box(f=0) \wedge \Box(g=0)$, and have to prove
that~$\Box(f=0 \wedge g=0)$. (To this end, we could simply invoke the third
axiom on a modal operator, but we want to stay close to the given external
proof.) So by assumption, both~$\Box(f=0)$ and~$\Box(g=0)$ hold. Since our goal
is to prove a boxed statement, we may in fact assume that~$f = 0$ and~$g = 0$.
Thus~$f = 0 \wedge g = 0$.\end{proof}

By using the internal language with its modal operators, we can thus reduce
basic facts of scheme theory which deal with stalks and neighbourhoods to facts
of algebra in a \emph{modal intuitionistic context}. As with using the internal
language in its basic form without modalities, this brings conceptual clarity
and reduced technical overhead. There are however two more distinctive
advantages. Firstly, many internal proofs do not require specific properties of
the modal operator and thus work with any modal operator. By interpreting such
a proof using different operators, one obtains a whole family of external
statements without any additional work.

Secondly, the following corollary gives a general metatheorem which is
applicable to a wide range of cases. It allows to decide whether spreading will
occur (or is likely not to occur) simply by looking at the \emph{logical form}
of the statement is question.

\begin{cor}\label{cor:geometric-spreading}
Let~$X$ be a topological space. Let~$\varphi$ be a formula.
If~$\varphi$ is geometric, truth of~$\varphi$ at a point~$x \in X$ implies
truth of~$\varphi$ on some open neighbourhood of~$x$, and vice versa.\end{cor}
\begin{proof}By the purely logical lemmas of the previous section, it holds
that~$\varphi^\Box \Leftrightarrow \Box\varphi$.
\end{proof}

\begin{cor}
Let~$X$ be a topological space. Let~$\varphi$ be a formula.
If~$\varphi$ is geometric, the property ``$\varphi$ holds at a point~$x \in
X$'' is open.
\end{cor}
\begin{proof}This is just a reformulation of the previous corollary:
If~$\varphi$ holds at a point~$x \in X$, it holds on some open
neighbourhood~$U$ of~$x$ as well. Going back to stalks, it follows
that~$\varphi$ holds at every point of~$U$.\end{proof}

\begin{ex}Let~$X$ be a scheme (or a ringed space). Since the condition for a
function~$f\?\O_X$ to be nilpotent is geometric (it is~$\bigvee_{n \geq 0} f^n
= 0$), nilpotency of~$f$ at a point is equivalent to nilpotency on some open
neighbourhood.\end{ex}

Combined with lemma~\ref{lemma:stalk-open-with-hypothesis}, this metatheorem is
quite useful. We will illustrate it with many examples in the next subsection.

An important special case of spreading from stalks to neighbourhoods is the
case of spreading from the generic point to a dense open subset. Recall that
the \emph{generic point}~$\xi \in X$ has the property that~$\Clos\{\xi\} = X$.
Such a point exists and is unique if~$X$ is an irreducible scheme, and need not
exist otherwise.

\begin{lemma}\label{lemma:negneg-generic-point}
Let~$X$ be a topological space and~$\xi \in X$ a point such
that~$\Clos\{\xi\} = X$. Then the modal operator~$\Box :\equiv ((\placeholder
\Rightarrow \notat{\xi}) \Rightarrow \notat{\xi})$ coincides with the double
negation modality.\end{lemma}
\begin{proof}The semantics of the formula~$\notat{\xi}$ was defined by the
equivalence
\[ U \models \notat{\xi} \quad\Longleftrightarrow\quad
  \xi \not\in U. \]
By the assumption on~$\xi$, this is equivalent to requiring~$U = \emptyset$.
Thus for any open subset~$U$ the formulas~$\notat{\xi}$ and~$\bot$ have the
same meaning; they are therefore logically equivalent from the internal point of
view. The given modal operator thus simplifies to
\[ \Box\varphi \quad\equiv\quad ((\varphi \Rightarrow \notat{\xi}) \Rightarrow \notat{\xi})
  \quad\Leftrightarrow\quad ((\varphi \Rightarrow \bot) \Rightarrow \bot)
  \quad\Leftrightarrow\quad \neg\neg\varphi. \qedhere \]
\end{proof}

In particular, if~$X$ contains a generic point~$\xi$ in the sense of the lemma,
we can describe the sublocale~$X_{\neg\neg}$ in very explicit terms: In this
case, it coincides with the subspace~$\{\xi\}$.
\XXX{discuss that sheafifying is the same as calculating the generic stalk;
and that pushing forward is the same as calculating the constant sheaf.
do this in the section discussing negneg-sheaves.
Then continue with the story here...}

\begin{proof}[Proof of theorem~\ref{thm:box-translation-semantically}]
A fancy proof goes as follows. First, one shows intuitionistically that for a
modal operator~$\Box$ in~$\Set$, it holds that
\[ \Set \models \varphi^\Box \quad\Longleftrightarrow\quad
  \Sh_\Box(\Set) \models \varphi. \]
This can be done by an easy and nontechnical induction on the structure of
formulas~$\varphi$. Then one interprets this result in the sheaf topos~$\Sh(X)$:
\begin{align*}
  &\ \Sh(X) \models \varphi^\Box \\
  \Longleftrightarrow&\
  \Sh(X) \models \speak{$\Set \models \varphi^\Box$} &&\text{by idempotency}\\
  \Longleftrightarrow&\
  \Sh(X) \models \speak{$\Sh_\Box(\Set) \models \varphi$} &&\text{by the first step} \\
  \Longleftrightarrow&\
  \Sh_\Box(\Sh(X)) \models \varphi &&\text{by idempotency} \\
  \Longleftrightarrow&\
  \Sh(X_\Box) \models \varphi &&\text{since~$\Sh_\Box(\Sh(X)) \simeq
  \Sh(X_\Box)$}
\end{align*}
By \emph{idempotency}, we mean that internally employing the Kripke--Joyal
semantics to interpret doubly-internal statements is the same as using the
Kripke--Joyal semantics once. However, we do not want to discuss this here any further;
some details can be found in the original article on the stack
semantics~\cite[lemma~7.20]{shulman:stack}, but the lemma given there is not
general enough to justify the second use of idempotency above. For this, one
would have to extend the stack semantics to support internal statements about
locally internal categories like~$\Sh(X_\Box) \hookrightarrow \Sh(X)$ (which
then look like locally small categories from the internal point of view). This
is worthwhile for other reasons too, but shall not be pursued in these notes.

Therefore, we give a more explicit proof. By induction, we are going to prove
that for any open subset~$U \subseteq X$ and any formula~$\varphi$ over~$U$, it
holds that
\[ U \models_X \varphi^\Box \quad\Longleftrightarrow\quad j(U) \models_{X_\Box}
\varphi, \]
where the internal statements are to be interpreted by the Kripke--Joyal
semantics of~$X$ and~$X_\Box$ respectively and~$j$ is the nucleus associated
to~$\Box$. We may assume that any sheaves occuring in~$\varphi$ as domains of
quantifications are in fact~$\Box$-sheaves; we justify this with a separate lemma
below.

The cases~$\varphi \equiv \top$,~$\varphi \equiv (\psi \wedge \chi)$,
and~$\varphi \equiv \bigwedge_i \psi_i$ are trivial. For~$\varphi \equiv \bot$,
the claim is that~$U \models_X \Box\varphi$ if and only if~$j(U)
\models_{X_\Box} \bot$. The former means~$U \subseteq j(\emptyset)$ and the
latter means~$j(U) = \sup \emptyset = j(\emptyset)$, so the claim follows from
the first two axioms on a nucleus.
\end{proof}

\begin{lemma}Let~$\Box$ be a modal operator. Let~$\varphi$ be a formula.
Let~$\psi :\equiv \varphi^\Box$ be the~$\Box$-translation of~$\varphi$.
Let~$\psi'$ be the formula obtained from~$\psi$ by substituting any occuring
domain of quantification by its~$\Box$-sheafification. Then~$\psi$
and~$\psi'$ are equivalent.
\end{lemma}
\begin{proof}
For any formula~$\varphi$, we denote by~``$\varphi^\boxplus$'' the result of
first applying the~$\Box$-translation to~$\varphi$ and then substituting any
set~$F$ occuring in~$\varphi$ as a domain of quantification by the plus
construction~$F^+$. Recall that for any such~$F$ there is a canonical map~$F
\to F^+,\ x \mapsto [\{x\}]$. We are going to show by induction that for any
formula~$\varphi(x_1,\ldots,x_n)$ in which elements~$x_i\?F_i$ may occur as
terms, it holds that~$\varphi^\Box(x_1,\ldots,x_n)$ is equivalent
to~$\varphi^\boxplus([\{x_1\}],\ldots,[\{x_n\}])$. This suffices to prove the
lemma.

The cases for
\[ \top \quad \bot \quad \wedge \quad \bigwedge \quad \vee \quad \bigvee \quad \implies \]
are trivial. The cases for unbounded~``$\forall$'' and~``$\exists$'' are
trivial as well. The case for~``$=$'' is slightly more interesting; let~$\varphi(x,y)
\equiv (x = y)$. Then we are to show that~$\varphi^\Box(x,y) \equiv \Box(x=y)$
(equality in some set~$F$) is equivalent to~$\varphi^\boxplus([\{x\}],[\{y\}])
\equiv \Box([\{x\}] = [\{y\}])$ (equality in~$F^+$). This follows by the
definition of the plus construction. The case for~``$\in$'' is similar.

Let~$\varphi \equiv (\exists x\?F\_ \psi(x))$, where we have dropped further
variables occuring in~$\psi$ for simplicity. Then we are to show
that~$\varphi^\Box \equiv \Box(\exists x\?F\_ \psi^\Box(x))$ is equivalent
to~$\varphi^\boxplus \equiv \Box(\exists \bar x\?F^+\_ \psi^\boxplus(\bar x))$.
The ``only if'' direction is trivial (set~$\bar x := [\{x\}]$). For the ``if''
direction, we may assume that there exists~$\bar x\?F^+$ such
that~$\psi^\boxplus(\bar x)$, since we want to prove a boxed statement. By
definition of the plus construction, it holds that~$\Box(\speak{$\bar x$ is a
singleton})$. So, again since we want to prove a boxed statement, we may assume
that~$\bar x$ is actually a singleton. Therefore there exists~$x\?F$ such
that~$\bar x = [\{x\}]$ and that~$\psi^\boxplus([\{x\})$ holds. By the induction
hypothesis, it follows that~$\psi^\Box(x)$. From this the claim follows.

The case for~``$\forall$'' is similar.
\end{proof}

\begin{ex}\label{ex:translation-equivalence}Let~$X$ be a scheme. Let~$f$ be
global functions on~$X$. Let~$\varphi :\equiv \neg(\speak{$f$ \inv})$
and~$\varphi' :\equiv \speak{$f$ nilpotent}$. Then, by proposition~\ref{prop:cond-zero}, we
have~$\Sh(X) \models (\varphi \Leftrightarrow \varphi')$. But in general, this
does not imply that~$\Sh(X) \models (\varphi^\Box \Leftrightarrow
(\varphi')^\Box)$. Consider for instance the modal operator given by~$\Box\alpha
:\equiv ((\alpha \Rightarrow \notat{x}) \Rightarrow \notat{x})$ associated to a
point~$x \in X$. Then~$\Sh(X) \models (\varphi^\Box \Leftrightarrow
(\varphi')^\Box)$ means that the equivalence~$\varphi \Leftrightarrow \varphi'$
holds at the point~$x$. This is false for~$X = \Spec \ZZ$,~$f = 2$, and~$x =
(2)$, since in the local ring~$\O_{X,x} = \ZZ_{(2)}$, the element $f$ is not invertible
while also not being nilpotent.
\end{ex}


\subsection{Internal proofs of common lemmas}

\begin{lemma}\label{lemma:module-zero-point-neighbourhood}
Let~$X$ be a scheme (or ringed space). Let~$\F$ be an~$\O_X$-module
of finite type.
\begin{itemize}
\item Let~$x \in X$ be a point. Then the stalk~$\F_x$ is zero if and
only if~$\F$ is zero on some open neighbourhood of~$x$.
\item Let~$A \subseteq X$ be a closed subset. Then the restriction~$\F|_A$ (\ie
the pullback of~$\F$ to~$A$) is zero if and only if~$\F$ is zero on some open
subset of~$X$ containing~$A$.
\end{itemize}
\end{lemma}
\begin{proof}\emph{Both} statements are simply internalizations of
example~\ref{ex:module-zero-geometric}, using the modal operators~$\Box =
(\placeholder \vee A^c)$ and~$\Box = ((\placeholder \Rightarrow
\notat{x}) \Rightarrow \notat{x})$.
\end{proof}

\begin{rem}Note that the proposition fails if one drops the hypothesis
that~$\F$ is of finite type. Indeed, in this case one cannot reformulate the
condition that~$\F$ is zero in a geometric way.\end{rem}

In a remark after the proof of proposition~\ref{prop:rank-function-internally},
we promised to present a simpler proof once we have developed the theory for
doing so. We can now follow up on this promise.
\begin{lemma}\label{lemma:gen-family-n}
Let~$X$ be a scheme (or ringed space). Let~$\F$ be an~$\O_X$-module
of finite type. Let~$x \in X$ be a point. Let~$n$ be a natural number. Then the
following statements are equivalent:
\begin{enumerate}
\item There exists a generating family for~$\F_x$ consisting of~$n$ elements.
\item There exists an open neighbourhood~$U$ of~$x$ such that
\[ U \models \speak{there exists a generating family for~$\F$ consisting of~$n$
elements}. \]
\end{enumerate}
\end{lemma}
\begin{proof}Using the modal operator~$\Box$ defined by~$\Box\varphi :\equiv
((\varphi \Rightarrow \notat{x}) \Rightarrow \notat{x})$, we have to show that
the following statements in the internal language are equivalent:
\begin{enumerate}
\item $\speak{there exists a generating family
for~$\F$ consisting of~$n$ elements}^\Box$.
\item $\Box(\speak{there exists a generating family
for~$\F$ consisting of~$n$ elements})$.
\end{enumerate}
By lemma~\ref{lemma:open-stalk}, the second statement implies the first -- note
that in a formal spelling of the statement in quotes,
\begin{equation}
  \tag{$\star$}
  \exists x_1,\ldots,x_n\?\F\_
  \forall x\?\F\_
  \exists a_1,\ldots,a_n\?\O_X\_
  x = \textstyle\sum_i a_i x_i,
\end{equation}
no implication signs occur. To show the converse direction,
we may assume that there is a generating family~$y_1,\ldots,y_m\?\F$ for~$\F$
(since~$\F$ is, externally speaking, of finite type). Then
the~$\Box$-translation of the statement that the~$y_i$ generate~$\F$ holds as
well (again by lemma~\ref{lemma:open-stalk}). Since there is an intuitionistic
proof of
\begin{multline*}
  \speak{$y_1,\ldots,y_m$ generate~$\F$} \Longrightarrow \\
  \bigl(\speak{there exist $x_1,\ldots,x_n\?\F$ which generate~$\F$}
    \Longleftrightarrow \\
    \exists x_1,\ldots,x_n\?\F\_
    \exists A\?\O^{m \times n}\_ \speak{$\vec y = A \vec x$}\bigr),
\end{multline*}
we can substitute the non-geometric formula~$(\star)$ by the geometric
formula
\[ \exists x_1,\ldots,x_n\?\F\_ \exists A\?\O^{m \times n}\_ \speak{$\vec
y = A \vec x$} \]
(lemma~\ref{lemma:stalk-open-with-hypothesis}). Thus the claim follows.
\end{proof}

\begin{lemma}Let~$X$ be a scheme (or ringed space). Let~$\alpha : \F \to \G$ be
a morphism of~$\O_X$-modules. Let~$\G$ be of finite type and assume
that~$\alpha_x : \F_x \to \G_x$ is surjective for some point~$x \in X$.
Then~$\alpha$ is an epimorphism on some open neighbourhood of~$x$.\end{lemma}
\begin{proof}In the presence of generators~$y_1,\ldots,y_n\?\G$, the
non-geometric surjectivity condition ($\forall y\?\G\_ \exists x\?\F\_
\alpha(x) = y$) can be reformulated in a geometric way: $\bigwedge_{i=1}^n
\exists x\?\F\_ \alpha(x) = y_i$. Thus the claim follows by
lemma~\ref{lemma:stalk-open-with-hypothesis}.\end{proof}

\begin{lemma}Let~$X$ be a scheme (or ringed space). Let~$\alpha : \F \to \G$ be
a morphism of~$\O_X$-modules. Let~$\F$ be of finite type and~$\G$ be coherent.
Suppose that~$\alpha_x$ is injective at some point~$x \in X$. Then~$\alpha$ is
a monomorphism on some open neighbourhood of~$x$.
\end{lemma}
\begin{proof}The kernel of~$\alpha$ is of finite type (by
lemma~\ref{lemma:coherent-stuff}) and zero at~$x$. By the previous lemma, it is
therefore zero on some open neighbourhood of~$x$.
\end{proof}

\begin{lemma}Let~$i : A \hookrightarrow X$ be a closed immersion of schemes (or
ringed spaces). Let~$\F$ be an~$\O_A$-module. Then~$i_*\F$ is of finite type if
and only if~$\F$ is of finite type.\end{lemma}
\begin{proof}
Let~$\Box$ be the modal operator defined by~$\Box\varphi :\equiv (\varphi \vee
A^c)$. From the internal perspective, we have a surjective ring homomorphism~$i^\sharp
: \O_X \to \O_A$, where we omit the forgetful functor~$i_*$ from~$\Box$-sheaves
to arbitrary sets in the notation, and an~$\O_A$-module~$\F$. Furthermore, we
may assume that~$\F$ is a~$\Box$-sheaf. We can regard~$\F$ as an~$\O_X$-module
by~$i^\sharp$.

Note that~$A^c \Rightarrow (\F = 0)$, by~$\Box$-separatedness of~$\F$.

We are to show that~$\F$ is a finitely generated~$\O_X$-module if and only if
the~$\Box$-translation of ``$\F$ is a finitely generated~$\O_A$-module'' holds.
In explicit terms, we have to show the equivalence of the following statements:
\begin{enumerate}
\item $\bigvee_{n \geq 0} \exists x_1,\ldots,x_n\?\F\_
  \forall x\?\F\_ \exists a_1,\ldots,a_n\?\O_X\_ x = \sum_i i^\sharp(a_i) x_i$.
\item $\Box(\bigvee_{n \geq 0} \Box(\exists x_1,\ldots,x_n\?\F\_
  \forall x\?\F\_ \Box(\exists b_1,\ldots,b_n\?\O_A\_ \Box(
    x = \sum_i b_i x_i))))$.
\end{enumerate}
It is clear that the first statement implies the second. For the converse
direction, we just have to repeatedly use the observation that~$\Box\varphi$
implies~$\varphi \vee (\F = 0)$ (once for each occurence of~$\Box$). So in each
step, we either obtain the statement we want or may assume
that~$\F$ is the trivial module, in which case any subclaim trivially follows. By
surjectivity of~$i^\sharp$, we may write any~$b\?\O_A$ as~$b =
i^\sharp(a)$ for some~$a\?\O_X$.
\end{proof}

\begin{lemma}Let~$X$ be a scheme (or a ringed space). Let~$\F$ and~$\G$ be~$\O_X$-modules. Let~$x
\in X$. Then $\HOM_{\O_X}(\F,\G)_x \cong \Hom_{\O_{X,x}}(\F_x,\G_x)$ if~$\F$ is
of finite presentation around~$x$.\end{lemma}
\begin{proof}It suffices to give an intuitionistic proof of the following fact:
The construction~$\Hom_R(M,\placeholder)$ is geometric if~$M$ is a finitely
presented~$R$-module. So assume that~$M$ is the cokernel of a presentation
matrix~$(a_{ij}) \? R^{n \times m}$. Then we can calculate the Hom with
any~$R$-module~$N$ as
\[ \Hom_R(M,N) \cong \Bigl\{ x \? N^n \ \Big|\ \bigwedge_{j=1}^m \sum_{i=1}^n a_{ij}
x_i = 0 \? N \Bigr\}, \]
and this construction is patently geometric (set comprehension with respect to
a geometric formula).
\end{proof}

\begin{lemma}Let~$X$ be a scheme (or a ringed space). Let~$\F$ be an~$\O_X$-module of finite
presentation. Let~$x \in X$. Then the stalk~$\F_x$ is a finite
free~$\O_{X,x}$-module if and only if~$\F$ is finite locally free on some open
neighbourhood of~$x$.\end{lemma}
\begin{proof}The internal statement that~$\F$ is a finite free module is not geometric:
\[ \bigvee_{n \geq 0}
  \exists x_1,\ldots,x_n\?\F\_
  \forall x\?\F\_
  \exists! a_1,\ldots,a_n\?\O_X\_
  x = \textstyle\sum_i a_i x_i. \]
But it can equivalently be reformulated as
\[ \bigvee_{n \geq 0}
  \exists \alpha\?\HOM_{\O_X}(\F,\O_X^n)\_
  \exists \beta\?\HOM_{\O_X}(\O_X^n,\F)\_
  \alpha \circ \beta = \id \wedge \beta \circ \alpha = \id. \]
This reformulation is geometric, therefore it holds at~$x$ if and only if it
holds on some open neighbourhood of~$x$. The claim follows since, by the
previous proposition, taking stalks commutes with
calculating~$\HOM_{\O_X}(\F,\placeholder)$ \resp~$\HOM_{\O_X}(\O_X^n,\placeholder)$;
thus the pulled back formula indeed expresses that~$\F_x$ is finite free as
an~$\O_{X,x}$-module.
\end{proof}

\XXX{Find proper place for the following lemma.}
\XXX{Also, generalize to arbitrary schemes.}
\begin{lemma}\label{lemma:dense-standard-reflection}
Let~$X$ be an integral scheme. Let~$\varphi$ be any formula
over~$X$. Then
\[ \Sh(X) \models \neg\neg\varphi \Longrightarrow \exists f\?\O_X\_
  \neg\neg(\speak{$f$ \inv}) \wedge (\speak{$f$ \inv} \Rightarrow \varphi). \]
\end{lemma}
\begin{proof}We may assume that~$X$ is the spectrum of an integral domain~$A$
and that there is a dense open subset~$U \subseteq X$ on which~$\varphi$ holds.
The open set~$U$ may be covered by standard open subsets~$D(f_i)$; by the
integrality hypothesis, at least one of these is nonempty and thus itself
dense. We may take this~$f_i$ as the required~$f$.
\end{proof}

\begin{lemma}Let~$X$ be an integral scheme with generic point~$\xi$. Let~$\F$
be a quasicoherent~$\O_X$-module. Then~$\F$ is a torsion module if and only if
its generic stalk~$\F_\xi$ vanishes.
\end{lemma}
\begin{proof}The generic stalk vanishes if and only if the internal
statement~``$(\F = 0)^{\neg\neg}$'' holds. Therefore it suffices to give an
intuitionistic proof of the following internal statement: The module~$\F$ is
torsion if and only if any element of~$\F$ is \notnot zero.

For the ``only if'' direction, let~$x\?\F$ be an arbitrary element. Since~$\F$
is a torsion module, there exists a regular element~$a\?\O_X$ such that~$ax =
0$. Since~$X$ is reduced, regularity is equivalent to not-not-invertibility.
Since we want to verify the~$\neg\neg$-stable statement~``$\neg\neg(x = 0)$'', we
may in fact assume that~$a$ is invertible. Then~$x = 0$ obviously follows.

For the ``if'' direction, let~$x\?\F$ be an arbitrary element; by assumption,~$x$
is \notnot zero. Since~$X$ is integral,
lemma~\ref{lemma:dense-standard-reflection} is applicable. Therefore there
exists an element~$a\?\O_X$ such that~$a$ is \notnot invertible and such that
invertibility of~$a$ implies~$x = 0$. Since~$\F$ is quasicoherent, for some
natural number~$n$ it holds that~$a^n x = 0$ (theorem~\ref{thm:qcoh-sheafchar}). Since~$a$ is \notnot invertible,
it is regular (lemma~\ref{lemma:regular-notnot-invertible}), and therefore~$a^n$ is regular. So~$x \in \F_\tors$.
\end{proof}

\begin{itemize}
\item general explanation of modalities (as for instance in philosophy)
\item explain that for some modal operators, the~$\Box$-translation of the law
of excluded middle is valid; explain consequences
\item spreading of properties from stalk to neighbourhood: give many examples
\item give proof of the expressions for the nuclei listed in the table
\end{itemize}


\section{Rational functions and Cartier divisors}
\label{sect:rational-functions}

\subsection{The sheaf of rational functions} Recall that the sheaf~$\K_X$ of rational
functions on a scheme~$X$ (or ringed space) can be defined as the sheaf
associated to the presheaf
\[ \text{$U \subseteq X$ open} \quad\longmapsto\quad \Gamma(U,\O_X)[\Gamma(U,\S)^{-1}], \]
where~$\Gamma(U,\S)$ is the multiplicative set of those sections of~$\O_X$ on~$U$,
which are regular in each stalk~$\O_{X,x}$, $x \in U$. Recall also that there are
some wrong definitions in the literature~\cite{kleiman:misconceptions}.

Using the internal language, we can give a simpler definition of~$\K_X$.
Recall that we can associate to any ring~$R$ its total quotient ring, \ie
its localization at the multiplicative subset of regular elements. Since from
the internal perspective~$\O_X$ is an ordinary ring, we can associate to it its
total quotient ring $\O_X[\S^{-1}]$,
where~$\S$ is internally defined by the formula
\[ \S := \{ s\?\O_X \,|\, \speak{$s$ is regular} \} \subseteq \O_X. \]
Externally, this ring is the sheaf~$\K_X$.
\begin{prop}\label{prop:kx-internally}
Let~$X$ be a scheme (or a ringed space). The sheaf of rings defined
in the internal language by localizing~$\O_X$ at its set of regular elements is
(canonically isomorphic to) the sheaf~$\K_X$ of rational functions.
\end{prop}
\begin{proof}Internally, the ring~$\O_X[\S^{-1}]$ has the following
universal property: For any ring~$R$ and any homomorphism~$\O_X \to R$ which
maps the elements of~$\S$ to units, there exists exactly one
homomorphism~$\O_X[\S^{-1}] \to R$ which renders the evident diagram commutative.
\[ \xymatrix{
  \O_X \ar[rr] \ar[dr] && R \\
  & \O_X[\S^{-1}] \ar@{-->}[ru]
} \]
The translation using the Kripke--Joyal semantics gives the following universal
property: For any open subset~$U \subseteq X$, any sheaf of rings~$\R$ on~$U$ and any
homomorphism~$\O_X|_U \to \R$ which maps all elements of~$\Gamma(V,\S)$, $V
\subseteq U$ to units, there exists exactly one homomorphism~$\O_X[\S^{-1}]|_U \to
\R$ which renders the evident diagram commutative.
It is well-known that the sheaf~$\K_X$ as usually defined has
this universal property as well.
\end{proof}

\begin{prop}\label{prop:stalks-kx}
Let~$X$ be a scheme (or ringed space). Then the stalks of~$\K_X$
are given by
\[ \K_{X,x} = \O_{X,x}[\S_x^{-1}]. \]
The elements of~$\S_x$ are exactly the germs of those local sections which are
regular not only in~$\O_{X,x}$, but in all rings~$\O_{X,y}$ where~$y$
ranges over some open neighbourhood of~$x$ (depending on the section).\end{prop}
\begin{proof}
Since localization is a geometric construction, the first statement is made entirely
trivial by our framework. The second statement follows since
\[ \Gamma(U,\S) = \{ s\in\Gamma(U,\O_X) \,|\, U \models \speak{$s$ is regular}
\} \]
and regularity is a geometric implication, so that
$U \models \speak{$s$ is regular}$ if and only if the germ~$s_y$ is regular
in~$\O_{X,y}$ for all~$y \in U$.
\end{proof}

\begin{rem}Speaking internally, the multiplicative set~$\S$ is saturated.
Therefore an element~$s/t \? \K_X$ is invertible in~$\K_X$ if and only if the
numerator~$s$ belongs to~$\S$, \ie is an regular element of~$\O_X$.\end{rem}


\subsection{Regularity of local functions}
It is well known that on a locally Noetherian scheme, regularity spreads from
stalks to neighbourhoods, \ie a section of~$\O_X$ is regular
in~$\O_{X,x}$ if and only if it is regular on some open neighbourhood of~$x$.
This fact has a simple proof in the internal language.
\begin{prop}\label{prop:regularity-spreading}
Let~$X$ be a locally Noetherian scheme. Let~$s \in \Gamma(U,\O_X)$
be a local function on~$X$. Let~$x \in U$. Then the following statements are
equivalent:
\begin{enumerate}
\item The section~$s$ is regular in~$\O_{X,x}$.
\item The section~$s$ is regular in all local rings~$\O_{X,y}$ where~$y$ ranges
over some open neighbourhood of~$x$.
\end{enumerate}
\end{prop}
\begin{proof}
Let~$\Box$ be the modal operator defined by~$\Box\varphi :\equiv ((\varphi
\Rightarrow {!x}) \Rightarrow {!x})$. By corollary~\ref{cor:spreading}, we are
to show that the following statements of the internal language are equivalent:
\begin{enumerate}
\item $(\speak{$s$ is regular})^\Box$, \ie
$\forall t\?\O_X\_ st = 0 \Rightarrow \Box(t = 0)$.
\item $\Box(\speak{$s$ is regular})$, \ie
$\Box(\forall t\?\O_X\_ st = 0 \Rightarrow t = 0)$.
\end{enumerate}
It is clear that the second statement implies the first -- in fact, this is true
without any assumptions on~$X$: Let~$t\?\O_X$ be such that~$st = 0$. Since we want to
prove the boxed statement~$\Box(t=0)$, we may assume that~$s$ is regular and
prove~$t = 0$. This is immediate. (This direction also follows simply by
examining the logical form and applying lemma~\ref{lemma:open-stalk}.)

For the converse direction, consider the annihilator of~$s$, \ie the ideal
\[ I := \Ann_{\O_X}(s) = \{ t\?\O_X \,|\, st = 0 \} \subseteq \O_X. \]
This ideal satisfies the quasicoherence condition (example~\ref{ex:annihilator-qcoh}),
thus~$I$ is a quasicoherent submodule of a finitely generated module. Since~$X$ is
locally Noetherian, it follows that~$I$ is finitely generated as well, say by~$x_1,\ldots,x_n \? I$. By
assumption, each generator~$x_i \? I$ fulfills~$\Box(x_i = 0)$. Since we want
to prove a boxed statement, we may in fact assume~$x_i = 0$. Thus~$I = (0)$ and
the assertion that~$s$ is regular follows.
\end{proof}

Note that the proof critically depends on the ideal~$I$ being finitely
generated, since a modal operator need only commute with finite
conjuctions. Intuitively, each time we use the modus ponens rule~$\Box\varphi \wedge
(\varphi \Rightarrow \psi) \Rightarrow \Box\psi$, we restrict to a smaller open
neighbourhood of~$x$. Since infinite intersections of open sets need not be
open, we cannot expect an infinitary modus ponens rule to hold.

\begin{cor}Let~$X$ be a locally Noetherian scheme. Then the stalks~$\K_{X,x}$
of the sheaf of rational functions are given by the total quotient rings of the
local rings~$\O_{X,x}$.\end{cor}
\begin{proof}Combine proposition~\ref{prop:stalks-kx} and
proposition~\ref{prop:regularity-spreading}.\end{proof}


\subsection{Normality}\label{sect:normality}
Recall that a ring~$R$ is \emph{normal} if and only if
it is integrally closed in its total quotient ring. Recall also that a
scheme~$X$ (or ringed space) is \emph{normal} if and only if all
rings~$\O_{X,x}$ are normal.

\begin{prop}A locally Noetherian scheme is normal if and only if the
ring~$\O_X$ is normal from the internal perspective.\end{prop}
\begin{proof}The condition of normality can be put into a form which is almost
a geometric implication:
\begin{multline*}
  \forall s,t\?\O_X\_
  \Bigl(\speak{$t$ regular} \wedge
  (\exists a_0,\ldots,a_{n-1}\?\O_X\_
  s^n + a_{n-1} t s^{n-1} + \cdots + a_1 t^{n-1} s + a_0 t^n = 0)
  \Longrightarrow \\
  \exists u\?\O_X\_ s = ut\Bigr).
\end{multline*}
The only non-geometric subpart is the condition on~$t$ to be regular. However,
by proposition~\ref{prop:regularity-spreading}, for the purposes of comparing
its truth at points \vs on neighbourhoods, it behaves just like a geometric
formula. Therefore the claim follows.
\end{proof}


\subsection{Geometric interpretation of rational functions} Recall that on
integral schemes, rational functions (\ie sections of~$\K_X$) are the same
thing as regular functions defined on dense open subsets. This amounts to
saying that~\emph{$\K_X$ is the~$\neg\neg$-sheafification of~$\O_X$}
(see proposition~\ref{prop:negneg-sheaves}). We want to rederive this result,
as far as possible in the internal language, and generalize it to arbitrary
(not necessarily locally Noetherian) schemes.

\begin{lemma}\label{lemma:regular-notnot-invertible}Let~$X$ be a reduced scheme. Then:
\begin{enumerate}
\item $\O_X$ is~$\neg\neg$-separated.
\item Internally, an element~$s\?\O_X$ is regular
if and only if it is \notnot invertible.
\end{enumerate}
\end{lemma}
\begin{proof}Recall from corollary~\ref{cor:field-reduced} that
\begin{equation}\label{eqn:field-condition}
  \Sh(X) \models \forall s\?\O_X\_ \neg(\speak{$s$ invertible}) \Leftrightarrow
  s=0.
\end{equation}
From this we can deduce that~$\O_X$ is~$\neg\neg$-separated:
Assume~$\neg\neg(s=0)$ for~$s\?\O_X$. If~$s$ were invertible, we would
have~$\neg\neg(1=0)$ and thus~$\bot$. Therefore~$s$ is not invertible and thus
zero.

For the ``only if'' direction of the second statement,
note that a regular element is not zero (if it were, then the true statement~$0
\cdot 0 = 0 \cdot 1$ would imply the false statement~$0 = 1$) and thus \notnot
invertible (by the contrapositive of equivalence~\eqref{eqn:field-condition}). For the ``if''
direction, let~$st = 0$ in~$\O_X$. Since~$s$ is \notnot invertible, it follows
that~$t$ is \notnot zero. Since~$\O_X$ is~$\neg\neg$-separated, this implies
that~$t$ really is zero.
\end{proof}

\begin{prop}
\label{prop:kx-is-negneg-sheafification}
Let~$X$ be a reduced scheme. Then~$\K_X$ is
the~$\neg\neg$-sheafification of~$\O_X$.\end{prop}
\begin{proof}
We first show that~$\K_X$ is~$\neg\neg$-separated,
so assume~$\neg\neg(a/s = 0)$ for~$a/s \? \K_X$. Since~$\K_X$ is obtained
from~$\O_X$ by localizing at regular elements, it holds that~$a/s = 0$
in~$\K_X$ if and only if~$a = 0$ in~$\O_X$. Thus it follows that~$\neg\neg(a =
0)$ in~$\O_X$ and therefore~$a = 0$ in~$\O_X$; in particular, $a/s = 0$ in~$\K_X$.

We defer the proof that~$\K_X$ is a~$\neg\neg$-sheaf to the end and first
verify the universal property of~$\neg\neg$-sheafification.
% grammar?
So let~$G$ be a~$\neg\neg$-sheaf and let~$\alpha : \O_X \to G$ be a map. We
can define an extension~$\bar\alpha : \K_X \to G$ in the following way:
Let~$f \? \K_X$. Define the subsingleton~$S := \{ x \? G \,|\, \exists
b\?\O_X\_ f = b/1 \wedge x = \alpha(b) \} \subseteq G$. Since~$f$ can be
written in the form~$a/s$ with~$s$ \notnot invertible, it follows that~$S$
is \notnot inhabited. Since~$G$ is a~$\neg\neg$-sheaf, there exists a
unique~$x\?G$ such that~$\neg\neg(x \in S)$. We declare~$\bar\alpha(f)$ to be
this~$x$. It is straightforward to check that the composition~$\O_X \to \K_X
\to G$ equals~$\alpha$ and that~$\bar\alpha$ is unique with this property.

Up to this point, the proof did not need that~$X$ is a scheme -- it was enough
for~$X$ to be a ringed space such that equivalence~\eqref{eqn:field-condition} holds and
such that~$\neg(0 = 1)$ in~$\O_X$. Only now, in showing that~$\K_X$ is
a~$\neg\neg$-sheaf, the scheme condition enters. To this end, we first
reformulate the sheaf condition in a way such that it only refers to~$\O_X$,
not~$\K_X$: The quotient ring~$\K_X$ is a~$\neg\neg$-sheaf if and only if
\begin{multline*}
  \Sh(X) \models \forall T \subseteq \O_X\_
  \speak{$T$ subsingleton} \wedge \neg\neg(\speak{$T$ inhabited})
  \Longrightarrow \\
  \exists a,b\?\O_X\_ \speak{$b$ regular} \wedge \neg\neg(b^{-1} a \in T).
\end{multline*}
This is done just as in the proof of theorem~\ref{thm:qcoh-sheafchar}. Note
that~``$b^{-1}$'' refers to the inverse of~$b$ which indeed exists in a doubly
negated context, since~$b$ is assumed regular. More explicitly, we should write
\[ \neg\neg(\exists c\?\O_X\_ bc = 1 \wedge ca \in T)
  \quad\text{instead of}\quad
  \neg\neg(b^{-1} a \in T). \]
To prove the Kripke--Joyal interpretation of the rewritten sheaf condition, let
an affine open subset~$U = \Spec A \subseteq X$ and a subsheaf~$T
\hookrightarrow \O_X|_U$ be given, such that~$T$ is internally a subsingleton
and \notnot inhabited. We may thus glue the unique germs in the inhabited
stalks of~$T$ to obtain a section~$s \in \Gamma(V,\O_X)$ where~$V \subseteq U$
is a dense open subset. We may write~$V = \bigcup_i D(f_i)$ for some (possibly
infinitely many) functions~$f_i \in A$. Since~$V$ is dense in~$U$, these have the
property that
\[ \forall g \in A\_
  (\forall i\_ \text{$f_i g$ nilpotent in $A$}) \Longrightarrow
  \text{$g$ nilpotent in $A$}. \]
Since~$\Gamma(V,\O_X) = A[S_V^{-1}]$ with~$S_V = \{ x \in A \,|\, \text{$f_i
\in \sqrt{(x)}$ for all~$i$} \}$, we can write~$s = a/b$ with~$a,b \in A$
and~$f_i^{n_i} = c_i b$ for some~$c_i \in A$, $n_i \geq 0$.
\XXX{$\Gamma(V,\O_X) = A[S_V^{-1}]$ is wrong.}

The function~$b$ is a regular element of~$A$: Let~$bg = 0$ for~$g \in A$.
Then~$c_i b g = f_i^{n_i} g = 0 \in A$. Thus~$f_i g$ is
nilpotent in~$A$. Since this holds for any~$i$,~$g$ is nilpotent in~$A$.
Since~$A$ is reduced,~$g$ is in fact zero.

By lemma~\ref{lemma:regular-affine}, the function~$b$ is also regular as an
element of~$\O_X$ from the internal point of view. Note that~$b$ is invertible
on~$V$, since~$V \subseteq D(b)$. It follows that on the dense
open subset~$V \subseteq U$, the sections~$s$ and~$b^{-1} a$ agree.
This observation concludes the proof.
\end{proof}

\begin{cor}Let~$X$ be a reduced scheme. Then~$\K_X$ is the result of
pulling back~$\O_X$ to the sublocale~$X_{\neg\neg}$ and then pushing forward
again. If~$X$ is irreducible with generic point~$\xi$, then~$\K_X$ is the
constant sheaf associated to the set~$\O_{X,\xi}$.\end{cor}
\begin{proof}Recall from section~\ref{sect:internal-sheaves} that pulling back
to~$X_{\neg\neg}$ is equivalent to sheafifying with respect to the double
negation modality; and that pushing forward is equivalent to forgetting the
sheaf property. Therefore the first statement holds.

For the second statement, recall from lemma~\ref{lemma:negneg-generic-point} that the
sublocale~$X_{\neg\neg}$ is given by the subspace~$\{\xi\}$; that the
sheafification functor~$\Sh(X) \to \Sh(\{\xi\}) \simeq \Set$ is given by
calculating the stalk at~$\xi$; and that the inclusion functor~$\Set \simeq
\Sh(\{\xi\}) \hookrightarrow \Sh(X)$ is given by the constant sheaf
construction.
\end{proof}
\XXX{maybe reorder qcoh before this}

If~$X$ is a general scheme (not necessarily integral, reduced, or locally
Noetherian), we can describe~$\K_X$ in a similar way as the sheafification
of~$\O_X$; specifically, it is the sheafification with respect to the modal
operator defined by
\[ \Box\varphi :\equiv \speak{$\O_X$ is~$(\varphi \Rightarrow
\placeholder)$-separated} \]
in the internal language of~$\Sh(X)$.

\begin{prop}\label{prop:kx-is-box-sheafification}
Let~$X$ be a ringed space. Then:
\begin{enumerate}
\item The operator~$\Box$ fulfills the axioms on a modal operator.
\item $\O_X$ is~$\Box$-separated.
\item $\K_X$ is~$\Box$-separated.
\item Internally, it holds that~$\Box(\speak{$f$ \inv})$ implies that~$f$ is
regular for any~$f\?\O_X$.
% update addtocounter below if numbering changes
\end{enumerate}
Suppose furthermore that~$X$ is a scheme. Then:
\begin{enumerate}
\addtocounter{enumi}{4}
\item The converse in~(4) holds.
\item $\K_X$ is the~$\Box$-sheafification of~$\O_X$.
\end{enumerate}
\end{prop}
\begin{proof}The first four properties are entirely formal; we thus skip over
some details. For the first property, we verify the second axiom on a modal
operator. So we assume~$\Box\Box\varphi$ and have to show~$\Box\varphi$. To
this end, let~$s\?\O_X$ be arbitrary such that~$\varphi \Rightarrow (s=0)$; we
have to prove that~$s = 0$. If~$\O_X$ were separated with respect to the modal
operator~$(\varphi \Rightarrow \placeholder)$, it would follow that~$s = 0$. So
unconditionally it holds that~$\Box\varphi \Rightarrow (s=0)$. Since by
assumption~$\O_X$ is~$\Box\varphi$-separated, the claim follows.

For the second property, let~$s\?\O_X$ be arbitrary such that~$\Box(s = 0)$.
Obviously it holds that~$(s = 0) \Rightarrow (s = 0)$. Thus, since~$\O_X$ is
separated with respect to~$((s = 0) \Rightarrow \placeholder)$, it follows
that~$s = 0$. The proof of the third property is similar.

For the fourth property, assume~$\Box(\speak{$f$ \inv})$ and let~$h\?\O_X$ be
arbitrary such that~$fh = 0$. Then, trivially, it holds that~$\speak{$f$ \inv}
\Rightarrow h = 0$. Since~$\O_X$ is separated with respect to~$(\speak{$f$
\inv} \Rightarrow \placeholder)$, it follows that~$h = 0$.

We may now suppose that~$X$ is a scheme. To verify the fifth property, let a
regular function~$f\?\O_X$ be given. We have to show that~$\O_X$ is separated
with respect to the modality~$(\speak{$f$ \inv} \Rightarrow \placeholder)$. So
assume that~$\speak{$f$ \inv} \Rightarrow (s = 0)$ for some~$s\?\O_X$. By
proposition~\ref{prop:cond-zero}, it follows that~$f^n s = 0$ for some natural
number~$n$. Since~$f$ is regular, it follows that~$s = 0$.

The verification of the universal property of~$\K_X$ is done analogously as in
the case that~$X$ is reduced: For the proof of
proposition~\ref{prop:kx-is-negneg-sheafification}, it was critical that
regular elements of~$\O_X$ are \notnot invertible. We now need (and have) that
regular elements of~$\O_X$ are~$\Box(\speak{invertible})$.

Thus it only remains to verify that~$\K_X$ is a~$\Box$-sheaf. We may again imitate
the proof of proposition~\ref{prop:kx-is-negneg-sheafification}; using the same
notation, we may now suppose that~$V$ is an open subset such that~$U \models \Box
V$ (previously, we supposed that~$U \models \neg\neg V$). The proof that the
denominator~$b$ is regular (as seen from the internal perspective, as an
element of~$\O_X$) now goes as follows: We have~$V \subseteq
D(b)$. Thus~$U \models \Box V$ implies~$U \models \Box(\speak{$f$ \inv})$. By
the fourth property, it follows that~$U \models \speak{$f$ is regular}$.
\end{proof}

\begin{rem}The modal operator~$\Box$ is the largest (weakest) operator such
that~$\O_X$ is~$\Box$-separated, \ie if~$\Box'$ is any modal operator
such that~$\O_X$ is~$\Box'$-separated, then~$\Box'\varphi
\Rightarrow \Box\varphi$ for any proposition~$\varphi$.\end{rem}

In the special case that~$X$ is a reduced scheme,
proposition~\ref{prop:kx-is-box-sheafification} recovers
the result of proposition~\ref{prop:kx-is-negneg-sheafification}.

\begin{prop}Let~$X$ be a reduced scheme. Then the modal operator~$\Box$
coincides with the double negation modality.\end{prop}
\begin{proof}We show that from the internal point of view,~$\Box\varphi$ is
equivalent to~$\neg\neg\varphi$ for any formula~$\varphi$. For the ``only if''
direction, note that~$\neg\varphi$ is equivalent to~$\varphi \Rightarrow (1 =
0)$. Since by assumption~$\O_X$ is separated with respect to the~$(\varphi
\Rightarrow \placeholder)$-modality, this in turn is equivalent to~$1 = 0 \?
\O_X$, \ie to~$\bot$. Thus~$\neg\neg\varphi$.

For the ``if'' direction, let~$\varphi \Rightarrow (s = 0)$ for some~$s\?\O_X$;
we have to show that in fact~$s = 0$. Since by assumption~$\neg\neg\varphi$, it
follows that~$s$ is \notnot zero. Since~$X$ is reduced,~$\O_X$
is~$\neg\neg$-separated, so this implies that~$s$ is really zero.
\end{proof}

\begin{cor}Let~$X$ be a scheme. Then~$\K_X$ is the result of
pulling back~$\O_X$ to the sublocale~$X_\Box$ associated to the modal
operator~$\Box$ and then pushing forward again. If~$X$ is locally Noetherian,
this sublocale is the subspace of associated points in~$X$.
\end{cor}

In formulas, the corollary says that the canonical map
\[ \K_X \longrightarrow i_* i^{-1} \O_X \]
is an isomorphism, where~$i : X_\Box \hookrightarrow X$ is the inclusion of
the sublocale~$X_\Box$. This result holds without any Noetherian hypotheses.
These are only needed if we want to describe~$X_\Box$ as a certain explicitly
given subspace.

\begin{proof}The first statement follows trivially by the results of
section~\ref{sect:internal-sheaves} and the fact that~$\K_X$ is
the~$\Box$-sheafification of~$\O_X$.

For the second statement, we need to verify that the nucleus~$j_{\Ass(\O_X)}$
associated to the subspace of associated points coincides with the
nucleus~$j_\Box$ associated to the modal operator~$\Box$. Recall from
remark~\XXX{ref} that the former is defined by
\begin{align*}
  j_{\Ass(\O_X)}(U) &= \bigcup \{ V \subseteq X \,|\,
  \text{$V$ open},\ V \cap \Ass(\O_X) \subseteq U \} \\
\intertext{and recall from \XXX{ref} that the latter is given by}
  j_\Box(U) &= \text{largest open subset of~$X$ on which~$\Box U$ holds} \\
  &= \bigcup \{ V \subseteq X \,|\,
  \text{$V$ open},\ V \models \Box U \}.
\end{align*}
The equivalence thus follows from a standard result on the set of associated
points on locally Noetherian schemes:
\begin{align*}
  &\ V \cap \Ass(\O_X) \subseteq U \\
  \Longleftrightarrow&\
    \Ass(\O_V) \subseteq U \\
  \Longleftrightarrow&\
    \text{the canonical morphism~$\O_V \to i_* \O_{U \cap V}$
    (with $i : U \cap V \hookrightarrow V$) is injective} \\
  &\qquad\qquad\text{(this steps requires the Noetherian assumption)} \\
  \Longleftrightarrow&\
    V \models \speak{$\O_X \to \O_X^{++}$ is injective} \\
  &\qquad\qquad\text{(where the plus construction is with respect to} \\
  &\qquad\qquad\text{the modality~$(U \Rightarrow \placeholder)$)} \\
  \Longleftrightarrow&\
    V \models \speak{$\O_X \to \O_X^{+}$ is injective} \\
  &\qquad\qquad\text{(by the factorization~$\O_X \to \O_X^{+} \to \O_X^{++}$)} \\
  \Longleftrightarrow&\
    V \models \speak{$\O_X$ is~$(U \Rightarrow \placeholder)$-separated} \\
  \Longleftrightarrow&\
    V \models \Box U. \qedhere
\end{align*}
\end{proof}

\XXX{explain that~$X \models \Box U$ means that~$U$ is scheme-theoretically
dense in~$X$. Give internal proof that scheme-theoretical denseness implies
topological denseness, and sometimes vice versa.}


\subsection{Cartier divisors} Let~$X$ be a scheme (or ringed space). Recall
that a \emph{Cartier divisor} on~$x$ is a global section of the sheaf of
groups~$\K_X^* / \O_X^*$. This sheaf can be constructed internally, with the
same notation: It is the quotient of the group of invertible elements of the
ring~$\K_X$ by the subgroup of invertible elements of the ring~$\O_X$. So an
arbitrary section of~$\K_X^*/\O_X^*$ is internally of the form~$[s/t]$
with~$s,t\?\O_X$ being regular elements; this is a simpler description than the
usual external one (as a family~$(f_i)_i$ of functions~$f_i \in
\Gamma(U_i,\K_X^*)$ such that~$f_i^{-1}|_{U_i \cap U_j} \cdot f_j|_{U_i \cap
U_j} \in \Gamma(U_i \cap U_j, \O_X^*)$ for all~$i,j$).

We can sketch the basic theory of Cartier divisors completely from the internal
perspective. In accordance with common practice, we write the group
operation of~$\K_X^*/\O_X^*$ (which is induced by multiplication of elements
in~$\K_X^*$) additively.

\begin{defn}\label{defn:effective-cartier-divisor}
A Cartier divisor is \emph{effective} if and only if, from the
internal perspective, it can be written in the form~$[s/1]$ with~$s\?\O_X$
being a regular element.\end{defn}

Thus a Cartier divisor~$[s/t]$ is effective if and only if~$s$ is
an~$\O_X$-multiple of~$t$.

\begin{defn}A Cartier divisor~$D$ is \emph{principal} if and only if there
exists a global section~$f \in \Gamma(X,\K_X^*)$ such that internally,~$D = [f]$.
Two Cartier divisors are \emph{linearly equivalent} if and only if their
difference is a principal divisor.
\end{defn}

Note that decidedly, principality is a global notion: For \emph{any} divisor~$D$ it is
true that locally there exists sections~$f$ of~$\K_X^*$ such that~$D = [f]$.

\begin{defn}\label{defn:line-bundle-of-divisor}
The \emph{line bundle associated to a Cartier divisor}~$D$
is the~$\O_X$-submodule
\[ \O_X(D) := \{ g \in \K_X \,|\, g D \in \O_X \} = D^{-1} \O_X \subseteq \K_X
\]
of~$\K_X$. Here we are abusing language for~``$gD \in \O_X$'' to mean that~$gf
\in \O_X$ if~$D = [f]$ with~$f\?\K_X$; and for~``$D^{-1} \O_X$'' to
mean~$f^{-1}\O_X$. This condition \resp submodule does not depend on the
representative~$f$, since~$f$ is well-defined up to multiplication by an element
of~$\O_X^*$.\end{defn}

The submodule~$\O_X(D)$ is indeed locally free of rank~$1$, since
internally~$f^{-1}$ gives an one-element basis. Note that~$D$ is effective if
and only if~$\O_X(-D)$ is a subset of~$\O_X$ from the internal perspective
(this comparison makes sense, since~$\O_X(-D)$ and~$\O_X$ are both canonically
embedded in~$\K_X$). In
this case, we can define the \emph{support} of~$D$ to be the closed subscheme
of~$X$ associated to the sheaf of ideals~$\O_X(-D) \subseteq \O_X$.

%\begin{prop}Let~$D$ be an effective divisor on~$X$. Then~$\O_X(D)$ is trivial
%outside of the support of~$D$.\end{prop}
%\begin{proof}We have to show that~$\O_X(D)|_U$ is trivial on~$U := X \setminus
%V(\O_X(-D)) = \{ x \in X \,|\, 1 \in \O_X(-D) \}$. We do this by verifying ...
%D = [f], f : O_X regular. O_X(-D) = (f).
%Assume 1 in O_X(-D): Then f is invertible. Obviously O_X(-D) --> O_X
%is an isomorphism. So O_X --> O_X(D) is as well.
%\end{proof}

\begin{defn}The \emph{Cartier divisor associated to a free submodule~$\L \subseteq
\K_X$ of rank~1} is~$D := [f^{-1}]$, where~$f\?\K_X$ is the unique element of
some one-element-basis of~$\L$.\end{defn}

The basis element~$f\?\K_X$ does indeed lie in~$\K_X^*$: Write~$f
= s/t$ with~$s,t \? \O_X$. It suffices to show that~$s$ is a regular element
of~$\O_X$. So let~$h\?\O_X$ such that~$sh = 0$ in~$\O_X$. Then in
particular~$hf = 0$ in~$\K_X$. By linear independence, it follows that~$h = 0$
in~$\K_X$ and thus~$h = 0$ in~$\O_X$.

Furthermore, the associated divisor does not depend on the choice of~$f$,
since~$f$ is well-defined up to multiplication by an element of~$\O_X^*$: If~$f
\O_X = g \O_X \subseteq \K_X$, then there exist~$u,v\?\O_X$ such that~$fu = g$
and~$gv = f$ in~$\K_X$. It follows that~$uv = fuvf^{-1} = gvf^{-1} = ff^{-1} =
1$ in~$\K_X$ and thus in~$\O_X$, by injectivity of the canonical map~$\O_X \to
\K_X$. Therefore~$u$ and~$v$ are elements of~$\O_X^*$.

\begin{lemma}Let~$D$ and~$D'$ be divisors on~$X$. Then~$\O_X(D) \otimes_{\O_X}
\O_X(D') \cong \O_X(D + D')$.\end{lemma}
\begin{proof}The wanted morphism of sheaves~$\O_X(D) \otimes \O_X(D') \to
\O_X(D + D')$ is given by multiplication. That this is well-defined and an
isomorphism can be checked from the internal point of view, where the claims
are obvious.\end{proof}

\begin{prop}The association~$D \mapsto \O_X(D)$ defines an one-to-one
correspondence between Cartier divisors on~$X$ and rank-one submodules
of~$\K_X$. This correpondence descends to an one-to-one correspondence between
Cartier divisiors up to linear equivalance and rank-one submodules of~$\K_X$ up
to isomorphism (as abstract~$\O_X$-modules, ignoring their embedding
into~$\K_X$).\end{prop}
\begin{proof}The first statement is obvious from the definitions. For the
second statement, it suffices to show that~$\O_X(D)$ is isomorphic to~$\O_X$ if
and only if~$D$ is principal. A given isomorphism~$\O_X \to \O_X(D)$ gives a
global section~$f \in \K_X^*$ (by considering the image of the unit element)
such that internally,~$D = [f^{-1}]$; this shows that~$D$ is principal. The
converse is similar.
\end{proof}

%\begin{rem}Locally principal subschemes (closed subschemes which are locally
%the vanishing subscheme of a regular section of~$\O_X$) up to isomorphisms of
%subschemes are in one-to-one correspondence with rank-1 submodules of~$\O_X$
%(see~\xxx{ref}). Thus locally principal subschemes (up to isomorphisms of abstract
%schemes) are in one-to-one correspondence with effective Cartier divisors (up
%to linear equivalence).\end{rem}
%\xxx{check this.}

\begin{prop}Assume that~$X$ is an integral scheme. Then any line bundle on~$X$
is (uncanonically) a submodule of~$\K_X$.\end{prop}
\begin{proof}Let~$\xi$ be the generic point of~$X$ and let~$\Box := \neg\neg$
denote the modal operator such that internal sheafification with respect
to~$\Box$ is the same as pulling back to~$\{\xi\}$ and then pushing forward
to~$X$ again (see section~\ref{sect:negneg-sheaves}). Let~$\L$ be a line bundle on~$X$. Since~$\L_\xi \cong
\O_{X,\xi}$ (uncanonically), there is some injection~$\L_\xi \to \K_{X,\xi}$;
this corresponds internally to an injection~$\L^{++} \to \K_X^{++}$.
Since~$\K_X$ is already a~$\Box$-sheaf (see
proposition~\ref{prop:kx-is-negneg-sheafification}) and~$\L$ is~$\Box$-separated
(being isomorphic to~$\O_X$), we have the global injection
\[ \L \lhra \L^{++} \lhra \K_X^{++} \stackrel{({\cong})^{-1}}{\longrightarrow} \K_X. \qedhere \]
\end{proof}

\begin{itemize}
\item on reduced schemes, $\K_X$ is the sheaf of meromorphic functions
\item show~$\K_X = j_*(\O_X)$?
\item divisor associated to rational sections
\item $X \setminus V$ is scheme-theoretically dense in $X$, if~$V$ is the
support of an effective Cartier divisor
\end{itemize}


\section{Compactness principles}
\label{sect:compactness}

As stated in the introduction, quasicompactness of a space can not be detected
by the internal language: There cannot exist a formula~$\varphi$ such that a
topological space is quasicompact if and only if~$\Sh(X) \models \varphi$,
since the latter is always a local property on~$X$ while quasicompactness is not.
However, quasicompactness can be characterized by a \emph{metaproperty} of the
internal language.

This result is best stated in a way which does not explicitly refer to a notion
of finiteness. So recall that quasicompactness of a topological space~$X$ can
be phrased in the following way: For any directed set~$I$ and any monotone
family~$(U_i)_{i \in I}$ of open subsets, if~$X = \bigcup_i U_i$ then~$X = U_i$
for some~$i \in I$. As usual, a \emph{directed set} is an inhabited partially
ordered set such that for any two elements, there exists a common upper bound.
A family~$(U_i)_{i \in I}$ is \emph{monotone} if and only if~$i \preceq j$
implies~$U_i \subseteq U_j$.

\begin{prop}Let~$X$ be a topological space. Then~$X$ is quasicompact if and
only if the internal language of~$\Sh(X)$ has the following metaproperty:
For any directed set~$I$ and any monotone family~$(\varphi_i)_{i \in I}$ of
formulas over~$X$,
\[ \Sh(X) \models \bigvee_{i \in I} \varphi_i
  \quad\text{implies}\quad
  \text{for some~$i \in I$, $\Sh(X) \models \varphi_i$}. \]
The monotonicity condition means that~$\Sh(X) \models (\varphi_i \Rightarrow
\varphi_j)$ for any~$i \preceq j$ in~$I$.
\end{prop}

Stated more succintly, a topological space~$X$ is quasicompact if and only
if~``$\Sh(X) \models$'' commutes with directed~``$\bigvee_{i \in I}$'''s.

\begin{proof}For the ``only if'' direction, let such a family of formulas be
given. Declare~$U_i$ to be the largest open subset of~$X$ where~$\varphi_i$
holds. Then by assumption, the~$U_i$ form a monotone family and cover~$X$. By
quasicompactness of~$X$, some single~$U_i$ covers~$X$ as well, such that the
corresponding formula~$\varphi_i$ holds on~$X$.

For the ``if'' direction, note that a monotone family~$(U_i)$ of open subsets
induces a monotone family of formulas by defining~$\varphi_i :\equiv U_i$. This
correspondence is such that~$\Sh(X) \models \bigvee_i \varphi_i$ holds if and
only if~$X = \bigcup_i U_i$ and such that~$\Sh(X) \models \varphi_i$ if and
only if~$X = U_i$. With these observations the claim is obvious.
\end{proof}

\XXX{formulate for locally constant index sheaves I as well.}

\begin{ex}\label{ex:nilpotency-directed}
Let~$X$ be a quasicompact scheme (or quasicompact ringed space).
Let~$f \in \Gamma(X,\O_X)$ be a global function. Endow the set of natural
numbers with the usual ordering. Then the family of formulas given by~$(f^n =
0)_{n \in \NN}$ is monotone. Thus, if it internally holds that~$f$ is
nilpotent, then~$f$ is nilpotent as an element of~$\Gamma(X,\O_X)$ as
well.\end{ex}

\begin{prop}Let~$X$ be a topological space. Let~$K \subseteq X$ be an open
subset which is \emph{locally quasicompact} in the sense that there exists an open
covering~$X = \bigcup_j U_j$ such that each~$K \cap U_j$ is quasicompact. Then the
internal language of~$\Sh(X)$ has the following metaproperty: For any
directed set~$I$ and monotone family~$(\varphi_i)_{i \in I}$ of formulas
over~$X$ it holds that
\[ \Sh(X) \models \bigl(K \Rightarrow \bigvee_i \varphi_i\bigr)
  \quad\text{implies}\quad
  \Sh(X) \models \bigvee_i (K \Rightarrow \varphi_i). \]
If additionally for any open subset~$V \subseteq X$ the set~$K \cap V$ is
locally quasicompact in~$V$, the following stronger and purely internal
statement holds:
\[ \Sh(X) \models \bigl(K \Rightarrow \bigvee_i \varphi_i\bigr)
  \Longrightarrow
  \bigvee_i (K \Rightarrow \varphi_i). \]
\end{prop}
\begin{proof}Assume that~$\Sh(X) \models (K \Rightarrow \bigvee_i \varphi_i)$.
This is equivalent to~$K \models \bigvee_i \varphi_i$. By the locality of the
internal language, it follows that~$K \cap U_j \models \bigvee_i \varphi_i$ for each~$j$.
Since~$K \cap U_j$ is quasicompact, it follows by the previous proposition that
there exists an index~$i_j \in I$ such that~$K \cap U_j \models \varphi_{i_j}$.
This is equivalent to~$U_j \models (K \Rightarrow \varphi_{i_j})$. In
particular, it holds that~$U_j \models \bigvee_i (K \Rightarrow \varphi_i)$.
Since this is true for any~$j$, it follows that~$X \models \bigvee_i (K
\Rightarrow \varphi_i)$, again by the locality of the internal language.

The second statement is a corollary of the first one.
\end{proof}

\begin{ex}Any retrocompact subset of a scheme is locally quasicompact in the
sense of the proposition.\end{ex}

\begin{ex}\label{ex:df-locally-compact}
Let~$X$ be a scheme and~$f \in \Gamma(X,\O_X)$ be a global function.
Then the open set~$D(f) = \{ x \in X \,|\, \text{$f_x$ is invertible in~$\O_{X,x}$}
\}$ is locally quasicompact in the sense of the proposition, even in the
stronger sense: Let~$V \subseteq X$ be any open set and consider a covering~$V = \bigcup_i
U_i$ by open affine subsets~$U_i = \Spec A_i$. Then~$D(f) \cap U_i \cong \Spec
A_i[f^{-1}]$ is quasicompact.\end{ex}

From this example, it will trivially follow that the nilradical~$\sqrt{(0)}
\subseteq \O_X$ of a scheme and indeed the radical of any quasicoherent ideal
sheaf is quasicoherent (example~\ref{ex:radical-qcoh}).

\begin{rem}In applications, the open set~$K$ of the proposition is often given
as the largest open subset on which some formula~$\psi$ holds. (For instance,
in the previous example,~$K$ was given by the formula~$\speak{$f$
is invertible in $\O_X$}$.)
Then the conclusion of the proposition is that \emph{assuming that~$\psi$ holds commutes
with directed disjunctions}.\end{rem}

A stronger condition on a topological space~$X$ than quasicompactness is
locality: A topological space is \emph{local} if and only if for any open
covering~$X = \bigcup_i U_i$ (not necessarily directed) a certain single~$U_i$
covers~$X$ as well. Locality has a similar characterization as a metaproperty
of~$\Sh(X)$:

\begin{prop}Let~$X$ be a topological space. Then~$X$ is local if and
only if the internal language of~$\Sh(X)$ has the following metaproperty:
For any set~$I$ and any family~$(\varphi_i)_{i \in I}$ of
formulas over~$X$, it holds that
\[ \Sh(X) \models \bigvee_{i \in I} \varphi_i
  \quad\text{implies}\quad
  \text{for some~$i \in I$, $\Sh(X) \models \varphi_i$}. \]
In this case, the internal language has additionally the following (weaker) metaproperty: For any
sheaf~$\F$ on~$X$ and any formula~$\varphi(s)$ containing a variable~$s\?\F$,
it holds that
\[ \Sh(X) \models \exists s\?\F\_ \varphi(s)
  \quad\text{implies}\quad
  \text{for some~$s \in \Gamma(X,\F)$, $\Sh(X) \models \varphi(s)$}. \]
\end{prop}
\begin{proof}The proof of the first part is very similar to the proof of the
previous proposition. For the ``only if'' direction of the second part, note
that the antecedent implies that there exist local section~$s_i \in
\Gamma(U_i,\F)$ such that~$U_i \models \varphi(s_i)$ for some open covering~$X
= \bigcup_i U_i$. By locality of~$X$, one such~$U_i$ suffices to cover~$X$; so
the corresponding section~$s_i$ is actually a global section and verifies~$X
\models \varphi(s_i)$.

For the converse direction, note that given a family~$(U_i)_{i \in I}$ of open
subsets, we can define a sheaf on~$X$ by the internal definition
\[ \F := \{ M \in \Omega \,|\, \bigvee_{i \in I} (M = U_i) \}. \]
Recall that~$\Omega$ is the object of truth values, internally defined as the
power set of~$1 := \{\star\}$ and that~``$M = U_i$'' is abuse of notation
and means~$M = \{ x \in 1 \,|\, U_i \}$.
\XXX{the global sections of $\F$ are not those which I expected! Is the claim
true?}
\end{proof}

\XXX{lead-in}

\begin{prop}\label{prop:irreducibility-internally}
A topological space~$X$ is irreducible if and only if the internal
language of~$\Sh(X)$ has the following metaproperty: For any
formulas~$\varphi$ and~$\psi$
\[ \Sh(X) \models \neg(\varphi \wedge \psi)
  \quad\text{implies}\quad
  \Sh(X) \models \neg\varphi \text{ or }
  \Sh(X) \models \neg\psi. \]
Furthermore, in this case the following internal logical principle holds:
\[ \Sh(X) \models \forall \alpha,\beta \in \Omega\_
  \neg(\alpha \wedge \beta) \Rightarrow (\neg\alpha \vee \neg\beta). \]
\end{prop}
\begin{proof}The statement ``$\Sh(X) \models \neg(\varphi \wedge \psi)$'' means
that~$U \cap V = \empty$, where~$U$ and~$V$ are the largest open subsets on
which~$\varphi$ respectively~$\psi$ hold. The disjunction ``$\Sh(X) \models
\neg\varphi$ or $\Sh(X) \models \neg\psi$ means that~$U = \empty$ or~$V =
\empty$.

Therefore, if~$X$ is irreducible, then the internal language has the claimed metaproperty. The converse
can be seen by instantiating~$\varphi$ and~$\psi$ with the formulas associated
to given open subsets having empty intersection. It then follows that one of
these formulas is false in the internal language; thus the associated subset is
empty.

The stated logical principle holds since open subsets of irreducible spaces are
irreducible.
\end{proof}


\subsection{Internal proofs of common lemmas}

\begin{lemma}Let~$X$ be an irreducible reduced scheme. Then all local
rings~$\O_{X,x}$ are integral domains.\end{lemma}
\begin{proof}It suffices to give a proof of the following statement: Let~$R$ be
a local ring such that elements which are not invertible are nilpotent. Further
assume that~$R$ is reduced. Then~$R$ is an integral domain in the weak sense.

This proof may, additionally to the rules of intuitionistic logic, use the
classical axiom given by proposition~\ref{prop:irreducibility-internally}.

So let arbitrary elements~$x,y \? R$ with~$xy = 0$ be given. Then it is not the
case that~$x$ and~$y$ are both invertible: If they were, their product~$xy$
would be invertible as well, contradicting~$1 \neq 0$. By the classicality
principle, it follows that~$x$ is not invertible or that~$y$ is not invertible.
Thus~$x$ or~$y$ is nilpotent and therefore zero.
\end{proof}


\begin{itemize}
\item basic lemmas: filtered colimits, flatness, \ldots
\end{itemize}


\section{Quasicoherent sheaves of modules}
\label{sect:qcoh}

Recall that an~$\O_X$-module~$\F$ on a ringed space~$X$ is \emph{quasicoherent}
if and only if there exists a covering of~$X$ by open subsets~$U$ such that on
each such~$U$, there exists an exact sequence
\[ (\O_X|_U)^J \longrightarrow (\O_X|_U)^I \longrightarrow \F|_U \longrightarrow 0 \]
of~$\O_X|_U$-modules, where~$I$ and~$J$ are arbitrary sets (which may depend
on~$U$).

If~$X$ is indeed a scheme, quasicoherence can also be characterized in
terms of inclusions of distinguished open subsets of affines:
An~$\O_X$-module~$\F$ is quasicoherent if and only if for any open affine
subscheme~$U = \Spec A$ of~$X$ and any function~$f \in A$, the canonical map
\[ \Gamma(U,\F)[f^{-1}] \longrightarrow \Gamma(D(f),\F),\
  \tfrac{s}{f^n} \longmapsto f^{-n} s|_{D(f)} \]
is an isomorphism of~$A[f^{-1}]$-modules. Here~$D(f) \subseteq U$ denotes the
standard open subset~$\{ \ppp \in \Spec A \,|\, f \not\in \ppp \}$. Both
conditions can be internalized.

\begin{prop}Let~$X$ be a ringed space. Let~$\F$ be an~$\O_X$-module. Then~$\F$
is quasicoherent if and only if
\[ \Sh(X) \models \exists I,J\ \mathrm{lc}\_ \speak{there exists an
  exact sequence~$\O_X^J \to \O_X^I \to \F \to 0$}. \]
The ``\textnormal{lc}'' indicates that when interpreting this internal statement with the
Kripke--Joyal semantics,~$I$ and~$J$ should only be instantiated with
\emph{locally constant} sheaves.
\end{prop}
\begin{proof} We only sketch the proof.
The translation of the internal statement is that there exists a covering
of~$X$ by open subsets~$U$ such that for each such~$U$, there exist sets~$I,J$
and an exact sequence
\[ (\O_X|_U)^{\ul{J}} \longrightarrow (\O_X|_U)^{\ul{I}} \longrightarrow \F|_U
\longrightarrow 0 \]
where~$\ul{I}$ and~$\ul{J}$ are the constant sheaves associated to~$I$
respectively~$J$. The term~``$(\O_X|_U)^{\ul{I}}$'' refers to the internally
defined free~$\O_X$-module with basis the elements of~$\ul{I}$. By exploiting
that~$\ul{I}$ is a discrete set from the internal point of view (\ie any two
elements are either equal or not), one can show that this is the same
as~$(\O_X|_U)^I$; similarly for~$J$. With this observation, the statement
follows.
\end{proof}

\begin{rem}The restriction to locally constant sheaves is really necessary: The
internal statement~$\Sh(X) \models \exists I,J\_ \speak{there exists an
exact sequence~$\O_X^J \to \O_X^I \to \F \to 0$}$ is true for
\emph{any}~$\O_X$-module~$\F$. This is because the usual proof of the fact that
any module admits a resolution by (not necessarily finite) free modules is
intuitionistically acceptable and thus also valid in the internal
universe.\end{rem}

At the moment, we do not know of any useful internal characterization of
locally constant sheaves. The internal condition given by the following
theorem does not need such a characterization.

\begin{thm}\label{thm:qcoh-sheafchar}
Let~$X$ be scheme. Let~$\F$ be an~$\O_X$-module. Then~$\F$ is
quasicoherent if and only if, from the internal perspective, for any~$f\?\O_X$,
the localized module~$\F[f^{-1}]$ is a sheaf for the modal operator~$(\speak{$f$ \inv}
\Rightarrow \placeholder)$.
\end{thm}

In detail, the internal condition is that for any~$f\?\O_X$, it holds that
\[ \forall s\?\F[f^{-1}]\_
  (\speak{$f$ \inv} \Rightarrow s = 0) \Longrightarrow s = 0 \]
and for any subsingleton~$\S \subseteq \F[f^{-1}]$ it holds that
\[ (\speak{$f$ \inv} \Rightarrow \speak{$\S$ inhabited}) \Longrightarrow
  \exists s\?\F[f^{-1}]\_
  (\speak{$f$ \inv} \Rightarrow s \in \S). \]
Unlike with the internalizations of finite type, finite presentation and
coherence, this condition is \emph{not} a standard condition of commutative
algebra. In fact, in classical logic, this condition is always satisfied --
for trivial logical reasons if~$f$ is invertible, and because~$\F[f^{-1}]$ is
the zero module if~$f$ is not invertible (since then, it is nilpotent).

That this condition in not known in commutative algebra is to be expected:
Quasicoherence is a condition on sheaves of modules, ensuring
that they are locally isomorphic to sheaves of the form~$M^\sim$,
where~$M$ is a plain module. But in commutative algebra, one \emph{only} studies plain
modules (and not sheaves of modules). The quasicoherence condition is imported
into the realm of commutative algebra only by the internal language.

We give the proof of the theorem below, after first discussing some examples
and consequences. The proof will explain the origin of this condition.

\begin{ex}The zero~$\O_X$-module is quasicoherent, since (it and) all
localizations of it are singleton sets from the internal perspective and
thus~$\Box$-sheaves for any modal operator~$\Box$
(example~\ref{ex:special-sets-sheaves}).\end{ex}

\begin{cor}Let~$X$ be a scheme. Let~$\F$ be a quasicoherent~$\O_X$-module.
Let~$\G \subseteq \F$ be a submodule. Then~$\G$ is quasicoherent if and only
if
\[ \Sh(X) \models \forall f\?\O_X\_
  \forall s\?\F\_
  (\speak{$f$ \inv} \Rightarrow s \in \G) \Longrightarrow
  \bigvee_{n \geq 0} f^n s \in \G. \]
\end{cor}
\begin{proof}We can give a purely internal proof. Let~$f\?\O_X$.
Since subpresheaves of separated sheaves are separated, the module~$\G[f^{-1}]$
is in any case separated with respect to the modal operator~$(\speak{$f$ \inv}
\Rightarrow \placeholder)$.

Now suppose that~$\G$ is quasicoherent. Let~$f\?\O_X$. Let $s\?\F$ and assume that
if~$f$ were invertible,~$s$ would be an element of~$\G$. Define the
subsingleton~$S := \{ t\?\G[f^{-1}] \,|\, \speak{$f$ \inv} \wedge t=s/1 \}$.
Then~$S$ would be inhabited by~$s/1$ if~$f$ were invertible. Since~$\G[f^{-1}]$
is a sheaf, it follows that there exists an element~$u/f^n$ of~$\G[f^{-1}]$
such that, if~$f$ were invertible, it would be the case that~$u/f^n = s/1 \in
\G[f^{-1}] \subseteq \F[f^{-1}]$.
Since~$\F[f^{-1}]$ is separated, it follows that it actually holds that~$u/f^n
= s/1 \in \F[f^{-1}]$. Therefore there exists~$m\?\NN$ such that $f^m f^n s =
f^m u \in \F$. Thus~$f^{m+n} s$ is an element of~$\G$.

For the converse direction, assume that~$\G$ fulfills the stated condition.
Let$f\?\O_X$. Let~$S \subseteq \G[f^{-1}]$ be a subsingleton which would be
inhabited if~$f$ were invertible. By regarding~$S$ as a subset of~$\F[f^{-1}]$,
it follows that there exists an element~$u/f^n \in \F[f^{-1}]$ such that,
if~$f$ were invertible, $u/f^n$ would be an element of~$S$. In particular,~$u$
would be an element of~$\G$. By assumption
it follows that there exists~$m\?\NN$ such that~$f^m u \in G$. Thus~$(f^m u) /
(f^m f^n)$ is an element of~$\G[f^{-1}]$ such that, if~$f$ were invertible, it
would be an element of~$S$.
\end{proof}

\begin{ex}\label{ex:annihilator-qcoh}
Let~$X$ be a scheme and~$s$ be a global section of~$\O_X$. Then the
annihilator of~$s$, \ie the sheaf of ideals internally defined by the
formula
\[ I := \Ann_{\O_X}(s) = \{ t\?\O_X \,|\, st = 0 \} \subseteq \O_X \]
is quasicoherent. To prove this in the internal language, it suffices to
verify the condition of the proposition.
So let~$f\?\O_X$ and~$t\?\O_X$ be arbitrary and assume~$\speak{$f$ \inv} \Rightarrow t \in I$,
\ie assume that if~$f$ were invertible,~$st$ would be zero. By
proposition~\ref{prop:cond-zero} it follows that~$f^n st = 0$ for
some~$n\?\NN$, \ie that~$f^n t \in I$.
\end{ex}

\begin{ex}\label{ex:radical-qcoh} Let~$X$ be a scheme and~$\I \subseteq \O_X$
be a quasicoherent ideal sheaf.  Then the radical of~$\I$, internally definable
as \[ \sqrt{\I} := \Bigl\{ s\?\O_X \,\Big|\, \bigvee_{n \geq 0} s^n \in \I \Bigr\}, \] is
quasicoherent as well: Let~$f\?\O_X$ and~$s\?\O_X$ be arbitrary and
assume~$\speak{$f$ \inv} \Rightarrow s \in \sqrt{\I}$, \ie assume that if~$f$
were invertible, some power~$s^n$ would be an element of~$\I$. Since
\emph{assuming that~$f$ is invertible commutes with directed disjunctions}
(example~\ref{ex:df-locally-compact}), it follows that for some natural
number~$n$, it holds that~$\speak{$f$ \inv} \Rightarrow s^n \in \I$. By
quasicoherence of~$\I$, we may deduce that for some natural number~$m$, it
holds that~$f^m s^n \in \I$. Thus~$fs \in \sqrt{\I}$.\end{ex}

\begin{prop}Let~$X$ be a scheme of dimension~$\leq 0$. Then any~$\O_X$-module
is quasicoherent.\end{prop}
\begin{proof}By corollary~\ref{cor:scheme-dimension-zero}, any
element~$f\?\O_X$ is invertible or nilpotent. Therefore the quasicoherence
condition of theorem~\ref{thm:qcoh-sheafchar} is for any~$\O_X$-module
trivially satisfied.
\end{proof}

\begin{rem}\label{rem:qcoh-in-constructive-mathematics}
In general intuitionistic mathematics -- not inside the internal universe of a
scheme -- the notion of quasicoherence as given by the internal condition of
theorem~\ref{thm:qcoh-sheafchar}
does not seem to be very interesting: For many important rings, there a few
quasicoherent modules in this sense. For instance, let~$M$ be a module over a
ring~$R$ such that every element of~$R$ is invertible or not invertible. (The
ring~$\ZZ$ is such a ring.) Then~$M$ is quasicoherent if and only if for any~$f
\? R$ which is not invertible, the localized module~$M[f^{-1}]$ is the zero
module, \ie any element of~$M$ is annihilated by some power~$f^n$. As a
concrete example, any~$\ZZ$-submodule of~$\ZZ$ which contains a nonzero element
fails to be quasicoherent.
\end{rem}

\begin{proof}[Proof of theorem~\ref{thm:qcoh-sheafchar}]
By the well-known characterization of quasicoherence in terms of inclusions of
distinguished open subsets, an~$\O_X$-module~$\F$ is quasicoherent if and only
if for any affine open subset~$U \subseteq X$ and any function~$f \in
\Gamma(U,\O_U)$, the canonical map
\begin{equation}\label{eqn:restr-map}
  \Gamma(U,\F)[f^{-1}] \lra \Gamma(D(f),\F), \ s/f^n \longmapsto
  f^{-n} s|_{D(f)}
\end{equation}
is bijective. We will see that this map is injective for all such~$U$ and~$f$
if and only if from the internal perspective, for any~$f\?\O_X$, the set~$\F[f^{-1}]$ is a
separated presheaf with respect to the modal operator~$(\speak{$f$ \inv}
\Rightarrow \placeholder)$; and we will see that in this
case, the map is additionally surjective for all such~$U$ and~$f$ if the full
sheaf condition is fulfilled.

Since the sheaf~$\F[f^{-1}]$ does not appear in the stated characterization, we
will first reformulate the separatedness and the sheaf condition in terms
of~$\F$ instead of~$\F[f^{-1}]$. To this end, note that the separatedness
condition is equivalent to
\begin{equation}\label{eqn:separated}
  \forall f\?\O_X\_ \forall s\?\F\_
  (\speak{$f$ \inv} \Rightarrow s = 0 \? \F) \Longrightarrow
  \bigvee_{n \geq 0} f^n s = 0 \? \F.
\end{equation}
The equivalence can easily be proven in the internal language. The sheaf
condition is equivalent to the conjunction of the separatedness condition and
\begin{multline}\label{eqn:sheaf}
  \forall f\?\O_X\_ \forall \K \subseteq \F\_
  (\speak{$f$ \inv} \Rightarrow \speak{$K$ is a singleton})
  \Longrightarrow \\
  \bigvee_{n \geq 0} \exists s\?\F\_
  \speak{$f$ \inv} \Rightarrow f^{-n} s \in \K.
\end{multline}
In one direction, a set~$\S \subseteq \F[f^{-1}]$ is given; construct~$K := \{
s\?\F \,|\, s/1 \in \S \} \subseteq \F$. In the other direction, a set~$\K
\subseteq \F$ is given; construct~$S := \{ s\?\F[f^{-1}] \,|\, \exists
s'\?\F\_ s' \in \K \wedge s = s'/1 \} \subseteq \F[f^{-1}]$. The remaining
details can easily be filled out.

We now interpret the internal statement~\eqref{eqn:separated} with the
Kripke--Joyal semantics. Using the simplification rules, the external meaning
is that for any affine open subset~$U \subseteq X$ and any function~$f \in
\Gamma(U,\O_U)$ the following condition is satisfied: For any section~$s \in
\Gamma(U,\F)$ it should hold that
\[ U \models (\speak{$f$ \inv} \Rightarrow s = 0) \quad\text{implies}\quad
  U \models \bigvee_{n \geq 0} f^n s = 0. \]
The antecedent is equivalent to saying that~$s$ is zero in~$\Gamma(D(f),\F)$.
The consequent is (by quasicompactness of~$U$, see
example~\ref{ex:nilpotency-directed}) equivalent to saying that for some~$n \geq 0$, the
section~$f^n s$ is zero in~$\Gamma(U,\F)$, \ie that~$s$ is zero
in~$\Gamma(U,\F)[f^{-1}]$. So this condition is precisely the injectivity of
the canonical map~\eqref{eqn:restr-map}.

The external meaning of statement~\eqref{eqn:sheaf} is that for any affine open
subset~$U \subseteq X$ and any function~$f \in \Gamma(U,\O_U)$ the following
condition is satisfied: For any subsheaf~$\K \subseteq \F|_U$ it should hold
that
\begin{multline*}
  U \models (\speak{$f$ \inv} \Rightarrow \speak{$\K$ is a singleton})
  \quad\text{implies} \\
  U \models \bigvee_{n \geq 0} \exists s\?\F\_
  \speak{$f$ \inv} \Rightarrow f^{-n} s \in \K.
\end{multline*}
Given the injectivity of the canonical map~\eqref{eqn:restr-map} (for any
affine open subset, not only~$U$), this condition is equivalent to its
surjectivity: To see that surjectivity is sufficient, let a subsheaf~$\K
\subseteq \F|_U$ verifying the antecedent be given. Since~$\K|_{D(f)}$ is a
singleton sheaf, we can consider its unique section~$u \in \Gamma(D(f),\K)
\subseteq \Gamma(D(f),\F)$. By surjectivity, there exists a preimage, \ie a
fraction~$s/f^n \in \Gamma(U,\F)[f^{-1}]$ such that~$u = f^{-n} s|_{D(f)}$
in~$\Gamma(D(f),\F)$. Thus~$U \models f^{-n}s \in \K$ holds and the consequent
is verified.

To see that surjectivity is necessary, let a section~$u \in \Gamma(D(f),\F)$ be
given. Define a subsheaf~$\K \subseteq \F|_U$ by setting~$\Gamma(V,\K) := \{
u|_V \,|\, V \subseteq D(f) \}$. Then~$\K$ verifies the antecedent. Thus the
consequent holds: There exists an open covering~$U = \bigcup_i U_i$ such that
for each~$i$, there exists a natural number~$n_i$ and a section~$s_i \in
\Gamma(U_i,\F)$ such that~$f^{-n_i} s_i = u$ on~$U_i \cap D(f)$. Without loss of
generality, we may assume that the~$U_i$ are distinguished open subsets~$D(g_i)
\subseteq U$; that they are finite in number; and that the natural
numbers~$n_i$ agree with each other and thus equal some number~$n$. Since~$s_i
= s_j$ in~$\Gamma(U_i \cap U_j \cap D(f), \F)$, injectivity of the canonical
map~\eqref{eqn:restr-map} (on the affine set~$U_i \cap U_j = D(g_i g_j)$)
implies that~$s_i = s_j$ in~$\Gamma(U_i \cap U_j, \F)[f^{-1}]$. Thus for
any~$i,j$ there exists a natural number~$m_{ij}$ such that~$f^{m_{ij}} s_i =
f^{m_{ij}} s_j$ in~$\Gamma(U_i \cap U_j, \F)$. We may assume that the
numbers~$m_{ij}$ equal some common number~$m$; thus the local sections~$f^m s_i$
glue to a section~$s \in \Gamma(U,\F)$. The sought preimage of~$u$ is the
fraction~$s/f^{n+m}$, since~$f^{-(n+m)} s|_{D(f)}$ equals~$u$
in~$\Gamma(D(f),\F)$ (as this is true on the covering~$D(f) = \bigcup_i (D(f)
\cap U_i)$).
\end{proof}
% XXX: Give simpler proof using Gamma(U, F[f^(-1)]) = Gamma(U, F)[f^(-1)];
% use that F[f^(-1)] is a filtered colimit.

\begin{itemize}
\item is the condition good enough to show that modules of finite type are
quasicoherent? To show that cokernels are quasicoherent?
\item discussion meaning of the sheaf condition in external language
\item give more examples: $(h)$, \ldots
\item Noetherian hypotheses: for example, that any quasicoherent submodule of a
module of finite type is of finite type as well
\end{itemize}


\section{Subschemes}

\subsection{Sheaves on open and closed subspaces} It is well-known that sheaves
defined on open or closed subspaces of a topological space~$X$ can be related
with certain sheaves on~$X$, by using appropriate extension functors. We can
define these functors and show their basic properties in the internal
language. Recall from section~\ref{sect:modalities-geometric-meaning} that we
have defined a formula~``$U$'' for any open subset~$U \subseteq X$ such that
$V \models U$ if and only if $V \subseteq U$.

\begin{lemma}\label{lemma:extension-by-empty-set}
Let~$X$ be a topological space. Let~$j : U \hookrightarrow X$ be the inclusion
of an open subspace. Then there is a canonical functor~$j_! : \Sh(U) \to
\Sh(X)$ called \emph{extension by the empty set} with the following properties:
\begin{enumerate}
\item The functor~$j_!$ is left adjoint to the restriction functor~$j^{-1} : \Sh(X) \to
\Sh(U)$.
\item The composition~$j^{-1} \circ j_! : \Sh(U) \to \Sh(U)$ is (canonically
isomorphic to) the identity.
\item The essential image of~$j_!$ consists of exactly those sheaves~$\F$ on~$X$
whose stalks are empty at all points of~$U^c$. In this case, it holds
that~$j_!j^{-1}\F \cong \F$ (canonically).
\end{enumerate}
\end{lemma}
\begin{proof}Internally, for a set~$\F$, we can define~$j_!(\F)$ simply be the
set comprehension
\[ j_!(\F) := \{ x\?\F \,|\, U \}. \]
Externally, the sections of the thusly defined sheaf on an open subset~$V
\subseteq X$ are given by~$\{ x \in \Gamma(V,\F) \,|\, V \subseteq U \}$,
\ie the whole of~$\Gamma(V,\F)$ if~$V \subseteq U$ and the empty set otherwise.
With this short internal description, all of the stated properties can be
easily verified in the internal language.

For instance, recall that internally the functor~$j^{-1}$ is given by
sheafifying with respect to the modal operator~$\Box :\equiv (U \Rightarrow
\placeholder)$. Thus, to show the second statement, we have to give a
bijection~$(j_!(\F))^{++} \to \F$ for any~$\Box$-sheaf~$\F$. (This map has to
be given explicitly, to not only show a weaker statement about a local
isomorphism -- see section~\ref{sect:internal-constructions}). To this end, we can use the composition
\[ (j_!(\F))^{++} \lhra \F^{++} \stackrel{({\cong})^{-1}}{\lra} \F, \]
where the first map is injective since sheafifying is exact. It is also
surjective, since the~$\Box$-translation of the statement~$\speak{$j_!(F) \to
\F$ is surjective}$ holds: For any element~$x\?\F$, it holds
that~$\Box(\speak{$x$ possesses a preimage})$.

For the third property, note that a sheaf~$\F$ on~$X$ fulfills the stated
condition on stalks if and only if, from the internal perspective, it holds
that~$U \Rightarrow \speak{$\F$ is inhabited}$. We omit further details.
\end{proof}

\begin{lemma}\label{lemma:extension-by-zero}
Let~$X$ be a ringed space. Let~$j : U \hookrightarrow X$ be the inclusion
of an open subspace. Then there is a canonical functor~$j_! : \Mod_U(\O_U) \to
\Mod_X(\O_X)$ called \emph{extension by zero} with the following properties:
\begin{enumerate}
\item The functor~$j_!$ is left adjoint to the restriction functor~$j^{-1} :
\Mod_X(\O_X) \to \Mod_U(\O_U)$.
\item The composition~$j^{-1} \circ j_! : \Mod_U(\O_U) \to \Mod_U(\O_U)$ is (canonically
isomorphic to) the identity.
\item The essential image of~$j_!$ consists of exactly those~$\O_X$-modules
whose stalks are zero at all points of~$U^c$. In this case, it holds
that~$j_!j^{-1}\F \cong \F$ (canonically).
\end{enumerate}
\end{lemma}
\begin{proof}Internally, a sheaf of modules on~$\O_U$ is simply a module
on~$\O_X^{++}$ which is a~$\Box$-sheaf, where~$\Box :\equiv (U \Rightarrow
\placeholder)$. The suitable internal definition for the extension by zero of
such a module~$\F$ is
\[ j_!(\F) := \{ x\?\F \,|\, (x = 0) \vee U \}. \]
With this description, all necessary verifications are easy. Note that
an~$\O_X$-module~$\F$ fulfills the stated condition on stalks if and only if
internally, it holds that~$\forall x\?\F\_ ((x = 0) \vee U)$.
\end{proof}

\begin{lemma}\label{lemma:essim-closed-immersion}
Let~$X$ be a topological space. Let~$i : A \hookrightarrow X$ be the inclusion
of a closed subspace. The essential image of the
inclusion~$i_* : \Sh(A) \to \Sh(X)$ consists of exactly those sheaves~$\F$ whose support
is a subset of~$A$. In this case, it holds that~$i_* i^{-1} \F \cong \F$
(canonically).\end{lemma}
\begin{proof}Recall that the modal operator associated to~$A$ is~$\Box\varphi
:\equiv (\varphi \vee A^c)$, and that by section~\ref{sect:internal-sheaves} the
essential image of~$i_*$ consists of exactly those sheaves which
are~$\Box$-sheaves from the internal perspective. Let~$\F$ be a sheaf on~$X$.
Then it holds that
\[ \supp\F \subseteq A \quad\Longleftrightarrow\quad
  A^c \subseteq X \setminus \supp\F \quad\Longleftrightarrow\quad
  A^c \subseteq \Int(X \setminus \supp\F). \]
Since the interior of the complement of~$\supp\F$ can be characterized as the
largest open subset of~$X$ on which the internal statement~``$\F$ is a
singleton'' holds (remark~\ref{rem:support-sheaf-of-sets}), the condition on
the support is fulfilled if and only if
\[ \Sh(X) \models (A^c \Rightarrow \speak{$\F$ is a singleton}). \]
We thus have to show that this internal condition is equivalent to~$\F$ being
a~$\Box$-sheaf. For the ``if'' direction, assume~$A^c$. Then the empty subset~$S
\subseteq \F$ trivially verifies the condition that~$\Box(\speak{$S$ is a
singleton})$. There thus exists an element~$x\?\F$ (such that~$\Box(x \in S)$).
If we're given a further element~$y\?\F$, it trivially holds that~$\Box(x =
y)$. By~$\Box$-separatedness, it thus follows that~$x = y$. Thus~$\F$ is the
singleton~$\{x\}$. The proof of the ``only if'' direction is similar.

The second statement says that internally, sheafifying a~$\Box$-sheaf with
respect to the modal operator~$\Box$ and then forgetting that the result is
a~$\Box$-sheaf amounts to doing nothing. This is obvious.
\end{proof}

\subsection{Closed subschemes} Let~$X$ be a ringed space. Recall
that an ideal sheaf~$\I \subseteq \O_X$ defines a closed subset~$V(\I) = \{ x
\in X \,|\, \I_x \neq (1) \subseteq \O_{X,x} \}$, a sheaf of
rings~$\O_X/\I$, and a ringed space~$(V(\I), \O_{V(\I)})$ where~$\O_{V(\I)}$ is
the pullback of~$\O_X/\I$ to~$V(\I)$. In the internal universe, we can
reify~$V(\I)$ by giving a modal operator~$\Box$ such that externally, the
subspace~$X_\Box$ coincides with~$V(\I)$.

\begin{prop}\label{prop:basics-closed-subspace}
Let~$X$ be a ringed space. Let~$\I \subseteq \O_X$ be an ideal
sheaf. Then:
\begin{enumerate}
\item The subspace of~$X$ associated to the modal operator~$\Box$ defined
by~$\Box\varphi :\equiv (\varphi \vee (1 \in \I))$ is~$V(\I)$.
\item The support of~$\O_X/\I$ is exactly~$V(\I)$.
\item The canonical morphism~$i : V(\I) \to X$ is a closed immersion
of ringed spaces.
\end{enumerate}\end{prop}
\begin{proof}For any open subset~$U \subseteq X$, it holds that~$U \models 1
\in \I$ if and only if~$U \subseteq D(\I) = X \setminus V(\I)$. Thus~$D(\I)$
can be characterized as the largest open subset on which~``$1 \in \I$'' holds.
According to table~\ref{table:nuclei} on page~\pageref{table:nuclei}, the
stated modal operator thus defines the subspace~$D(\I)^c$, \ie~$V(\I)$.

For the second statement, note that since~$\O_X/\I$ is a sheaf of rings, its
support is closed.  Therefore the largest open subset of~$X$ where the internal
statement~``$\O_X/\I = 0$'' holds is the complement of the support
(proposition~\ref{prop:characterization-support}). Since~$D(\I)$ is the largest
open subset where the internal statement~``$\I = (1)$'' holds, it suffices to
show that internally,~$\O_X/\I = 0$ if and only if~$\I = (1)$. This is obvious.

The topological part of the third statement is clear. For the ring-theoretic
part, we have to show that the canonical ring homomorphism~$\O_X \to i_*
\O_{V(\I)}$, that is the canonical projection~$\O_X \to \O_X/(\I)$, is an
epimorphism of sheaves. This is obvious.
\end{proof}

By lemma~\ref{lemma:essim-closed-immersion}, the sheaf~$\O_X/\I$ is
thus a~$\Box$-sheaf from the internal perspective.

\begin{prop}Let~$X$ be a locally ringed space. Let~$\I \subseteq \O_X$ be an
ideal sheaf. Then the ringed space~$(V(\I), \O_{V(\I)})$ is too locally
ringed.\end{prop}
\begin{proof}We have to show that
\[ \Sh(V(\I)) \models \speak{$\O_{V(\I)}$ is a local ring}. \]
By theorem~\ref{thm:box-translation-semantically}, this is equivalent to
\[ \Sh(X) \models (\speak{$\O_X/\I$ is a local ring})^\Box, \]
where~$\Box$ is the modal operator given by~$\Box\varphi :\equiv (\varphi \vee
(1 \in \I))$. We therefore have to give an intuitionistic proof of the fact
\[ \forall x,y\?\O_X/\I\_ \speak{$x+y$ \inv} \Longrightarrow
  \Box(\speak{$x$ \inv} \vee \speak{$y$ \inv}). \]
So let~$x = [s], y = [t] \? \O_X/\I$ such that~$x + y$ is invertible
in~$\O_X/\I$. This means that there exists~$u\?\O_X$ and~$v\?\I$ such that~$us
+ ut + v = 1$ in~$\O_X$. Since~$\O_X$ is a local ring, it follows
that~$us$,~$ut$, or~$v$ is invertible. In the first two cases, it follows
that~$x$ respectively~$y$ are invertible in~$\O_X/\I$. In the third case, it
follows that~$1 \in \I$ and thus any boxed statement is trivially true.
\end{proof}

If~$X$ is a scheme and~$\I \subseteq \O_X$ is an ideal sheaf, it is well-known
that the locally ringed space~$V(\I)$ is a scheme if and only if~$\I$ is
quasicoherent. We cannot give an internal proof of this fact since we lack an
internal characterization of being a scheme.

\begin{lemma}\label{lemma:closed-subspace-reduced}
Let~$X$ be a scheme (or ringed space). Let~$\I \subseteq \O_X$ be
an ideal sheaf. The ringed space~$V(\I)$ is reduced if and only if, from the
internal perspective of~$\Sh(X)$, the ideal~$\I$ is a radical ideal.\end{lemma}
\begin{proof}The following chain of equivalences holds:
\begin{align*}
  &\ \Sh(V(\I)) \models \speak{$\O_{V(\I)}$ is a reduced ring} \\
  \Longleftrightarrow&\
    \Sh(V(\I)) \models \bigwedge_{n \geq 0} \forall s\?\O_{V(\I)}\_
      s^n = 0 \Longrightarrow s = 0 \\
  \Longleftrightarrow&\
    \Sh(X) \models \bigl(\bigwedge_{n \geq 0} \forall s\?\O_X/\I\_ s^n = 0
    \Rightarrow s = 0\bigr)^\Box \\
  \Longleftrightarrow&\
    \Sh(X) \models \bigwedge_{n \geq 0} \forall s\?\O_X/\I\_ s^n = 0 \Rightarrow \Box(s = 0) \\
  \Longleftrightarrow&\
    \Sh(X) \models \bigwedge_{n \geq 0} \forall s\?\O_X\_ s^n \in \I
    \Rightarrow \Box(s \in \I) \\
  \Longleftrightarrow&\
    \Sh(X) \models \bigwedge_{n \geq 0} \forall s\?\O_X\_ s^n \in \I
    \Rightarrow s \in \I \\
  \Longleftrightarrow&\
    \Sh(X) \models \speak{$\I$ is a radical ideal}
\end{align*}
In the second-to-last step, we used that~$\Box(s \in \I) \equiv ((s \in \I) \vee
(1 \in \I))$ implies~$s \in \I$. This is trivial in both cases of the
disjunction.
\end{proof}

\begin{lemma}\label{lemma:reduced-subspace}
Let~$X$ be a scheme (or ringed space).
\begin{enumerate}
\item There exists a reduced closed sub-ringed space~$X_\mathrm{red}
\hookrightarrow X$ having the same underlying topological space as~$X$ with
the following universal property: Any morphism~$Y \to X$
of (ringed or locally ringed) spaces such that~$Y$ is reduced factors uniquely
over the closed immersion~$X_\mathrm{red} \hookrightarrow X$.
\item Let~$A \subseteq X$ be a closed subset. Then there exists a structure of
a reduced closed ringed subspace on~$A$ with a similar universal
property.
\end{enumerate}
\end{lemma}
\begin{proof}For the first statement, let~$\N \subseteq \O_X$ be the nilradical
of~$\O_X$. This can internally be simply defined by~$\N := \sqrt{(0)} = \{
s\?\O_X \,|\, \bigvee_{n \geq 0} s^n = 0 \}$. Define~$X_\mathrm{red}$ as the closed
subspace associated to this ideal sheaf. This ringed space is reduced by the
previous lemma. If~$X$ is a scheme, then quasicoherence of~$\N$ (which is
necessary and sufficient for~$X_\mathrm{red}$ to be a scheme) can be shown
internally (example~\ref{ex:radical-qcoh}).
The proof of the universal property can also be done in the
internal language, by using that the well-known fact of locale theory that the
category of locales over~$X$ is equivalent to internal locales in~$\Sh(X)$; but
we do not want to discuss this further.

For the second statement, internally define the ideal~$\I := \sqrt{\{ s\?\O_X \,|\, s = 0 \vee
A^c \}} \subseteq \O_X$. Then~$1 \in \I$ if and only if~$A^c$, thus by
proposition~\ref{prop:basics-closed-subspace} the closed ringed subspace defined
by~$\I$ has~$A$ as underlying topological space. It is reduced since~$\I$ is a
radical ideal. \XXX{is~$\I$ quasicoherent, if~$X$ is a scheme?}\end{proof}

\begin{lemma}Let~$X$ be a scheme of dimension~$\leq n$. Let~$V(\I)
\hookrightarrow X$ be a closed subscheme which is locally cut out by a regular
equation. Then~$\dim V(\I) \leq n-1$.\end{lemma}
\begin{proof}By proposition~\ref{prop:dimension-scheme-ox}, it suffices to give
an intuitionistic proof of the following fact of dimension theory: Let~$A$ be
an arbitrary ring of dimension~$\leq n$. Let~$I = (s) \subseteq A$ be an ideal
which is generated by a regular element~$s\?A$. Then the~$\Box$-translation
of~``$A/I$ is of dimension~$\leq n-1$'' holds. In fact, we can show that~$A/I$
really is of dimension~$\leq n-1$; since ``being of dimension~$\leq n-1$'' is a
geometric condition, lemma~\ref{lemma:open-stalk} is applicable and implies
that this a stronger statement.

For this, let a sequence~$([a_0],\ldots,[a_{n-1}])$ of elements in~$A/I$ be
given. We can lift and extend this sequence to the
sequence~$(a_0,\ldots,a_{n-1},s)$ of elements of~$A$. Since~$\dim A \leq n$,
there exists a complementary sequence~$(b_0,\ldots,b_{n-1},b_n)$.
Since~$s$ is regular, the inclusion~$\sqrt{(s b_n)} \subseteq \sqrt{(0)}$
given by the definition of complementarity implies that~$b_n$ is nilpotent.
Thus we have that~$\sqrt{(a_{n-1}b_{n-1})} \subseteq \sqrt{(s,b_n)} =
\sqrt{(s)}$ in~$A$, which translates to~$\sqrt{([a_{n-1}] [b_{n-1}])} \subseteq
\sqrt{(0)}$ in~$A/I$.  Therefore~$([b_0],\ldots,[b_{n-1}])$ is a complementary
sequence to~$([a_0],\ldots,[a_{n-1}])$ in~$A/I$.
\end{proof}

\begin{itemize}
\item open subschemes
\item Koszul resolution
\end{itemize}


\section{Relative spectrum}
\label{sect:relative-spectrum}

Recall that if~$\A$ is a quasicoherent~$\O_X$-algebra on a scheme~$X$, one can
construct the \emph{relative spectrum}~$\RelSpec{X}{\A}$ by appropriately
gluing the spectra~$\Spec \Gamma(U,\A)$ where~$U$ ranges over the affine opens
of~$X$. This relative spectrum comes equipped with a canonical
morphism~$\RelSpec{X}{\A} \to X$. We can give a simple construction of the
relative spectrum in the internal language of~$\Sh(X)$, imitating the usual
construction of the spectrum of a ring (as opposed to a sheaf of rings).

\subsection{Internal locales} Let~$X$ be a topological space (or a locale). A
fundamental fact in the theory of locales is that there is a canonical
equivalence between the category of \emph{locales over~$X$} -- that is
locales~$Y$ equipped with a morphism~$Y \to X$ -- and \emph{internal locales
in~$\Sh(X)$}~\cite[page~49]{johnstone:point}. An internal locale in a topos~$\E$ is given by an object~$L$ of~$\E$
(the internal lattice of opens of the locale) together with a binary
relation~$(\preceq) \hookrightarrow L \times L$ such that the axioms on a
locale hold from the internal point of view. (In these notes, we do not need a
precise wording of these axioms.)

The equivalence is described as follows: A locale~$f : Y \to X$ over~$X$
induces an internal locale~$I(Y)$ with object of opens given by~$\Open(I(Y)) :=
f_* \Omega_{\Sh(Y)} \in \Sh(X)$, where~$f_*$ is the pushforward functor
and~$\Omega_{\Sh(Y)}$ is the object of truth values in the topos of sheaves
on~$Y$. Conversely, an internal locale~$\L \in \Sh(X)$ induces an (external)
locale~$E(\L)$ with lattice of opens given by~$\Open(E(\L)) := \Gamma(X,\L)$.
This comes equipped with a canonical morphism~$Y \to X$ of locales which we do
not need to describe explicitly~\cite[section~C1.6]{johnstone:elephant}.

As a special case, the internalization of the trivial locale~$\id : X \to X$
over~$X$ has as lattice of opens the object~$\id_* \Omega_{\Sh(X)} =
\Omega_{\Sh(X)} = \P(1)$. This is precisely the lattice of opens of the
one-point space. Thus~$I(X) \cong \pt$. This illustrates the intuition
behind working internally in~$\Sh(X)$ very well: From the perspective
of~$\Sh(X)$, the space~$X$ looks like the one-point space (even if in fact it
is not).

One can associate to an internal locale~$L$ in a topos~$\E$ a topos of internal
sheaves on it:~$\Sh_\E(L)$. The correspondence is made in such a way that the topos of
sheaves on a locale~$Y$ over~$X$ is equivalent to the topos of sheaves on the
internal locale~$I(Y)$: $\Sh(Y) \simeq \Sh_{\Sh(X)}(I(Y))$.

There is no similarly nice correspondence between topological spaces
over~$X$ and internal topological spaces
in~$\Sh(X)$~\cite[corollary~C1.6.7]{johnstone:elephant}. This is one of the
reasons why locales are better suited for working internally and for switching
between internal and external perspectives.


\subsection{The spectrum of a ring as a locale} Recall that the spectrum
of a ring~$A$ is usually constructed as the set
\[ \Spec A := \{ \ppp \subseteq A \,|\,
  \text{$\ppp$ is a prime ideal} \} \]
endowed with a certain topology and a sheaf of rings~$\O_{\Spec A}$. From an
intuitionistic (and thus internal) point of view, this construction does not
work well: Prime ideals are intuitionistically much more elusive than
classically, where one can appeal to Zorn's lemma to obtain maximal (and thus
prime) ideals. More to the point, one can not show that this construction of
the spectrum as a topological space verifies the expected universal property.

On the other hand, the lattice of opens of~$\Spec A$ admits a simple
description not needing the notion of prime ideals:
\[ \Open(\Spec A) \cong \{ \aaa \subseteq A \,|\,
  \text{$\aaa$ is a radical ideal} \}. \]
An open subset~$U \subseteq \Spec A$ corresponds to the radical ideal~$\{ h \in
A \,|\, D(h) \subseteq U \}$ (so in particular, the open subset~$D(f)$
corresponds to the radical ideal~$\sqrt{(f)}$); conversely, a radical ideal~$\aaa$
corresponds to the open subset~$\bigcup_{h \in \aaa} D(h)$.

Thus, in an intuitionistic context, we will construct the spectrum of a ring~$A$
only as a locale, not as a topological space; we will use the lattice of
radical ideals as the lattice opens. This construction has the expected
universal property, namely that it is adjoint to the global sections functor:
\[ \Hom_{\LRL}(X, \Spec A) \cong \Hom_{\Ring}(A, \Gamma(X,\O_X)). \]
Here, ``$\LRL$'' refers to the category of \emph{locally ringed locales}, \ie
locales~$X$ equipped with a sheaf of rings~$\O_X$ such that from the internal point of
view of~$\Sh(X)$, the ring~$\O_X$ is a local ring. A morphism~$Y \to X$ of
locally ringed locales consists of a locale morphism~$f : Y \to X$ and a
morphism~$f^\sharp : f^{-1} \O_X \to \O_Y$ of sheaves of rings on~$Y$ such that, from the
internal point of view of~$\Sh(Y)$, the ring homomorphism~$f^\sharp$ is a local
homomorphism. The notion of a locally ringed locale is thus a straightforward
generalization of that of a locally ringed space.

The importance of a locale-theoretic approach to spectra of rings, especially in
relative situations, has also been stressed by Lurie~\cite[page~37]{lurie:dag5}.

For later use, we study the question when the spectrum is the one-point space.
The answer is well-known classically, but since we want to use this result in
an internal context, we have to give an intuitionistic proof.
\begin{lemma}\label{lemma:spectrum-one-point}
Let~$A$ be a ring with~$0 \neq 1$. Its spectrum is a one-point
space (as a locale) if and only if any element of~$A$ is nilpotent or
invertible.\end{lemma}
\begin{proof}The locale~$\Spec A$ is a one-point space if and only if the
canonical map
\[ \begin{array}{@{}rcl@{}}
  \Omega = \P(1) &\longrightarrow& \Open(\Spec A) \\[0.1em]
  \varphi &\longmapsto& \aaa_\varphi := \sup\{\sqrt{(1)} \,|\, \varphi \} =
  \{ x \? A \,|\, \speak{$x$ nilpotent} \vee \varphi \}
\end{array} \]
is bijective. It is always injective: If~$\aaa_\varphi = \aaa_\psi$,
then~$(1 \in \aaa_\varphi) \Leftrightarrow (1 \in \aaa_\psi)$. Since the unit
of~$A$ is not nilpotent, this amounts to~$\varphi \Leftrightarrow \psi$.

The map is surjective if and only if for any radical ideal~$\aaa \subseteq A$,
it holds that~$\aaa = \{ x \? A \,|\, \speak{$x$ nilpotent} \vee \varphi \}$
for some proposition~$\varphi$. By considering the condition~``$1 \in \aaa$'',
it follows that this proposition~$\varphi$ must be equivalent to the
proposition~``$1 \in \aaa$'' (if it is at all possible to write~$\aaa$ in such
a way).

So the map is surjective if and only if for any radical ideal~$\aaa \subseteq
A$ and any element~$x$ of~$A$ it holds that
\[ x \in \aaa \quad\Longleftrightarrow\quad
  \speak{$x$ nilpotent} \vee (1 \in \aaa). \]
The ``if'' direction always holds. If any element of~$A$ is nilpotent or
invertible, the ``only if'' direction holds as well (for any~$\aaa$ and any~$x$).
Considering the radical ideal~$\sqrt{(f)}$ for an element~$f \? A$, one
verifies that the converse holds as well.
\end{proof}


\subsection{The relative spectrum as an ordinary spectrum from the internal
point of view} Let~$X$ be a scheme and~$\A$ be a quasicoherent~$\O_X$-algebra.
Since~$\A$ looks like a plain algebra from the internal perspective
of~$\Sh(X)$, we can consider its internally defined spectrum. This is a locale
internal to~$\Sh(X)$; we might hope that its externalization is precisely the
relative spectrum of~$\A$ (considered as a locale):
\[ E(\Spec \A) \stackrel{?}{\cong} \RelSpec{X}{\A}. \]
However, this turns out to be too naive. The externalization of the internally
defined spectrum has the universal property
\begin{align*}
  \Hom_{\LRL/E(\Spec\O_X)}(Y, E(\Spec\A)) & \cong
  \Hom_{\LRL_{\Sh(X)}/\Spec\O_X}(I(Y), \Spec\A) \\
  & \cong \Hom_{\O_X}(\A, \mu_* \O_Y)
\end{align*}
for all locally ringed locales~$Y$ over~$E(\Spec\O_X)$. Here,~$\mu$ is the
structure morphism~$Y \to \Spec\O_X$; $E(\Spec\O_X)$ is the locally ringed
locale associated to the internally defined spectrum of~$\O_X$;
and~$\LRL_{\Sh(X)}$ is the category of locally ringed locales internal
to~$\Sh(X)$. However, the relative spectrum has the different universal property
\begin{align*}
  \Hom_{\LRL/X}(Y, \RelSpec{X}{\A}) & \cong
  \Hom_{\LRL_{\Sh(X)}/(\pt,\O_X)}(I(Y), I(\RelSpec{X}{\A})) \\
  & \cong \Hom_{\O_X}(\A, \mu_* \O_Y)
\end{align*}
for all locally ringed locales~$Y$ over~$X$. The crucial
difference is that in general, the internally defined locally ringed
locale~$\Spec\O_X$ does \emph{not} coincide with the internal locally ringed
locale~$(\pt,\O_X)$ (which is simply~$(X,\O_X)$ from the external point of
view). More succinctly, the functor~$E \circ \Spec$ is an adjoint to the
global sections functor~$\LRL/E(\Spec\O_X) \to \Alg(\O_X)^\op$, while the
relative spectrum functor is an adjoint to the global sections functor~$\LRL/X
\to \Alg(\O_X)^\op$.
\XXX{check details?}

The internal construction which correctly reflects the relative spectrum is the
following.
\begin{defn}Let~$A$ be an~$R$-algebra which is quasicoherent in the sense that
the condition given in theorem~\ref{thm:qcoh-sheafchar} is fulfilled. The
lattice of opens of its \emph{quasicoherent spectrum} is given by
\[ \Open(\QcohSpec{R}{A}) := \{ \aaa \subseteq A \,|\,
  \text{$\aaa$ is a quasicoherent radical ideal} \}, \]
where again ``quasicoherent'' is meant as in theorem~\ref{thm:qcoh-sheafchar}.
If this lattice fulfills the axioms on a locale, we further define a
structure sheaf on a base by
$\Gamma(\sqrt{(f)}, \O_{\QcohSpec{R}{A}}) := A[f^{-1}]$.
\end{defn}

\begin{prop}Let~$X$ be a scheme and~$\A$ a quasicoherent~$\O_X$-algebra. Then:
\begin{enumerate}
\item The internal lattice~$\Open(\QcohSpec{\O_X}{\A})$ fulfills the axioms on an
internal locale.
\item The externalization~$E(\QcohSpec{\O_X}{\A})$ coincides with the relative
spectrum~$\RelSpec{\O_X}{\A}$.
\end{enumerate}
\end{prop}
\begin{proof}We first show that the internalization~$I(\RelSpec{\O_X}{\A})$
coincides with the internal lattice~$\Open(\QcohSpec{\O_X}{\A})$. Both of these
objects are sheaves on~$X$; so to show that they are canonically isomorphic, it
suffices to give compatible canonical isomorphisms on the base of~$X$
consisting of all affine opens. On such an open~$U = \Spec R$, the
quasicoherent algebra~$\A$ is given by a tilde construction:~$\A|_U =
S^{\sim}$ for some~$R$-algebra~$S$. Thus it holds that
\begin{align*}
  \Gamma(U, I(\RelSpec{\O_X}{\A})) &\cong
  \Open(\RelSpec{\O_X}{(\A)} \times_X U) \\
  & \cong
  \Open(\RelSpec{\O_X|_U}{\A|_U}) \\
  & \cong
  \Open(\Spec S) \\
  & \cong
  \{ \aaa \subseteq S \,|\, \text{$\aaa$ is a radical ideal} \}, \\
  \Gamma(U, \Open(\QcohSpec{\O_X}{\A})) &\cong
  \{ \I \hookrightarrow \A|_U \ |\ \text{$\I$ is a quasicoherent radical ideal sheaf} \}.
\end{align*}
Clearly, these lattices are isomorphic (by~$\aaa \mapsto \aaa^\sim$ and~$\I
\mapsto \Gamma(U,\I)$).

This is already enough to prove the claims: By a general lemma of locale
theory~\cite[discussion before proposition~C1.6.1]{johnstone:elephant},
the internal lattice~$\Open(\QcohSpec{\O_X}{\A})$ defines an internal locale
(as the pushforward under~$\RelSpec{\O_X}{\A} \to X$ of a locale), and its
externalization coincides with~$\RelSpec{\O_X}{\A}$.
\end{proof}

There is also a general spectrum functor by Gillam~\cite{gillam:localization}
which works for arbitrary~$\O_X$-algebras (instead of only quasicoherent
ones). It coincides with the relative spectrum construction (and thus the
externalization of the internal quasicoherent spectrum) on
quasicoherent~$\O_X$-algebras. Furthermore, there is a general spectrum
construction by Hakim~\cite{hakim:relative-schemes}, sending ringed toposes to
locally ringed toposes. We hope to study its relationship with the internal
spectrum construction in the future; it may turn out that they coincide.

\begin{prop}Let~$X$ be a scheme. Then~$E(\Spec\O_X) \cong X$ as locales
over~$X$ if and only if~$X$ is the empty scheme or~$X$ has dimension zero.\end{prop}
\begin{proof}The externalization of~$\Spec\O_X$ coincides with~$X$ if and only
if from the internal point of view, the locale~$\Spec\O_X$ coincides with the
one-point locale. By interpreting lemma~\ref{lemma:spectrum-one-point} in the
internal language of~$\Sh(X)$, it follows that this is the case if and only if
\[ \Sh(X) \models \forall f\?\O_X\_ \speak{$f$ nilpotent} \vee \speak{$f$
invertible}. \]
(Internally, it always holds that~$\neg(1 = 0)$ in~$\O_X$, even if~$X$ happens
to be the empty scheme. Therefore the lemma is indeed applicable.) By
corollary~\ref{cor:scheme-dimension-zero}, this condition is equivalent to the
dimension of~$X$ being less than or equal to zero, \ie to~$X$ being empty or
having dimension exactly zero.
% Since this condition is a geometric implication, it is fulfilled in the
% internal language if and only if it is fulfilled at every point~$x \in X$.
% This amounts to requiring that in any local ring~$\O_{X,x}$, the unique
% maximal ideal is the only prime ideal, \ie that all local rings~$\O_{X,x}$
% have Krull dimension zero. This is equivalent to~$X$ being empty or having
% dimension zero.
\end{proof}

\begin{cor}Let~$X$ be a scheme. Then the relative spectrum of
quasicoherent~$\O_X$-algebras can be calculated by
the internal spectrum (instead of the internal quasicoherent spectrum) if and
only if~$X$ is empty or zero-dimensional.\end{cor}
\begin{proof}The externalization of the internal spectrum of arbitrary
quasicoherent~$\O_X$-algebras~$\A$ coincides with the relative spectrum if and
only if it coincides in the special case~$\A = \O_X$. This is apparent by the
universal properties of both constructions. Thus the claim follows by the
previous proposition.
\end{proof}


\section{Unsorted}
\begin{itemize}
\item ``functoriality''
\item Kähler differentials
\item closed and open subschemes
\item $j_! \O_U$ flat over~$\O_X$, \ldots
\item Koszul resolution; Beilinson resolution?
\item meta properties: some lemmas about limits of modules
\item locally small categories
\item big Zariski topos
\item open/closed immersions
\item morphisms of schemes...
\item proper maps...
\item limits and colimits...
\item Kähler differentials; clear myth that the definition via free modules
``does not glue very well''
(\url{http://www.mathematik.uni-kl.de/~gathmann/class/alggeom-2002/chapter-7.pdf})
\end{itemize}


\appendix

\section{Noetherianity}

Recall the usual notion of a Noetherian ring: Any sequence~$\aaa_0 \subseteq
\aaa_1 \subseteq \cdots$ of ideals should stabilize, \ie there should exist a
natural number~$n$ such that~$\aaa_n = \aaa_{n+1} = \cdots$.

Intuitionistically, this definition has two problems. Firstly, without the
axiom of dependent choice, it is often not possible to construct a
\emph{sequence} of ideals: Often, it is only possible to show that there
\emph{exists} a suitable ideal~$\aaa_{n+1}$ depending on~$\aaa_n$. But since in
general, there is no canonical choice for this successor ideal, the axiom of dependent choice
would be required to collect those into a sequence, \ie a function from~$\NN$
to the set of ideals.

Secondly, the conclusion that the sequence stabilizes is too strong:
Intuitionistically, one cannot even show that a weakly descending sequence of
natural numbers stabilizes in this sense; the statement that one could is
equivalent to the \emph{limited principle of omniscience for~$\NN$}.
Intuitionistically, it is only true that a weakly descending sequence~$a_0 \geq
a_1 \geq \cdots$ of natural numbers eventually \emph{halts} in the sense that
there exists an index~$n$ such that~$a_n = a_{n+1}$ (but~$a_{n+1} > a_{n+2}$ is
allowed).

We therefore adopt the following definitions.

\begin{defn}Let~$M$ be a partially ordered set. An \emph{ascending process
with values in~$M$} is a function~$f : \NN \to \P(M)$ such that
the subset~$f(0)$ is inhabited and such that for any~$x \in f(n)$, $n \in \NN$,
there exists an element~$y \in f(n+1)$ with~$x \preceq y$. (In particular, all
subsets~$f(n)$ are inhabited.) Such a process \emph{halts} if and only if there
exists a step~$n$ such that there is an element~$x \in f(n) \cap f(n+1)$. The
set~$M$ satisfies the \emph{ascending process condition} if and only if any
ascending process with values in~$M$ halts.
\end{defn}

\begin{defn}A ring~$R$ is \emph{processly Noetherian} if and only if the
set of finitely generated ideals in~$R$ satisfies the ascending process
condition.\end{defn}

Any ascending chain of elements~$a_0 \preceq a_1 \preceq \cdots$ in a partially
ordered set gives rise to an ascending process by setting~$f(n) := \{ a_n
\}$. Conversely, the axiom of dependent choice would allow to construct an
ascending chain out of an ascending process. In classical logic, a ring is
processly Noetherian if and only if it is Noetherian in the usual sense.

The notion of a processly Noetherian ring works well in an
intuitionistic context: Important rings such as~$\ZZ$ and more generally~$\O_K$
for any algebraic number field~$K$ are processly Noetherian, and matrices
over Bézout rings which are integral domains in the weak sense and
processly Noetherian can be put into Smith canonical form.

\begin{prop}A scheme~$X$ is locally Noetherian if and only if the ring~$\O_X$
is processly Noetherian from the internal point of view.\end{prop}
\begin{proof}We only prove the ``only if'' direction. We may assume that~$X =
\Spec A$ is affine with~$A$ a Noetherian ring and that internally, we are given an
ascending process on the set of finitely generated ideals of~$\O_X$.
Externally, this is a morphism~$\ul{\NN} \to \P(\M)$ where~$\NN$ is the
constant sheaf with value~$\NN$ and~$U$-sections of~$\M$ are finite type ideal
sheaves of~$\O_X|_U$.

Since~$X \models \speak{$f(0)$ is inhabited}$, there exists an open covering~$X
= \bigcup_i U_i$ and finite type ideal sheaves~$\I_i \hookrightarrow
\O_X|_{U_i}$ such that~$U_i \models \I_i \in f(0)$. Without loss of generality,
we may assume that the open sets~$U_i$ are standard open sets~$D(f_i)$ and that
the covering is finite. Since the sheaves~$\I_i$ are quasicoherent (being of finite type), they
correspond to ideals~$J_i \subseteq A[f_i^{-1}]$. (Note for future reference
that~$\I_i|_{D(g)}$ corresponds to the extension of~$J_i$ in the further
localized ring~$A[g^{-1}]$, if~$D(g) \subseteq D(f_i)$.)

For each~$i$,~$D(f_i) \models \exists \aaa \in f(1)\_ \I_i \subseteq \aaa$.
Thus there exists an open covering~$D(f_i) = \bigcup_j D(g_{ij})$ and finite
type ideal sheaves~$\I_{ij} \hookrightarrow \O_X|_{D(g_{ij})}$; these
correspond to ideals~$J_{ij} \subseteq A[g_{ij}^{-1}]$ such that~$J_i
\subseteq J_{ij}$ (where we have suppressed the localization
morphism~$A[f_i^{-1}] \to A[g_{ij}^{-1}]$ in the notation). Equivalently,
writing~$J_i' := A \cap J_i$ and~$J_{ij}' := A \cap J_{ij}$ for the
contractions, we have the inclusions~$J_i' \subseteq J_{ij}'$ of ideals of~$A$.

Continuing in this fashion, we obtain a tree of ideals~$J_{i_1 \cdots i_n}'$.
Each path in this tree is a chain of ascending ideals and thus stabilizes
since~$A$ is Noetherian. Since only finitely many subtrees branch off at
each node, there appear only finitely many distinct ideals in this tree (this
is an application of the graph-theoretical \emph{König's lemma}).

There thus exists a natural number~$n$ such that~$J_{i_1 \cdots i_n}' = J_{i_1
\cdots i_n i_{n+1}}'$ for all appropriate indices~$i_1,\ldots,i_n,i_{n+1}$.
For this number~$n$, the internal statement~$X \models \exists \aaa \in f(n)
\cap f(n+1)$ holds; we leave further details to the reader.
\end{proof}

\begin{rem}Let~$X$ be a locally Noetherian scheme. The proof shows that even
the set of all quasicoherent ideals (instead of merely the finitely generated
ones) fulfills the ascending process condition. We have not taken this property
as the definition of a processly Noetherian ring since it is a notion not
usually studied in constructive mathematics (compare
remark~\ref{rem:qcoh-in-constructive-mathematics}).
\end{rem}

\XXX{Find appropriate place for the material in this appendix}

\XXX{Give examples made possible by the internal Noetherianity}


\section{Dictionary between internal and external notions}

\small
{\renewcommand{\arraystretch}{1.3}
\begin{longtable}{@{}p{5cm}@{\qquad}p{5cm}@{\qquad}p{3cm}@{}}
  \toprule
  external & internal \\ \midrule
  \textbf{sheaves of sets} \\
  sheaf of sets & set \\
  $\alpha : \F \to \G$ epimorphism & $\alpha$ surjective & example~\ref{ex:injective-surjective} \\
  $\alpha : \F \to \G$ monomorphism & $\alpha$ injective & example~\ref{ex:injective-surjective} \\
  $\Int(X \setminus \supp\F)$ & truth value of ``$\F$ is a singleton'' & remark~\ref{rem:support-sheaf-of-sets} \\
  $f : X \to \NN$ upper semicontinuous & element of~$\widehat\NN$ & lemma~\ref{lemma:upper-semicontinuous-functions} \\
  $f : X \to \NN$ locally constant & element of~$\NN$ & discussion after lemma~\ref{lemma:upper-semicontinuous-functions} \\\\

  \textbf{sheaves of rings} \\
  sheaf of rings & ring & proposition~\ref{prop:rings-internally} \\
  local sheaf of rings & local ring & proposition~\ref{prop:local-ring} \\
  $\O_X$ is reduced & $\O_X$ is reduced & proposition~\ref{prop:reduced-ring}; a field property holds: $\neg\text{invertible} \Rightarrow \text{zero}$ \\\\

  \textbf{sheaves of modules} \\
  sheaf of modules & module \\
  $\F$ is finite locally free & $\F$ is finite free & proposition~\ref{prop:locally-free} \\
  $\F$ is of finite type & $\F$ is finitely generated & proposition~\ref{prop:finite-type-and-co} \\
  $\F$ is of finite presentation & $\F$ is finitely presented & proposition~\ref{prop:finite-type-and-co} \\
  $\F$ is coherent & $\F$ is coherent & proposition~\ref{prop:finite-type-and-co} \\
  $\F$ is quasicoherent & $\F[f^{-1}]$ is a sheaf wrt.\@~$(\speak{$f$ \inv} \Rightarrow \placeholder)$ for any~$f\?\O_X$ & theorem~\ref{thm:qcoh-sheafchar} \\
  $\F$ is flat & $\F$ is flat & proposition~\ref{prop:flatness} \\
  tensor product $\F \otimes \G$ & tensor product $\F \otimes \G$ & proposition~\ref{prop:internal-tensor-product} \\
  dual~$\F^\vee = \HOM_{\O_X}(\F,\O_X)$ & dual $\F^\vee = \Hom_{\O_X}(\F,\O_X)$ \\
  $\Int(X \setminus \supp\F)$ & truth value of~``$\F = 0$'' & proposition~\ref{prop:characterization-support} \\
  rank function of~$\F$ & minimal number of generators for~$\F$ & proposition~\ref{prop:rank-function-internally} \\\\

  \textbf{subspaces} \\
  sheaf supported on closed subset~$A$ & $\Box$-sheaf, where~$\Box = (\placeholder \vee A^c)$ & lemma~\ref{lemma:essim-closed-immersion} \\
  sheaf of the form~$j_*(\F)$ & $\Box$-sheaf, where~$\Box = (U \Rightarrow
  \placeholder)$ & $j : U \hookrightarrow X$ open inclusion \\
  extension of~$\F$ by the empty set & $j_!(\F) = \{ x\?\F \,|\, U \}$ & lemma~\ref{lemma:extension-by-empty-set} \\
  extension of~$\F$ by zero & $j_!(\F) = \{ x\?\F \,|\, (x = 0) \vee U \}$ & lemma~\ref{lemma:extension-by-zero} \\
  sheaf with empty/zero stalks on~$U^c$ & sheaf of the form~$j_!(\F)$ & $j : U
  \hookrightarrow X$ \\
  sections of~$\F$ are equal if they agree on dense open & $\F$ is $\neg\neg$-separated & proposition~\ref{prop:negneg-sheaves} \\
  sheaf of sections of~$\F$ defined on dense open subsets & $\F^{++}$ with respect to~$\Box = \neg\neg$ & proposition~\ref{prop:negneg-sheaves}, assuming~$\F$ is~$\neg\neg$-separated \\
  $V(\I)$ is a reduced scheme & $\I$ is a radical ideal & lemma~\ref{lemma:closed-subspace-reduced} \\
  $\O_{X_\mathrm{red}}$ & $\O_X/\sqrt{(0)}$ & lemma~\ref{lemma:reduced-subspace} \\\\

  \multicolumn{3}{@{}l@{}}{\textbf{rational functions and Cartier divisors}} \\
  $\K_X$ & total quotient ring of~$\O_X$ & proposition~\ref{prop:kx-internally} \\
  Cartier divisor & element of~$\K_X^*/\O_X^*$ \\
  effective Cartier divisor & $[s/1]$ with~$s\?\O_X$ regular & definition~\ref{defn:effective-cartier-divisor} \\
  line bundle~$\O_X(D)$ & $D^{-1} \O_X \subseteq \K_X$ & definition~\ref{defn:line-bundle-of-divisor} \\
  \bottomrule
\end{longtable}}

\XXX{update table to contain all concepts discussed in these notes}

\nocite{*}
\printbibliography

\XXX{``completed natural number'' is a misnomer.}

\XXX{remark on possible pitfalls}

\XXX{$:=$, $:\equiv$}

\end{document}

Snippet that may be useful later:
By appealing to the axiom of unique choice (see~YYY), we can
define a morphism of sheaves~$\O_X(D) \otimes \O_X(D') \to \O_X(D + D')$ by
internally describing a suitable map using representatives~$D = [f]$,~$D' =
[f']$, as long as the resulting map does not depend on the choice of representatives.

For the third statement, note that it is equivalent to show that
\[ \Gamma(U,\F^+) = \{ (V,s) \,|\,
  \text{$V \subseteq U$ dense open},\
  s \in \Gamma(V,\F),\
  \text{$(V,s)$ maximal} \}, \]
where~``$(V,s)$ maximal'' means that for any other such pair~$(W,t)$ such
that~$V \subseteq W$ and~$t|_V = s$, it holds that~$V = W$. This follows from
the fact that the plus construction can also be defined as
\[ \F^+ := \{ S \subseteq F \,|\,
  \speak{$S$ subsingleton},\
  \neg\neg(\speak{$S$ inhabited}),\
  \speak{$S$ $\neg\neg$-stable} \}. \]
